---
layout: post
title: Exploring the World of ESI Injection
---

<p>Heyyy Everyoneee,</p><p>In this writeup I will be sharing my findings related to ESI (<strong><em>Edge Side Include</em></strong>) Injection which me and my friend <a href="https://twitter.com/nytr0gen_">nytr0gen</a> found on a Private bug bounty program. We found a bunch of them so make sure you read it till the last , as you won’t miss the most interesting findings in that manner :)</p><p>If you aren’t aware / haven’t already heard about <strong><em>Edge Side Include Injection, </em></strong>I strongly recommend reading the below articles first , as Gosecure has already done a great job at explaining it and also you can checkout Alex Birsan tweet below to find out how to look for them last but not the least you can also you can watch the DEFCON talk:</p><ul><li><a href="https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/">Beyond XSS: Edge Side Include Injection - GoSecure</a></li><li><a href="https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/">ESI Injection Part 2: Abusing specific implementations - GoSecure</a></li></ul><iframe src="https://cdn.embedly.com/widgets/media.html?src=https%3A%2F%2Fwww.youtube.com%2Fembed%2FVUZGZnpSg8I%3Ffeature%3Doembed&amp;display_name=YouTube&amp;url=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DVUZGZnpSg8I&amp;image=https%3A%2F%2Fi.ytimg.com%2Fvi%2FVUZGZnpSg8I%2Fhqdefault.jpg&amp;key=a19fcc184b9711e1b4764040d3dc5c07&amp;type=text%2Fhtml&amp;schema=youtube" width="854" height="480" frameborder="0" scrolling="no"><a href="https://medium.com/media/e003d30fe578f3e7f3cc67d986561af0/href">https://medium.com/media/e003d30fe578f3e7f3cc67d986561af0/href</a></iframe><h3>Alex Birsan (parody) on Twitter: &quot;2. If he llo turns into hello but he llo isn&#39;t modified you have ESI injection / Twitter&quot;</h3><p>2. If he llo turns into hello but he llo isn&#39;t modified you have ESI injection</p><h4>The Story Begins</h4><p>These findings were on a private program so I will be referring to the target as <strong>redacted.com</strong>, to give you some idea about the company I will let you know that it’s a very famous sport’s organization.</p><p>I was looking for xss bugs and soon enough found one endpoint where it allowed &lt;&gt;&#39;&quot; characters as they were reflecting as it is in the response but I couldn’t get xss there easily due to the <em>Akamai WAF</em> in place.</p><p>Going through the page source, I noticed a block of code which looked kinda suspicious to me:</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/849/1*InPK3iHArBuUKZ1s2hWH6w.png" /></figure><p>I knew about <strong><em>ESI </em></strong>so instead of focusing on popping an alert box I started checking if the <em>caching server</em> will render my inputted esi tags,</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/842/1*W_9UgYxqu8bmxwQzov0XkQ.png" /></figure><p>I used the above payload and it was blocked by waf, the application had some more strict waf rules in place after further testing I realised that the waf looks for pattern like this &lt;esi:placeholderhere&gt; and blocks if it contains any of the valid <em>ESI </em>tags such as include, etc . Using just &lt;esi:&gt; returned 500 Internal Server Error ,so I knew the caching server was actually trying to render the <em>ESI </em>tags, I tried various characters such as %00,%0A,etc to check if any of them allows to bypass the check but nothing worked in the end.</p><p>At that time I was using <strong><em>Burp Pro Trial</em></strong>, so I scanned this parameter using it and I received this output:</p><pre>https://globe.redacted.com/?showFooter=um6k%3c!--esi--%3e8omf%3c!--esx--%3eekdi<br><br>Note: This issue was generated by the Burp extension: Active Scan++.<br>Issue detail<br>The application appears to support Edge Side Includes:  The following probe was sent: um6k&lt;!--esi--&gt;8omf&lt;!--esx--&gt;ekdi In the response, the ESI comment has been stripped: um6k8omf&lt;!--esx--&gt;ekdi  Refer to https://gosecure.net/2018/04/03/beyond-xss-edge-side-include-injection/ for further information</pre><p>So I was able to confirm the <em>ESI injection</em> using the comment tag, but still not very useful. As I had no further idea to try , I decided to move on.</p><p>I then saved the endpoint in my notes and moved on, in hope I will be able to escalate it in future.</p><p>A couple of months passed and I received a mail from the company’s bbp, they had launched a <strong><em>Promotion Event</em></strong> and were paying <strong>2x</strong> for all high/crtical submissions.</p><p>Seeing this mail, I couldn’t leave the endpoint in my notes any longer I needed to somehow escalate it, whatever it takes.</p><p>I was pretty sure I wouldn’t be able to escalate it on my own as I don’t have the required skillset for it so why not contact somebody else who has way more experience than me and would be able to come up with a solution to bypass the waf.</p><p>The program allowed <strong><em>collaborating</em></strong> on reports , so I could just contact someone from the collaborator section.</p><p>There were many people in this program even some big names were also there , so it was a tough call on who should I contact after some thoughts I contacted <strong><em>nytr0gen ,</em></strong> I already knew about him as I have been playing ctfs. He is from <em>WreckTheLine </em>ctf team and trust me CTF players skillset are on a whole different level.</p><h3>Collaboration Magic ⭐</h3><p>In 30 minutes approximately nytr0gen came up with working ESI payload which can be used to popup a xss alert box.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/732/1*u-oj9vcDFjE6BxpbkIKOMA.png" /></figure><p>Some more examples for you to understand how ESI tags can be use to bypass WAF:</p><h3>ramsexy on Twitter: &quot;Found an ESI injection but all tags are blocked by the WAF? If ESI comments works, you can try to bypass the WAF for the XSS with something like this : error=ale rt(1)&gt; / Twitter&quot;</h3><p>Found an ESI injection but all tags are blocked by the WAF? If ESI comments works, you can try to bypass the WAF for the XSS with something like this : error=ale rt(1)&gt;</p><h3>Alex Birsan (parody) on Twitter: &quot;1. Much easier and straight-forward way to bypass XSS auditors and WAFs is by adding whenever needed: ipt&gt;aler t(1) ript&gt; / Twitter&quot;</h3><p>1. Much easier and straight-forward way to bypass XSS auditors and WAFs is by adding whenever needed: ipt&gt;aler t(1) ript&gt;</p><p>Let me decode the payload for you to understand what actually happened</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/e69130d1d8fea40f31b0a5dd234aca09/href">https://medium.com/media/e69130d1d8fea40f31b0a5dd234aca09/href</a></iframe><p>I was blown away when I first saw this as I didn’t knew you can use variables inside the ESI comment tag also.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*Vmx6y09Moau1U5_IBACReA.png" /><figcaption><a href="https://docs.oracle.com/cd/A97335_02/caching.102/a90372/esi.htm#633138">https://docs.oracle.com/cd/A97335_02/caching.102/a90372/esi.htm#633138</a></figcaption></figure><p>When the above payload will be rendered by caching server it will return only this on the page source:</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/819/1*jvkwoikvdqO8RMedlVrCKg.png" /></figure><p>$(QUERY_STRING{countryCode}) returned the countryCode parameter value, ESI Tags are really very powerful you can do a bunch of things with them.</p><p>Another interesting thing was that the application session cookies were marked as <strong><em>httponly </em></strong>and it was scope to .redacted.com , as the cookies were marked as <strong><em>httponly </em></strong>it wouldn’t have been possible to steal the session cookies with a normal mere xss but with ESI tags it’s possible :)</p><p>Well I even asked him how he came up with the idea of using the variables inside ESI comment, he told me he just read the docs</p><p><a href="https://docs.oracle.com/cd/B14099_19/caching.1012/b14046/esi.htm#i654520">Edge Side Includes (ESI) Language Tags</a></p><figure><img alt="" src="https://cdn-images-1.medium.com/max/715/1*SyNnIKxIUwixF1gwIo-0DQ.png" /></figure><p>A full blown account takeover POC was provided in the report , the issue got <em>triaged </em>and was rewarded with a<em> high severity</em> rating (thanks to the 2x multplier):</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/899/1*cyMqqPBhbHJm93p4LTeu0A.png" /></figure><p>The story doesn’t ends here as it turn out nytr0gen found another subdomain where he had xss upon using ESI tags, there also they were being rendered by the caching server, this was a great signal for us as this might mean that still there might be more of this ESI Injection bugs across the whole target.</p><p>This application was doing some wierd uppercase / lowercase transformation of our input so we were not able to use any variable like for eg HTTP_COOKIE as it was being transformed into uppercase / lowercase wierdly <strong>http_COOKIE</strong> , still nytr0gen was able to again read the docs and find another useful ESI function which allows to decode url encoded strings:</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*fhSCF1_6wG1jLiI5MI3aoQ.png" /><figcaption><a href="https://www.akamai.com/site/zh/documents/technical-publication/akamai-esi-developers-guide-technical-publication.pdf">https://www.akamai.com/site/zh/documents/technical-publication/akamai-esi-developers-guide-technical-publication.pdf</a></figcaption></figure><p>He url encoded the payload 2times to make sure Akamai doesn’t blocks it,</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*B4vjQfVX3OOx32AmvPfYOA.png" /></figure><p>Moving on, as now I slowly slowly started to get a grasp of this ESI Injection by reading nytr0gen multiple times. I had already found a xss on another subdomain ,there were no signs of ESI tags in page source anywhere but I still decided to give it a shot aaa&lt;!--esi--&gt;bbb&lt;!--esx--&gt;ccc , use this as the payload and the server actually rendered it so I knew ESI injection bug was there used the same payload for account takeover</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*hhXrjLUd7xxESt_u4h32ZA.png" /></figure><p>If you are interested in <em>account takeover POC</em> here it is (the js code is placed after the hash, I just placed it below to make it more readable):</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*JJcsDm8V7QZL7gYfNQNZ2g.png" /></figure><p>nytr0gen did an awesome job here making it very easy for the triager to reproduce the actual impact using this poc. As you guys are now already aware what does the HTTP_COOKIE and QUERY_STRING{x} variables do so it should easy for you to understand the poc.</p><p>Btw it turned out that nytr0gen had already submitted this xss bug 10 months ago, we still decided to report it as this had much more impact compared to a normal xss.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/902/1*BkqmkF1peTYOEIocmZMp5w.png" /></figure><p>Another HIGH severity bug, we are doing good here :)</p><p>Let’s keep going, the upcoming ESI Injection bugs are super interesting so hold your seats tight, the best is yet to come.</p><p>After few days nytr0gen again found another new endpoint which was vulnerable .</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/718/1*d5LXW5ihf2d1FYRSwSIURg.png" /></figure><p>Yeah you read that right, the Response Content-Type header value for this endpoint was application/json , the ESI tags were still rendered by caching server.</p><p>Although it was possible to include the ESI tag here, but how would you be able to steal the cookie which is in the page response as xss won’t work with Content-Type: application/json or is it so?</p><p>Anyone would have have stopped here thinking that you can’t do anything now due to the Content-Type , but you shouldn’t be worried when nytr0gen is there to cover your back :)</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/726/1*aRHptw99NJtB2Niee5_9Dw.png" /></figure><p>Here’s the answer using the $add_header() method you can overwrite any response header.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*VdEUWFnYWD1h-0GrMNN0wA.png" /><figcaption><a href="https://www.akamai.com/site/zh/documents/technical-publication/akamai-esi-developers-guide-technical-publication.pdf">https://www.akamai.com/site/zh/documents/technical-publication/akamai-esi-developers-guide-technical-publication.pdf</a></figcaption></figure><p>The below payload will change the response content-type to text/html</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/687/1*Fd50GPveRabA_2KLV7iPXA.png" /></figure><p>And here’s the final payload we used to execute js code, we first used HTTP_COOKIE then add_header and then the url_decode function:</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*RvvowpnpSZycjwBm1fNfiQ.png" /></figure><p>The HTTP_COOKIE variable returns the cookies in the response, add_header function changes the <em>content type</em> of the response and finally using url_decode function we put our xss payload (url encoded 2 times to avoid waf ) using which we can steal the page response.</p><p>A great bug deserves a great bounty :)</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/915/1*5kufvYug-OnnNjskYjoVGg.png" /></figure><p>We thought this must be the end of it and there will be no more ESI bugs, but we were wrong…………..</p><h3>The Story Continueeeees</h3><p>We found another endpoint , it looked like a proxy which takes an url parameter as input and it then fetches the response of that url.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/832/1*PwXiz5U2QP92-iriHUY1dw.png" /></figure><p>It only whitelisted few domains some of them were on our target redacted.com and few were on other 3rd party sites.</p><p>Due to the way it worked ,we started testing to see if ssrf is possible here. As it only allowed making requests to some whitelist hosts we began looking for any open redirect bug in those hosts.</p><p>We were able to find one in redacted.com but it only worked when the user is authenticated, btw this open redirect was a bit interesting.</p><p>Upon visiting this url: <a href="https://www.redacted.com/auth#login?url=http://evil.com">https://www.redacted.com/auth#login?url=http://evil.com</a></p><p>It loaded another url inside an iframe which then redirect to our url, I tried for xss but it didn’t worked as the redirect was happening via the Location header.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*ZYFqILdcN9dAsWlq6NX7ZQ.png" /></figure><p>We then moved onto the 3rd party sites xyz.com which were also in the whitelist, still we didn’t find any open redirect which can be useful to us, although we find some xss on these 3rd party sites.</p><p>Ssrf looked so close here but still we weren’t able to make arbitrary requests.</p><p>While playing around with this endpoint, I used the 3rd party site xss vulnerable endpoint in the url parameter and surprisingly the xss popup appeared in the context of redacted.com domain.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*8Jco2DUpQp0h4ZtfNfsY6w.jpeg" /></figure><p>We had already reported an ESI Injection on this host before, so I just tried using an ESI payload and it really worked</p><p>So by using a xss on a different 3rd party domain we were able to get ESI injection working on our target domain, we couldn’t get ssrf as we didn’t find any open redirect after spending a couple of days but atleast we managed to escalate this using ESI Injection so we reported this.</p><p>We also tried one more thing which I think I should mention, as you already know about the add_header function of ESI, we thought we can create our own open redirect bug with a payload like this:</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/802/1*5c0iN1sBrN_wBtIJjtN6uw.png" /></figure><p>Using this payload on any of the previous endpoint which we found vulnerable to ESI injection will give us a sweet and simple open redirect.</p><p>It was working normally but when we used this open redirect url on the <strong><em>proxy </em></strong>endpoint, it didn’t worked for some reason maybe Akamai waf or something we didn’t knew.</p><p>And here comes the twist in the story, the bug was marked as duplicate by the <em>h1 triager , </em>we both were like wtf that’s impossible.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/887/1*Muu8_lsFfMtgKDo1Vm0alQ.png" /></figure><p>If this was actually duplicate that would mean that there is someone else in this program who also knows about this ESI magic or is to so?</p><p>After further back and forth with the <em>h1 triager , </em>we got to know that the original reporter actually was able to escalate it to perform SSRF but without the ESI trick obviously.</p><p>We forgot about this report and moved on. Soon enough the <em>promotion </em>came to end and we decided that we will also stop for now and if in future they did the same 2x promotion we will look back at this, which we thought had very less probability.</p><h3>Another Promotion</h3><p>Soon enough after 4–5 months they again launched the same 2x multiplier promotion and we were ready to hunt those ESI injection bugs again</p><iframe src="https://cdn.embedly.com/widgets/media.html?src=https%3A%2F%2Fgiphy.com%2Fembed%2FqQRfz2VfUbDeebczif%2Ftwitter%2Fiframe&amp;display_name=Giphy&amp;url=https%3A%2F%2Fmedia.giphy.com%2Fmedia%2FqQRfz2VfUbDeebczif%2Fgiphy.gif&amp;image=https%3A%2F%2Fi.giphy.com%2Fmedia%2FqQRfz2VfUbDeebczif%2Fgiphy.gif&amp;key=a19fcc184b9711e1b4764040d3dc5c07&amp;type=text%2Fhtml&amp;schema=giphy" width="435" height="348" frameborder="0" scrolling="no"><a href="https://medium.com/media/81cb3629a492fd2cf2ce165dfd2b8437/href">https://medium.com/media/81cb3629a492fd2cf2ce165dfd2b8437/href</a></iframe><p>I tested out some <em>callback </em>parameters as they usually reflect the input in response and found some which even allowed &lt;&gt; characters but the caching server configuration for such hosts were different so the ESI tags didn’t worked.</p><p>Some of old reports were fixed already , nytr0gen found that the same json api endpoint was now acccessible over a different path. To fix the original json api ESI bug they completely removed the endpoint but the same endpoint existed on another path so the bug was still there, using the same poc as before we were able to reproduce the bug.</p><p>Submitted it as the endpoint was different although it had the same api, triaged by the program and again rewarded as HIGH.</p><p>The team even asked us a question this time regarding mitigation :)</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/984/1*H9r_nxk7vAjwxP5u5Ut68Q.png" /></figure><p>I am going to talk about the last ESI bug we found, this one is the best so many cool ways we came up with to actually to come up with a working exploit.</p><p>If you stayed this long to the blog thanks a ton, be ready as I am going to tell you about the best ESI bug we found.</p><p>I found another endpoint , the Content-Type for this was application/json</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*GXdzqyEH8eliaGjjXiH4cw.png" /></figure><p>In the above screenshot you can see that the locale parameter value is reflected in the source, but the ESI tags didn’t get rendered by the caching server. As we had already found an ESI Injection bug here before, this should have worked.</p><p>I send this url over to nytr0gen and according to him also this should have worked. After some time he messages me saying that he got it working but it’s not useful.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/717/1*xkgyYq56yLGLxQPob-kXWA.png" /></figure><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*cVbLEn-ZwMJ3v0F3hRPUtw.png" /></figure><p>In this screenshot you can see that ESI tags worked but can you spot the changes made to this request?</p><p>A trained eye would have already spot the url encoded . in the url %2e</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/933/1*ifR64FQWqcSBiHV4jrdH_Q.png" /></figure><p>The <strong>Backend server</strong> decoded the %2e in the url and returned the same response , the <strong>Caching Server</strong> didn’t ignored the %2e so it didn’t treated it as a <em>static file</em> anymore and hence it allowed the ESI tags to work.</p><p>It was working but sadly this isn’t exploitablable :(</p><p>If you send this url to an victim, when he loads this url . The browser will auto decode the %2e , so a request is made to the original endpoint not the one we wanted it to thus the ESI tags don’t get rendered.</p><p>We spent some more time on this but couldn’t figured it out how to make it work on the browser also.</p><p>Left this endpoint and moved to finding some more endpoints to test.</p><p>After a whole month passed, I was testing another program where I had a potential client side path traversal bug for eg suppose in the below js code you had control over the key variable.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/933/1*cwGPCLWE3lePcdWrKoPVbQ.png" /></figure><p>There was also a jsonp callback endpoint on the same host, so I was trying to trying to load it instead of the /api.js file, which will allow me to popup an alert</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/960/1*sG6bn-GfbAIOHhFE7Wa6Dg.png" /></figure><p>I was trying to do something like this , but the key variable value was taken from the query parameter so I couldn’t use the # symbol .</p><p>As if I put this # in the parameter value, it will be consumed by the browser and won’t be passed along in the key variable value.</p><p>If I urlencode %23 it then the browser while fetching the js file doesn’t auto decoded it, so I was stuck here. I also couldn’t use ? to ignore the /api.js part due to this part of the code.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*nWBy13XKChCBZSkrY2AUTA.png" /></figure><p>Inside the getAllUrlParams method noticed the first line url.split(&#39;?&#39;)[1] , so if I use ? in my url parameter value this would happen</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/641/1*6LpeUpQOo9Dsk3czJPUPRg.png" /></figure><p>The ? will get completely ignored :( , due to the split method.</p><p>At that time I thought maybe if I load the url with the url encoded # inside an iframe , it will work. But sadly it didn’t worked.</p><p>I though of using the same idea on the <em>Redacted target</em> also, if you are not short tempered remember this endpoint?</p><figure><img alt="" src="https://cdn-images-1.medium.com/proxy/1*cVbLEn-ZwMJ3v0F3hRPUtw.png" /></figure><p>What if I load this url in an iframe would it work? Let’s find out</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*uusKhHzrIwvM_87BerA2Sg.png" /></figure><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*LsyF6INIG4clKi2KOrIROw.png" /></figure><p>It did actually work :)</p><iframe src="https://cdn.embedly.com/widgets/media.html?src=https%3A%2F%2Fgiphy.com%2Fembed%2FmQG644PY8O7rG%2Ftwitter%2Fiframe&amp;display_name=Giphy&amp;url=https%3A%2F%2Fmedia.giphy.com%2Fmedia%2FmQG644PY8O7rG%2Fgiphy.gif&amp;image=https%3A%2F%2Fi.giphy.com%2Fmedia%2FmQG644PY8O7rG%2Fgiphy.gif&amp;key=a19fcc184b9711e1b4764040d3dc5c07&amp;type=text%2Fhtml&amp;schema=giphy" width="435" height="244" frameborder="0" scrolling="no"><a href="https://medium.com/media/028b68879354e23888c638a1f0bb17f6/href">https://medium.com/media/028b68879354e23888c638a1f0bb17f6/href</a></iframe><p>When I tried to load the same code in Chrome browser it didn’t worked :(</p><p>%2e was automatically decoded by Chrome</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*wtoQ82I_oPNUFbeotMwOxg.png" /></figure><p>So wierdly this worked in Firefox but not in Chrome, I later confirmed that it also worked in the Safari the same way as Firefox.</p><p>I was so happy that it was finally working, I quickly contacted nytr0gen to give him the good news</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*bNrln2kdAU6qkhsz9sbJyQ.png" /></figure><p>Onto the POC part now, when I used the HTTP_COOKIE , I noticed that all the cookies weren’t present there mainly the one used for session purpose. Asked ntr0gen about it and it turns out it was due to the page being loaded inside an iframe and the parent was of different origin.</p><p>So instead we used another xss (created using one of our old ESI Injection bug) and use it to iframe this .json url and voilla this time the cookie appeared.</p><p>When I tried using the add_header method to change the application/json content type to text/html the waf blocked the request, after shortening I found that the waf now was blocking text/html keyword . This additional rule might have been set from the fix of our previous report so I needed to comeup with a bypass.</p><p>Upon fuzzing I found that %09 tab character (\t), was converted to t by the server.By using the below payload it was possible to change the Content-Type and then using xss steal the session cookie.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/722/1*0ehpBJMKY2oFikGPgg4HAg.png" /></figure><figure><img alt="" src="https://cdn-images-1.medium.com/max/912/1*mQNg92C_DdV2eMAh5IEqpQ.png" /></figure><p>This wasn’t rewarded with 2x multiplier because the asset in which we found the bug was not part of promotion and we agreed upon it as they still paid it as a HIGH severity even though it only worked in Firefox not in Chrome.</p><p>Another thing happened here at the last, the program manager asked us to stop testing further for ESI Injection bugs as they were going fine tune their WAF.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/885/1*QiTam4KlJUUIBTw1u9IB8Q.png" /></figure><p>Finally we have come to an end , I hope you didn’t get bored and enjoyed reading it :) That’s all, thankyou very much for reading it till the last. Hope you would have enjoyed it.</p><p>Goodluck for 2023</p><p>Sya Everyoneeee</p><img src="https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=b86234e66f91" width="1" height="1" alt=""><hr><p><a href="https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91">Exploring the World of ESI Injection</a> was originally published in <a href="https://infosecwriteups.com">InfoSec Write-ups</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>
